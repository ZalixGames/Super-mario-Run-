<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mario Run â€“ Earn Real money </title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <!-- Ad Script 1 (Placeholder - Ensure correct implementation) -->
  <script type='text/javascript' src='//pl26412649.profitableratecpm.com/13/e5/a4/13e5a43804eecf191c995f63cff90d9c.js'></script>
  <style>
    /* --- CSS Styles --- */
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Press Start 2P', cursive; overflow: hidden;
      background: #0a0a0a url('https://www.transparenttextures.com/patterns/stardust.png');
      color: #fff; margin-bottom: 50px; /* Space for banner */
    }
    canvas { display: block; background-color: #70c5ce; /* Default sky color if bg image fails */ }
    .text-glow { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff007f; }
    .box-glow { box-shadow: 0 0 8px rgba(255, 255, 255, 0.6), 0 0 15px rgba(255, 0, 127, 0.5); }
    .game-btn {
      padding: 12px 25px; margin: 10px; font-size: 14px; border: none;
      border-radius: 8px; cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, background-image 0.2s ease; /* Added background-image to transition */
      background: linear-gradient(145deg, #ff4757, #ff6348); color: #fff;
      font-family: 'Press Start 2P', cursive; text-transform: uppercase;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7); border-bottom: 4px solid #c0392b;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); display: inline-flex; /* Use inline-flex for alignment */
      align-items: center; justify-content: center; line-height: 1.2;
      text-decoration: none; /* Remove underline from <a> tags styled as buttons */
      background-size: cover; /* Default background size */
      background-position: center; /* Default background position */
      background-repeat: no-repeat; /* Default background repeat */
    }
    .game-btn:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 100, 100, 0.6);
      /* Keep background gradient change for standard buttons, will be overridden for download btn if needed */
      background-color: #ff6348; /* Fallback */
      background-image: linear-gradient(145deg, #ff6348, #ff7f50);
    }
    .game-btn:active:not(:disabled) {
         transform: translateY(1px) scale(1); border-bottom-width: 2px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .game-btn:disabled { background: #555; cursor: not-allowed; border-bottom-color: #333; box-shadow: none; transform: none; opacity: 0.7; }

    /* --- Login/Signup Panel Common Styles --- */
    .auth-panel {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/nxRZ03R.png') no-repeat center center;
      background-size: cover;
      background-color: rgba(0, 0, 0, 0.65); /* Adjust alpha (0.65) as needed */
      background-blend-mode: darken; /* Blend the color over the image */
      z-index: 100; display: none; /* Default to hidden */ flex-direction: column;
      justify-content: center; align-items: center; color: #fff; padding: 20px; text-align: center;
    }
    .auth-panel h2 { font-size: 2.5em; color: #ff007f; margin-bottom: 30px; text-shadow: 3px 3px 0px #000, 0 0 15px #ff007f; }
    .auth-panel input {
      width: 280px; padding: 12px 15px; margin: 8px; background: rgba(25, 25, 25, 0.85); /* Slightly lighter input background */
      border: 2px solid #ff007f; color: #fff; border-radius: 5px; font-family: 'Press Start 2P', cursive;
      font-size: 14px; outline: none; transition: border-color 0.3s, box-shadow 0.3s;
    }
    .auth-panel input:focus { border-color: #ff60af; box-shadow: 0 0 10px rgba(255, 0, 127, 0.7); }
    .auth-panel button.game-btn { width: 200px; }
    .auth-panel .switch-link { margin-top: 15px; color: #ccc; font-size: 0.9em; font-family: Arial, sans-serif; }
    .auth-panel .switch-link button { background: none; border: none; color: #ff007f; cursor: pointer; text-decoration: underline; font-family: 'Press Start 2P', cursive; font-size: 1em; padding: 0 5px; display: inline; }
    .auth-panel .switch-link button:hover { color: #ff60af; }
    #loginPanel button#loginButton { background: linear-gradient(145deg, #ff007f, #e60073); border-bottom-color: #a70057; }
    #loginPanel button#loginButton:hover:not(:disabled) { background-image: linear-gradient(145deg, #e60073, #ff309f); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 0, 127, 0.6); }
    #signupPanel button#performSignupBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #signupPanel button#performSignupBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #1dd1a1, #00b894); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(46, 213, 115, 0.6); }

    /* --- Main Menu --- */
    #mainMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/KFWJlte.png') no-repeat center center; background-size: cover;
      z-index: 30; display: none; /* Initially hidden */ flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center;
      padding-top: 80px; /* Add padding top to push buttons down slightly */
    }
    /* Removed h1 style as h1 is removed */
    #topRightStatus {
      position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.85); padding: 10px 15px;
      border-radius: 8px; font-size: 18px; color: #FFD700; z-index: 35; border: 2px solid #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); display: none; /* Initially hidden, shown for logged-in users */ align-items: center;
    }
    #topRightStatus img#coinIcon { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; }
    #settingsBtn {
      position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); border: 2px solid #ccc;
      border-radius: 50%; cursor: pointer; z-index: 35; width: 45px; height: 45px; display: none; /* Initially hidden, shown for logged-in users */
      justify-content: center; align-items: center; transition: transform 0.2s, box-shadow 0.2s;
    }
    #settingsBtn svg { width: 24px; height: 24px; fill: #fff; }
    #settingsBtn:hover { transform: rotate(45deg) scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.7); border-color: #fff; }
    #mainMenu .menu-btn { width: 220px; margin-bottom: 15px; /* Add slightly more space between buttons */ }
    #mainMenu #withdrawBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; display: none; /* Initially hidden */ }
    #mainMenu #withdrawBtn:hover { background-image: linear-gradient(145deg, #1dd1a1, #00b894); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(46, 213, 115, 0.6); }
    #mainMenu #inviteFriend { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; display: none; /* Initially hidden */ }
    #mainMenu #inviteFriend:hover { background-image: linear-gradient(145deg, #2e86de, #1e66b0); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(84, 160, 255, 0.6); }
    #mainMenu #logoutBtn { background: linear-gradient(145deg, #8395a7, #576574); border-bottom-color: #2f3640; display: none; /* Initially hidden */ }
    #mainMenu #logoutBtn:hover { background-image: linear-gradient(145deg, #576574, #434c58); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(131, 149, 167, 0.6); }

    /* --- START: Download Button Specific Style (Updated) --- */
    #downloadApkLink {
      /* Inherits width: 220px from .menu-btn */
      /* Inherits margin: 10px; margin-bottom: 15px from .menu-btn */
      /* Inherits display: inline-flex, align-items: center, justify-content: center from .game-btn */
      padding: 0; /* Remove default padding to let background image control size better */
      height: 70px; /* Adjust height based on your image aspect ratio, approx 3.6:1 for 220 width */
      background-image: url('https://imgur.com/QJZ5IJp.png'); /* Use the new image URL */
      background-color: transparent; /* Remove any gradient or solid color */
      background-size: contain; /* Fit the entire image within the button bounds */
      background-repeat: no-repeat;
      background-position: center center;
      border: none; /* Remove border if not part of the image */
      border-bottom: none; /* Remove specific bottom border */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); /* Keep basic shadow */
      text-indent: -9999px; /* Hide any potential text nodes */
      font-size: 0; /* Hide text */
      color: transparent; /* Hide text */
    }
    #downloadApkLink:hover {
       /* Keep transform and shadow from .game-btn:hover */
       transform: translateY(-2px) scale(1.03);
       box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.5); /* Example shadow on hover */
       /* Do NOT change background image on hover unless desired */
       background-image: url('https://imgur.com/QJZ5IJp.png'); /* Ensure image stays */
    }
    #downloadApkLink:active {
       transform: translateY(1px) scale(1); /* Keep active state transform */
       box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Keep active shadow */
    }
    /* --- END: Download Button Specific Style --- */


    /* --- Game Over Menu --- */
    #gameOverMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
      z-index: 40; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: #ff4757; padding: 20px; text-align: center;
    }
    #gameOverMenu h2 { font-size: 4em; text-shadow: 4px 4px 0px #000, 0 0 20px #ff0000; margin-bottom: 20px; }
    #gameOverMenu p { font-size: 1.5em; color: #fff; margin-bottom: 10px; text-shadow: 1px 1px 2px #000; }
    #gameOverMenu .menu-btn { width: 200px; }
    #gameOverMenu #restartBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #gameOverMenu #restartBtn:hover { background-image: linear-gradient(145deg, #1dd1a1, #00b894); }
    #gameOverMenu #backMenuBtn { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    #gameOverMenu #backMenuBtn:hover { background-image: linear-gradient(145deg, #2e86de, #1e66b0); }


    /* --- Modal Common Styles --- */
    .modal { display: none; position: fixed; z-index: 70; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
    .modal .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e1e1e; padding: 20px 25px; border-radius: 10px; width: 90%; color: #eee; text-align: center; font-family: 'Press Start 2P', cursive; border: 3px solid #ff007f; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(255, 0, 127, 0.4); max-height: 85vh; overflow-y: auto; }
    .modal h2 { margin-bottom: 20px; font-size: 1.4em; color: #ff007f; text-shadow: 1px 1px 2px #000; }
    .modal button.game-btn { width: 100%; margin: 8px 0; padding: 10px 15px; font-size: 12px; }
    .modal input[type="text"], .modal input[type="email"], .modal input[type="password"] { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border: 2px solid #555; border-radius: 5px; background: #333; color: #fff; font-family: 'Arial', sans-serif; font-size: 16px; outline: none; transition: border-color 0.3s, box-shadow 0.3s; }
    .modal input:focus { border-color: #ff007f; box-shadow: 0 0 8px rgba(255, 0, 127, 0.6); }
    .close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #aaa; font-family: Arial, sans-serif; transition: color 0.2s, transform 0.2s; font-weight: bold; }
    .close-btn:hover { color: #ff007f; transform: scale(1.2); }

    /* --- Specific Modal Sizes --- */
    #settingsModal .modal-content { max-width: 320px; }
    #profileModal .modal-content { max-width: 380px; text-align: left; }
    #inviteModal .modal-content { max-width: 360px; }
    #withdrawModal .modal-content { max-width: 380px; }
    #infoModal .modal-content { max-width: 360px; }
    #withdrawalHistoryModal .modal-content { max-width: 450px; }

    /* --- Settings Modal Button Styles --- */
    #profileBtn { background: linear-gradient(145deg, #9b59b6, #8e44ad); border-bottom-color: #6c3483; }
    #toggleSound { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #customerService { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    #withdrawalHistoryBtn { background: linear-gradient(145deg, #feca57, #ff9f43); border-bottom-color: #e67e22; }
    #profileBtn:hover { background-image: linear-gradient(145deg, #8e44ad, #a569bd); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(155, 89, 182, 0.6); }
    #toggleSound:hover { background-image: linear-gradient(145deg, #1dd1a1, #00b894); }
    #customerService:hover { background-image: linear-gradient(145deg, #2e86de, #1e66b0); }
    #withdrawalHistoryBtn:hover { background-image: linear-gradient(145deg, #ff9f43, #f39c12); }

    /* --- Profile Modal Styles --- */
    #profileModal .modal-content h2 { color: #9b59b6; }
    #profileModal .modal-content p { margin: 12px 0; font-family: Arial, sans-serif; font-size: 15px; line-height: 1.6; color: #ddd; }
    #profileModal .modal-content p strong { color: #fff; display: inline-block; min-width: 120px; }
    #profileModal .modal-content span { color: #feca57; word-break: break-all; }
    #profileInfo { border-top: 1px solid #444; margin-top: 15px; padding-top: 15px; }

    /* --- Invite Modal Styles --- */
    #inviteModal .section { margin: 20px 0; border-top: 1px solid #444; padding-top: 15px; }
    #inviteModal .section h3 { font-size: 1.1em; margin-bottom: 10px; color: #eee; }
    #inviteModal .section p { font-size: 1em; margin-bottom: 12px; font-family: Arial, sans-serif; }
    #inviteModal #yourInviteLinkDisplay { /* Changed ID */
        font-size: 1.0em; /* Slightly smaller for potentially long link */
        color: #FFD700;
        background: #333;
        padding: 8px 12px;
        border-radius: 5px;
        display: block; /* Make it block to take full width */
        border: 1px solid #555;
        word-break: break-all; /* Break long URLs */
        text-align: left; /* Align link left */
        margin-bottom: 10px; /* Add space before button */
    }
    #copyInviteCode { background: linear-gradient(145deg, #feca57, #ff9f43); border-bottom-color: #e67e22; }
    #redeemCodeBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #copyInviteCode:hover { background-image: linear-gradient(145deg, #ff9f43, #f39c12); }
    #redeemCodeBtn:hover { background-image: linear-gradient(145deg, #1dd1a1, #00b894); }

    /* --- Withdraw Modal Styles --- */
    #withdrawModal .modal-content p { margin-bottom: 20px; font-family: Arial, sans-serif; line-height: 1.5; }
    #withdrawModal .redeem-option { background: linear-gradient(145deg, #1abc9c, #16a085); border-bottom: 4px solid #117a65; color: #fff; padding: 10px 15px; margin: 6px 0; border-radius: 8px; font-size: 13px; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease; width: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2); }
    #withdrawModal .redeem-option:hover { background: linear-gradient(145deg, #1dd1a1, #1abc9c); transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3), 0 0 15px rgba(26, 188, 156, 0.5); }
    #withdrawModal .redeem-option:active { transform: translateY(1px); border-bottom-width: 2px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
    #redeemForm { display: none; margin-top: 20px; font-family: Arial, sans-serif; font-size: 16px; line-height: 1.5; text-align: left; }
    #redeemForm h3 { font-family: 'Press Start 2P', cursive; font-size: 1.2em; color: #eee; margin-bottom: 15px; text-align: center; }
    #redeemForm label { display: block; margin-bottom: 5px; color: #ccc; font-size: 14px; }
    #redeemForm input[type="text"] { margin-bottom: 15px; }
    #redeemForm input[type="radio"] { margin-right: 8px; vertical-align: middle; }
    #redeemForm label input[type="radio"] { display: inline; margin-bottom: 0; }
    #redeemForm .payment-options label { margin-bottom: 10px; display: block;}
    #redeemSubmitBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; width: 100%; margin-top: 20px; font-size: 14px; }
    #redeemSubmitBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #1dd1a1, #00b894); }
    #redeemSubmitBtn:disabled { background: #555; cursor: not-allowed; border-bottom-color: #333; box-shadow: none; transform: none; opacity: 0.7;}

    /* --- Info Modal Styles --- */
    #infoModal .modal-content h2 { color: #54a0ff; }
    #infoModal .modal-content p { margin: 15px 0; font-family: Arial, sans-serif; font-size: 15px; line-height: 1.6; color: #ddd; text-align: left; }
    #infoModal .modal-content p strong { color: #fff; }

    /* --- Withdrawal History Modal Styles --- */
    #withdrawalHistoryModal .modal-content h2 { color: #feca57; }
    #historyList { margin-top: 20px; max-height: 50vh; overflow-y: auto; padding-right: 10px; text-align: left; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.5; }
    .history-item { background: #2a2a2a; border: 1px solid #444; border-radius: 6px; padding: 12px 15px; margin-bottom: 10px; color: #ccc; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
    .history-item span { display: block; margin-bottom: 4px; }
    .history-item .details { flex-grow: 1; margin-right: 10px; }
    .history-item .status { font-family: 'Press Start 2P', cursive; font-size: 12px; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; min-width: 80px; text-align: center; margin-top: 5px; }
    .history-item .status-pending { background-color: #ff9f43; color: #573a0a; border: 1px solid #e67e22;}
    .history-item .status-approved { background-color: #2ed573; color: #0a4a2f; border: 1px solid #10ac84;}
    .history-item .status-rejected { background-color: #ff4757; color: #5e141e; border: 1px solid #c0392b;}
    .history-item .date { font-size: 12px; color: #888; width: 100%; text-align: right; margin-top: 5px; }
    #historyList .no-history { color: #888; text-align: center; padding: 20px; font-size: 1em;}

    /* --- Ad Container Styles --- */
    #bannerAdContainer { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background-color: #000; z-index: 1000; display: flex; justify-content: center; align-items: center; overflow: hidden; border-top: 2px solid #333; }
    #bannerAdContainer iframe { max-width: 100%; }
    #interstitialAdOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; font-family: 'Press Start 2P', cursive; padding: 20px; backdrop-filter: blur(3px); }
    #interstitialAdOverlay p#adInfoText { font-size: 1.1em; margin-bottom: 25px; color: #eee; line-height: 1.5; }
    #interstitialAdCloseButton { padding: 12px 25px; font-size: 1em; cursor: pointer; background: linear-gradient(145deg, #ff4757, #e84118); border-bottom-color: #c23616; color: white; border-radius: 8px; font-family: 'Press Start 2P', cursive; display: none; text-transform: uppercase; margin-top: 20px; }
    #interstitialAdCloseButton:hover { background-image: linear-gradient(145deg, #e84118, #d63031); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 71, 87, 0.6); }
    #interstitialAdTimer { margin-top: 15px; font-size: 0.9em; color: #ccc; }
    #interstitialAdOverlay p.skip-info { font-size: 0.8em; color: #aaa; margin-top: 30px; font-family: Arial, sans-serif; line-height: 1.4; }

    /* --- Status Message Container --- */
    #statusMessageContainer { display: none; position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.85); color: white; padding: 12px 25px; border-radius: 8px; z-index: 5000; font-family: 'Press Start 2P', cursive; font-size: 0.9em; text-align: center; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); opacity: 0; transition: opacity 0.4s ease-in-out, top 0.4s ease-in-out; max-width: 90%; pointer-events: none; }
    #statusMessageContainer.show { display: block; opacity: 1; top: 25px; /* Animate downwards slightly */ }
    #statusMessageContainer.success { border-color: #2ed573; }
    #statusMessageContainer.error { border-color: #ff4757; }
    #statusMessageContainer.info { border-color: #54a0ff; }

    /* --- End of CSS --- */
  </style>
</head>
<body>
  <!-- Status Message Container -->
  <div id="statusMessageContainer"> <span id="statusMessageText"></span> </div>

  <!-- Audio Elements -->
  <audio id="backgroundAudio" loop> <source src="mines background .mp3" type="audio/mp3"> Your browser does not support the audio element. </audio>
  <audio id="jumpSound"> <source src="gruntjumpland-101soundboards.mp3" type="audio/mp3"> </audio>
  <audio id="coinSound"> <source src="coin-recieved-230517.mp3" type="audio/mp3"> </audio>
  <audio id="gameOverSound"> <source src="game-over-arcade-6435.mp3" type="audio/mp3"> </audio>

  <!-- Login Panel (Initially Visible) -->
  <div id="loginPanel" class="auth-panel" style="display: flex;">
    <h2>Gamer Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button id="loginButton" class="game-btn">Login</button>
    <button id="guestButton" class="game-btn">Continue Guest</button>
    <p class="switch-link">Don't have an account? <button id="switchToSignupBtn">Sign Up</button></p>
  </div>

  <!-- Signup Panel (Initially Hidden) -->
  <div id="signupPanel" class="auth-panel" style="display: none;">
      <h2>Create Account</h2>
      <input type="email" id="signupEmail" placeholder="Email" required />
      <input type="text" id="signupUsername" placeholder="Username" required />
      <input type="password" id="signupPassword" placeholder="Password (min. 6 chars)" required />
      <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" required />
      <input type="text" id="signupReferralCode" placeholder="Referral Code (Optional)" />
      <button id="performSignupBtn" class="game-btn">Sign Up</button>
      <p class="switch-link">Already have an account? <button id="switchToLoginBtn">Login</button></p>
  </div>

  <!-- Game Canvas (Initially Hidden) -->
  <canvas id="gameCanvas" style="display: none;"></canvas>

  <!-- Main Menu (Initially Hidden) -->
  <div id="mainMenu" style="display: none;">
     <button id="settingsBtn" title="Open Settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M487.4 315.7l-42.1-24.3c2.8-12.8 4.3-26 4.3-39.4s-1.5-26.6-4.3-39.4l42.1-24.3c9.4-5.4 13.3-17.1 9.4-27.2l-45.3-78.4c-3.9-10.1-14.2-14.8-24.7-11.5l-49.5 19.9c-20.5-16.1-43-29.2-67.2-38.1l-7.5-52.8C309 3.7 300.3-2.5 290.3.1l-90.6 18.5c-10 2.1-17.6 9.9-19.8 19.8l-7.5 52.8c-24.3 8.9-46.8 22-67.2 38.1L54.6 83.1c-10.5-3.3-20.8.4-24.7 11.5L-15.4 172.9c-3.9 10.1-.1 21.8 9.4 27.2l42.1 24.3C73.5 243.3 72 256.4 72 269.9c0 13.5 1.5 26.6 4.3 39.4l-42.1 24.3c-9.4 5.4-13.3 17.1-9.4 27.2l45.3 78.4c3.9 10.1 14.2 14.8 24.7 11.5l49.5-19.9c20.5 16.1 43 29.2 67.2 38.1l7.5 52.8c2 10 10.7 15.3 20.7 12.8l90.6-18.5c10-2.1 17.6 9.9 19.8-19.8l7.5-52.8c24.3-8.9 46.8-22 67.2-38.1l49.5 19.9c10.5 3.3 20.8-.4 24.7-11.5l45.3-78.4c3.9-10.1.1-21.8-9.4-27.2zM256 336c-44.2 0-80-35.8-80-80s35.8-80 80-80c44.2 0 80 35.8 80 80s-35.8 80-80 80z"></path></svg>
     </button>
     <div id="topRightStatus"> <img id="coinIcon" src="https://i.imgur.com/PCDgdlS.png" alt="Coin"> Coins: <span id="menuCoinCount">0</span> </div>
     <!-- <h1> Element REMOVED -->
     <button id="startBtn" class="menu-btn game-btn">Play Now</button>
     <button id="withdrawBtn" class="menu-btn game-btn">Withdraw Coins</button>
     <button id="inviteFriend" class="menu-btn game-btn">Invite (0)</button>
     <button id="infoBtn" class="menu-btn game-btn">Game Info</button>
     <!-- START: Updated Download Link/Button -->
     <a href="Super Mario Earn Real Money .apk" download="MarioRunEarnMoney.apk" id="downloadApkLink" class="menu-btn game-btn">
        <!-- Content removed: Image and text will come from CSS background -->
     </a>
     <!-- END: Updated Download Link/Button -->
     <button id="logoutBtn" class="menu-btn game-btn">Exit</button>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeSettings">Ã—</button>
      <h2>Settings</h2>
      <button id="profileBtn" class="game-btn">View Profile</button>
      <button id="toggleSound" class="game-btn">Sound: On</button>
      <button id="withdrawalHistoryBtn" class="game-btn">Withdrawal History</button>
      <button id="customerService" class="game-btn">Customer Service</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
      <div class="modal-content">
          <button class="close-btn" id="closeProfileModal">Ã—</button>
          <h2>Gamer Profile</h2>
          <div id="profileInfo">
              <p><strong>Username:</strong> <span id="profileUsername">...</span></p>
              <p><strong>Email:</strong> <span id="profileEmail">...</span></p>
              <p><strong>Total Coins:</strong> <span id="profileTotalCoins">...</span></p>
              <p><strong>Referrals:</strong> <span id="profileReferralCount">...</span></p>
              <p><strong>Your Code:</strong> <span id="profileInviteCode">...</span></p>
              <p><strong>Joined:</strong> <span id="profileJoinedDate">...</span></p>
          </div>
      </div>
  </div>

  <!-- Invite Modal -->
  <div id="inviteModal" class="modal">
      <div class="modal-content">
          <button class="close-btn" id="closeInviteModal">Ã—</button>
          <h2>Invite Friend</h2>
          <div class="section">
              <h3>Your Invite Link</h3>
              <!-- Changed p to div for better control, updated ID -->
              <div id="yourInviteLinkDisplay">Generating link...</div>
              <button id="copyInviteCode" class="game-btn">Copy Link</button>
          </div>
          <div class="section">
              <h3>Redeem Invite Code</h3>
              <input type="text" id="redeemCodeInput" placeholder="Enter friend's code" />
              <button id="redeemCodeBtn" class="game-btn">Redeem</button>
          </div>
      </div>
  </div>

  <!-- Game Over Overlay -->
  <div id="gameOverMenu" style="display: none;">
      <h2>Game Over</h2>
      <p>Session Coins: <span id="sessionCoinCount">0</span></p>
      <p>Total Coins: <span id="finalTotalCoins">0</span></p>
      <button id="restartBtn" class="menu-btn game-btn">Restart</button>
      <button id="backMenuBtn" class="menu-btn game-btn">Back to Menu</button>
  </div>

  <!-- Withdraw Modal -->
  <div id="withdrawModal" class="modal">
     <div class="modal-content">
         <button class="close-btn" id="closeWithdraw">Ã—</button>
         <h2>Redeem Coins</h2>
         <p>Select an option:</p>
         <div id="redeemOptions">
             <button class="redeem-option" data-coins="10000" data-pkr="100">10k Coins - 100 PKR</button>
             <button class="redeem-option" data-coins="30000" data-pkr="300">30k Coins - 300 PKR</button>
             <button class="redeem-option" data-coins="50000" data-pkr="500">50k Coins - 500 PKR</button>
             <button class="redeem-option" data-coins="80000" data-pkr="800">80k Coins - 800 PKR</button>
             <button class="redeem-option" data-coins="100000" data-pkr="1000">100k Coins - 1000 PKR</button>
             <button class="redeem-option" data-coins="500000" data-pkr="5000">500k Coins - 5000 PKR</button>
         </div>
         <div id="redeemForm" style="display: none;">
             <h3>Enter Details</h3>
             <form id="redeemDetailsForm">
                 <div><label for="accountHolderName">Account Name:</label><input type="text" id="accountHolderName" required /></div>
                 <div><label for="accountNumber">Account Number:</label><input type="text" id="accountNumber" required /></div>
                 <div class="payment-options" style="margin-top: 15px;">
                     <label>Method:</label>
                     <label><input type="radio" name="paymentMethod" value="JazzCash" required> JazzCash</label>
                     <label><input type="radio" name="paymentMethod" value="EasyPaisa" required> EasyPaisa</label>
                 </div>
                 <button type="submit" id="redeemSubmitBtn" class="game-btn">Submit Request</button>
             </form>
         </div>
     </div>
  </div>

  <!-- Game Info Modal -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeInfo">Ã—</button>
      <h2>Game Info</h2>
      <p>Welcome to <strong>Mario Run Earn Real Money</strong>! Run, jump, collect coins, and avoid obstacles.</p>
      <p><strong>Online Play:</strong> Login or Signup to save your coins and compete. Your progress is stored securely.</p>
      <p><strong>Offline Play (Guest):</strong> Play for fun without saving coins. Great for practice!</p>
      <p><strong>Bonuses:</strong>
          <br>- Get <strong>100 Coins</strong> just for signing up!
          <br>- Invite friends using your unique link (find it in the Invite menu).
          <br>- When your friend signs up using your code, they get an <strong>extra 100 Coins</strong> (total 200 start!), and YOU get <strong>200 Coins!</strong>
          <br>- Existing users can also redeem a code once for a <strong>100 Coin</strong> bonus.
      </p>
      <p><strong>Withdrawals:</strong> Redeem your earned coins for real rewards via JazzCash or EasyPaisa once you reach the minimum threshold.</p>
      <p><strong>Profile:</strong> Check your stats, email, and invite code in Settings > View Profile.</p>
      <p><strong>Download App:</strong> Get the dedicated Android app for a better experience using the download button in the main menu!</p>
    </div>
  </div>

  <!-- Withdrawal History Modal -->
  <div id="withdrawalHistoryModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeHistoryModal">Ã—</button>
      <h2>Withdrawal History</h2>
      <div id="historyList"> <p class="no-history">Loading...</p> </div>
    </div>
  </div>

  <!-- AD INTEGRATION -->
  <div id="bannerAdContainer">
    <script type="text/javascript"> atOptions = {'key' : '84c9a4eabdeffe242051226bdf854fd8', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {}}; </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/84c9a4eabdeffe242051226bdf854fd8/invoke.js"></script>
  </div>
  <div id="interstitialAdOverlay" style="display: none;">
      <p id="adInfoText">Loading ad...</p>
      <div id="interstitialAdTimer"></div>
      <button id="interstitialAdCloseButton" class="game-btn" style="display: none;">Skip Ad</button>
      <p class="skip-info">(Click 'Skip Ad' or close ad tab manually if needed)</p>
  </div>

  <!-- Firebase and Game Scripts -->
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    // Import onValue for real-time updates
    import { getDatabase, ref, set, get, push, query, orderByChild, equalTo, onValue, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js"; // Added serverTimestamp, update
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

    // --- DOM Element References (Ensure ALL are listed) ---
    const loginPanel = document.getElementById('loginPanel');
    const signupPanel = document.getElementById('signupPanel');
    const mainMenu = document.getElementById('mainMenu');
    const gameOverMenu = document.getElementById('gameOverMenu');
    const gameCanvas = document.getElementById('gameCanvas');
    const settingsModal = document.getElementById('settingsModal');
    const profileModal = document.getElementById('profileModal');
    const inviteModal = document.getElementById('inviteModal');
    const withdrawModal = document.getElementById('withdrawModal');
    const infoModal = document.getElementById('infoModal');
    const withdrawalHistoryModal = document.getElementById('withdrawalHistoryModal');
    const historyListDiv = document.getElementById('historyList');
    const interstitialAdOverlay = document.getElementById('interstitialAdOverlay');
    const interstitialAdCloseButton = document.getElementById('interstitialAdCloseButton');
    const interstitialAdTimer = document.getElementById('interstitialAdTimer');
    const adInfoText = document.getElementById('adInfoText');
    const menuCoinCountSpan = document.getElementById('menuCoinCount');
    const finalTotalCoinsSpan = document.getElementById('finalTotalCoins');
    const sessionCoinCountSpan = document.getElementById('sessionCoinCount');
    const inviteFriendBtn = document.getElementById('inviteFriend');
    const yourInviteLinkDisplay = document.getElementById('yourInviteLinkDisplay'); // ** UPDATED ID **
    const redeemCodeInput = document.getElementById("redeemCodeInput");
    const toggleSoundBtn = document.getElementById("toggleSound");
    const redeemOptionsDiv = document.getElementById("redeemOptions");
    const redeemFormDiv = document.getElementById("redeemForm");
    const redeemDetailsForm = document.getElementById("redeemDetailsForm");
    const redeemSubmitBtn = document.getElementById('redeemSubmitBtn');
    const withdrawalHistoryBtn = document.getElementById('withdrawalHistoryBtn');
    const closeHistoryModalBtn = document.getElementById('closeHistoryModal');
    const profileBtn = document.getElementById('profileBtn');
    const closeProfileModalBtn = document.getElementById('closeProfileModal');
    const profileUsernameSpan = document.getElementById('profileUsername');
    const profileEmailSpan = document.getElementById('profileEmail');
    const profileTotalCoinsSpan = document.getElementById('profileTotalCoins');
    const profileReferralCountSpan = document.getElementById('profileReferralCount');
    const profileInviteCodeSpan = document.getElementById('profileInviteCode');
    const profileJoinedDateSpan = document.getElementById('profileJoinedDate');
    const statusMessageContainer = document.getElementById('statusMessageContainer');
    const statusMessageText = document.getElementById('statusMessageText');
    let statusMessageTimeoutId = null;
    const loginEmailInput = document.getElementById('loginEmail');
    const loginPasswordInput = document.getElementById('loginPassword');
    const loginButton = document.getElementById('loginButton');
    const guestButton = document.getElementById('guestButton');
    const switchToSignupBtn = document.getElementById('switchToSignupBtn');
    const signupEmailInput = document.getElementById('signupEmail');
    const signupUsernameInput = document.getElementById('signupUsername');
    const signupPasswordInput = document.getElementById('signupPassword');
    const signupConfirmPasswordInput = document.getElementById('signupConfirmPassword');
    const signupReferralCodeInput = document.getElementById('signupReferralCode');
    const performSignupBtn = document.getElementById('performSignupBtn');
    const switchToLoginBtn = document.getElementById('switchToLoginBtn');
    const backgroundAudio = document.getElementById("backgroundAudio");
    const jumpSound = document.getElementById("jumpSound");
    const coinSound = document.getElementById("coinSound");
    const gameOverSound = document.getElementById("gameOverSound");
    const settingsBtn = document.getElementById('settingsBtn');
    const closeSettings = document.getElementById('closeSettings');
    const infoBtn = document.getElementById('infoBtn'); // Added ref
    const closeInfo = document.getElementById('closeInfo'); // Added ref
    const copyInviteCode = document.getElementById('copyInviteCode'); // Added ref
    const redeemCodeBtn = document.getElementById('redeemCodeBtn'); // Added ref
    const closeInviteModal = document.getElementById('closeInviteModal'); // Added ref
    const withdrawBtn = document.getElementById('withdrawBtn'); // Added ref
    const closeWithdraw = document.getElementById('closeWithdraw'); // Added ref
    const logoutBtn = document.getElementById('logoutBtn'); // Added ref
    const startBtn = document.getElementById('startBtn'); // Added ref
    const restartBtn = document.getElementById('restartBtn'); // Added ref
    const backMenuBtn = document.getElementById('backMenuBtn'); // Added ref
    const customerService = document.getElementById('customerService'); // Added ref
    const accountHolderName = document.getElementById('accountHolderName'); // Added ref for withdraw form
    const accountNumber = document.getElementById('accountNumber'); // Added ref for withdraw form
    const topRightStatus = document.getElementById('topRightStatus'); // Added ref
    const downloadApkLink = document.getElementById('downloadApkLink'); // Ref for download link/button

    const firebaseConfig = {
      // KEEP YOUR FIREBASE CONFIGURATION HERE
      apiKey: "AIzaSyCxqQEPU7qpEGleQXok7OFAyAouOrccoUY", authDomain: "test1-f9ef8.firebaseapp.com",
      databaseURL: "https://test1-f9ef8-default-rtdb.firebaseio.com", projectId: "test1-f9ef8",
      storageBucket: "test1-f9ef8.appspot.com", messagingSenderId: "709839711061",
      appId: "1:709839711061:web:ae8cc321d2ddac66c91ddc", measurementId: "G-K4Q94MBQDT"
    };

    // --- Firebase Initialization ---
    let appFirebase, db, auth;
    try {
        appFirebase = initializeApp(firebaseConfig);
        db = getDatabase(appFirebase);
        auth = getAuth();
        console.log("Firebase initialized successfully.");
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        showStatusMessage("Connection error. Check console.", "error", 10000);
        // Disable auth buttons if Firebase fails critically
        loginButton.disabled = true;
        guestButton.disabled = true;
        performSignupBtn.disabled = true;
    }

    // --- Global State ---
    let totalCoins = 0, soundEnabled = true, currentUserInviteCode = null, currentUsername = null;
    let currentReferralCount = 0, currentJoinedDate = null, gameStarted = false, gameOver = false;
    let score = 0, mario, obstacles, coins, speed, bgX, platformX;
    let lastJumpInputTime = 0; const doubleJumpWindow = 350; let canDoubleJump = false;
    let animationFrameId = null, allImagesLoaded = false, restartAttempts = 0, isProcessingAuth = false;
    let coinListenerUnsubscribe = null; // To store the unsubscribe function for the coin listener

    // --- Constants for Bonuses ---
    const SIGNUP_BONUS = 100;
    const REFERRER_BONUS = 200; // Person whose code is used gets this
    const REDEEMER_BONUS = 100; // Person using the code gets this (on top of signup if applicable)

    // --- *** CORRECTED Invite Link Base URL *** ---
    const baseInviteUrl = "https://zalixgames.github.io/Super-mario-/"; // <-- FIXED URL

    // --- Status Message Function ---
    function showStatusMessage(message, type = 'info', duration = 3000) {
        if (statusMessageTimeoutId) { clearTimeout(statusMessageTimeoutId); statusMessageContainer.classList.remove('show'); }
        console.log(`Status [${type}]: ${message}`);
        statusMessageText.textContent = message;
        statusMessageContainer.className = 'statusMessageContainer'; // Reset classes
        statusMessageContainer.classList.add(type);
        statusMessageContainer.style.display = 'block';
        statusMessageContainer.style.top = '15px'; // Reset position before animating
        // Force reflow to ensure transition plays
        void statusMessageContainer.offsetWidth;
        statusMessageContainer.classList.add('show');
        statusMessageTimeoutId = setTimeout(() => {
            statusMessageContainer.classList.remove('show');
            statusMessageTimeoutId = null;
            // Hide after transition finishes
            setTimeout(() => {
                if (!statusMessageContainer.classList.contains('show')) {
                    statusMessageContainer.style.display = 'none';
                }
            }, 400); // Corresponds to transition duration
        }, duration);
    }

    // --- AD INTEGRATION ---
    const directLinkUrl = "https://www.profitableratecpm.com/ycus2u5z?key=6d1f652cb3c1d695c1a7cb556f20002a"; // Example Ad URL
    let adCloseTimerInterval; let adCloseTimeout; let currentAdCallback = null;
    function showInterstitialAd(callback) {
        console.log("Attempting to show Interstitial Ad...");
        if (typeof callback !== 'function') { console.error("Invalid ad callback provided."); return; }
        currentAdCallback = callback;
        adInfoText.textContent = "Ad loading..."; interstitialAdOverlay.style.display = 'flex';
        interstitialAdCloseButton.style.display = 'none'; interstitialAdTimer.textContent = "";
        let adWindow = null;
        try { adWindow = window.open(directLinkUrl, '_blank'); } catch (e) { console.error("Error opening ad window (popup blocker?):", e); }
        if (!adWindow) { console.warn("Pop-up blocked or failed to open ad window."); showStatusMessage("Ad might be blocked. Proceeding...", "info"); interstitialAdOverlay.style.display = 'none'; if (currentAdCallback) { try { currentAdCallback(); } catch (e) { console.error("Error executing callback after ad block:", e); } } currentAdCallback = null; return; }

        // Timer for skip button
        let secondsRemaining = 3; // Increased timer for ads
        interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`;
        if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
        adCloseTimerInterval = setInterval(() => { secondsRemaining--; if (secondsRemaining > 0) { interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`; } else { interstitialAdTimer.textContent = "Skip available"; clearInterval(adCloseTimerInterval); } }, 1000);
        adCloseTimeout = setTimeout(() => { interstitialAdCloseButton.style.display = 'block'; if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); interstitialAdTimer.textContent = "Skip available"; }, secondsRemaining * 1000 + 100);
    }
    interstitialAdCloseButton.addEventListener('click', () => {
        console.log("Ad Skip Button clicked."); interstitialAdOverlay.style.display = 'none';
        if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
        interstitialAdTimer.textContent = "";
        if (typeof currentAdCallback === 'function') { console.log("Executing ad callback after skip."); try { currentAdCallback(); } catch(e) { console.error("Error in ad callback:", e); showStatusMessage("Error proceeding after ad.", "error"); } currentAdCallback = null; }
        else { console.warn("No ad callback was found after skipping."); }
    });

    // --- Sound Functions ---
    function playSound(audioElement) { if (soundEnabled && audioElement) { try { audioElement.currentTime=0; audioElement.play().catch(e=>console.warn(`Sound play error (${audioElement.id}):`, e)); } catch(e) { console.warn("Sound play failed:", e); } } }
    function playBackgroundMusic() { if (soundEnabled && backgroundAudio && backgroundAudio.paused) { backgroundAudio.play().catch(e=>console.warn("Background music play failed:",e)); } }
    function stopBackgroundMusic() { if (backgroundAudio && !backgroundAudio.paused) { backgroundAudio.pause(); backgroundAudio.currentTime=0; } }

    // --- Auth Panel Switching ---
    switchToSignupBtn.addEventListener('click', () => {
      console.log("Switch to Signup clicked.");
      if(isProcessingAuth) return;
      loginPanel.style.display = 'none';
      signupPanel.style.display = 'flex';
      console.log("Signup panel displayed.");
    });
    switchToLoginBtn.addEventListener('click', () => {
      console.log("Switch to Login clicked.");
      if(isProcessingAuth) return;
      signupPanel.style.display = 'none';
      loginPanel.style.display = 'flex';
      console.log("Login panel displayed.");
    });

    // --- Authentication Logic ---
    function setAuthProcessing(isProcessing) {
        console.log(`Setting Auth Processing: ${isProcessing}`);
        isProcessingAuth = isProcessing;
        // Disable/Enable all relevant buttons during auth operations
        loginButton.disabled = isProcessing;
        performSignupBtn.disabled = isProcessing;
        guestButton.disabled = isProcessing;
        switchToSignupBtn.disabled = isProcessing;
        switchToLoginBtn.disabled = isProcessing;
    }

    function handleAuthSuccess(user) {
        console.log(`handleAuthSuccess called for user: ${user.uid}`);
        // NOTE: setAuthProcessing(true) should have been called by the function *calling* handleAuthSuccess (login/signup)
        // We now need to show the ad, and *after* the ad, load data, show menu, and then setAuthProcessing(false)
        showInterstitialAd(() => {
            console.log("handleAuthSuccess Ad Callback: Starting post-ad actions.");
            try {
                loadUserData(user.uid); // Load initial data for the logged-in user
                setupCoinListener(user.uid); // Setup real-time listener
                showMainMenu(); // Show the main game menu
                checkUrlForReferral(); // Check if referred (might prefill redeem input now)
                console.log("handleAuthSuccess Ad Callback: Post-ad actions completed.");
            } catch (error) {
                console.error("Error inside handleAuthSuccess ad callback:", error);
                showStatusMessage("Error loading game data.", "error", 5000);
                // Attempt graceful logout on critical error after successful login/signup
                signOut(auth).catch(e => console.error("Sign out error during error handling:", e)).finally(() => {
                    resetAppStateToLoggedOut(); // Reset state
                    // Force show login panel as a fallback
                    signupPanel.style.display = "none";
                    loginPanel.style.display = "flex";
                    mainMenu.style.display = "none";
                });
            } finally {
                // *** CRITICAL: Ensure buttons are re-enabled regardless of try/catch outcome in the callback ***
                setAuthProcessing(false);
                console.log("Auth Processing set to false in finally block of ad callback.");
            }
        });
    }


    loginButton.addEventListener("click", () => {
      console.log("Login button clicked.");
      if (isProcessingAuth) { console.log("Auth already processing, returning."); return; }
      const email = loginEmailInput.value.trim(); const password = loginPasswordInput.value;
      if (!email || !password) { showStatusMessage("Please enter email & password.", "error"); return; }

      setAuthProcessing(true); // Disable buttons
      showStatusMessage("Logging in...", "info", 2000);
      console.log(`Attempting login for: ${email}`);

      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
            console.log("Firebase login successful for:", userCredential.user.uid);
            // Don't setAuthProcessing(false) here yet, wait for ad callback
            handleAuthSuccess(userCredential.user); // Proceed to post-login flow (includes ad)
        })
        .catch(err => {
            console.error("Login Error:", err.code, err.message);
            let errorMsg = "Login Error. Please try again.";
            if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') { errorMsg = "Incorrect email or password."; }
            else if (err.code === 'auth/invalid-email') { errorMsg = "Invalid email format."; }
            else if (err.code === 'auth/network-request-failed') { errorMsg = "Network error. Check connection."; }
            else if (err.code === 'auth/too-many-requests') { errorMsg = "Too many attempts. Try later."; }
            showStatusMessage(errorMsg, "error", 4000);
            setAuthProcessing(false); // Re-enable buttons on failure
        });
    });

    performSignupBtn.addEventListener("click", () => {
        console.log("Signup button clicked.");
        if (isProcessingAuth) { console.log("Auth already processing, returning."); return; }

        const email = signupEmailInput.value.trim(); const username = signupUsernameInput.value.trim();
        const password = signupPasswordInput.value; const confirmPassword = signupConfirmPasswordInput.value;
        const referralCode = signupReferralCodeInput.value.trim().toUpperCase();

        // --- Validation ---
        if (!email || !username || !password || !confirmPassword) { showStatusMessage("Please fill all required fields.", "error"); return; }
        if (username.length < 3) { showStatusMessage("Username must be >= 3 chars.", "error"); return; }
        if (password.length < 6) { showStatusMessage("Password must be >= 6 chars.", "error"); return; }
        if (password !== confirmPassword) { showStatusMessage("Passwords do not match.", "error"); return; }
        if (!/\S+@\S+\.\S+/.test(email)) { showStatusMessage("Invalid email format.", "error"); return; }
        // Simple username validation (allow letters, numbers, underscore)
        if (!/^[a-zA-Z0-9_]+$/.test(username)) { showStatusMessage("Username can only contain letters, numbers, and underscore.", "error"); return; }
        // --- End Validation ---

        console.log("Signup validation passed.");
        setAuthProcessing(true); // Disable buttons
        showStatusMessage("Creating account...", "info", 3000);

        createUserWithEmailAndPassword(auth, email, password)
            .then(async (userCredential) => {
                const user = userCredential.user;
                const creationTime = serverTimestamp(); // Use server time for consistency
                console.log("1: Firebase user created:", user.uid);

                const generatedInviteCode = generateRandomCode();
                const initialUserData = {
                    email: user.email,
                    username: username,
                    uid: user.uid,
                    totalCoins: SIGNUP_BONUS, // *** APPLY SIGNUP BONUS HERE ***
                    referralCount: 0,
                    referralRedeemed: false, // Track if they redeemed someone else's code
                    codeRedeemedFrom: null, // Store whose code they redeemed (optional)
                    inviteCode: generatedInviteCode,
                    createdAt: creationTime // Store creation time
                };

                console.log(`2: Setting initial user data in DB (with ${SIGNUP_BONUS} signup bonus)...`);
                await set(ref(db, "users/" + user.uid), initialUserData);
                console.log("3: DB data set.");

                let referralMessage = ""; // Will be built based on outcome
                let finalCoins = SIGNUP_BONUS; // Start with the signup bonus

                // Attempt to apply referral bonus if code was provided
                if (referralCode) {
                    console.log(`4: Attempting to redeem referral code: ${referralCode}`);
                    try {
                        // Pass the newly created user ID and initial data (which includes the signup bonus)
                        const { newCoinsForRedeemer, referrerUid } = await redeemInviteCode(referralCode, user.uid, initialUserData);
                        console.log("5: Referral redemption during signup successful.");

                        // Update the user's data to mark referral as redeemed and who it was from
                        await update(ref(db, `users/${user.uid}`), {
                            referralRedeemed: true,
                            codeRedeemedFrom: referrerUid // Store the referrer's UID
                        });
                        console.log("User data updated with referral redemption status.");

                        finalCoins = newCoinsForRedeemer; // This now includes signup + referral bonus
                        referralMessage = ` +${REDEEMER_BONUS} referral bonus!`; // Message specific to referral part

                    } catch (redeemError) {
                        console.warn("5: Referral redemption error during signup:", redeemError.message);
                        // Keep the initial signup bonus if referral fails
                        referralMessage = ` (Referral code error: ${redeemError.message})`;
                        // finalCoins remains SIGNUP_BONUS
                    }
                }

                totalCoins = finalCoins; // Update local state immediately
                console.log("Local totalCoins updated after signup:", totalCoins);
                // Construct final success message
                showStatusMessage(`Account created! +${SIGNUP_BONUS} signup bonus${referralMessage}`, "success", 6000);


                // Don't setAuthProcessing(false) here yet, wait for ad callback
                handleAuthSuccess(user); // Proceed to post-signup flow (includes ad)

            })
            .catch(err => {
                console.error("Signup Error:", err.code, err.message);
                let errorMsg = "Signup Error: " + err.message;
                 if (err.code === 'auth/email-already-in-use') { errorMsg = "Email already registered. Try logging in."; }
                 else if (err.code === 'auth/weak-password') { errorMsg = "Password is too weak."; }
                 else if (err.code === 'auth/network-request-failed') { errorMsg = "Network error. Check connection."; }
                 else if (err.code === 'auth/operation-not-allowed') { errorMsg = "Email/password accounts not enabled."; } // Should not happen with standard setup
                showStatusMessage(errorMsg, "error", 5000);
                setAuthProcessing(false); // Re-enable buttons on failure
            });
    });

    guestButton.addEventListener("click", () => {
        console.log("Guest button clicked.");
        if (isProcessingAuth) { console.log("Auth processing, returning."); return; }
        console.log("Setting auth processing true for guest.");
        setAuthProcessing(true); // Disable buttons temporarily

        try {
            console.log("Hiding auth panels for guest.");
            loginPanel.style.display = "none";
            signupPanel.style.display = "none";
            console.log("Resetting application state for guest.");
            resetAppStateToLoggedOut(); // Clear any logged-in user data
            console.log("Calling showMainMenu for guest.");
            showMainMenu(); // Display the main menu for guest
            console.log("Showing guest status message.");
            showStatusMessage("Playing as Guest. Coins will not be saved.", "info", 4000);
        } catch (error) {
            console.error("Error entering guest mode:", error);
            showStatusMessage("Error starting guest mode.", "error");
            // Show login panel as fallback if guest mode fails
            loginPanel.style.display = "flex";
        } finally {
            console.log("Setting auth processing false for guest in finally block.");
            // Re-enable buttons after setup/potential error
            setAuthProcessing(false);
        }
    });


    // --- Auth State Change Listener ---
    onAuthStateChanged(auth, (user) => {
      console.log("Auth State Changed. User:", user ? user.uid : 'null');

      // Clean up previous real-time listener if it exists
      if (coinListenerUnsubscribe) {
            console.log("Removing previous coin listener due to auth state change.");
            coinListenerUnsubscribe();
            coinListenerUnsubscribe = null;
      }

      if(user){
          // User is signed in (or session restored).
          // Check if we are *not* in the middle of an explicit login/signup flow
          // (which would call handleAuthSuccess itself).
          if(loginPanel.style.display === 'none' && signupPanel.style.display === 'none' && mainMenu.style.display === 'none' && gameCanvas.style.display === 'none') {
             console.log("User session detected (e.g., page refresh). Loading data and showing main menu.");
             loadUserData(user.uid);
             setupCoinListener(user.uid);
             showMainMenu(); // Ensure main menu is shown
             checkUrlForReferral(); // Check URL on session restore too
          } else {
             console.log("Auth state changed to signed in, but UI indicates login/signup/game is active. handleAuthSuccess or game flow will manage UI.");
          }
          setAuthProcessing(false); // Ensure buttons are enabled once auth state is resolved
      } else {
          // User is signed out.
          console.log("User signed out. Resetting state and showing login panel.");
          resetAppStateToLoggedOut();
          // Explicitly set UI state for logged-out user
          signupPanel.style.display="none";
          loginPanel.style.display="flex"; // Show login panel
          mainMenu.style.display="none";
          gameCanvas.style.display='none';
          gameOverMenu.style.display='none';
          // Close all modals on logout
          settingsModal.style.display="none";
          profileModal.style.display="none";
          inviteModal.style.display="none";
          withdrawModal.style.display="none";
          infoModal.style.display="none";
          withdrawalHistoryModal.style.display = "none";
          stopBackgroundMusic();
          setAuthProcessing(false); // Ensure buttons enabled
      }
    });

    // --- Real-time Coin Listener Setup ---
    function setupCoinListener(userId) {
        if (!userId) {
            console.error("Cannot setup coin listener without userId.");
            return;
        }
        // Clean up previous listener if any (safety check)
        if (coinListenerUnsubscribe) {
            console.warn("Removing existing coin listener before setting up new one.");
            coinListenerUnsubscribe();
            coinListenerUnsubscribe = null;
        }

        const coinsRef = ref(db, `users/${userId}/totalCoins`);
        console.log(`Setting up real-time coin listener for user: ${userId}`);

        coinListenerUnsubscribe = onValue(coinsRef, (snapshot) => {
            const newCoins = snapshot.val() ?? 0; // Use 0 if value is null/undefined from DB
            console.log(`Firebase real-time coins update received: ${newCoins}`);
            totalCoins = newCoins; // Update global state

            // Update relevant UI elements immediately
            if (menuCoinCountSpan) menuCoinCountSpan.innerText = totalCoins;
            if (finalTotalCoinsSpan && gameOverMenu.style.display === 'flex') {
                finalTotalCoinsSpan.innerText = totalCoins; // Update total on game over screen if visible
            }
            if (profileTotalCoinsSpan && profileModal.style.display === 'block') {
                profileTotalCoinsSpan.textContent = totalCoins; // Update total in profile modal if visible
            }
            console.log(`UI updated with new total coins: ${totalCoins}`);

        }, (error) => {
            console.error("Firebase coin listener error:", error);
            showStatusMessage("Coin sync error.", "error");
            // Consider potential recovery or notification strategies here
            if (coinListenerUnsubscribe) {
                 coinListenerUnsubscribe(); // Attempt to detach listener on error
                 coinListenerUnsubscribe = null;
            }
        });
    }

    // --- Reset & Load Data ---
    function resetAppStateToLoggedOut() {
        console.log("Resetting application state to logged-out defaults...");
        if (coinListenerUnsubscribe) { // Make sure to unsubscribe listener on logout/reset
            console.log("Removing coin listener during state reset.");
            coinListenerUnsubscribe();
            coinListenerUnsubscribe = null;
        }
        // Reset game state variables
        totalCoins = 0;
        currentUserInviteCode = null;
        currentUsername = null;
        currentReferralCount = 0;
        currentJoinedDate = null;
        gameStarted = false;
        gameOver = false;
        score = 0; // Reset session score
        if(animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
        stopBackgroundMusic();

        // Reset UI elements to default/guest state
        if (menuCoinCountSpan) menuCoinCountSpan.innerText = "0";
        if (finalTotalCoinsSpan) finalTotalCoinsSpan.innerText = "0";
        if (sessionCoinCountSpan) sessionCoinCountSpan.innerText = "0";
        updateInviteButtonText(0); // Show 0 referrals
        if (yourInviteLinkDisplay) yourInviteLinkDisplay.textContent = "N/A (Log in)"; // ** Updated ID **
        if (profileUsernameSpan) profileUsernameSpan.textContent = "...";
        if (profileEmailSpan) profileEmailSpan.textContent = "...";
        if (profileTotalCoinsSpan) profileTotalCoinsSpan.textContent = "0";
        if (profileReferralCountSpan) profileReferralCountSpan.textContent = "0";
        if (profileInviteCodeSpan) profileInviteCodeSpan.textContent = "...";
        if (profileJoinedDateSpan) profileJoinedDateSpan.textContent = "...";

        // Reset game objects
        mario = null;
        obstacles = [];
        coins = [];
        restartAttempts = 0;
        isProcessingAuth = false; // Ensure auth processing is false

        console.log("Application state reset complete.");
    }

    function loadUserData(userId) {
       if (!userId) {
           console.error("loadUserData called without a userId.");
           showStatusMessage("Cannot load data: Not logged in.", "error");
           return; // Early exit if no user ID
       }
       console.log(`Loading initial user data for: ${userId}`);
       const userRef = ref(db, `users/${userId}`);
       get(userRef).then(snapshot => {
           if (snapshot.exists()) {
               const userData = snapshot.val();
               console.log("Initial user data fetched:", userData);

               // Update global state (coins will be primarily managed by the listener, but set initial value)
               totalCoins = userData.totalCoins || 0; // Should include signup/referral bonuses if applicable
               currentUsername = userData.username || userData.email || 'Gamer'; // Use username, fallback to email, then generic
               currentReferralCount = userData.referralCount || 0;
               currentUserInviteCode = userData.inviteCode; // Might be missing if generated later

               // Format join date
               if (userData.createdAt && typeof userData.createdAt === 'number') {
                   try { currentJoinedDate = new Date(userData.createdAt).toLocaleDateString(); }
                   catch (e) { console.warn("Error formatting date:", e); currentJoinedDate = "N/A"; }
               } else if (userData.createdAt && userData.createdAt.seconds) { // Handle Firebase Timestamp object
                   try { currentJoinedDate = new Date(userData.createdAt.seconds * 1000).toLocaleDateString(); }
                   catch (e) { console.warn("Error formatting Firebase Timestamp date:", e); currentJoinedDate = "N/A"; }
               } else {
                   currentJoinedDate = "N/A"; // Handle missing or unexpected timestamp format
               }


               // Update UI elements based on this initial load
               menuCoinCountSpan.innerText = totalCoins;
               updateInviteButtonText(currentReferralCount);
               updateInviteLinkDisplay(); // Update the displayed invite link ** NEW FUNCTION **

               // Check if invite code is missing and generate/save it if needed
               if (!currentUserInviteCode && auth.currentUser?.uid === userId) {
                   console.log("User invite code missing, generating and saving...");
                   const newCode = generateRandomCode();
                   set(ref(db, `users/${userId}/inviteCode`), newCode)
                    .then(() => {
                        console.log("New invite code saved:", newCode);
                        currentUserInviteCode = newCode;
                        updateInviteLinkDisplay(); // Update UI immediately ** NEW FUNCTION **
                        if (profileModal.style.display === 'block') {
                            profileInviteCodeSpan.textContent = newCode; // Update profile modal if open
                        }
                    })
                    .catch(e => {
                        console.error("Error saving generated invite code:", e);
                        if(yourInviteLinkDisplay) yourInviteLinkDisplay.textContent = "Error generating link"; // ** Updated ID **
                    });
               }
           } else {
               // This case is serious - user is authenticated but no data in DB.
               console.error(`CRITICAL: User node missing in DB for authenticated user: ${userId}`);
               showStatusMessage("Profile data missing! Logging out.", "error", 5000);
               signOut(auth).catch(e => console.error("Sign out error after detecting missing profile:", e));
               // onAuthStateChanged will handle the UI reset upon logout
           }
       }).catch(error => {
           console.error("Error fetching user data from DB:", error);
           showStatusMessage("Failed to load user data.", "error");
           // Consider if a logout is appropriate here too, depending on app requirements
       });
    }

    function checkUrlForReferral() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                const cleanCode = refCode.trim().toUpperCase();
                console.log("Referral code found in URL:", cleanCode);
                // If user is NOT logged in, pre-fill the signup referral field
                if (!auth.currentUser && signupReferralCodeInput) {
                    signupReferralCodeInput.value = cleanCode;
                    console.log("Referral code pre-filled in signup form.");
                    showStatusMessage(`Using referral code: ${cleanCode}`, "info", 4000);
                }
                // If user IS logged in, pre-fill the redeem code field in the invite modal
                else if (auth.currentUser && redeemCodeInput) {
                    redeemCodeInput.value = cleanCode;
                    console.log("Referral code pre-filled in redeem code input.");
                    // Optionally, open the invite modal automatically?
                    // inviteModal.style.display = "block";
                    showStatusMessage(`Ready to redeem code: ${cleanCode}?`, "info", 4000);
                }
                // Clean the URL to remove the ref parameter after processing
                // Use replaceState to avoid adding to history
                 const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                 window.history.replaceState({path:cleanUrl},'',cleanUrl);
                 console.log("Cleaned referral code from URL.");
            }
        } catch (e) {
            console.error("Error processing URL parameters:", e);
        }
    }

    // --- UI Update & View Navigation ---
    function updateInviteButtonText(count) { inviteFriendBtn.innerText = `Invite (${count || 0} Refs)`; }
    function updateSoundButton() { toggleSoundBtn.textContent=`Sound: ${soundEnabled?'On':'Off'}`; const onColor="linear-gradient(145deg, #2ed573, #1dd1a1)", offColor="linear-gradient(145deg, #8395a7, #576574)"; const onBorder='#10ac84', offBorder='#2f3640'; toggleSoundBtn.style.background=soundEnabled?onColor:offColor; toggleSoundBtn.style.borderBottomColor=soundEnabled?onBorder:offBorder; }

    // --- ** NEW: Function to update the displayed Invite Link ---
    function updateInviteLinkDisplay() {
        if (yourInviteLinkDisplay) {
            if (currentUserInviteCode && auth.currentUser) {
                yourInviteLinkDisplay.textContent = `${baseInviteUrl}?ref=${currentUserInviteCode}`;
            } else if (auth.currentUser) {
                yourInviteLinkDisplay.textContent = "Generating link...";
            } else {
                 yourInviteLinkDisplay.textContent = "Log in to get your invite link";
            }
        }
         if (profileInviteCodeSpan && profileModal.style.display === 'block') {
             profileInviteCodeSpan.textContent = currentUserInviteCode || '...';
         }
    }


    function showMainMenu() {
        console.log("Attempting to show Main Menu...");
        gameStarted = false; gameOver = false;
        if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; console.log("Game loop stopped."); }

        console.log("Hiding other primary views...");
        loginPanel.style.display = "none";
        signupPanel.style.display = "none";
        gameOverMenu.style.display = "none";
        gameCanvas.style.display = "none";

        console.log("Hiding all modals...");
        settingsModal.style.display = "none";
        profileModal.style.display = "none";
        inviteModal.style.display = "none";
        withdrawModal.style.display = "none";
        infoModal.style.display = "none";
        withdrawalHistoryModal.style.display = "none";

        console.log("Displaying Main Menu flex container...");
        mainMenu.style.display = "flex"; // Use flex as defined in CSS
        // mainMenu.querySelector('h1').textContent = "Mario Run: Earn Coins"; // Title removed

        // Update UI elements specific to main menu based on auth state
        const user = auth.currentUser;
        if (user) {
             console.log("User is logged in, showing relevant menu items.");
             logoutBtn.style.display = 'inline-flex'; // Show logout
             withdrawBtn.style.display = 'inline-flex'; // Show withdraw
             inviteFriendBtn.style.display = 'inline-flex'; // Show invite
             settingsBtn.style.display = 'flex'; // Show settings cog
             topRightStatus.style.display = 'inline-flex'; // Show coin status
             menuCoinCountSpan.innerText = totalCoins; // Update coin count display
             updateInviteButtonText(currentReferralCount); // Update referral count display
             updateInviteLinkDisplay(); // ** Update invite link display **
             downloadApkLink.style.display = 'inline-flex'; // Show download button for logged-in users
        } else {
             console.log("User is Guest, hiding user-specific menu items.");
             logoutBtn.style.display = 'none'; // Hide logout
             withdrawBtn.style.display = 'none'; // Hide withdraw
             inviteFriendBtn.style.display = 'none'; // Hide invite
             settingsBtn.style.display = 'none'; // Hide settings cog
             topRightStatus.style.display = 'none'; // Hide coin status
             menuCoinCountSpan.innerText = "0"; // Show 0 coins for guest
             updateInviteButtonText(0); // Show 0 referrals for guest
             updateInviteLinkDisplay(); // ** Update invite link display (will show 'log in') **
             downloadApkLink.style.display = 'inline-flex'; // Also show download button for guests
        }


        playBackgroundMusic(); // Start music if enabled
        console.log("showMainMenu function finished.");
    }


    function showGameOverMenu() {
        console.log("Showing Game Over Menu");
        gameStarted = false; // Explicitly mark game as not started
        gameOver = true; // Mark game as over

        // Update Game Over screen elements
        sessionCoinCountSpan.innerText = score; // Show score earned in this session
        // Show the total coins based on current state (listener might update this further)
        finalTotalCoinsSpan.innerText = auth.currentUser ? totalCoins : 0;

        // Hide game, show game over
        gameCanvas.style.display='none';
        gameOverMenu.style.display="flex"; // Show the menu
        mainMenu.style.display="none"; // Ensure main menu is hidden

        stopBackgroundMusic(); // Stop game music
        playSound(gameOverSound); // Play game over sound effect
    }

    // --- Settings & Profile Modals ---
    settingsBtn.addEventListener("click", () => { if (!auth.currentUser) { showStatusMessage("Log in to access settings.", "info"); return; } updateSoundButton(); settingsModal.style.display = "block"; });
    closeSettings.addEventListener("click", () => { settingsModal.style.display = "none"; });
    toggleSoundBtn.addEventListener("click", () => { soundEnabled = !soundEnabled; updateSoundButton(); if (!soundEnabled) stopBackgroundMusic(); else if (mainMenu.style.display==='flex'||(gameStarted&&!gameOver)) playBackgroundMusic(); showStatusMessage(`Sound ${soundEnabled ? 'On' : 'Off'}`, 'info', 1500); });
    customerService.addEventListener("click", () => { window.open("https://wa.me/923019022815", "_blank"); }); // Ensure number is correct
    profileBtn.addEventListener('click', showProfileModal);
    closeProfileModalBtn.addEventListener('click', () => { profileModal.style.display = 'none'; });

    function showProfileModal() {
        const user = auth.currentUser;
        if (!user) { showStatusMessage("Log in to view your profile.", "error"); return; }

        // Refresh data just before showing, in case listener hasn't caught up or for initial display
        // Use current state variables primarily, but could fetch again if needed (though less efficient)
        profileUsernameSpan.textContent = currentUsername || 'Loading...';
        profileEmailSpan.textContent = user.email || 'N/A';
        profileTotalCoinsSpan.textContent = totalCoins; // Uses state updated by listener
        profileReferralCountSpan.textContent = currentReferralCount;
        profileInviteCodeSpan.textContent = currentUserInviteCode || 'Loading...'; // Shows the code itself
        profileJoinedDateSpan.textContent = currentJoinedDate || 'Loading...';

        // Hide settings modal if open, show profile modal
        settingsModal.style.display = 'none';
        profileModal.style.display = 'block';

        // Optional: Trigger a fresh loadUserData if data seems stale, but usually listener is enough
        // loadUserData(user.uid);
    }

    // --- Withdrawal History ---
    withdrawalHistoryBtn.addEventListener('click', showWithdrawalHistory);
    closeHistoryModalBtn.addEventListener('click', () => { withdrawalHistoryModal.style.display = 'none'; });
    async function showWithdrawalHistory() {
        const user = auth.currentUser;
        if (!user) { showStatusMessage("Log in to view withdrawal history.", "error"); return; }

        historyListDiv.innerHTML = '<p class="no-history">Loading history...</p>'; // Show loading state
        settingsModal.style.display = 'none'; // Hide settings modal
        withdrawalHistoryModal.style.display = 'block'; // Show history modal

        try {
            // Query Firebase for requests matching the current user's UID
            const requestsRef = ref(db, 'withdrawRequests');
            const userRequestsQuery = query(requestsRef, orderByChild('uid'), equalTo(user.uid));
            const snapshot = await get(userRequestsQuery);

            historyListDiv.innerHTML = ''; // Clear loading message

            if (snapshot.exists()) {
                const historyData = [];
                snapshot.forEach(childSnapshot => {
                    historyData.push({ key: childSnapshot.key, ...childSnapshot.val() });
                });

                // Sort by timestamp descending (most recent first)
                historyData.sort((a, b) => {
                     // Handle serverTimestamp objects vs regular numbers
                     const timeA = typeof a.timestamp === 'object' ? (a.timestamp?.seconds || 0) : (a.timestamp || 0);
                     const timeB = typeof b.timestamp === 'object' ? (b.timestamp?.seconds || 0) : (b.timestamp || 0);
                     return timeB - timeA;
                 });


                if (historyData.length === 0) {
                     historyListDiv.innerHTML = '<p class="no-history">No withdrawal history found.</p>';
                     return;
                }

                // Populate the list
                historyData.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('history-item');

                    let date = null;
                    if(item.timestamp) {
                        if(typeof item.timestamp === 'object' && item.timestamp.seconds) {
                            date = new Date(item.timestamp.seconds * 1000); // Firebase Server Timestamp
                        } else if (typeof item.timestamp === 'number') {
                            date = new Date(item.timestamp); // Regular JS Timestamp
                        }
                    }
                    const formattedDate = date ? date.toLocaleString() : 'N/A';
                    const status = (item.status || 'pending').toLowerCase();
                    let statusClass = 'status-pending'; // Default
                    if (status === 'approved') statusClass = 'status-approved';
                    else if (status === 'rejected') statusClass = 'status-rejected';

                    itemDiv.innerHTML = `
                        <div class="details">
                            <span>Amount: ${item.pkrAmount || '?'} PKR (${item.withdrawalAmountCoins || '?'} Coins)</span>
                            <span>Method: ${item.paymentMethod || 'N/A'}</span>
                            <span>Account: ${item.accountNumber || 'N/A'} (${item.accountHolderName || 'N/A'})</span>
                        </div>
                        <div class="status ${statusClass}">${status.toUpperCase()}</div>
                        <div class="date">${formattedDate}</div>
                    `;
                    historyListDiv.appendChild(itemDiv);
                });

            } else {
                historyListDiv.innerHTML = '<p class="no-history">No withdrawal history found.</p>';
            }
        } catch (error) {
            console.error("Error fetching withdrawal history:", error);
            historyListDiv.innerHTML = '<p class="no-history" style="color: red;">Error loading history. Please try again.</p>';
            showStatusMessage("Could not load withdrawal history.", "error");
        }
    }

    // --- Invite Logic ---
    // baseInviteUrl is now defined globally near the top
    function generateRandomCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }

    async function redeemInviteCode(code, currentUserId, currentUserData) {
        // Can be called during signup (new user) or later by existing user
        console.log(`Attempting redeemInviteCode. Code: ${code}, User: ${currentUserId}`);
        if (!currentUserId) throw new Error("User ID missing for redemption.");
        if (!code) throw new Error("Please enter an invite code.");

        code = code.trim().toUpperCase();

        // Ensure user isn't redeeming their own code (check against generated code if available)
        if (currentUserData && currentUserData.inviteCode && code === currentUserData.inviteCode) {
            console.warn("User attempted to redeem their own code.");
            throw new Error("You cannot redeem your own invite code.");
        }
        // Check if the current user has already redeemed a code
        if (currentUserData && currentUserData.referralRedeemed === true) { // Explicit check for true
             console.warn(`User ${currentUserId} already redeemed a code.`);
             throw new Error("You have already redeemed an invite code.");
        }

        // Find the user (referrer) whose code matches the entered code
        const usersRef = ref(db, "users");
        const referrerQuery = query(usersRef, orderByChild("inviteCode"), equalTo(code));
        const snapshot = await get(referrerQuery);

        if (!snapshot.exists()) {
            console.warn(`Invite code ${code} not found in DB.`);
            throw new Error("Invalid or non-existent invite code.");
        }

        let referrerUid = null;
        let referrerData = null;
        snapshot.forEach(childSnapshot => {
            // Ensure we found a user *other* than the one redeeming the code
            if (childSnapshot.key !== currentUserId) {
                referrerUid = childSnapshot.key;
                referrerData = childSnapshot.val();
            } else {
                 console.warn("Query found the current user's own code - ignoring self-referral match.");
            }
        });

        if (!referrerUid || !referrerData) {
            // This could happen if the code matched the current user's *own* code,
            // or if DB is inconsistent (code exists but user doesn't?)
             console.warn(`Valid referrer not found for code ${code}, possible self-match or DB issue.`);
             // If the code existed but only matched the current user, treat it as invalid
            throw new Error("Invalid invite code.");
        }

        // --- If we found a valid referrer ---
        console.log(`Found referrer: ${referrerUid}`);
        const referrerCurrentRefCount = referrerData.referralCount || 0;
        const referrerCurrentCoins = referrerData.totalCoins || 0;
        // Get the redeemer's current coins from the passed data (which might already include signup bonus)
        const redeemUserCurrentCoins = currentUserData.totalCoins || 0;

        // Use the defined bonus constants
        const newTotalForRedeemer = redeemUserCurrentCoins + REDEEMER_BONUS;
        const newTotalForReferrer = referrerCurrentCoins + REFERRER_BONUS;
        const newRefCountForReferrer = referrerCurrentRefCount + 1;

        console.log(`Applying bonuses: Redeemer +${REDEEMER_BONUS} (New Total: ${newTotalForRedeemer}), Referrer +${REFERRER_BONUS} (New Total: ${newTotalForReferrer})`);

        // Perform DB updates using a multi-path update
        const updates = {};
        updates[`/users/${currentUserId}/totalCoins`] = newTotalForRedeemer;
        // Note: referralRedeemed status is updated separately by the calling function (signup or redeem button) AFTER this succeeds
        updates[`/users/${referrerUid}/totalCoins`] = newTotalForReferrer;
        updates[`/users/${referrerUid}/referralCount`] = newRefCountForReferrer;

        await update(ref(db), updates);
        console.log("DB updated for both users.");

        // Return relevant info
        return {
            newCoinsForRedeemer: newTotalForRedeemer, // New total for the user redeeming
            referrerUid: referrerUid // Return referrer UID for logging/tracking
        };
    }

    inviteFriendBtn.addEventListener("click", () => {
        if (!auth.currentUser) { showStatusMessage("Log in to invite friends.", "error"); return; }
        // Ensure user data (especially invite code) is loaded/fresh before showing
        // loadUserData(auth.currentUser.uid); // Usually not needed if listener is active, but can force refresh
        updateInviteLinkDisplay(); // ** Make sure link is updated before showing modal **
        inviteModal.style.display = "block";
    });
    closeInviteModal.addEventListener("click", () => { inviteModal.style.display = "none"; });

    copyInviteCode.addEventListener("click", () => {
        const inviteLink = yourInviteLinkDisplay.textContent; // Get the link from the display element
        if (inviteLink && inviteLink.startsWith('http') && currentUserInviteCode) { // Basic check if it looks like a valid link
             navigator.clipboard.writeText(inviteLink).then(() => {
                 showStatusMessage("Invite link copied!", "success");
             }).catch(err => {
                 showStatusMessage("Failed to copy link.", "error");
                 console.error('Clipboard copy error:', err);
                 // Fallback: Manually select the text for the user
                 try {
                    // For a div, we can't directly use .select(). We need Range/Selection API.
                    const range = document.createRange();
                    range.selectNodeContents(yourInviteLinkDisplay);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    showStatusMessage("Could not auto-copy. Link selected, please copy manually.", "info", 4000);
                 } catch (selectError) {
                     console.error("Manual selection fallback failed:", selectError);
                 }
             });
         } else {
             showStatusMessage("Invite link not ready or invalid.", "error");
             console.warn("Attempted to copy invalid invite link:", inviteLink);
         }
     });

    // This button is for logged-in users redeeming a code *after* signup
    redeemCodeBtn.addEventListener("click", async () => {
        const code = redeemCodeInput.value.trim().toUpperCase(); // Ensure trimmed and uppercase
        if (!code) { showStatusMessage("Please enter a code to redeem.", "error"); return; }
        const user = auth.currentUser;
        if (!user) { showStatusMessage("You must be logged in to redeem a code.", "error"); return; }

        redeemCodeBtn.disabled = true; // Prevent double clicks
        showStatusMessage("Redeeming code...", "info");

        try {
            // Need current user data for checks (e.g., already redeemed?)
            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);
            if (!snapshot.exists()) {
                console.error("Critical: Current user data not found in DB during redeem.");
                 throw new Error("Your user data could not be found.");
            }
            const userData = snapshot.val();

            // Use the same core redeem function, passing current user ID and data
            // Note: userData.totalCoins here is the user's coin total *before* this redemption
            const { newCoinsForRedeemer, referrerUid } = await redeemInviteCode(code, user.uid, userData);

            // Update user data AFTER successful redemption (mark as redeemed)
            await update(ref(db, `users/${user.uid}`), {
                 referralRedeemed: true,
                 codeRedeemedFrom: referrerUid // Store who they redeemed from
            });
            console.log(`User ${user.uid} successfully redeemed code from ${referrerUid}`);

            // totalCoins state will be updated by the listener eventually.
            showStatusMessage(`Code redeemed successfully! +${REDEEMER_BONUS} coins added.`, "success", 5000);
            inviteModal.style.display = "none"; // Close modal on success
            redeemCodeInput.value = ""; // Clear input
            // No need to call loadUserData, listener handles the coin update.

        } catch (e) {
            console.error("Redeem code error (redeemCodeBtn):", e);
            showStatusMessage(`Error: ${e.message}`, "error", 4000);
        } finally {
             redeemCodeBtn.disabled = false; // Re-enable button
        }
    });


    // --- Withdraw Logic ---
    let selectedWithdrawCoins = 0; let selectedWithdrawPKR = 0;
    withdrawBtn.addEventListener("click", () => {
        if(!auth.currentUser){showStatusMessage("Log in to withdraw.", "error");return;}
        // Ensure latest coin total is displayed before showing options
        // loadUserData(auth.currentUser.uid); // Listener should keep totalCoins updated
        redeemOptionsDiv.style.display="block"; // Show options first
        redeemFormDiv.style.display="none"; // Hide details form
        redeemDetailsForm.reset(); // Clear previous input
        redeemSubmitBtn.disabled=false; // Ensure submit is enabled
        redeemSubmitBtn.textContent="Submit Request";
        withdrawModal.style.display="block";
    });
    closeWithdraw.addEventListener("click", () => { withdrawModal.style.display = "none"; });
    redeemOptionsDiv.querySelectorAll('.redeem-option').forEach(button => {
        button.addEventListener('click', () => {
            selectedWithdrawCoins=parseInt(button.dataset.coins,10);
            selectedWithdrawPKR=parseInt(button.dataset.pkr,10);

            if(isNaN(selectedWithdrawCoins) || isNaN(selectedWithdrawPKR) || selectedWithdrawCoins <= 0) { // Added positive check
                 console.error("Invalid data attributes on redeem button:", button.dataset);
                 showStatusMessage("Error selecting option.", "error");
                 return;
            }

            // Check if user has enough coins *before* showing the form
            if(totalCoins < selectedWithdrawCoins){
                 showStatusMessage(`Not enough coins. You need ${selectedWithdrawCoins} but have ${totalCoins}.`, "error", 4000);
                 return; // Don't proceed
            }
            // If sufficient coins, hide options and show form
            redeemOptionsDiv.style.display='none';
            redeemFormDiv.style.display='block';
            // Optionally pre-fill form or add info about the selected option
            redeemFormDiv.querySelector('h3').textContent = `Redeem ${selectedWithdrawCoins} Coins for ${selectedWithdrawPKR} PKR`;
        });
    });

    redeemDetailsForm.addEventListener('submit', (e) => {
         e.preventDefault(); // Prevent default form submission
         const name = accountHolderName.value.trim();
         const number = accountNumber.value.trim();
         const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked');

         if(!name || !number || !paymentMethodInput){
             showStatusMessage("Please fill account details & select payment method.", "error");
             return;
         }
          // Basic validation for number (e.g., prevent letters, length check if desired)
         if(!/^\d+$/.test(number)) {
             showStatusMessage("Account number should contain only digits.", "error");
             return;
         }

         // Final check for sufficient coins right before submitting
         if(totalCoins < selectedWithdrawCoins){
             showStatusMessage(`Insufficient coins (${totalCoins}/${selectedWithdrawCoins}). Please try again later.`, "error", 5000);
             withdrawModal.style.display = "none"; // Close modal if coins became insufficient
             return;
         }

         const user=auth.currentUser;
         if(!user){ // Should not happen if withdrawBtn is hidden, but check anyway
             showStatusMessage("Authentication error. Please log in again.", "error");
             withdrawModal.style.display="none";
             return;
         }

         const method = paymentMethodInput.value;
         const timestamp = serverTimestamp(); // Use server time for request

         const requestData = {
             uid: user.uid,
             email: user.email || "N/A",
             username: currentUsername || user.email || "N/A", // Use loaded username if available
             withdrawalAmountCoins: selectedWithdrawCoins,
             pkrAmount: selectedWithdrawPKR,
             accountHolderName: name,
             accountNumber: number,
             paymentMethod: method,
             status: "pending", // Initial status
             timestamp: timestamp
         };

         redeemSubmitBtn.disabled = true;
         redeemSubmitBtn.textContent = "Submitting...";
         showStatusMessage("Processing withdrawal request...", "info");

         // 1. Push the withdrawal request to the database
         const newRequestRef = push(ref(db,"withdrawRequests"), requestData);

         newRequestRef.then(async (reqRef)=>{
             console.log("Withdrawal request submitted successfully:", reqRef.key);

             // 2. If request submission is successful, deduct coins from user's total
             const newTotalCoins = totalCoins - selectedWithdrawCoins;
             if (newTotalCoins < 0) {
                 // This is a safety check, should ideally not happen if initial check passed
                 console.error("Coin calculation error - resulted in negative balance. This should not happen!");
                 throw new Error("Coin balance calculation error."); // Throw error to trigger catch block
             }
             await set(ref(db,`users/${user.uid}/totalCoins`), newTotalCoins);
             console.log(`User coins updated in DB to: ${newTotalCoins}`);

             // The real-time listener will update the local `totalCoins` and UI automatically.
             showStatusMessage(`Withdrawal request for ${selectedWithdrawPKR} PKR submitted! Status: Pending.`, "success", 5000);
             withdrawModal.style.display = "none"; // Close modal on success

         }).catch(err=>{
             showStatusMessage("Submission error: "+err.message, "error", 5000);
             console.error("Withdrawal request or coin deduction error:", err);
             // Re-enable button ONLY if the process failed
             redeemSubmitBtn.disabled = false;
             redeemSubmitBtn.textContent = "Submit Request";
         });
    });


    // --- Info Modal ---
    infoBtn.addEventListener("click", () => { infoModal.style.display = "block"; });
    closeInfo.addEventListener("click", () => { infoModal.style.display = "none"; });

    // --- Logout ---
    logoutBtn.addEventListener("click", () => {
        console.log("Logout button clicked.");
        if (isProcessingAuth) return; // Prevent action during other auth ops
        setAuthProcessing(true); // Disable buttons during logout
        showStatusMessage("Logging out...", "info", 1500);
        signOut(auth).then(() => {
            showStatusMessage("Logged out successfully.", "info");
            // onAuthStateChanged listener will handle the UI reset and state cleanup
            console.log("Firebase signOut successful.");
        }).catch((e) => {
            showStatusMessage("Logout error: "+e.message, "error");
            console.error("Sign out error:", e);
            setAuthProcessing(false); // Re-enable buttons if logout fails
        });
    });

    // --- Game Engine ---
    const ctx = gameCanvas.getContext("2d");
    function resizeCanvas() {
        console.log("Resizing canvas...");
        gameCanvas.width = window.innerWidth;
        const bannerHeight = document.getElementById('bannerAdContainer')?.offsetHeight || 50; // Get actual height or default
        gameCanvas.height = window.innerHeight - bannerHeight;
        console.log(`Canvas size set to: ${gameCanvas.width} x ${gameCanvas.height}`);

        // Adjust Mario's position if game is running to prevent falling through floor on resize
        if(gameStarted && mario) {
             const groundY = gameCanvas.height - 50; // Recalculate ground
             // If Mario is on or below the new ground level after resize
             if (mario.y + mario.height >= groundY - 5) {
                 mario.y = groundY - mario.height; // Place him firmly on ground
                 mario.dy = 0; // Stop vertical movement
                 if(mario.isJumping) { // If he was jumping, reset jump state
                     mario.isJumping = false;
                     canDoubleJump = false;
                 }
                 console.log("Adjusted Mario position after resize.");
             }
        }
    }
    window.addEventListener("resize", resizeCanvas);

    // --- Image Loading ---
    const imagesToLoad = {
         character:"https://i.imgur.com/AbfH2aB.png", // Mario/Player sprite
         background:"https://i.imgur.com/xZpZqGt.png", // Background image
         enemy:"https://i.imgur.com/TsR4WXH.png",    // Obstacle sprite (e.g., Goomba)
         coin:"https://i.imgur.com/cMQ9X0d.png",      // Coin sprite
         platform:"https://i.imgur.com/06ptzal.png" // Ground platform sprite
         // NOTE: Download button image is loaded via CSS background, not here
    };
    const gameImages = {};
    let imagesLoadedCount = 0;
    let totalImagesToLoad = Object.keys(imagesToLoad).length;

    function checkAllImagesLoaded() {
        imagesLoadedCount++;
        console.log(`Image loaded (${imagesLoadedCount}/${totalImagesToLoad})`);
        if (imagesLoadedCount === totalImagesToLoad) {
             allImagesLoaded = true;
             console.log("All game images loaded successfully.");
             // Potentially enable the start button now if it was disabled
             if(startBtn) startBtn.disabled = false;
             if(restartBtn) restartBtn.disabled = false;
             showStatusMessage("Game ready!", "success", 1500); // Inform user assets are loaded
        }
    }

    console.log("Starting image loading...");
    if (startBtn) startBtn.disabled = true; // Disable start until images load
    if (restartBtn) restartBtn.disabled = true; // Disable restart until images load
    showStatusMessage("Loading game assets...", "info", 5000); // Keep message visible longer

    for (const key in imagesToLoad) {
        gameImages[key] = new Image();
        gameImages[key].onload = checkAllImagesLoaded;
        gameImages[key].onerror = () => {
             console.error(`Failed to load image: ${key} at ${imagesToLoad[key]}`);
             // Handle image loading failure - maybe show error, disable game start
             totalImagesToLoad--; // Adjust total count if one fails critically
             showStatusMessage(`Error loading asset: ${key}. Game might not start.`, "error", 5000);
             if (startBtn) startBtn.disabled = true; // Keep start disabled on error
             if (restartBtn) restartBtn.disabled = true;
        };
        gameImages[key].src = imagesToLoad[key];
    }
    // --- End Image Loading ---

    function initGame() {
        if (!allImagesLoaded) {
            showStatusMessage("Game assets still loading. Please wait.", "info");
            console.warn("initGame called before all images were loaded.");
            // Ensure start/restart buttons remain disabled
             if (startBtn) startBtn.disabled = true;
             if (restartBtn) restartBtn.disabled = true;
            return;
        }
        console.log("Initializing game variables and state...");
        resizeCanvas(); // Ensure canvas is correct size before starting

        // Reset game state variables
        bgX = 0;
        platformX = 0;
        const groundY = gameCanvas.height - 50;
        mario = {
            x: 60,
            y: groundY - 60, // Start slightly above ground
            width: 40,       // Adjust size as needed
            height: 60,      // Adjust size as needed
            dy: 0,           // Vertical velocity
            gravity: 1.6,    // Pull downwards
            jumpPower: -22,  // Initial jump force (negative is up)
            doubleJumpPower: -18, // Force for second jump
            isJumping: false, // Track if currently in a jump arc
            onGround: true   // Track if standing on the platform
        };
        obstacles = []; // Clear obstacles array
        coins = [];     // Clear coins array
        speed = 6;      // Initial game speed
        score = 0;      // Reset session score for this run
        gameOver = false; // Game is not over
        gameStarted = true; // Game is now active
        lastJumpInputTime = 0; // Reset double jump timer
        canDoubleJump = false; // Reset double jump availability

        if(animationFrameId) {
            cancelAnimationFrame(animationFrameId); // Cancel any previous loop
            animationFrameId = null;
        }

        playBackgroundMusic(); // Start background music
        console.log("Game initialized. Starting game loop.");
        gameLoop(); // Start the main game loop
    }
    function drawBackground() {
        if (!gameImages.background?.complete || gameImages.background.naturalHeight === 0) {
            ctx.fillStyle = '#70c5ce'; // Fallback sky color
            ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
            return;
        };
        // Scroll background slower than foreground for parallax effect
        bgX = (bgX - speed * 0.4) % gameImages.background.width;
        ctx.drawImage(gameImages.background, bgX, 0, gameImages.background.width, gameCanvas.height);
        // Draw second image to fill gap during scroll
        ctx.drawImage(gameImages.background, bgX + gameImages.background.width, 0, gameImages.background.width, gameCanvas.height);
    }
    function drawPlatform() {
        if (!gameImages.platform?.complete || gameImages.platform.naturalHeight === 0) {
             ctx.fillStyle = '#E0A070'; // Fallback ground color
             ctx.fillRect(0, gameCanvas.height - 50, gameCanvas.width, 50);
            return;
        };
        const groundY = gameCanvas.height - 50;
        // Scroll platform at game speed
        platformX = (platformX - speed) % gameImages.platform.width;
        ctx.drawImage(gameImages.platform, platformX, groundY, gameImages.platform.width, 50);
        // Draw second image to fill gap
        ctx.drawImage(gameImages.platform, platformX + gameImages.platform.width, groundY, gameImages.platform.width, 50);
    }
    function drawMario() {
        if(!mario || !gameImages.character?.complete || gameImages.character.naturalHeight === 0) return; // Don't draw if missing
        // Simple draw - add animation logic here later if needed
        ctx.drawImage(gameImages.character, mario.x, mario.y, mario.width, mario.height);
    }
    function drawObstacles() {
        if (!gameImages.enemy?.complete || gameImages.enemy.naturalHeight === 0) return; // Don't draw if image missing
        for (let i = obstacles.length - 1; i >= 0; i--){
            let obs = obstacles[i];
            obs.x -= speed; // Move obstacle leftwards
            ctx.drawImage(gameImages.enemy, obs.x, obs.y, obs.width, obs.height);
            // Remove obstacle if it goes off-screen to the left
            if(obs.x + obs.width < 0) {
                obstacles.splice(i, 1);
            }
        }
    }
    function spawnObstacles() {
        if(gameOver || !gameImages.enemy?.complete || gameImages.enemy.naturalHeight === 0) return; // Don't spawn if game over or image missing

        // Increase spawn rate/difficulty based on score or time
        const baseMinDistance = 350; // Minimum distance between obstacles initially
        const baseMaxDistance = 650; // Maximum distance initially
        // Difficulty factor: reduces distance range as score increases (adjust divisor for difficulty curve)
        const difficultyFactor = Math.max(0.3, 1 - (score / 1000)); // Ensure it doesn't get impossibly small
        const currentMinDistance = baseMinDistance * difficultyFactor;
        const currentMaxDistance = baseMaxDistance * difficultyFactor;
        const distanceRange = Math.max(50, currentMaxDistance - currentMinDistance); // Ensure a minimum range

        const randomDistance = currentMinDistance + Math.random() * distanceRange;

        // Determine position of the last obstacle on screen
        let lastObstacleX = -randomDistance; // Default if no obstacles exist yet
        if (obstacles.length > 0) {
            lastObstacleX = obstacles[obstacles.length - 1].x;
        }

        // Check if enough space exists after the last obstacle to spawn a new one
        if (gameCanvas.width - lastObstacleX > randomDistance && obstacles.length < 5) { // Limit max obstacles on screen
            const groundY = gameCanvas.height - 50;
            obstacles.push({
                 x: gameCanvas.width + 10, // Start just off-screen right
                 y: groundY - 50,          // Position on the ground (adjust height if needed)
                 width: 50,                // Obstacle size
                 height: 50
            });
            // console.log(`Spawned obstacle at distance: ${randomDistance.toFixed(0)}`); // Less frequent logging
        }
    }

    function spawnCoins() {
        if(!gameImages.coin?.complete || gameImages.coin.naturalHeight === 0 || gameOver) return; // Don't spawn if image missing or game over

        const spawnChance = 0.025; // Probability per frame to start a coin group
        const maxCoinGroups = 3; // Limit simultaneous coin groups on screen (approx)

        if (coins.length < (maxCoinGroups * 5) && Math.random() < spawnChance) { // Check if likely to spawn
            const groundY = gameCanvas.height - 50;
            let startY;
            const heightChance = Math.random();
            if (heightChance < 0.5) {
                startY = groundY - 30; // Low coins
            } else if (heightChance < 0.85) {
                startY = groundY - 100 - (Math.random() * 40); // Mid-air coins (jump height)
            } else {
                startY = groundY - 160 - (Math.random() * 50); // High coins (double jump height)
            }

            let coinCount = Math.floor(Math.random() * 4) + 2; // 2 to 5 coins per group
            let startX = gameCanvas.width + Math.random() * 150; // Start spawning off-screen right
            const spacing = 45; // Horizontal spacing between coins

            for (let i = 0; i < coinCount; i++) {
                coins.push({
                    x: startX + i * spacing,
                    y: startY,
                    width: 25, // Coin size
                    height: 25
                });
            }
            // console.log(`Spawned ${coinCount} coins at y=${startY.toFixed(0)}`); // Less frequent logging
        }
    }

    function drawCoinsAndCollect() {
        if (!gameImages.coin?.complete || gameImages.coin.naturalHeight === 0 || !mario || gameOver) return;

        for (let i = coins.length - 1; i >= 0; i--) {
            let c = coins[i];
            c.x -= speed; // Move coin leftwards with the screen

            // Draw the coin (centered on its x, y)
            ctx.drawImage(gameImages.coin, c.x - c.width / 2, c.y - c.height / 2, c.width, c.height);

            // --- Collision Check (Mario vs Coin) ---
            // Basic AABB collision detection
            if (mario.x < c.x + c.width / 2 &&        // Mario's left edge < Coin's right edge
                mario.x + mario.width > c.x - c.width / 2 && // Mario's right edge > Coin's left edge
                mario.y < c.y + c.height / 2 &&       // Mario's top edge < Coin's bottom edge
                mario.y + mario.height > c.y - c.height / 2) // Mario's bottom edge > Coin's top edge
            {
                // Collision detected!
                coins.splice(i, 1); // Remove the coin from the array
                score += 1; // Increment the SESSION score
                playSound(coinSound); // Play collection sound
                // IMPORTANT: Do NOT update totalCoins here. It's handled on game over.
                // console.log(`Coin collected! Session score: ${score}`); // Less frequent logging
            }
            // Remove coins that go off-screen to the left
            else if (c.x + c.width / 2 < 0) {
                coins.splice(i, 1);
            }
        }
    }

    function applyPhysics() {
        if(!mario || gameOver) return; // Don't apply physics if no Mario or game over

        // Apply gravity
        mario.dy += mario.gravity;
        // Update vertical position
        mario.y += mario.dy;

        const groundY = gameCanvas.height - 50; // Define ground level

        // Check for ground collision
        if (mario.y + mario.height >= groundY) {
            mario.y = groundY - mario.height; // Place Mario exactly on the ground
            mario.dy = 0; // Stop vertical movement
            mario.onGround = true; // Mario is now on the ground
            if(mario.isJumping) {
                // Reset jump state only when landing
                mario.isJumping = false;
                canDoubleJump = false;
                // console.log("Landed on ground."); // Less frequent logging
            }
        } else {
            mario.onGround = false; // Mario is in the air
        }

        // Prevent Mario from going above the top edge (optional)
        if (mario.y < 0) {
            mario.y = 0;
            mario.dy = 0; // Stop upward movement if hitting ceiling
        }
    }
    function checkCollision() {
        if(!mario || gameOver) return; // No collision checks if game over

        for(let i = obstacles.length - 1; i >= 0; i--){
            let obs = obstacles[i];

            // --- AABB Collision Check (Mario vs Obstacle) ---
            // More forgiving collision box (adjust numbers as needed)
            const marioHitboxX = mario.x + 5;
            const marioHitboxY = mario.y + 5;
            const marioHitboxW = mario.width - 10;
            const marioHitboxH = mario.height - 10;

            const obsHitboxX = obs.x + 5;
            const obsHitboxY = obs.y + 5;
            const obsHitboxW = obs.width - 10;
            const obsHitboxH = obs.height - 10;


            if (marioHitboxX < obsHitboxX + obsHitboxW &&
                marioHitboxX + marioHitboxW > obsHitboxX &&
                marioHitboxY < obsHitboxY + obsHitboxH &&
                marioHitboxY + marioHitboxH > obsHitboxY)
            {
                // Collision detected!
                console.log("Collision detected with obstacle!");
                gameOver = true; // Set game over flag
                stopBackgroundMusic();
                // Note: handleGameOver() is called in the main loop *after* this check
                break; // Exit loop once collision is found
            }
        }
    }
    function jump() {
        if(!gameStarted || gameOver || !mario) return; // Can only jump if game is active and not over

        const now = Date.now();

        // --- Double Jump Logic ---
        // Check if currently jumping, double jump is available, and within the time window
        if (mario.isJumping && !mario.onGround && canDoubleJump && (now - lastJumpInputTime < doubleJumpWindow)) {
             mario.dy = mario.doubleJumpPower; // Apply double jump force
             canDoubleJump = false; // Can only double jump once per initial jump
             lastJumpInputTime = 0; // Reset timer to prevent triple jump attempts
             console.log("Double Jump!");
             playSound(jumpSound);
        }
        // --- First Jump Logic ---
        // Check if Mario is on the ground
        else if (mario.onGround) {
             mario.dy = mario.jumpPower; // Apply initial jump force
             mario.isJumping = true; // Mario is now in a jump arc
             mario.onGround = false; // Mario leaves the ground
             canDoubleJump = true; // Enable double jump possibility
             lastJumpInputTime = now; // Record time of initial jump for double jump window
             console.log("First Jump!");
             playSound(jumpSound);
        }
    }

    function gameLoop() {
        // Stop loop if game ended or not started
        if(gameOver || !gameStarted) {
             // console.log(`Game loop stopping. gameOver: ${gameOver}, gameStarted: ${gameStarted}`); // Less frequent logging
             if (gameOver) {
                 handleGameOver(); // Process game over state (save score etc.)
             }
             return; // Exit the loop
        }

        // --- Game Logic Updates ---
        applyPhysics(); // Update Mario's position based on gravity/jump
        checkCollision(); // Check if Mario hit an obstacle

        // Check game over status *again* after physics and collision
        if (gameOver) {
            handleGameOver(); // Process game over if collision occurred
            return; // Exit loop
        }

        spawnObstacles(); // Potentially add new obstacles
        spawnCoins(); // Potentially add new coins

        // --- Drawing ---
        // Clear canvas for new frame
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

        // Draw elements back to front
        drawBackground();
        drawPlatform();
        drawObstacles();
        drawCoinsAndCollect(); // Handles drawing AND collection logic
        drawMario();

        // --- Draw Score & Other UI ---
        ctx.fillStyle="#FFF";
        ctx.font="20px 'Press Start 2P'";
        ctx.textAlign="left";
        ctx.textBaseline="top";
        // Add shadow for better visibility
        ctx.shadowColor = 'rgba(0, 0, 0, 0.7)'; ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;

        ctx.fillText("Score: " + score, 20, 20); // Display current session score

        // Reset shadow for other potential drawing
        ctx.shadowColor = 'transparent'; ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;

        // Request the next frame
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    function handleGameOver() {
        console.log(`--- GAME OVER --- Session Score: ${score}`);
        gameStarted = false; // Mark game as inactive
        gameOver = true; // Ensure flag is set

        // Cancel next frame request if somehow still scheduled
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            console.log("Game animation frame cancelled.");
        }

        restartAttempts = 0; // Reset restart ad counter for the next game session
        console.log("Restart ad attempts reset.");

        const user = auth.currentUser;

        // --- Save Score for Logged-in Users ---
        if (user && score > 0) {
            // Calculate the new total based on the LATEST known totalCoins + session score
            // Fetch the *current* value from the database just before saving for maximum accuracy
            const userCoinsRef = ref(db, `users/${user.uid}/totalCoins`);
            get(userCoinsRef).then(snapshot => {
                 const currentCoinsInDB = snapshot.val() || 0;
                 const finalCoinsToSave = currentCoinsInDB + score;
                 console.log(`Attempting to save coins for user ${user.uid}. DB Coins: ${currentCoinsInDB}, Session Score: ${score}, New Total to Save: ${finalCoinsToSave}`);

                 return set(userCoinsRef, finalCoinsToSave); // Return the promise from set()
            })
            .then(() => {
                console.log("Score saved to DB successfully.");
                // Listener will update local state and UI
            })
            .catch(e => {
                console.error("Error fetching current coins or saving score to Firebase:", e);
                showStatusMessage("Error saving score. Check connection.", "error");
                // If saving fails, the listener won't update. The game over screen
                // might show an optimistic total, but the listener/next refresh will correct it.
            });
        } else if (user && score === 0) {
            console.log("Score is 0, no need to save to DB.");
        } else {
            console.log("Guest player game over. Score not saved.");
        }

        // --- Show Game Over Menu ---
        // The menu should show the session score and the *current* totalCoins state
        // (which listener will eventually update if save was successful)
        showGameOverMenu();
        console.log("Game Over Menu displayed.");
    }


    // --- Game Control Buttons ---
    startBtn.addEventListener("click", () => {
        if (!allImagesLoaded) {
             showStatusMessage("Game assets are still loading...", "info");
             console.warn("Start button clicked before images loaded.");
             return; // Prevent starting if assets not ready
        }
        if (gameStarted) {
             console.warn("Start button clicked but game already started.");
             return; // Prevent restarting via start button
        }
        console.log("Start button clicked.");
        // Show ad before starting the game
        showInterstitialAd(() => {
             console.log("Ad callback executed: Starting game.");
             mainMenu.style.display = "none"; // Hide main menu
             gameCanvas.style.display = 'block'; // Show game canvas
             initGame(); // Initialize and start the game loop
        });
    });

    restartBtn.addEventListener("click", () => {
        if (!allImagesLoaded) {
             showStatusMessage("Assets error. Cannot restart.", "error");
             showMainMenu(); // Go back to menu if assets failed
             return;
        }
        if (gameStarted) {
             console.warn("Restart clicked while game is running?"); // Should not happen if only on game over screen
             return;
        }
        console.log("Restart button clicked.");
        restartAttempts++;
        console.log(`Restart attempt number: ${restartAttempts}`);

        const performRestart = () => {
             console.log("Performing game restart...");
             gameOverMenu.style.display = "none"; // Hide game over menu
             gameCanvas.style.display = 'block'; // Show game canvas
             initGame(); // Re-initialize and start game
        };

        // Show ad every 3 restarts, ONLY for logged-in users
        if (restartAttempts >= 3 && auth.currentUser) {
             console.log("Showing ad before restart (attempt >= 3 and logged in).");
             showInterstitialAd(() => {
                 console.log("Ad callback executed: Restarting game.");
                 restartAttempts = 0; // Reset counter after showing ad
                 performRestart();
             });
        } else {
             // Restart immediately if guest or fewer than 3 attempts
             console.log("Restarting game without ad.");
             performRestart();
        }
    });

    backMenuBtn.addEventListener("click", () => {
        console.log("Back to Menu button clicked.");
        // Simply show the main menu. It will display the latest totalCoins.
        showMainMenu();
    });

    // --- Jump Listeners ---
    document.addEventListener("keydown", (e) => {
        // Trigger jump on Space or ArrowUp, only if game is running
        if ((e.code === "Space" || e.code === "ArrowUp") && gameStarted && !gameOver) {
             e.preventDefault(); // Prevent spacebar from scrolling page
             jump();
        }
    });
    // Use click/touch on canvas for mobile/touchscreen jump
    gameCanvas.addEventListener("click", (e) => {
        if (gameStarted && !gameOver) {
             e.preventDefault();
             jump();
        }
    });
    // Use touchstart for potentially faster response on touch devices
    gameCanvas.addEventListener("touchstart", (e) => {
        if (gameStarted && !gameOver) {
             e.preventDefault(); // Prevent default touch behavior (like scrolling)
             jump();
        }
    }, { passive: false }); // Need passive: false to allow preventDefault

    // --- Initial Setup on Page Load ---
    function initializeAppUI() {
        console.log("Initializing Application UI...");
        // Default state: Show Login Panel, hide others
        mainMenu.style.display = "none";
        gameCanvas.style.display = "none";
        gameOverMenu.style.display = "none";
        signupPanel.style.display = "none";
        loginPanel.style.display = "flex"; // Start with login visible

        setAuthProcessing(false); // Ensure buttons are enabled initially
        updateSoundButton(); // Set initial sound button text/style
        updateInviteLinkDisplay(); // Set initial invite link text (** NEW **)
        // checkUrlForReferral() // Will be called by onAuthStateChanged or handleAuthSuccess if needed

        // Disable game start/restart until assets load
        if (startBtn) startBtn.disabled = true;
        if (restartBtn) restartBtn.disabled = true;

        console.log("Initial UI setup complete. Waiting for Firebase Auth state or user interaction.");
        // onAuthStateChanged will handle showing the main menu if already logged in
        // and potentially call checkUrlForReferral after loading data.
    }

    // Run the initial UI setup once the DOM is ready (though script module might defer anyway)
    initializeAppUI();

  </script>
</body>
</html>