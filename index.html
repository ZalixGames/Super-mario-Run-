
 <!DOCTYPE html>
 <html lang="en">
 <head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />

   <title>Super Mario Run - Play Online & Earn Money</title>
   <meta name="description" content="Play Super Mario Run online, collect coins, spin to win PKR prizes! Classic Mario gameplay on browser. No download needed!" />
   <meta name="keywords" content="Super Mario Run, Mario game, Earn money playing, Play Super Mario online, Free Mario Run game, Super Mario browser game, Spin to win, PKR prizes, Real money game" />
   <meta name="author" content="Zalix Games" />
   <meta property="og:title" content="Play Super Mario Run â€“ Spin to Win PKR!" />
   <meta property="og:description" content="Enjoy classic Mario Run online, collect coins, and spin the wheel for real PKR prizes!" />
   <meta property="og:image" content="https://supermariorun.site/assets/preview.png" />
   <meta property="og:url" content="https://supermariorun.site" />
   <meta property="og:type" content="website" />
   <meta name="robots" content="index, follow" />


   <!-- PWA Meta Tags -->
   <meta name="theme-color" content="#3761bd" />
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
   <meta name="apple-mobile-web-app-title" content="Mario Run" />
   <link rel="manifest" href="./manifest.json" />
   <link rel="apple-touch-icon" href="./20250517_001646.png" />

   <!-- Existing Styles -->
   <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />

   <!-- SEO: Structured Data for Video Game -->
   <script type="application/ld+json">
   {
     "@context": "https://schema.org",
     "@type": "VideoGame",
     "name": "Super Mario Run - Play Online & Earn PKR",
     "url": "https://supermariorun.site",
     "description": "Play Super Mario Run online, collect coins, and spin the wheel for real PKR prizes. Classic Mario gameplay on browser. No download needed!",
     "applicationCategory": "Game",
     "operatingSystem": "Web browser",
     "browserRequirements": "Requires HTML5 Canvas and JavaScript",
     "offers": {
       "@type": "Offer",
       "price": "0",
       "priceCurrency": "USD"
     },
     "genre": ["Arcade game", "Platform game", "Endless runner", "Gambling game"],
     "playMode": "SinglePlayer",
     "publisher": {
       "@type": "Organization",
       "name": "Zalix Games"
     },
     "image": "https://supermariorun.site/assets/preview.png",
     "keywords": "Super Mario Run, Mario game, Earn money playing, Play Super Mario online, Free Mario Run game, Super Mario browser game, Spin to win, PKR prizes, Real money game"
   }
   </script>

   <!-- Service Worker Registration -->
   <script>
     if ('serviceWorker' in navigator) {
       window.addEventListener('load', () => {
         navigator.serviceWorker.register('./service-worker.js')
           .then(registration => {
             console.log('ServiceWorker registration successful with scope: ', registration.scope);
           })
           .catch(err => {
             console.log('ServiceWorker registration failed: ', err);
           });
       });
     }
   </script>
   <!-- Ad Script 1 (Placeholder) -->
   <style>
     /* --- CSS Styles --- */
     /* Basic Reset */
     * { margin: 0; padding: 0; box-sizing: border-box; }

     body {
       font-family: 'Press Start 2P', cursive; overflow: hidden;
       background: #050505 url('https://www.transparenttextures.com/patterns/stardust.png'); /* Darker background */
       color: #e0e0e0; /* Slightly off-white text */
       margin-bottom: 50px; /* Space for banner */
     }
     canvas { display: block; background-color: #60a5fa; /* Brighter sky blue */ }
     .text-glow { text-shadow: 0 0 4px #fff, 0 0 8px #fff, 0 0 12px #ff38a1, 0 0 16px #ff38a1; } /* Enhanced Pink Glow */
     .box-glow { box-shadow: 0 0 6px rgba(255, 255, 255, 0.7), 0 0 12px rgba(255, 56, 161, 0.6); } /* Enhanced Pink Glow */

     /* --- Enhanced General Button Styles --- */
     .game-btn {
       padding: 14px 28px; /* Slightly larger padding */
       margin: 10px;
       font-size: 14px; /* Keep font size readable */
       border: none;
       border-radius: 10px; /* Slightly more rounded */
       cursor: pointer;
       transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease; /* Faster transform */
       background: linear-gradient(145deg, #ff5252, #e53935); /* Base Red Gradient */
       color: #ffffff; /* Pure white text */
       font-family: 'Press Start 2P', cursive;
       text-transform: uppercase;
       text-shadow: 2px 2px 3px rgba(0,0,0,0.8); /* Sharper text shadow */
       border-bottom: 5px solid #b71c1c; /* Darker, thicker bottom border */
       box-shadow: 0 5px 8px rgba(0, 0, 0, 0.3); /* Enhanced shadow */
       display: inline-flex;
       align-items: center;
       justify-content: center;
       line-height: 1.3; /* Adjusted line-height */
       text-decoration: none;
       background-size: cover;
       background-position: center;
       background-repeat: no-repeat;
     }
     .game-btn:hover:not(:disabled) {
       transform: translateY(-3px) scale(1.04); /* More pronounced hover effect */
       box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 18px rgba(255, 82, 82, 0.7); /* Enhanced shadow + red glow */
       background: linear-gradient(145deg, #ff6161, #ef5350); /* Slightly brighter hover gradient */
     }
     .game-btn:active:not(:disabled) {
          transform: translateY(1px) scale(1.01); /* Subtle press effect */
          border-bottom-width: 3px; /* Reduce border on press */
          box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3); /* Reduced shadow on press */
     }
     .game-btn:disabled {
         background: linear-gradient(145deg, #666, #444); /* Dark grey gradient */
         cursor: not-allowed;
         border-bottom-color: #222; /* Very dark border */
         box-shadow: none; transform: none; opacity: 0.6; /* More faded */
         color: #aaa; /* Grey text */
         text-shadow: none;
     }

     /* --- Google Sign-in Panel Styles --- */
     #googleSignInPanel {
         position: absolute; top: 0; left: 0; width: 100%; height: 100%;
         background: url('https://i.imgur.com/nxRZ03R.png') no-repeat center center;
         background-size: cover; background-color: rgba(0, 0, 0, 0.75); /* Slightly darker overlay */
         background-blend-mode: darken; z-index: 100; display: none;
         flex-direction: column; justify-content: center; align-items: center;
         color: #fff; padding: 20px; text-align: center;
     }
      #googleSignInPanel h2 {
         font-size: 2.8em; /* Slightly larger */
         color: #ff38a1; /* Consistent pink */
         margin-bottom: 35px;
         text-shadow: 4px 4px 0px #000, 0 0 18px #ff38a1, 0 0 25px #ff38a1; /* Enhanced text shadow */
     }
     #googleSignInBtn {
         background: linear-gradient(145deg, #4f8ef7, #3678e6); /* Brighter Google blue */
         border-bottom-color: #1a5ac4;
         color: white; width: 300px; /* Slightly wider */
         padding: 16px 28px; /* More padding */
         font-size: 16px;
         display: inline-flex; align-items: center; justify-content: center;
     }
     #googleSignInBtn img { width: 26px; height: 26px; margin-right: 18px; background-color: white; padding: 3px; border-radius: 3px; }
     #googleSignInBtn:hover:not(:disabled) {
         background-image: linear-gradient(145deg, #5a95f8, #4185f4);
         box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(66, 133, 244, 0.7); /* Blue glow on hover */
     }
      #guestButtonAlt {
         background: linear-gradient(145deg, #95a5a6, #7f8c8d); /* Muted grey/blue */
         border-bottom-color: #525e5f;
         width: 300px; margin-top: 15px;
      }
      #guestButtonAlt:hover:not(:disabled) {
          background-image: linear-gradient(145deg, #aab5b6, #95a5a6);
          box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 15px rgba(149, 165, 166, 0.6); /* Grey glow */
      }

     /* --- Main Menu --- */
     #mainMenu {
       position: absolute; top: 0; left: 0; width: 100%; height: 100%;
       background: url('https://i.imgur.com/KFWJlte.png') no-repeat center center; background-size: cover;
       background-color: rgba(10, 10, 10, 0.6); background-blend-mode: darken; /* Add subtle overlay */
       z-index: 30; display: none; flex-direction: column; justify-content: center; align-items: center;
       color: #fff; padding: 20px; text-align: center; padding-top: 90px; /* Adjusted padding */
     }
     /* --- Adjusted Coin/PKR Counter Display --- */
     #topRightStatus {
       position: absolute; top: 15px; right: 15px;
       background: rgba(0,0,0,0.88); /* Darker, less transparent */
       padding: 8px 12px; /* Adjusted Padding */
       border-radius: 10px; /* Match button radius */
       font-size: 14px; /* Adjusted Font Size */
       color: #FFD700; /* Keep Gold for Coins */
       z-index: 35;
       border: 2px solid #b8860b; /* Darker gold border */
       box-shadow: 0 0 12px rgba(255, 215, 0, 0.6), inset 0 0 5px rgba(0,0,0,0.5); /* Gold glow + inner shadow */
       display: none; /* Handled by JS */
       align-items: center;
         flex-direction: column; /* Stack coin and pkr */
     }
      #topRightStatus > div {
          display: flex;
          align-items: center;
          margin: 2px 0; /* Space between lines */
          width: 100%;
          justify-content: flex-start; /* Align text/icons left within div */
      }
     #topRightStatus img {
       width: 20px; /* Adjusted Image Size: Smaller icon */
       height: 20px; /* Adjusted Image Size: Smaller icon */
       margin-right: 8px; /* Adjusted Margin */
       vertical-align: middle;
       filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.8));
     }
      #topRightStatus img#pkrIcon { filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.8)); } /* No specific filter for PKR yet */
     #topRightStatus span { vertical-align: middle; color: #eee; /* Default text color */ }
      #topRightStatus span#menuCoinCount { color: #FFD700; } /* Gold for coins */
      #topRightStatus span#menuPkrCount { color: #4CAF50; } /* Green for PKR */
     /* --- End Adjusted Coin/PKR Counter Display --- */

     #settingsBtn {
       position: absolute; top: 15px; left: 15px; background: rgba(30,30,30,0.85); /* Slightly less dark */
       border: 2px solid #bbb;
       border-radius: 50%; cursor: pointer; z-index: 35; width: 50px; height: 50px; /* Slightly larger */
       display: none;
       justify-content: center; align-items: center; transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
       box-shadow: 0 2px 5px rgba(0,0,0,0.5);
     }
     #settingsBtn svg { width: 26px; height: 26px; fill: #ddd; }
     #settingsBtn:hover {
         transform: rotate(60deg) scale(1.12); /* Faster rotation, larger scale */
         box-shadow: 0 0 18px rgba(255,255,255,0.8); /* Brighter glow */
         border-color: #fff;
     }
     #mainMenu .menu-btn { width: 250px; margin-bottom: 18px; } /* Wider buttons, more spacing */
     /* Specific Main Menu Button Colors */
     #mainMenu #startBtn { background: linear-gradient(145deg, #ff5252, #e53935); border-bottom-color: #b71c1c; } /* Base Red */
     #mainMenu #startBtn:hover:not(:disabled) { background: linear-gradient(145deg, #ff6161, #ef5350); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 18px rgba(255, 82, 82, 0.7); }

      /* New Spin Button */
     #mainMenu #spinBtn { background: linear-gradient(145deg, #ffc107, #ffa000); border-bottom-color: #ff6f00; display: none; } /* Amber */
     #mainMenu #spinBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #ffca28, #ffb300); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 193, 7, 0.7); } /* Yellow glow */

     #mainMenu #inviteFriend { background: linear-gradient(145deg, #2196f3, #1976d2); border-bottom-color: #0d47a1; display: none; } /* Action Blue */
     #mainMenu #inviteFriend:hover:not(:disabled) { background-image: linear-gradient(145deg, #42a5f5, #1e88e5); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(33, 150, 243, 0.7); } /* Blue glow */

     #mainMenu #infoBtn { background: linear-gradient(145deg, #9e9e9e, #757575); border-bottom-color: #424242; } /* Info Grey */
     #mainMenu #infoBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #bdbdbd, #9e9e9e); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 15px rgba(158, 158, 158, 0.6); } /* Grey glow */

     #mainMenu #logoutBtn { background: linear-gradient(145deg, #ab47bc, #8e24aa); border-bottom-color: #6a1b9a; display: none; } /* Purple */
     #mainMenu #logoutBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #ba68c8, #9c27b0); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(171, 71, 188, 0.7); } /* Purple glow */


     /* --- WhatsApp Button Styles --- */
     .whatsapp-btn {
        position: fixed;
        bottom: 65px; /* Adjust based on banner height + padding */
        right: 20px;
        z-index: 900; /* High z-index */
        width: 60px; /* Slightly larger */
        height: 60px;
        background-color: #25D366; /* WhatsApp Green */
        border-radius: 50%; /* Circular shape */
        display: flex; /* Center the image */
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), 0 0 15px rgba(37, 211, 102, 0.6); /* Shadow and green glow */
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        text-decoration: none; /* Remove underline */
        border: 3px solid #128C7E; /* Darker green border */
        padding: 5px; /* Padding inside for the image */
     }
     .whatsapp-btn img {
         width: 100%; /* Make image fill the button */
         height: 100%;
         object-fit: contain; /* Ensure image is scaled correctly */
          border-radius: 50%; /* Make image circular */
     }
     .whatsapp-btn:hover {
        transform: scale(1.15); /* Grow slightly on hover */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5), 0 0 20px rgba(37, 211, 102, 0.8); /* More pronounced shadow/glow */
     }
      .whatsapp-btn:active {
          transform: scale(1.05); /* Shrink slightly on click */
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }
      /* Hide initially */
      .whatsapp-btn {
          display: none;
      }

     /* --- Game Over Menu --- */
     #gameOverMenu {
       position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.88); /* Darker overlay */
       z-index: 40; display: none; flex-direction: column; justify-content: center; align-items: center;
       color: #f44336; /* Consistent Error Red */
       padding: 20px; text-align: center;
     }
     #gameOverMenu h2 {
         font-size: 4.5em; /* Larger text */
         text-shadow: 5px 5px 0px #000, 0 0 25px #ff0000, 0 0 35px #ff0000; /* More intense shadow/glow */
         margin-bottom: 25px;
     }
     #gameOverMenu p {
         font-size: 1.8em; /* Larger score text */
         color: #fff;
         margin-bottom: 15px;
         text-shadow: 2px 2px 4px #000; /* Sharper shadow */
     }
     #gameOverMenu .menu-btn { width: 220px; } /* Standard button size */
     #gameOverMenu #restartBtn {
         background: linear-gradient(145deg, #4caf50, #388e3c); /* Positive Green */
         border-bottom-color: #1b5e20;
     }
     #gameOverMenu #restartBtn:hover:not(:disabled) {
         background-image: linear-gradient(145deg, #66bb6a, #43a047);
         box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); /* Green glow */
     }
     #gameOverMenu #backMenuBtn {
         background: linear-gradient(145deg, #2196f3, #1976d2); /* Action Blue */
         border-bottom-color: #0d47a1;
     }
     #gameOverMenu #backMenuBtn:hover:not(:disabled) {
         background-image: linear-gradient(145deg, #42a5f5, #1e88e5);
         box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(33, 150, 243, 0.7); /* Blue glow */
     }

     /* --- Modal Common Styles --- */
     .modal { display: none; position: fixed; z-index: 70; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(6px); } /* Slightly stronger blur */
     .modal .modal-content {
         position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
         background: #212121; /* Darker modal background */
         padding: 25px 30px; /* More padding */
         border-radius: 12px; /* Rounded corners */
         width: 90%; color: #eee; text-align: center; font-family: 'Press Start 2P', cursive;
         border: 4px solid #ff38a1; /* Thicker Pink border */
         box-shadow: 0 0 25px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 56, 161, 0.5), inset 0 0 10px rgba(0,0,0,0.4); /* Outer shadow + Pink glow + Inner shadow */
         max-height: 85vh; overflow-y: auto;
     }
     .modal h2 {
         margin-bottom: 25px; /* More space */
         font-size: 1.5em; /* Larger title */
         color: #ff38a1; /* Consistent Pink */
         text-shadow: 2px 2px 2px #000, 0 0 8px #ff38a1; /* Sharper shadow + glow */
     }
     .modal button.game-btn { width: 100%; margin: 10px 0; padding: 12px 20px; font-size: 13px; } /* Adjusted modal button size */
     .modal input[type="text"], .modal input[type="email"], .modal input[type="password"] {
         width: 100%; padding: 12px; margin-top: 8px; margin-bottom: 18px; /* Adjusted spacing */
         border: 2px solid #555; border-radius: 8px; /* Rounded input */
         background: #333; color: #fff; font-family: 'Arial', sans-serif; font-size: 16px; outline: none;
         transition: border-color 0.3s, box-shadow 0.3s;
     }
     .modal input:focus { border-color: #ff38a1; box-shadow: 0 0 10px rgba(255, 56, 161, 0.7); } /* Pink focus glow */
     .close-btn {
         position: absolute; top: 8px; right: 12px; /* Adjusted position */
         background: none; border: none; font-size: 32px; /* Larger close icon */
         cursor: pointer; color: #aaa; font-family: Arial, sans-serif;
         transition: color 0.2s, transform 0.2s; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
     }
     .close-btn:hover { color: #ff38a1; transform: scale(1.25) rotate(90deg); } /* Rotate on hover */

     /* --- Specific Modal Sizes --- */
     #settingsModal .modal-content { max-width: 340px; }
     #profileModal .modal-content { max-width: 400px; text-align: left; }
     #inviteModal .modal-content { max-width: 380px; }
      /* New Spin Modal Size */
     #spinModal .modal-content { max-width: 420px; }
      /* New Spin History Modal Size */
     #spinHistoryModal .modal-content { max-width: 480px; }
     #infoModal .modal-content { max-width: 400px; }
     #completeProfileModal .modal-content { max-width: 370px; }

     /* --- Settings Modal Button Styles (Using New Theme Colors) --- */
     #profileBtn { background: linear-gradient(145deg, #ab47bc, #8e24aa); border-bottom-color: #6a1b9a; } /* Purple */
     #toggleSound { background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; } /* Green */
     #customerService { background: linear-gradient(145deg, #2196f3, #1976d2); border-bottom-color: #0d47a1; } /* Blue */
      /* New Spin History Button */
     #spinHistoryBtn { background: linear-gradient(145deg, #ffc107, #ffa000); border-bottom-color: #ff6f00; } /* Amber */
     /* Hover states for settings buttons */
     #profileBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #ba68c8, #9c27b0); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(171, 71, 188, 0.7); }
     #toggleSound:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); }
     #customerService:hover:not(:disabled) { background-image: linear-gradient(145deg, #42a5f5, #1e88e5); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(33, 150, 243, 0.7); }
     #spinHistoryBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #ffca28, #ffb300); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 193, 7, 0.7); }

     /* --- Profile Modal Styles --- */
     #profileModal .modal-content h2 { color: #ab47bc; } /* Purple Title */
     #profileModal .modal-content p {
         margin: 16px 0; /* Increased spacing */
         font-family: 'Arial', sans-serif; /* More readable font */
         font-size: 16px; /* Slightly larger */
         line-height: 1.7; /* Better line spacing */
         color: #ddd; border-bottom: 1px solid #444; padding-bottom: 10px; /* Separator line */
     }
     #profileModal .modal-content p:last-child { border-bottom: none; } /* Remove last border */
     #profileModal .modal-content p strong { color: #fff; display: inline-block; min-width: 130px; /* Wider label */ }
     #profileModal .modal-content span { color: #ffc107; word-break: break-all; font-weight: bold; } /* Amber data */
     #profileModal .modal-content span.pkr-amount { color: #4CAF50; } /* Green for PKR */
     #profileInfo { border-top: 1px solid #555; margin-top: 20px; padding-top: 20px; }

     /* --- Invite Modal Styles --- */
     #inviteModal .section { margin: 25px 0; border-top: 1px solid #555; padding-top: 20px; }
     #inviteModal .section h3 { font-size: 1.2em; margin-bottom: 12px; color: #eee; text-shadow: 1px 1px 1px #000; }
     #inviteModal .section p { font-size: 1em; margin-bottom: 14px; font-family: Arial, sans-serif; color: #ccc; }
     #inviteModal #yourInviteLinkDisplay {
         font-size: 1.1em; color: #FFD700; background: #383838; padding: 10px 14px; /* More padding */
         border-radius: 6px; display: block; border: 1px solid #666;
         word-break: break-all; text-align: center; margin-bottom: 12px; /* Centered link */
         font-family: monospace; /* Monospace for code feel */
     }
     #copyInviteCode { background: linear-gradient(145deg, #ffc107, #ffa000); border-bottom-color: #ff6f00; } /* Amber */
     #redeemCodeBtn { background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; } /* Green */
     #copyInviteCode:hover:not(:disabled) { background-image: linear-gradient(145deg, #ffca28, #ffb300); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 193, 7, 0.7); }
     #redeemCodeBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); }

     /* --- Spin Modal Styles --- */
     #spinModal .modal-content h2 { color: #ffc107; } /* Amber Title */
      #spinModal .spin-status {
          margin: 15px 0 25px 0;
          font-size: 1em;
          color: #fff;
          text-shadow: 1px 1px 1px #000;
          display: flex;
          justify-content: center;
          gap: 20px; /* Space between coin/pkr */
      }
      #spinModal .spin-status .currency-display {
          display: flex;
          align-items: center;
          background: rgba(0,0,0,0.5);
          padding: 6px 12px;
          border-radius: 8px;
          border: 1px solid #555;
      }
      #spinModal .spin-status img {
          width: 18px; height: 18px; margin-right: 5px; filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.5));
      }
      #spinModal .spin-status span { font-size: 0.9em; }
       #spinModal .spin-status span.coin-amount { color: #FFD700; }
       #spinModal .spin-status span.pkr-amount { color: #4CAF50; }

     /* --- Spin Wheel Container --- */
     #wheelContainer {
         position: relative;
         width: 300px; /* Size of the wheel */
         height: 300px;
         margin: 0 auto 30px auto; /* Center and add space below */
     }
     #wheel {
         width: 100%;
         height: 100%;
         border-radius: 50%;
         border: 8px solid #ff38a1; /* Pink border */
         position: relative;
         overflow: hidden;
         background-color: #333; /* Base dark color */
         transition: transform 5s cubic-bezier(0.1, 0.8, 0.2, 1); /* Smooth animation */
     }
     /* Wheel Pointer (Arrow) */
     #wheelPointer {
         position: absolute;
         top: -20px; /* Position above the wheel */
         left: 50%;
         transform: translateX(-50%);
         width: 0;
         height: 0;
         border-left: 15px solid transparent;
         border-right: 15px solid transparent;
         border-top: 30px solid #f44336; /* Red color */
         z-index: 10;
     }

     /* Individual Wheel Segments */
      .wheel-segment {
          position: absolute;
          top: 0;
          right: 0;
          width: 50%;
          height: 50%;
          transform-origin: 0% 100%; /* Pivot at the center-bottom */
          overflow: hidden; /* Hide overflow from pie shape */
          font-family: 'Press Start 2P', cursive;
          font-size: 0.6em; /* Smaller text */
          color: #fff;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
          display: flex; /* Use flexbox to center content */
          align-items: flex-start; /* Align text to the start of the segment */
          justify-content: center;
          padding-top: 20px; /* Push text down slightly */
          box-sizing: border-box;
          transform: rotate(var(--segment-deg)); /* Dynamic rotation */
          clip-path: polygon(0 0, 100% 0, 0 100%); /* Creates a triangle (pie slice) */
      }

      .wheel-segment::before {
          content: attr(data-label); /* Use data-label for text */
          position: absolute;
          bottom: 0;
          left: 0; /* Adjust position within the triangle */
          transform-origin: 0% 0%;
          /* Rotate the text to be readable */
          transform: rotate(var(--text-deg)) translate(var(--text-x), var(--text-y)); /* Dynamic rotation/translation */
          white-space: nowrap;
          text-align: center;
          width: 100%;
      }

      /* Specific Segment Colors (adjust as needed) */
     .segment-color-1 { background-color: #ff38a1; } /* Pink */
     .segment-color-2 { background-color: #42a5f5; } /* Blue */
     .segment-color-3 { background-color: #66bb6a; } /* Green */
     .segment-color-4 { background-color: #ffca28; } /* Yellow */
     .segment-color-5 { background-color: #ef5350; } /* Red */
     .segment-color-6 { background-color: #ab47bc; } /* Purple */
     .segment-color-7 { background-color: #8d6e63; } /* Brown */
     .segment-color-badluck { background-color: #757575; color: #222; } /* Dark Grey */


     #spinButton {
         background: linear-gradient(145deg, #4caf50, #388e3c); /* Green */
         border-bottom-color: #1b5e20;
         width: 250px; /* Match menu button width */
         margin-top: 25px;
     }
     #spinButton:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); }
     #spinButton:disabled { background: linear-gradient(145deg, #666, #444); border-bottom-color: #222; cursor: not-allowed; opacity: 0.6; }
     #spinResult { margin-top: 20px; font-size: 1.1em; color: #fff; min-height: 1.5em; text-shadow: 1px 1px 2px #000; }
      #spinResult.win { color: #4CAF50; text-shadow: 0 0 8px #4CAF50, 0 0 12px #4CAF50; } /* Green glow */
      #spinResult.badluck { color: #ffc107; text-shadow: 0 0 8px #ffc107, 0 0 12px #ffc107; } /* Amber glow */


     /* --- Spin History Modal Styles --- */
     #spinHistoryModal .modal-content h2 { color: #ffc107; } /* Amber Title */
     #historyList { margin-top: 25px; max-height: 55vh; overflow-y: auto; padding-right: 15px; text-align: left; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6; }
     .spin-item { background: #2a2a2a; border: 1px solid #4f4f4f; border-radius: 8px; padding: 14px 18px; margin-bottom: 12px; color: #ccc; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
     .spin-item span { display: block; margin-bottom: 5px; font-size: 13px; }
     .spin-item .details { flex-grow: 1; margin-right: 15px; }
     .spin-item .details span:first-child { font-weight: bold; color: #eee; font-size: 14px; } /* Highlight outcome */
     .spin-item .outcome { font-family: 'Press Start 2P', cursive; font-size: 11px; padding: 5px 10px; border-radius: 5px; text-transform: uppercase; min-width: 90px; text-align: center; margin-top: 5px; font-weight: bold; letter-spacing: 0.5px; }
     .spin-item .outcome-win { background-color: #4caf50; color: #1b5e20; border: 1px solid #10ac84;} /* Green */
     .spin-item .outcome-badluck { background-color: #ffa000; color: #4d3f21; border: 1px solid #e67e22;} /* Amber */
     .spin-item .date { font-size: 11px; color: #999; width: 100%; text-align: right; margin-top: 6px; }
     #historyList .no-history { color: #888; text-align: center; padding: 25px; font-size: 1.1em; font-style: italic;}


     /* --- Info Modal Styles --- */
     #infoModal .modal-content h2 { color: #2196f3; } /* Blue Title */
     #infoModal .modal-content p { margin: 18px 0; font-family: 'Arial', sans-serif; font-size: 15px; line-height: 1.7; color: #ddd; text-align: left; padding-bottom: 10px; border-bottom: 1px solid #444; }
     #infoModal .modal-content p:last-child { border-bottom: none; }
     #infoModal .modal-content p strong { color: #fff; }
     #infoModal .modal-content .highlight { color: #ffee58; font-weight: bold; /* Brighter Yellow Highlight */ }


      /* --- Complete Profile Modal Styles --- */
     #completeProfileModal .modal-content h2 { color: #4caf50; } /* Green Title */
     #completeProfileModal .modal-content p { margin-bottom: 18px; font-family: Arial, sans-serif; line-height: 1.6; font-size: 15px; text-align: left; color: #ddd; }
     #completeProfileModal .modal-content p.subtle { font-size: 12px; color: #aaa; font-style: italic; margin-top: -12px; }
     #completeProfileModal .modal-content label { font-family: 'Press Start 2P', cursive; font-size: 13px; }
     #completeProfileModal .modal-content input[type="text"] { margin-bottom: 25px; border-radius: 8px; padding: 12px; }
     #completeProfileModal #saveProfileBtn { background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; } /* Green */
     #completeProfileModal #saveProfileBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); }

     /* --- Ad Container Styles --- */
     #bannerAdContainer { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background-color: #080808; z-index: 1000; display: flex; justify-content: center; align-items: center; overflow: hidden; border-top: 3px solid #333; }
     #bannerAdContainer iframe { max-width: 100%; }
     #interstitialAdOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.92); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; font-family: 'Press Start 2P', cursive; padding: 20px; backdrop-filter: blur(4px); }
     #interstitialAdOverlay p#adInfoText { font-size: 1.2em; margin-bottom: 30px; color: #eee; line-height: 1.6; text-shadow: 1px 1px 2px #000; }
     #interstitialAdCloseButton { /* Use game-btn styles */
         padding: 14px 28px; font-size: 1em; cursor: pointer;
         background: linear-gradient(145deg, #f44336, #d32f2f); border-bottom-color: #b71c1c; /* Error Red */
         color: white; border-radius: 10px; font-family: 'Press Start 2P', cursive;
         display: none; text-transform: uppercase; margin-top: 25px;
         text-shadow: 2px 2px 3px rgba(0,0,0,0.8); border: none;
         box-shadow: 0 5px 8px rgba(0, 0, 0, 0.3);
     }
     #interstitialAdCloseButton:hover { /* Match game-btn hover */
         transform: translateY(-3px) scale(1.04);
         box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 18px rgba(244, 67, 54, 0.7); /* Red glow */
         background: linear-gradient(145deg, #ef5350, #e53935);
     }
     #interstitialAdTimer { margin-top: 18px; font-size: 0.9em; color: #bbb; }
     #interstitialAdOverlay p.skip-info { font-size: 0.8em; color: #aaa; margin-top: 35px; font-family: Arial, sans-serif; line-height: 1.5; }

     /* --- Status Message Container --- */
     #statusMessageContainer {
         display: none; position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
         background-color: rgba(10, 10, 10, 0.92); /* Darker background */
         color: white; padding: 14px 28px; /* More padding */
         border-radius: 10px; z-index: 5000; font-family: 'Press Start 2P', cursive; font-size: 1.0em; /* Larger font */
         text-align: center; border: 3px solid #fff; /* Thicker border */
         box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6);
         opacity: 0;
         transition: opacity 0.4s ease-in-out, top 0.4s ease-in-out, transform 0.4s ease-in-out; /* Added transform transition */
         max-width: 90%; pointer-events: none; letter-spacing: 0.5px;
     }
     #statusMessageContainer.show {
         display: block; opacity: 1; top: 30px; /* Start slightly higher */
         transform: translateX(-50%) scale(1); /* Scale in */
     }
     /* Status colors matching button themes */
     #statusMessageContainer.success { border-color: #4caf50; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px rgba(76, 175, 80, 0.6); } /* Green */
     #statusMessageContainer.error { border-color: #f44336; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px rgba(244, 67, 54, 0.6); } /* Red */
     #statusMessageContainer.info { border-color: #2196f3; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px rgba(33, 150, 243, 0.6); } /* Blue */

     /* --- End of CSS --- */
   </style>

 </head>
 <body>
   <!-- Status Message Container -->
   <div id="statusMessageContainer"> <span id="statusMessageText"></span> </div>

   <!-- Audio Elements -->
   <audio id="backgroundAudio" loop> <source src="mines background .mp3" type="audio/mp3"> Your browser does not support the audio element. </audio>
   <audio id="jumpSound"> <source src="gruntjumpland-101soundboards.mp3" type="audio/mp3"> </audio>
   <audio id="coinSound"> <source src="coin-recieved-230517.mp3" type="audio/mp3"> </audio>
   <audio id="gameOverSound"> <source src="game-over-arcade-6435.mp3" type="audio/mp3"> </audio>
    <audio id="spinSound"> <source src="spin-sound.mp3" type="audio/mp3"> </audio>
    <audio id="winSound"> <source src="win-sound.mp3" type="audio/mp3"> </audio>
    <audio id="loseSound"> <source src="lose-sound.mp3" type="audio/mp3"> </audio>


   <!-- Google Sign-in Panel -->
   <div id="googleSignInPanel" style="display: flex;">
       <h2>Welcome Gamer!</h2>
       <button id="googleSignInBtn" class="game-btn">
           <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google G Logo"/>
           Sign in with Google
       </button>
       <button id="guestButtonAlt" class="game-btn">Continue as Guest</button>
   </div>

   <!-- Complete Profile Modal -->
   <div id="completeProfileModal" class="modal">
       <div class="modal-content">
           <h2>Complete Your Profile</h2>
           <p>Welcome! Please set your username and optionally enter a referral code.</p>
           <div>
               <label for="profileUsernameInput">Username:</label>
               <input type="text" id="profileUsernameInput" placeholder="Choose a username (min 3 chars)" required />
           </div>
            <div>
               <label for="profileReferralInput">Referral Code (Optional):</label>
               <input type="text" id="profileReferralInput" placeholder="Enter friend's code" />
               <p class="subtle">Enter a code to get a bonus!</p>
           </div>
           <button id="saveProfileBtn" class="game-btn">Save and Play</button>
       </div>
   </div>

   <!-- Game Canvas -->
   <canvas id="gameCanvas" style="display: none;"></canvas>

   <!-- Main Menu -->
   <div id="mainMenu" style="display: none;">
      <button id="settingsBtn" title="Open Settings">
         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M487.4 315.7l-42.1-24.3c2.8-12.8 4.3-26 4.3-39.4s-1.5-26.6-4.3-39.4l42.1-24.3c9.4-5.4 13.3-17.1 9.4-27.2l-45.3-78.4c-3.9-10.1-14.2-14.8-24.7-11.5l-49.5 19.9c-20.5-16.1-43-29.2-67.2-38.1l-7.5-52.8C309 3.7 300.3-2.5 290.3.1l-90.6 18.5c-10 2.1-17.6 9.9-19.8 19.8l-7.5 52.8c-24.3 8.9-46.8 22-67.2 38.1L54.6 83.1c-10.5-3.3-20.8.4-24.7 11.5L-15.4 172.9c-3.9 10.1-.1 21.8 9.4 27.2l42.1 24.3C73.5 243.3 72 256.4 72 269.9c0 13.5 1.5 26.6 4.3 39.4l-42.1 24.3c-9.4 5.4-13.3 17.1-9.4 27.2l45.3 78.4c3.9 10.1 14.2 14.8 24.7 11.5l49.5-19.9c20.5 16.1 43 29.2 67.2 38.1l7.5 52.8c2 10 10.7 15.3 20.7 12.8l90.6-18.5c10-2.1 17.6 9.9 19.8-19.8l7.5-52.8c24.3-8.9 46.8-22 67.2-38.1l49.5 19.9c10.5 3.3 20.8-.4 24.7-11.5l45.3-78.4c3.9-10.1.1 21.8-9.4-27.2zM256 336c-44.2 0-80-35.8-80-80s35.8-80 80-80c44.2 0 80 35.8 80 80s-35.8 80-80 80z"></path></svg>
      </button>
       <div id="topRightStatus">
           <div><img id="coinIcon" src="https://i.imgur.com/PCDgdlS.png" alt="Coin"> Coins: <span id="menuCoinCount">0</span></div>
           <div><img id="pkrIcon" src="https://i.imgur.com/oQhXG5b.png" alt="PKR"> PKR: <span id="menuPkrCount">0</span></div>
       </div>
      <button id="startBtn" class="menu-btn game-btn">Play Now</button>
      <button id="spinBtn" class="menu-btn game-btn">Spin to Win</button>
      <button id="inviteFriend" class="menu-btn game-btn">Invite (0)</button>
      <button id="infoBtn" class="menu-btn game-btn">Game Info</button>
      <button id="logoutBtn" class="menu-btn game-btn">Exit</button>
   </div>

   <!-- Settings Modal -->
   <div id="settingsModal" class="modal">
     <div class="modal-content">
       <button class="close-btn" id="closeSettings">Ã—</button>
       <h2>Settings</h2>
       <button id="profileBtn" class="game-btn">View Profile</button>
       <button id="toggleSound" class="game-btn">Sound: On</button>
       <button id="spinHistoryBtn" class="game-btn">Spin History</button>
       <button id="customerService" class="game-btn">Customer Service</button>
     </div>
   </div>

   <!-- Profile Modal -->
   <div id="profileModal" class="modal">
       <div class="modal-content">
           <button class="close-btn" id="closeProfileModal">Ã—</button>
           <h2>Gamer Profile</h2>
           <div id="profileInfo">
               <p><strong>Username:</strong> <span id="profileUsername">...</span></p>
               <p><strong>Email:</strong> <span id="profileEmail">...</span></p>
               <p><strong>Total Coins:</strong> <span id="profileTotalCoins">...</span></p>
               <p><strong>Total PKR:</strong> <span id="profileTotalPkr" class="pkr-amount">...</span></p>
               <p><strong>Referrals:</strong> <span id="profileReferralCount">...</span></p>
               <p><strong>Your Code:</strong> <span id="profileInviteCode">...</span></p>
               <p><strong>Joined:</strong> <span id="profileJoinedDate">...</span></p>
           </div>
       </div>
   </div>

   <!-- Invite Modal -->
   <div id="inviteModal" class="modal">
       <div class="modal-content">
           <button class="close-btn" id="closeInviteModal">Ã—</button>
           <h2>Invite Friend</h2>
           <div class="section">
               <h3>Your Invite Link</h3>
               <div id="yourInviteLinkDisplay">Generating link...</div>
               <button id="copyInviteCode" class="game-btn">Copy Link</button>
           </div>
           <div class="section">
               <h3>Redeem Invite Code</h3>
               <input type="text" id="redeemCodeInput" placeholder="Enter friend's code" />
               <button id="redeemCodeBtn" class="game-btn">Redeem</button>
           </div>
       </div>
   </div>

   <!-- Game Over Overlay -->
   <div id="gameOverMenu" style="display: none;">
       <h2>Game Over</h2>
       <p>Session Coins: <span id="sessionCoinCount">0</span></p>
       <p>Total Coins: <span id="finalTotalCoins">0</span></p>
        <p>Total PKR: <span id="finalTotalPkr" class="pkr-amount">0</span></p>
       <button id="restartBtn" class="menu-btn game-btn">Restart</button>
       <button id="backMenuBtn" class="menu-btn game-btn">Back to Menu</button>
   </div>

   <!-- Spin Modal -->
   <div id="spinModal" class="modal">
      <div class="modal-content">
          <button class="close-btn" id="closeSpin">Ã—</button>
          <h2>Spin to Win</h2>
          <div class="spin-status">
              <div class="currency-display"><img src="https://i.imgur.com/PCDgdlS.png" alt="Coin"> Coins: <span id="spinModalCoinCount">0</span></div>
              <div class="currency-display"><img src="https://i.imgur.com/oQhXG5b.png" alt="PKR"> PKR: <span id="spinModalPkrCount">0</span></div>
          </div>

          <div id="wheelContainer">
              <div id="wheelPointer"></div>
              <div id="wheel">
                  <!-- Segments will be added by JavaScript -->
              </div>
          </div>

          <button id="spinButton" class="game-btn">Spin (Cost: 10,000 Coins)</button>
          <p id="spinResult"></p>
      </div>
   </div>

   <!-- Spin History Modal -->
   <div id="spinHistoryModal" class="modal">
     <div class="modal-content">
       <button class="close-btn" id="closeHistoryModal">Ã—</button>
       <h2>Spin History</h2>
       <div id="historyList"> <p class="no-history">Loading...</p> </div>
     </div>
   </div>


   <!-- Game Info Modal -->
   <div id="infoModal" class="modal">
     <div class="modal-content">
       <button class="close-btn" id="closeInfo">Ã—</button>
       <h2>Game Info</h2>
       <p>Welcome to <strong>Mario Run Earn Real Money</strong>! Run, jump, collect coins, and avoid obstacles.</p>
       <p><strong>Login:</strong> Use your Google Account to Sign in and save your progress (Coins & PKR).</p>
       <p><strong>Guest Play:</strong> Play for fun without saving coins or earning PKR. Great for practice!</p>
       <p><strong>Bonuses:</strong>
           <br>- Get <strong class="highlight">100 Coins</strong> just for signing up!
           <br>- Invite friends using your unique link (find it in the Invite menu).
           <br>- When your friend signs up using your code, they get an <strong class="highlight">extra 100 Coins</strong> (total 200 start!), and YOU get <strong class="highlight">200 Coins!</strong>
           <br>- Existing users can also redeem a code once for a <strong class="highlight">100 Coin</strong> bonus.
       </p>
       <p><strong>Spin to Win:</strong> Use your earned coins to spin the Wheel of Fortune! Each spin costs <strong class="highlight">10,000 Coins</strong> and gives you a chance to win real PKR prizes. Prizes range from 1 PKR up to 500 PKR, or sometimes 'Bad Luck' (which gives you back some coins!).</p>
       <p><strong>PKR Prizes:</strong> Any PKR won is added to your PKR balance. You can check your balance in your Profile.</p>
       <p><strong>Profile:</strong> Check your stats, email, coin & PKR balance, referral count, and invite code in Settings > View Profile.</p>
       <p><strong>Withdrawal:</strong> Withdrawal of PKR is handled separately. Contact customer service via WhatsApp to request withdrawal of your PKR balance.</p>
     </div>
   </div>


   <!-- AD INTEGRATION -->
   <div id="bannerAdContainer">
     <script type="text/javascript">
         atOptions = {
             'key' : '34daa95d37aa866e4d5dc188a89f19b2',
             'format' : 'iframe',
             'height' : 50,
             'width' : 320,
             'params' : {}
         };
     </script>
     <script type="text/javascript" src="//www.highperformanceformat.com/34daa95d37aa866e4d5dc188a89f19b2/invoke.js"></script>
   </div>
   <div id="interstitialAdOverlay" style="display: none;">
       <p id="adInfoText">Loading ad...</p>
       <div id="interstitialAdTimer"></div>
       <button id="interstitialAdCloseButton" class="game-btn">Skip Ad</button>
       <p class="skip-info">(Click 'Skip Ad' or close ad tab manually if needed)</p>
   </div>

     <!-- WhatsApp Button -->
     <a href="https://wa.me/923019022815" target="_blank" id="whatsappBtn" class="whatsapp-btn" title="Contact Customer Service">
         <img src="https://i.imgur.com/d2UlLQN.png" alt="WhatsApp Icon">
     </a>


   <!-- Firebase and Game Scripts -->
   <script type="module">
     // --- Firebase Imports ---
     import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
     import { getDatabase, ref, set, get, push, query, orderByChild, equalTo, onValue, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
     import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

     // --- DOM Element References ---
     const googleSignInPanel = document.getElementById('googleSignInPanel');
     const googleSignInBtn = document.getElementById('googleSignInBtn');
     const guestButtonAlt = document.getElementById('guestButtonAlt');
     const completeProfileModal = document.getElementById('completeProfileModal');
     const profileUsernameInput = document.getElementById('profileUsernameInput');
     const profileReferralInput = document.getElementById('profileReferralInput');
     const saveProfileBtn = document.getElementById('saveProfileBtn');
     const mainMenu = document.getElementById('mainMenu');
     const gameOverMenu = document.getElementById('gameOverMenu');
     const gameCanvas = document.getElementById('gameCanvas');
     const settingsModal = document.getElementById('settingsModal');
     const profileModal = document.getElementById('profileModal');
     const inviteModal = document.getElementById('inviteModal');
     // REMOVED withdrawModal
     const infoModal = document.getElementById('infoModal');
     // RENAMED withdrawalHistoryModal to spinHistoryModal
     const spinHistoryModal = document.getElementById('spinHistoryModal');
     const historyListDiv = document.getElementById('historyList'); // Still used for spin history
     const interstitialAdOverlay = document.getElementById('interstitialAdOverlay');
     const interstitialAdCloseButton = document.getElementById('interstitialAdCloseButton');
     const interstitialAdTimer = document.getElementById('interstitialAdTimer');
     const adInfoText = document.getElementById('adInfoText');
     const menuCoinCountSpan = document.getElementById('menuCoinCount');
     const menuPkrCountSpan = document.getElementById('menuPkrCount'); // New PKR span
     const finalTotalCoinsSpan = document.getElementById('finalTotalCoins');
     const finalTotalPkrSpan = document.getElementById('finalTotalPkr'); // New PKR span
     const sessionCoinCountSpan = document.getElementById('sessionCoinCount');
     const inviteFriendBtn = document.getElementById('inviteFriend');
     const yourInviteLinkDisplay = document.getElementById('yourInviteLinkDisplay');
     const redeemCodeInput = document.getElementById("redeemCodeInput");
     const toggleSoundBtn = document.getElementById("toggleSound");
     // REMOVED redeemOptionsDiv, redeemFormDiv, redeemDetailsForm, redeemSubmitBtn
     // RENAMED withdrawalHistoryBtn to spinHistoryBtn
     const spinHistoryBtn = document.getElementById('spinHistoryBtn');
     const closeHistoryModalBtn = document.getElementById('closeHistoryModal'); // Still used for spin history
     const profileBtn = document.getElementById('profileBtn');
     const closeProfileModalBtn = document.getElementById('closeProfileModal');
     const profileUsernameSpan = document.getElementById('profileUsername');
     const profileEmailSpan = document.getElementById('profileEmail');
     const profileTotalCoinsSpan = document.getElementById('profileTotalCoins');
     const profileTotalPkrSpan = document.getElementById('profileTotalPkr'); // New PKR span
     const profileReferralCountSpan = document.getElementById('profileReferralCount');
     const profileInviteCodeSpan = document.getElementById('profileInviteCode');
     const profileJoinedDateSpan = document.getElementById('profileJoinedDate');
     const statusMessageContainer = document.getElementById('statusMessageContainer');
     const statusMessageText = document.getElementById('statusMessageText');
     let statusMessageTimeoutId = null;
     const backgroundAudio = document.getElementById("backgroundAudio");
     const jumpSound = document.getElementById("jumpSound");
     const coinSound = document.getElementById("coinSound");
     const gameOverSound = document.getElementById("gameOverSound");
     const spinSound = document.getElementById("spinSound"); // New Spin Sound
     const winSound = document.getElementById("winSound");     // New Win Sound
     const loseSound = document.getElementById("loseSound");   // New Lose Sound
     const settingsBtn = document.getElementById('settingsBtn');
     const closeSettings = document.getElementById('closeSettings');
     const infoBtn = document.getElementById('infoBtn');
     const closeInfo = document.getElementById('closeInfo');
     const copyInviteCode = document.getElementById('copyInviteCode');
     const redeemCodeBtn = document.getElementById('redeemCodeBtn');
     const closeInviteModal = document.getElementById('closeInviteModal');
     // RENAMED withdrawBtn to spinBtn
     const spinBtn = document.getElementById('spinBtn');
     // RENAMED closeWithdraw to closeSpin
     const closeSpin = document.getElementById('closeSpin');
     const logoutBtn = document.getElementById('logoutBtn');
     const startBtn = document.getElementById('startBtn');
     const restartBtn = document.getElementById('restartBtn');
     const backMenuBtn = document.getElementById('backMenuBtn');
     const customerService = document.getElementById('customerService');
     // REMOVED accountHolderName, accountNumber
     const topRightStatus = document.getElementById('topRightStatus');
     // REMOVED referralTaskDisplay
     const whatsappBtn = document.getElementById('whatsappBtn'); // Reference for the new WhatsApp button

     // --- Spin Wheel Elements ---
     const spinModal = document.getElementById('spinModal');
     const wheel = document.getElementById('wheel');
     const spinButton = document.getElementById('spinButton');
     const spinResult = document.getElementById('spinResult');
     const spinModalCoinCountSpan = document.getElementById('spinModalCoinCount');
     const spinModalPkrCountSpan = document.getElementById('spinModalPkrCount');


     const firebaseConfig = {
       // --- Your Firebase Config --- // Copied from original
       apiKey: "AIzaSyCpheUGTtliJyTXjVlm1VnfvGTbaeykQ7E", authDomain: "super-mario-earn-real-money.firebaseapp.com",
       databaseURL: "https://super-mario-earn-real-money-default-rtdb.firebaseio.com", projectId: "super-mario-earn-real-money",
       storageBucket: "super-mario-earn-real-money.firebasestorage.app", messagingSenderId: "527750706733",
       appId: "1:527750706733:web:71f31dc125468ca645eaa4", measurementId: "G-Z25ZFF8PWT"
       // --- End Firebase Config --- //
     };

     // --- Firebase Initialization ---
     let appFirebase, db, auth;
     try {
         appFirebase = initializeApp(firebaseConfig);
         db = getDatabase(appFirebase);
         auth = getAuth();
         console.log("Firebase initialized successfully.");
     } catch (error) {
         console.error("Firebase initialization failed:", error);
         showStatusMessage("Connection error. Cannot initialize.", "error", 10000);
         if (googleSignInBtn) googleSignInBtn.disabled = true;
         if (guestButtonAlt) guestButtonAlt.disabled = true;
     }

     // --- Global State ---
     let totalCoins = 0, totalPkr = 0, soundEnabled = true, currentUserInviteCode = null, currentUsername = null;
     let currentReferralCount = 0, currentJoinedDate = null, gameStarted = false, gameOver = false;
     let score = 0, mario, obstacles, coins, speed, bgX, platformX;
     let lastJumpInputTime = 0; const doubleJumpWindow = 350; let canDoubleJump = false;
     let animationFrameId = null, allImagesLoaded = false, isProcessingAuth = false;
     let coinListenerUnsubscribe = null; // Listener will now track coins AND pkr
     let profileCompleteListener = null;
     let isSpinning = false; // Flag to prevent multiple spins

     // --- Constants ---
     const SIGNUP_BONUS = 100;
     const REFERRER_BONUS = 200;
     const REDEEMER_BONUS = 100;
     const SPIN_COST = 10000; // 10,000 coins per spin
      const BAD_LUCK_COIN_RETURN = 500; // Coins awarded on "Bad Luck" spin

     // UPDATED: Use window.location to get the current base URL dynamically
     const baseInviteUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;

      // --- Spin Wheel Prizes and Probabilities ---
      // Structure: { label: 'Display Text', type: 'PKR' | 'Bad Luck', value: number (PKR or Coins), probability: number (0-100) }
      const spinPrizes = [
          { label: '1 PKR', type: 'PKR', value: 1, probability: 30, colorClass: 'segment-color-2' }, // Blue
          { label: 'Bad Luck', type: 'Bad Luck', value: BAD_LUCK_COIN_RETURN, probability: 40, colorClass: 'segment-color-badluck' }, // Grey
          { label: '5 PKR', type: 'PKR', value: 5, probability: 10, colorClass: 'segment-color-3' }, // Green
          { label: '10 PKR', type: 'PKR', value: 10, probability: 5, colorClass: 'segment-color-4' }, // Yellow
          { label: '30 PKR', type: 'PKR', value: 30, probability: 5, colorClass: 'segment-color-5' }, // Red
          { label: '50 PKR', type: 'PKR', value: 50, probability: 5, colorClass: 'segment-color-6' }, // Purple
          { label: '100 PKR', type: 'PKR', value: 100, probability: 3, colorClass: 'segment-color-1' }, // Pink
          { label: '500 PKR', type: 'PKR', value: 500, probability: 2, colorClass: 'segment-color-7' }, // Brown
      ];
      const totalProbability = spinPrizes.reduce((sum, p) => sum + p.probability, 0);
      if (totalProbability !== 100) { console.error("Spin prize probabilities do not sum to 100!"); }
      const segmentAngle = 360 / spinPrizes.length; // Angle for each segment

     // --- Status Message Function ---
     function showStatusMessage(message, type = 'info', duration = 3000) {
         if (statusMessageTimeoutId) { clearTimeout(statusMessageTimeoutId); statusMessageContainer.classList.remove('show'); }
         console.log(`Status [${type}]: ${message}`);
         statusMessageText.textContent = message;
         statusMessageContainer.className = 'statusMessageContainer'; statusMessageContainer.classList.add(type);
         statusMessageContainer.style.display = 'block'; statusMessageContainer.style.top = '15px'; statusMessageContainer.style.transform = 'translateX(-50%) scale(0.9)';
         void statusMessageContainer.offsetWidth; statusMessageContainer.classList.add('show');
         statusMessageTimeoutId = setTimeout(() => {
             statusMessageContainer.classList.remove('show'); statusMessageTimeoutId = null;
             setTimeout(() => { if (!statusMessageContainer.classList.contains('show')) statusMessageContainer.style.display = 'none'; }, 400);
         }, duration);
     }

     // --- AD INTEGRATION ---
     const directLinkUrl = "https://www.profitableratecpm.com/zi30dfhjnn?key=b78830ea0cb80a28c4b278ee2e122b06";
     let adCloseTimerInterval; let adCloseTimeout; let currentAdCallback = null;
     function showInterstitialAd(callback) {
          console.log("Attempting to show Interstitial Ad...");
          if (typeof callback !== 'function') { console.error("Invalid ad callback."); return; }
          currentAdCallback = callback; adInfoText.textContent = "Ad loading...";
          interstitialAdOverlay.style.display = 'flex'; interstitialAdCloseButton.style.display = 'none'; interstitialAdTimer.textContent = "";
          let adWindow = null; try { adWindow = window.open(directLinkUrl, '_blank'); } catch (e) { console.error("Error opening ad window:", e); }
          if (!adWindow) { console.warn("Pop-up blocked."); showStatusMessage("Ad might be blocked.", "info"); interstitialAdOverlay.style.display = 'none'; if (currentAdCallback) { try { currentAdCallback(); } catch (e) { console.error("Error in ad callback after block:", e); } } currentAdCallback = null; return; }
          let secondsRemaining = 3; interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`;
          if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
          adCloseTimerInterval = setInterval(() => { secondsRemaining--; if (secondsRemaining > 0) interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`; else { interstitialAdTimer.textContent = "Skip available"; clearInterval(adCloseTimerInterval); } }, 1000);
          adCloseTimeout = setTimeout(() => { interstitialAdCloseButton.style.display = 'inline-flex'; if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); interstitialAdTimer.textContent = "Skip available"; }, secondsRemaining * 1000 + 100);
     }
     interstitialAdCloseButton.addEventListener('click', () => {
          console.log("Ad Skip Button clicked."); interstitialAdOverlay.style.display = 'none';
          if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
          interstitialAdTimer.textContent = "";
          if (typeof currentAdCallback === 'function') { console.log("Executing ad callback after skip."); try { currentAdCallback(); } catch(e) { console.error("Error in ad callback:", e); showStatusMessage("Error proceeding.", "error"); } currentAdCallback = null; }
          else { console.warn("No ad callback found after skipping."); }
     });

     // --- Sound Functions ---
     function playSound(audioElement) { if (soundEnabled && audioElement) { try { audioElement.currentTime=0; audioElement.play().catch(e=>console.warn(`Sound play error (${audioElement.id}):`, e)); } catch(e) { console.warn("Sound play failed:", e); } } }
     function playBackgroundMusic() { if (soundEnabled && backgroundAudio && backgroundAudio.paused) { backgroundAudio.play().catch(e=>console.warn("Background music play failed:",e)); } }
     function stopBackgroundMusic() { if (backgroundAudio && !backgroundAudio.paused) { backgroundAudio.pause(); backgroundAudio.currentTime=0; } }

     // --- Authentication Logic ---
     function setAuthProcessing(isProcessing) {
         console.log(`Setting Auth Processing: ${isProcessing}`); isProcessingAuth = isProcessing;
         if(googleSignInBtn) googleSignInBtn.disabled = isProcessing;
         if(guestButtonAlt) guestButtonAlt.disabled = isProcessing;
         if(saveProfileBtn) saveProfileBtn.disabled = isProcessing;
         if(logoutBtn) logoutBtn.disabled = isProcessing;
     }

     async function handleGoogleSignInSuccess(userCredential) {
         const user = userCredential.user;
         console.log(`Google Sign-In Success for: ${user.uid}. Checking profile...`);
         setAuthProcessing(true);
         try {
             const userRef = ref(db, `users/${user.uid}`); const snapshot = await get(userRef);
             if (snapshot.exists() && snapshot.val().username) {
                 console.log("Existing user with username found.");
                 showStatusMessage(`Welcome back!`, "success", 2000);
                 showInterstitialAd(async () => {
                     try {
                         await loadUserData(user.uid);
                         setupUserDataListener(user.uid); // Listen for coins AND pkr
                         showMainMenu();
                         checkUrlForReferral();
                     } catch (loadError) {
                         console.error("Failed to load user data after ad:", loadError);
                         showStatusMessage("Error loading profile data.", "error");
                     } finally {
                         setAuthProcessing(false);
                     }
                 });
             } else {
                 console.log("New user or profile incomplete.");
                 showStatusMessage("Complete your profile.", "info", 3000);
                 profileUsernameInput.value = user.displayName || ""; profileReferralInput.value = "";
                 const urlParams = new URLSearchParams(window.location.search); const refCode = urlParams.get('ref');
                  if (refCode) { profileReferralInput.value = refCode.trim().toUpperCase(); console.log("Referral code pre-filled."); const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname; window.history.replaceState({path:cleanUrl},'',cleanUrl); }
                 completeProfileModal.style.display = "block"; googleSignInPanel.style.display = "none";
                 if(profileCompleteListener) saveProfileBtn.removeEventListener('click', profileCompleteListener);
                 profileCompleteListener = createProfileCompletionHandler(user); saveProfileBtn.addEventListener('click', profileCompleteListener);
                 setAuthProcessing(false);
             }
         } catch (error) {
             console.error("Error checking user existence:", error); showStatusMessage("Error loading profile.", "error");
             signOut(auth).catch(e => console.error("Sign out error:", e));
             setAuthProcessing(false);
         }
     }

     function createProfileCompletionHandler(user) {
         return async () => {
             if (isProcessingAuth) return;
             const chosenUsername = profileUsernameInput.value.trim(); const referralCode = profileReferralInput.value.trim().toUpperCase();
             if (chosenUsername.length < 3) { showStatusMessage("Username must be >= 3 chars.", "error"); return; }
             if (!/^[a-zA-Z0-9_]+$/.test(chosenUsername)) { showStatusMessage("Invalid username characters.", "error"); return; }
             console.log(`Saving profile for ${user.uid}. User: ${chosenUsername}, Ref: ${referralCode}`);
             setAuthProcessing(true); saveProfileBtn.disabled = true; showStatusMessage("Creating profile...", "info");
             try {
                 const generatedInviteCode = generateRandomCode(); const creationTime = serverTimestamp();
                 const initialUserData = { email: user.email, username: chosenUsername, uid: user.uid, totalCoins: SIGNUP_BONUS, totalPkr: 0, referralCount: 0, referralRedeemed: false, codeRedeemedFrom: null, inviteCode: generatedInviteCode, createdAt: creationTime, provider: 'google' };
                 console.log(`1: Setting initial data (+${SIGNUP_BONUS} coins, 0 PKR)...`);
                 await set(ref(db, `users/${user.uid}`), initialUserData);
                 console.log("2: Initial DB data set.");
                 let referralMessage = ""; let finalCoins = SIGNUP_BONUS;
                 if (referralCode) {
                     console.log(`3: Attempting referral: ${referralCode}`);
                     try {
                         // Pass the *just created* initial data for the check
                         const { newCoinsForRedeemer, referrerUid } = await redeemInviteCode(referralCode, user.uid, initialUserData);
                         console.log("4: Referral success.");
                         finalCoins = newCoinsForRedeemer; // This already includes the bonus
                         // Update the user's record AGAIN to mark redeemed status and set final coins
                         await update(ref(db, `users/${user.uid}`), {
                             referralRedeemed: true,
                             codeRedeemedFrom: referrerUid,
                             totalCoins: finalCoins // Update coins again explicitly
                         });
                         console.log("5: User record updated with redemption details.");
                         referralMessage = ` +${REDEEMER_BONUS} referral bonus!`;
                         // No need to update currentReferralCount here, loadUserData will fetch it
                     } catch (redeemError) {
                         console.warn("4: Referral error:", redeemError.message);
                         referralMessage = ` (Referral error: ${redeemError.message})`;
                         // Even if referral fails, keep the signup bonus
                         finalCoins = SIGNUP_BONUS;
                          // Ensure the DB has at least the signup bonus if referral failed after initial set
                         await update(ref(db, `users/${user.uid}`), { totalCoins: finalCoins });
                     }
                 } else {
                     // Ensure the DB has the signup bonus if no referral code was entered
                     await update(ref(db, `users/${user.uid}`), { totalCoins: SIGNUP_BONUS });
                     finalCoins = SIGNUP_BONUS;
                 }
                 totalCoins = finalCoins; // Update local state immediately
                 totalPkr = 0; // Ensure PKR is 0 for new profiles
                 showStatusMessage(`Profile created! +${SIGNUP_BONUS} bonus${referralMessage}`, "success", 6000);
                 completeProfileModal.style.display = "none";
                  showInterstitialAd(async () => {
                     try {
                         await loadUserData(user.uid);
                         setupUserDataListener(user.uid); // Listen for coins AND pkr
                         showMainMenu();
                     } catch (loadError) {
                         console.error("Failed to load data after profile creation/ad:", loadError);
                         showStatusMessage("Error loading profile data.", "error");
                     } finally {
                         setAuthProcessing(false);
                     }
                  });
             } catch (dbError) {
                 console.error("Error saving profile:", dbError); showStatusMessage("Error saving profile.", "error");
                 setAuthProcessing(false); saveProfileBtn.disabled = false;
             }
         };
     }

     googleSignInBtn.addEventListener("click", () => {
         if (isProcessingAuth) return; console.log("Google Sign In clicked."); setAuthProcessing(true); showStatusMessage("Opening Google Sign-in...", "info", 2000);
         const provider = new GoogleAuthProvider();
         signInWithPopup(auth, provider).then(handleGoogleSignInSuccess).catch((error) => {
             console.error("Google Sign-In Error:", error); let errorMsg = "Google Sign-in failed.";
             if (error.code === 'auth/popup-closed-by-user') errorMsg = "Sign-in cancelled.";
             else if (error.code === 'auth/network-request-failed') errorMsg = "Network error.";
             else if (error.code === 'auth/cancelled-popup-request') return; // Do nothing, expected sometimes
             showStatusMessage(errorMsg, "error", 4000); setAuthProcessing(false);
         });
     });

     guestButtonAlt.addEventListener("click", () => {
         console.log("Guest button clicked."); if (isProcessingAuth) return; setAuthProcessing(true);
         try { googleSignInPanel.style.display = "none"; resetAppStateToLoggedOut(); showMainMenu(); showStatusMessage("Playing as Guest. Progress is not saved.", "info", 5000); }
         catch (error) { console.error("Error entering guest mode:", error); showStatusMessage("Error starting guest mode.", "error"); googleSignInPanel.style.display = "flex"; }
         finally { setAuthProcessing(false); }
     });

     onAuthStateChanged(auth, async (user) => {
       console.log("Auth State Changed. User:", user ? user.uid : 'null');
       if (coinListenerUnsubscribe) { coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
       completeProfileModal.style.display = 'none';

       if (user) {
           setAuthProcessing(true);
           try {
               const userRef = ref(db, `users/${user.uid}`);
               const snapshot = await get(userRef);
               if (snapshot.exists() && snapshot.val().username) {
                   console.log("Auth State: Existing user session with profile.");
                    console.log("Auth State: Reloading user data and updating UI.");
                    await loadUserData(user.uid);
                    setupUserDataListener(user.uid); // Listener setup AFTER initial load

                    // Ensure UI elements are updated even if menu is already visible
                    updateInviteButtonText(currentReferralCount);
                    updateInviteLinkDisplay();
                    updateCoinAndPkrDisplay(); // Update top right and spin modal counts
                    updateSpinButtonState(); // Update spin button state

                    if (mainMenu.style.display !== 'flex') {
                        showMainMenu();
                    } else {
                         if (topRightStatus.style.display !== 'flex') { // Use flex here
                             topRightStatus.style.display = 'flex';
                        }
                    }
                    if (whatsappBtn) whatsappBtn.style.display = 'flex'; // Ensure WhatsApp button is shown

                    checkUrlForReferral();

               } else {
                   console.warn("Auth State: User authenticated but profile incomplete.");
                    profileUsernameInput.value = user.displayName || ""; profileReferralInput.value = "";
                    completeProfileModal.style.display = "block"; googleSignInPanel.style.display = "none"; mainMenu.style.display = "none";
                    if(profileCompleteListener) saveProfileBtn.removeEventListener('click', profileCompleteListener);
                    profileCompleteListener = createProfileCompletionHandler(user); saveProfileBtn.addEventListener('click', profileCompleteListener);
               }
           } catch (dbError) {
               console.error("Auth State: Error checking DB:", dbError); showStatusMessage("Error verifying profile.", "error");
               signOut(auth).catch(e => console.error("Sign out error:", e));
           } finally { setAuthProcessing(false); }
       } else {
           console.log("User signed out."); resetAppStateToLoggedOut();
           googleSignInPanel.style.display="flex"; mainMenu.style.display="none"; gameCanvas.style.display='none'; gameOverMenu.style.display='none';
           settingsModal.style.display="none"; profileModal.style.display="none"; inviteModal.style.display="none";
           spinModal.style.display="none"; infoModal.style.display="none"; spinHistoryModal.style.display = "none";
           completeProfileModal.style.display = 'none';
           if (whatsappBtn) whatsappBtn.style.display = 'none'; // Hide WhatsApp button
           stopBackgroundMusic(); setAuthProcessing(false);
       }
     });

     // --- Real-time User Data Listener Setup ---
     function setupUserDataListener(userId) {
          if (!userId) { console.error("No userId for data listener."); return; }
          if (coinListenerUnsubscribe) { console.warn("Removing existing data listener."); coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
          const userRefPath = `users/${userId}`;
          const userRef = ref(db, userRefPath);
          console.log(`Setting up user data listener for ${userId}`);
          coinListenerUnsubscribe = onValue(userRef, (snapshot) => {
             if (snapshot.exists()) {
                  const userData = snapshot.val();
                  const newCoins = userData.totalCoins ?? 0;
                  const newPkr = userData.totalPkr ?? 0; // Listen for PKR
                  const newRefCount = userData.referralCount ?? 0;
                  console.log(`RT Data update: Coins=${newCoins}, PKR=${newPkr}, Refs=${newRefCount}`);

                  // Update global state only if changed
                  let stateChanged = false;
                  if (totalCoins !== newCoins) {
                      totalCoins = newCoins;
                      stateChanged = true;
                  }
                  if (totalPkr !== newPkr) { // Check PKR
                      totalPkr = newPkr;
                      stateChanged = true;
                  }
                  if (currentReferralCount !== newRefCount) {
                      currentReferralCount = newRefCount;
                      stateChanged = true;
                  }

                  // Update UI only if state actually changed
                  if (stateChanged) {
                      console.log("State changed, updating relevant UI...");
                      updateCoinAndPkrDisplay(); // Update all displays
                      updateInviteButtonText(currentReferralCount);
                      updateSpinButtonState(); // Update spin button based on coins
                      console.log(`UI updated with ${totalCoins} coins, ${totalPkr} PKR and ${currentReferralCount} refs.`);
                  } else {
                     // console.log("RT Data update received, but no change in relevant state.");
                  }
             } else {
                 console.warn(`RT Listener: User node ${userId} no longer exists.`);
                 // Optional: handle this case, e.g., log out user
                 if (coinListenerUnsubscribe) { coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
                 signOut(auth).catch(e => console.error("Sign out error on missing node:", e));
             }
          }, (error) => {
              console.error("Firebase user data listener error:", error); showStatusMessage("Data sync error.", "error");
              if (coinListenerUnsubscribe) { coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
          });
      }

     // --- Reset & Load Data ---
     function resetAppStateToLoggedOut() {
         console.log("Resetting app state to logged-out...");
         if (coinListenerUnsubscribe) { coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
         totalCoins = 0; totalPkr = 0; currentUserInviteCode = null; currentUsername = null; currentReferralCount = 0; currentJoinedDate = null;
         gameStarted = false; gameOver = false; score = 0; if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null;
         stopBackgroundMusic();
         updateCoinAndPkrDisplay(); // Reset displays
         if (sessionCoinCountSpan) sessionCoinCountSpan.innerText = "0";
         updateInviteButtonText(0); if (yourInviteLinkDisplay) yourInviteLinkDisplay.textContent = "N/A (Log in)";
         if (profileUsernameSpan) profileUsernameSpan.textContent = "..."; if (profileEmailSpan) profileEmailSpan.textContent = "...";
         if (profileTotalCoinsSpan) profileTotalCoinsSpan.textContent = "0"; if (profileTotalPkrSpan) profileTotalPkrSpan.textContent = "0"; // Reset PKR
         if (profileReferralCountSpan) profileReferralCountSpan.textContent = "0";
         if (profileInviteCodeSpan) profileInviteCodeSpan.textContent = "..."; if (profileJoinedDateSpan) profileJoinedDateSpan.textContent = "...";
         mario = null; obstacles = []; coins = []; isProcessingAuth = false; isSpinning = false;
         console.log("App state reset complete.");
     }

     function loadUserData(userId) {
        return new Promise((resolve, reject) => {
            if (!userId) {
                console.error("loadUserData: No userId.");
                showStatusMessage("Cannot load data.", "error");
                return reject(new Error("No userId provided"));
            }
            console.log(`Loading data for: ${userId}`);
            const userRef = ref(db, `users/${userId}`);
            get(userRef).then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    console.log("User data fetched:", userData);
                    totalCoins = userData.totalCoins || 0;
                    totalPkr = userData.totalPkr || 0; // Load PKR
                    currentUsername = userData.username || 'Gamer';
                    currentReferralCount = userData.referralCount || 0; // Load referral count
                    currentUserInviteCode = userData.inviteCode;
                    if (userData.createdAt) {
                        if (typeof userData.createdAt === 'number') {
                            try { currentJoinedDate = new Date(userData.createdAt).toLocaleDateString(); }
                            catch (e) { console.warn("Error parsing numeric timestamp:", e); currentJoinedDate = "N/A"; }
                        } else if (typeof userData.createdAt === 'object' && userData.createdAt.seconds) {
                            try { currentJoinedDate = new Date(userData.createdAt.seconds * 1000).toLocaleDateString(); }
                            catch (e) { console.warn("Error parsing timestamp object:", e); currentJoinedDate = "N/A"; }
                        } else {
                            console.warn("Unrecognized createdAt format:", userData.createdAt); currentJoinedDate = "N/A";
                        }
                    } else { currentJoinedDate = "N/A"; }

                    updateCoinAndPkrDisplay(); // Update displays
                    updateInviteButtonText(currentReferralCount);
                    updateInviteLinkDisplay();
                    updateSpinButtonState(); // Update spin button state

                    if (!currentUserInviteCode && auth.currentUser?.uid === userId) {
                         console.log("Generating invite code...");
                         const newCode = generateRandomCode();
                         set(ref(db, `users/${userId}/inviteCode`), newCode)
                            .then(() => {
                                console.log("New invite code saved:", newCode);
                                currentUserInviteCode = newCode;
                                updateInviteLinkDisplay();
                                if (profileModal.style.display === 'block') profileInviteCodeSpan.textContent = newCode;
                                resolve();
                            })
                            .catch(e => {
                                console.error("Error saving invite code:", e);
                                if(yourInviteLinkDisplay) yourInviteLinkDisplay.textContent = "Error";
                                resolve();
                            });
                    } else {
                        resolve();
                    }
                } else {
                    console.error(`CRITICAL: User node missing: ${userId}. Logging out.`);
                    showStatusMessage("Profile data missing! Logging out.", "error", 5000);
                    signOut(auth).catch(e => console.error("Sign out error on missing node:", e));
                    reject(new Error(`User node missing: ${userId}`));
                }
            }).catch(error => {
                console.error("Error fetching user data:", error);
                showStatusMessage("Failed to load user data.", "error");
                reject(error);
            });
        });
     }

     function checkUrlForReferral() {
         try {
             const urlParams = new URLSearchParams(window.location.search); const refCode = urlParams.get('ref');
             if (refCode) { const cleanCode = refCode.trim().toUpperCase(); console.log("URL Referral code:", cleanCode); if (auth.currentUser && redeemCodeInput) { redeemCodeInput.value = cleanCode; console.log("Referral code pre-filled."); showStatusMessage(`Ready to redeem code: ${cleanCode}?`, "info", 4000); } const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname; window.history.replaceState({path:cleanUrl},'',cleanUrl); console.log("Cleaned URL."); }
         } catch (e) { console.error("Error processing URL params:", e); }
     }

     // --- UI Update & View Navigation ---
     function updateCoinAndPkrDisplay() {
          if (menuCoinCountSpan) menuCoinCountSpan.innerText = totalCoins;
          if (menuPkrCountSpan) menuPkrCountSpan.innerText = totalPkr; // Update PKR in top bar
          if (finalTotalCoinsSpan && gameOverMenu.style.display === 'flex') finalTotalCoinsSpan.innerText = totalCoins;
          if (finalTotalPkrSpan && gameOverMenu.style.display === 'flex') finalTotalPkrSpan.innerText = totalPkr; // Update PKR in game over
          if (profileTotalCoinsSpan && profileModal.style.display === 'block') profileTotalCoinsSpan.textContent = totalCoins;
          if (profileTotalPkrSpan && profileModal.style.display === 'block') profileTotalPkrSpan.textContent = totalPkr; // Update PKR in profile
          if (spinModalCoinCountSpan && spinModal.style.display === 'block') spinModalCoinCountSpan.textContent = totalCoins;
          if (spinModalPkrCountSpan && spinModal.style.display === 'block') spinModalPkrCountSpan.textContent = totalPkr; // Update PKR in spin modal
     }
     function updateInviteButtonText(count) { inviteFriendBtn.innerText = `Invite (${count || 0} Refs)`; }
     function updateSoundButton() {
         toggleSoundBtn.textContent=`Sound: ${soundEnabled?'On':'Off'}`;
         // Use the correct green/grey theme colors from the updated CSS
         const onGradient="linear-gradient(145deg, #4caf50, #388e3c)";
         const offGradient="linear-gradient(145deg, #9e9e9e, #7f8c8d)"; // Adjusted off color
         const onBorder='#1b5e20';
         const offBorder='#424242';
         toggleSoundBtn.style.background=soundEnabled?onGradient:offGradient;
         toggleSoundBtn.style.borderBottomColor=soundEnabled?onBorder:offBorder;
     }
     function updateInviteLinkDisplay() { if (yourInviteLinkDisplay) { if (currentUserInviteCode && auth.currentUser) yourInviteLinkDisplay.textContent = `${baseInviteUrl}?ref=${currentUserInviteCode}`; else if (auth.currentUser) yourInviteLinkDisplay.textContent = "Generating link..."; else yourInviteLinkDisplay.textContent = "Log in to get your invite link"; } if (profileInviteCodeSpan && profileModal.style.display === 'block') profileInviteCodeSpan.textContent = currentUserInviteCode || '...'; }
      function updateSpinButtonState() {
          if (spinButton) {
               const user = auth.currentUser;
               const canSpin = user && totalCoins >= SPIN_COST && !isSpinning;
               spinButton.disabled = !canSpin;
               if (user && totalCoins < SPIN_COST) {
                   spinButton.title = `Need ${SPIN_COST - totalCoins} more coins to spin`;
               } else if (isSpinning) {
                    spinButton.title = "Spinning...";
               } else if (user) {
                    spinButton.title = `Cost: ${SPIN_COST} coins`;
               } else {
                    spinButton.title = "Log in to spin";
               }
          }
      }


     function showMainMenu() {
         console.log("Showing Main Menu...");
         gameStarted = false; gameOver = false; if (animationFrameId) cancelAnimationFrame(animationFrameId);
         googleSignInPanel.style.display = "none"; completeProfileModal.style.display = 'none'; gameOverMenu.style.display = "none"; gameCanvas.style.display = "none";
         settingsModal.style.display = "none"; profileModal.style.display = "none"; inviteModal.style.display = "none";
         spinModal.style.display = "none"; infoModal.style.display = "none"; spinHistoryModal.style.display = "none"; // Hide spin modal and history
         mainMenu.style.display = "flex";

         const user = auth.currentUser;
         if (user && currentUsername) {
              console.log("User logged in, showing full menu.");
              logoutBtn.style.display = 'inline-flex';
              spinBtn.style.display = 'inline-flex'; // Show Spin button
              inviteFriendBtn.style.display = 'inline-flex';
              settingsBtn.style.display = 'flex';
              topRightStatus.style.display = 'flex'; // Use flex here
              // REMOVED withdrawalBtn, downloadApkLink

              updateCoinAndPkrDisplay(); // Ensure counts are current
              updateInviteButtonText(currentReferralCount);
              updateInviteLinkDisplay();
              updateSpinButtonState(); // Update state on menu show
         } else {
              console.log("Guest/Incomplete profile, showing limited menu.");
              logoutBtn.style.display = 'none';
              spinBtn.style.display = 'none'; // Hide Spin button for guests
              inviteFriendBtn.style.display = 'none';
              settingsBtn.style.display = 'none';
              topRightStatus.style.display = 'none'; // Hide status for guests

              updateCoinAndPkrDisplay(); // Still update locals, but they'll be 0/0
              updateInviteButtonText(0);
              updateInviteLinkDisplay();
              updateSpinButtonState(); // Disable spin button for guests
         }
         // Show WhatsApp button on Main Menu regardless of login status
         if (whatsappBtn) whatsappBtn.style.display = 'flex';

         playBackgroundMusic();
         console.log("showMainMenu finished.");
     }

     function showGameOverMenu() {
         console.log("Showing Game Over Menu"); gameStarted = false; gameOver = true;
         sessionCoinCountSpan.innerText = score;
         finalTotalCoinsSpan.innerText = auth.currentUser ? totalCoins : 0;
         finalTotalPkrSpan.innerText = auth.currentUser ? totalPkr : 0; // Show PKR in game over
         gameCanvas.style.display='none';
         gameOverMenu.style.display="flex";
         mainMenu.style.display="none";
         if (whatsappBtn) whatsappBtn.style.display = 'none'; // Hide WhatsApp button
         stopBackgroundMusic();
         playSound(gameOverSound);
     }

     // --- Settings & Profile Modals ---
     settingsBtn.addEventListener("click", () => { if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "info"); return; } updateSoundButton(); settingsModal.style.display = "block"; });
     closeSettings.addEventListener("click", () => { settingsModal.style.display = "none"; });
     toggleSoundBtn.addEventListener("click", () => { soundEnabled = !soundEnabled; updateSoundButton(); if (!soundEnabled) stopBackgroundMusic(); else if (mainMenu.style.display==='flex'||(gameStarted&&!gameOver)) playBackgroundMusic(); showStatusMessage(`Sound ${soundEnabled ? 'On' : 'Off'}`, 'info', 1500); });
     customerService.addEventListener("click", () => { window.open("https://wa.me/923019022815", "_blank"); }); // WhatsApp link for customer service
     profileBtn.addEventListener('click', showProfileModal);
     closeProfileModalBtn.addEventListener('click', () => { profileModal.style.display = 'none'; });
     function showProfileModal() { const user = auth.currentUser; if (!user || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; } profileUsernameSpan.textContent = currentUsername || '...'; profileEmailSpan.textContent = user.email || 'N/A'; profileTotalCoinsSpan.textContent = totalCoins; profileTotalPkrSpan.textContent = totalPkr; profileReferralCountSpan.textContent = currentReferralCount; profileInviteCodeSpan.textContent = currentUserInviteCode || '...'; profileJoinedDateSpan.textContent = currentJoinedDate || '...'; settingsModal.style.display = 'none'; profileModal.style.display = 'block'; }

     // --- Spin History ---
     spinHistoryBtn.addEventListener('click', showSpinHistory); // Renamed button
     closeHistoryModalBtn.addEventListener('click', () => { spinHistoryModal.style.display = 'none'; }); // Renamed modal
     async function showSpinHistory() { // Renamed function
         const user = auth.currentUser;
         if (!user) { showStatusMessage("Log in first.", "error"); return; }
         historyListDiv.innerHTML = '<p class="no-history">Loading...</p>'; // Use same historyList div
         settingsModal.style.display = 'none';
         spinHistoryModal.style.display = 'block'; // Show spin history modal
         console.log(`Fetching spin history for UID: ${user.uid}. Ensure Firebase rules allow read and '.indexOn': ['uid'] is set for 'spinHistory'.`);

         try {
             const reqRef = ref(db, 'spinHistory'); // Point to new collection
             const q = query(reqRef, orderByChild('uid'), equalTo(user.uid));
             const snapshot = await get(q);

             historyListDiv.innerHTML = ''; // Clear loading message

             if (snapshot.empty) {
                 console.log("Spin history query returned no documents.");
                 historyListDiv.innerHTML = '<p class="no-history">No spin history found.</p>';
             } else {
                 console.log(`Spin history query returned ${snapshot.size} document(s).`);
                 const data = [];
                 snapshot.forEach(doc => {
                     const itemData = doc.val();
                     if (typeof itemData === 'object' && itemData !== null) {
                         data.push({ key: doc.key, ...itemData });
                     } else {
                         console.warn("Encountered non-object value in spin history for doc ID:", doc.key, itemData);
                     }
                 });

                 // Sort data by timestamp (descending)
                 data.sort((a, b) => {
                    const tA = (typeof a.timestamp === 'object' && a.timestamp && typeof a.timestamp.seconds === 'number') ? (a.timestamp.seconds * 1000) : (typeof a.timestamp === 'number' ? a.timestamp : 0);
                    const tB = (typeof b.timestamp === 'object' && b.timestamp && typeof b.timestamp.seconds === 'number') ? (b.timestamp.seconds * 1000) : (typeof b.timestamp === 'number' ? b.timestamp : 0);
                    return tB - tA;
                });
                 console.log("Processed and sorted spin history data:", data);


                 if (data.length === 0) {
                     historyListDiv.innerHTML = '<p class="no-history">No valid history items to display after processing.</p>';
                 } else {
                     data.forEach(item => {
                         const itemDiv = document.createElement('div');
                         itemDiv.classList.add('spin-item');

                         let date = null;
                         if (item.timestamp) {
                              if (typeof item.timestamp === 'object' && item.timestamp && typeof item.timestamp.seconds === 'number') { // Firestore-like Timestamp object
                                  date = new Date(item.timestamp.seconds * 1000 + (item.timestamp.nanoseconds || 0) / 1000000);
                              } else if (typeof item.timestamp === 'number') { // RTDB serverTimestamp (milliseconds)
                                  date = new Date(item.timestamp);
                              }
                         }
                         const fDate = date ? date.toLocaleString() : 'N/A';
                         const outcomeType = (item.prizeType || 'unknown').toLowerCase();
                         let oClass = 'outcome-badluck'; // Default color for unknown/badluck
                         if (outcomeType === 'pkr') oClass = 'outcome-win'; // Green for wins

                         let outcomeText = `${item.coinsDeducted} Coins Spent`;
                         if (item.prizeType === 'PKR') outcomeText += ` - Won ${item.pkrAmount || 0} PKR`;
                         else if (item.prizeType === 'Bad Luck') outcomeText += ` - Bad Luck (+${item.coinsAwarded || 0} Coins)`;
                         else outcomeText += ` - Unknown Outcome`;


                         itemDiv.innerHTML = `
<div class="details">
    <span>${outcomeText}</span>
    <span>Result: ${item.resultText || 'N/A'}</span>
</div>
<div class="outcome ${oClass}">${outcomeType}</div>
<div class="date">${fDate}</div>`;
                         historyListDiv.appendChild(itemDiv);
                     });
                 }
             }
         } catch (error) {
             console.error("Error fetching spin history:", error);
             historyListDiv.innerHTML = '<p class="no-history" style="color: red;">Error loading history. Check console.</p>';
             showStatusMessage("Could not load spin history.", "error");
         }
     }


     // --- Invite Logic ---
     function generateRandomCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
     async function redeemInviteCode(code, currentUserId, currentUserData) { console.log(`Redeeming: ${code} by ${currentUserId}`); if (!currentUserId) throw new Error("User ID missing."); if (!code) throw new Error("Enter code."); code = code.trim().toUpperCase(); if (currentUserData?.inviteCode && code === currentUserData.inviteCode) throw new Error("Cannot redeem own code."); if (currentUserData?.referralRedeemed === true) throw new Error("Already redeemed code."); const usersRef = ref(db, "users"); const q = query(usersRef, orderByChild("inviteCode"), equalTo(code)); const snap = await get(q); if (!snap.exists()) throw new Error("Invalid code."); let refUid = null, refData = null; snap.forEach(cs => { if (cs.key !== currentUserId) { refUid = cs.key; refData = cs.val(); } else console.warn("Query found self-match."); }); if (!refUid || !refData) throw new Error("Invalid code."); console.log(`Found referrer: ${refUid}`); const refRefCount = refData.referralCount || 0; const refCoins = refData.totalCoins || 0; const redeemUserCoins = currentUserData.totalCoins || 0; const newRedeemerTotal = redeemUserCoins + REDEEMER_BONUS; const newReferrerTotal = refCoins + REFERRER_BONUS; const newReferrerCount = refRefCount + 1; console.log(`Bonuses: Redeemer +${REDEEMER_BONUS}, Referrer +${REFERRER_BONUS}`); const updates = {}; updates[`/users/${currentUserId}/totalCoins`] = newRedeemerTotal; // Update redeemer coins FIRST
      updates[`/users/${currentUserId}/referralRedeemed`] = true; // Mark redeemer as redeemed
      updates[`/users/${currentUserId}/codeRedeemedFrom`] = refUid; // Store who they redeemed from
      updates[`/users/${refUid}/totalCoins`] = newReferrerTotal; updates[`/users/${refUid}/referralCount`] = newReferrerCount; await update(ref(db), updates); console.log("DB updated for referral redemption."); return { newCoinsForRedeemer: newRedeemerTotal, referrerUid: refUid }; }
     inviteFriendBtn.addEventListener("click", () => { if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; } updateInviteLinkDisplay(); inviteModal.style.display = "block"; });
     closeInviteModal.addEventListener("click", () => { inviteModal.style.display = "none"; });
     copyInviteCode.addEventListener("click", () => { const link = yourInviteLinkDisplay.textContent; if (link && link.startsWith('http') && currentUserInviteCode) { navigator.clipboard.writeText(link).then(() => showStatusMessage("Link copied!", "success")).catch(err => { showStatusMessage("Failed to copy.", "error"); console.error('Copy error:', err); try { const r=document.createRange(); r.selectNodeContents(yourInviteLinkDisplay); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); showStatusMessage("Link selected.", "info", 4000); } catch (e) { console.error("Select fallback fail:", e); } }); } else { showStatusMessage("Link not ready.", "error"); console.warn("Invalid link copy attempt:", link); } });
     redeemCodeBtn.addEventListener("click", async () => { const code = redeemCodeInput.value.trim().toUpperCase(); if (!code) { showStatusMessage("Enter code.", "error"); return; } const user = auth.currentUser; if (!user || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; } redeemCodeBtn.disabled = true; showStatusMessage("Redeeming...", "info"); try { const userRef = ref(db, `users/${user.uid}`); const snap = await get(userRef); if (!snap.exists()) throw new Error("User data not found."); const userData = snap.val(); // Pass current user's data to the function
          const { newCoinsForRedeemer, referrerUid } = await redeemInviteCode(code, user.uid, userData); // This function now handles the update
          console.log(`User ${user.uid} redeemed from ${referrerUid}`); showStatusMessage(`Code redeemed! +${REDEEMER_BONUS} coins.`, "success", 5000); inviteModal.style.display = "none"; redeemCodeInput.value = ""; } catch (e) { console.error("Redeem error:", e); showStatusMessage(`Error: ${e.message}`, "error", 4000); } finally { redeemCodeBtn.disabled = false; } });

     // --- Spin Logic ---
      spinBtn.addEventListener("click", () => {
         if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; }
         if (isSpinning) return; // Prevent double spin
         showInterstitialAd(() => { // Show ad before showing the spin modal
              console.log("Ad callback: Showing spin modal.");
              showSpinModal();
         });
     });

      closeSpin.addEventListener("click", () => {
         if (isSpinning) return; // Don't close during spin
         spinModal.style.display = "none";
         showMainMenu(); // Go back to main menu after closing spin modal
         spinResult.textContent = ""; // Clear last result
         wheel.style.transform = 'rotate(0deg)'; // Reset wheel rotation visually
     });

     function showSpinModal() {
          console.log("Showing Spin Modal...");
          mainMenu.style.display = "none";
          spinModal.style.display = "block";
          updateCoinAndPkrDisplay(); // Update coin/pkr counts in the modal
          updateSpinButtonState(); // Ensure button state is correct when modal opens
          spinResult.textContent = ""; // Clear previous result
          // Ensure WhatsApp button is hidden while modal is open
          if (whatsappBtn) whatsappBtn.style.display = 'none';
     }

      function createWheelSegments() {
          if (wheel.children.length > 0) return; // Don't recreate
          const numSegments = spinPrizes.length;
          spinPrizes.forEach((prize, index) => {
              const segment = document.createElement('div');
              segment.classList.add('wheel-segment', prize.colorClass);
              // Calculate rotation for the segment itself
              const segmentRotation = index * segmentAngle;
              segment.style.setProperty('--segment-deg', `${segmentRotation}deg`);

              // Calculate rotation and position for the text within the segment
              // Text needs to be rotated by segmentRotation + (segmentAngle/2) to be centered and vertical
              // Then adjusted slightly to sit within the triangle slice
              const textRotation = segmentRotation + (segmentAngle / 2);
              // Adjust translation based on how far down the segment the text should be
              const textXOffset = 10; // How far from the center point along the segment's edge
              const textYOffset = 30; // How far from the edge towards the center

              segment.style.setProperty('--text-deg', `${textRotation - 90}deg`); // Rotate text to be upright
              segment.style.setProperty('--text-x', `${textXOffset}px`);
              segment.style.setProperty('--text-y', `${textYOffset}px`);

              segment.setAttribute('data-label', prize.label); // Use data-label for text

              wheel.appendChild(segment);
          });
      }

      spinButton.addEventListener('click', async () => {
          if (isSpinning) return; // Prevent multiple spins
          const user = auth.currentUser;
          if (!user || !currentUsername) { showStatusMessage("Log in to spin.", "error"); return; }
          if (totalCoins < SPIN_COST) { showStatusMessage(`Need ${SPIN_COST - totalCoins} more coins to spin!`, "error", 3000); return; }

          isSpinning = true;
          spinButton.disabled = true;
          spinButton.textContent = "Spinning...";
          spinResult.textContent = ""; // Clear previous result
          playSound(spinSound);

          // 1. Deduct coins
          const newTotalCoins = totalCoins - SPIN_COST;
          console.log(`Deducting ${SPIN_COST} coins. New total: ${newTotalCoins}`);

          try {
               await update(ref(db, `users/${user.uid}`), { totalCoins: newTotalCoins });
               console.log("Coins deducted in DB.");
               // totalCoins will be updated locally via listener

               // 2. Select random prize based on probability
               let randomValue = Math.random() * 100; // 0 to 99.999...
               let cumulativeProbability = 0;
               let winningPrize = null;

              // Sort prizes by angle index for correct calculation if needed, or just use the array index
              // For simpler probability selection, just iterate through the defined probabilities
               for (const prize of spinPrizes) {
                   cumulativeProbability += prize.probability;
                   if (randomValue < cumulativeProbability) {
                       winningPrize = prize;
                       break;
                   }
               }
               if (!winningPrize) { // Fallback if somehow random logic fails (shouldn't happen if probabilities sum to 100)
                   winningPrize = spinPrizes[spinPrizes.length - 1]; // Default to last prize? Or first? Or bad luck?
                   console.warn("Prize selection fallback used.");
               }
               console.log("Selected prize:", winningPrize);

               // 3. Calculate spin angle to land on the prize
               // Find the index of the winning prize
               const winningIndex = spinPrizes.findIndex(p => p.label === winningPrize.label && p.type === winningPrize.type && p.value === winningPrize.value);
               if (winningIndex === -1) { console.error("Winning prize index not found!"); winningIndex = 0; } // Fallback

              // Angle calculation:
              // The wheel starts at 0 degrees, with the pointer at the top (0 degrees).
              // Segments are added starting from 0 degrees counter-clockwise relative to the *right* edge of the segment.
              // A segment at index `i` has its right edge at `i * segmentAngle` degrees from the top-right line (relative to the center).
              // To land the *center* of the segment at the *top* pointer (0 degrees), the wheel needs to rotate so that the pointer aligns with the center of the segment.
              // The center of segment `i` is at `i * segmentAngle + segmentAngle / 2` degrees.
              // The wheel rotates clockwise. To land on the center of segment `i`, the wheel needs to rotate by `360 - (i * segmentAngle + segmentAngle / 2)` degrees.
              // We also want multiple full rotations for visual effect (e.g., 5-10 extra rotations).
              const baseRotation = 360 - (winningIndex * segmentAngle + segmentAngle / 2);
              const extraRotations = 5; // Adjust for desired spin duration/effect
              const totalRotation = baseRotation + (360 * extraRotations);

              // Apply animation
              wheel.style.transition = 'transform 5s cubic-bezier(0.1, 0.8, 0.2, 1)'; // Ensure transition is set
              wheel.style.transform = `rotate(${totalRotation}deg)`;

              // 4. Wait for animation to finish and award prize
              // Use 'transitionend' or a timeout. Timeout is often simpler to manage.
              setTimeout(async () => {
                  console.log("Spin animation finished.");
                  playSound(winSound); // Play a general sound first

                  let coinsAwarded = 0;
                  let pkrAwarded = 0;
                  let resultMsg = "";
                  let outcomeStatus = winningPrize.type === 'PKR' ? 'win' : 'badluck'; // CSS class for result text

                  if (winningPrize.type === 'PKR') {
                      pkrAwarded = winningPrize.value;
                      resultMsg = `You won ${pkrAwarded} PKR!`;
                      playSound(winSound); // Specific win sound
                  } else if (winningPrize.type === 'Bad Luck') {
                      coinsAwarded = winningPrize.value;
                      resultMsg = `Bad Luck! But here are ${coinsAwarded} Coins!`;
                      playSound(loseSound); // Specific lose sound
                  } else {
                      resultMsg = "Unknown prize!";
                      outcomeStatus = 'badluck'; // Treat unknown as bad luck visually
                      playSound(loseSound);
                  }

                  spinResult.textContent = resultMsg;
                  spinResult.className = `spinResult ${outcomeStatus}`; // Apply color class

                  // Update user's PKR and/or Coins in Firebase
                  if (pkrAwarded > 0 || coinsAwarded > 0) {
                      const updates = {};
                      if (pkrAwarded > 0) {
                          updates['totalPkr'] = totalPkr + pkrAwarded; // Use local state + new win
                          console.log(`Awarding ${pkrAwarded} PKR. New total PKR: ${totalPkr + pkrAwarded}`);
                      }
                      if (coinsAwarded > 0) {
                           // This coin update is for 'Bad Luck' only.
                           // The main coin deduction was already done at the start.
                           // We need to read the current totalCoins from RTDB at this point
                           // to avoid overwriting any coins earned *during* the spin animation (unlikely, but safe).
                           // Or, just add to the current local state and the listener will sync.
                           // Let's add to local state and trust the listener to sync.
                           updates['totalCoins'] = totalCoins + coinsAwarded; // Use local state + new win
                           console.log(`Awarding ${coinsAwarded} Coins (Bad Luck). New total Coins: ${totalCoins + coinsAwarded}`);
                      }

                      if (Object.keys(updates).length > 0) {
                           await update(ref(db, `users/${user.uid}`), updates);
                           console.log("User balance updated in DB.");
                           // local state (totalCoins, totalPkr) will be updated via the listener
                      }
                  }

                  // Record the spin in history
                  const historyEntry = {
                      uid: user.uid,
                      timestamp: serverTimestamp(),
                      coinsDeducted: SPIN_COST,
                      prizeType: winningPrize.type,
                      pkrAmount: winningPrize.type === 'PKR' ? winningPrize.value : null,
                      coinsAwarded: winningPrize.type === 'Bad Luck' ? winningPrize.value : null,
                      resultText: winningPrize.label, // Save the exact label shown
                      // Could also save winningIndex and totalRotation for debugging/replay
                  };
                  await push(ref(db, 'spinHistory'), historyEntry);
                  console.log("Spin history recorded.");

              } catch (awardError) {
                   console.error("Error awarding prize or recording history:", awardError);
                   showStatusMessage("Error processing prize.", "error", 5000);
              } finally {
                  // Reset spin state
                  isSpinning = false;
                  spinButton.disabled = false;
                  spinButton.textContent = "Spin (Cost: 10,000 Coins)";
                  updateSpinButtonState(); // Ensure button state is correct
                  updateCoinAndPkrDisplay(); // Ensure displays are updated (listener should handle this, but double-check)

                  // Reset wheel position to avoid accumulating rotation
                  wheel.style.transition = 'none'; // Remove transition for immediate reset
                  wheel.style.transform = `rotate(${totalRotation % 360}deg)`; // Reset to the final angle within 0-360
                  // Force reflow to apply the 'none' transition and new transform immediately
                  // eslint-disable-next-line no-unused-vars
                  const dummy = wheel.offsetWidth;
                  // Re-enable transition for the *next* spin
                  wheel.style.transition = 'transform 5s cubic-bezier(0.1, 0.8, 0.2, 1)';
              }

          } catch (deductionError) {
              console.error("Error deducting coins:", deductionError);
              showStatusMessage("Error deducting coins. Try again.", "error", 5000);
              isSpinning = false;
              spinButton.disabled = false;
              spinButton.textContent = "Spin (Cost: 10,000 Coins)";
              updateSpinButtonState();
               wheel.style.transition = 'none'; wheel.style.transform = 'rotate(0deg)'; // Reset wheel
          }
      });

      // Initial wheel setup
      createWheelSegments();


     // --- Info Modal ---
     infoBtn.addEventListener("click", () => { infoModal.style.display = "block"; });
     closeInfo.addEventListener("click", () => { infoModal.style.display = "none"; });

     // --- Logout ---
     logoutBtn.addEventListener("click", () => { console.log("Logout clicked."); if (isProcessingAuth) return; setAuthProcessing(true); showStatusMessage("Logging out...", "info", 1500); signOut(auth).then(() => { showStatusMessage("Logged out.", "info"); console.log("SignOut ok."); }).catch((e) => { showStatusMessage("Logout error: "+e.message, "error"); console.error("Sign out error:", e); setAuthProcessing(false); }); });

     // --- Game Engine ---
     const ctx = gameCanvas.getContext("2d");
     function resizeCanvas() { gameCanvas.width=window.innerWidth; const bannerHeight=document.getElementById('bannerAdContainer')?.offsetHeight||50; gameCanvas.height=window.innerHeight-bannerHeight; if(gameStarted&&mario){const groundY=gameCanvas.height-50; if(mario.y+mario.height>=groundY-5){mario.y=groundY-mario.height;mario.dy=0;if(mario.isJumping){mario.isJumping=false;canDoubleJump=false;}}} } window.addEventListener("resize", resizeCanvas);
     const imagesToLoad = { character:"https://i.imgur.com/AbfH2aB.png", background:"https://i.imgur.com/xZpZqGt.png", enemy:"https://i.imgur.com/TsR4WXH.png", coin:"https://i.imgur.com/cMQ9X0d.png", platform:"https://i.imgur.com/06ptzal.png" }; const gameImages = {}; let imagesLoadedCount = 0; let totalImagesToLoad = Object.keys(imagesToLoad).length;
     function checkAllImagesLoaded() { imagesLoadedCount++; console.log(`Image loaded (${imagesLoadedCount}/${totalImagesToLoad})`); if (imagesLoadedCount === totalImagesToLoad) { allImagesLoaded = true; console.log("All images loaded."); if(startBtn) startBtn.disabled = false; if(restartBtn) restartBtn.disabled = false; showStatusMessage("Ready!", "success", 1500); } }
     console.log("Loading assets..."); if (startBtn) startBtn.disabled = true; if (restartBtn) restartBtn.disabled = true; showStatusMessage("Loading assets...", "info", 5000); for (const key in imagesToLoad) { gameImages[key] = new Image(); gameImages[key].onload = checkAllImagesLoaded; gameImages[key].onerror = () => { console.error(`Failed load: ${key}`); totalImagesToLoad--; showStatusMessage(`Error loading asset: ${key}.`, "error", 5000); if (startBtn) startBtn.disabled = true; if (restartBtn) restartBtn.disabled = true; }; gameImages[key].src = imagesToLoad[key]; }
     function initGame() { if (!allImagesLoaded) { showStatusMessage("Assets loading...", "info"); return; } console.log("Initializing game..."); resizeCanvas(); bgX = 0; platformX = 0; const groundY = gameCanvas.height - 50; mario = { x: 60, y: groundY - 60, width: 40, height: 60, dy: 0, gravity: 1.6, jumpPower: -22, doubleJumpPower: -18, isJumping: false, onGround: true }; obstacles = []; coins = []; speed = 6; score = 0; gameOver = false; gameStarted = true; lastJumpInputTime = 0; canDoubleJump = false; if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null; playBackgroundMusic(); console.log("Game initialized. Starting loop."); gameLoop(); if (whatsappBtn) whatsappBtn.style.display = 'none'; } // Hide WhatsApp button
     function drawBackground() { if (!gameImages.background?.complete || gameImages.background.naturalHeight === 0) { ctx.fillStyle = '#60a5fa'; ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height); return; }; bgX = (bgX - speed * 0.4) % gameImages.background.width; ctx.drawImage(gameImages.background, bgX, 0, gameImages.background.width, gameCanvas.height); ctx.drawImage(gameImages.background, bgX + gameImages.background.width, 0, gameImages.background.width, gameCanvas.height); }
     function drawPlatform() { if (!gameImages.platform?.complete || gameImages.platform.naturalHeight === 0) { ctx.fillStyle = '#E0A070'; ctx.fillRect(0, gameCanvas.height - 50, gameCanvas.width, 50); return; }; const groundY = gameCanvas.height - 50; platformX = (platformX - speed) % gameImages.platform.width; ctx.drawImage(gameImages.platform, platformX, groundY, gameImages.platform.width, 50); ctx.drawImage(gameImages.platform, platformX + gameImages.platform.width, groundY, gameImages.platform.width, 50); }
     function drawMario() { if(!mario || !gameImages.character?.complete || gameImages.character.naturalHeight === 0) return; ctx.drawImage(gameImages.character, mario.x, mario.y, mario.width, mario.height); }
     function drawObstacles() { if (!gameImages.enemy?.complete || gameImages.enemy.naturalHeight === 0) return; for (let i = obstacles.length - 1; i >= 0; i--){ let obs = obstacles[i]; obs.x -= speed; ctx.drawImage(gameImages.enemy, obs.x, obs.y, obs.width, obs.height); if(obs.x + obs.width < 0) obstacles.splice(i, 1); } }
     function spawnObstacles() { if(gameOver || !gameImages.enemy?.complete || gameImages.enemy.naturalHeight === 0) return; const bMin=350, bMax=650; const dF=Math.max(0.3,1-(score/1000)); const cMin=bMin*dF, cMax=bMax*dF; const dR=Math.max(50,cMax-cMin); const rD=cMin+Math.random()*dR; let lastX=-rD; if(obstacles.length>0) lastX=obstacles[obstacles.length-1].x; if(gameCanvas.width-lastX>rD && obstacles.length<5){ const gY=gameCanvas.height-50; obstacles.push({x:gameCanvas.width+10,y:gY-50,width:50,height:50}); } }
     function spawnCoins() {
         if(!gameImages.coin?.complete || gameImages.coin.naturalHeight === 0 || gameOver) return;
         const spawnChance = 0.014; // REDUCED chance
         const maxGroups = 3;
         if(coins.length < (maxGroups * 2) && Math.random() < spawnChance) {
             const groundY = gameCanvas.height - 50; let startY; const hChance=Math.random();
             if(hChance<0.5) startY=groundY-30; else if(hChance<0.85) startY=groundY-100-(Math.random()*40); else startY=groundY-160-(Math.random()*50);
             let coinCount = Math.floor(Math.random() * 2) + 1; // REDUCED: 1 to 2 coins
             let startX = gameCanvas.width + Math.random() * 150; const spacing = 45;
             for(let i=0; i<coinCount; i++) coins.push({x:startX+i*spacing,y:startY,width:25,height:25});
         }
     }
     function drawCoinsAndCollect() { if (!gameImages.coin?.complete || gameImages.coin.naturalHeight === 0 || !mario || gameOver) return; for (let i = coins.length - 1; i >= 0; i--) { let c = coins[i]; c.x -= speed; ctx.drawImage(gameImages.coin, c.x - c.width / 2, c.y - c.height / 2, c.width, c.height); if (mario.x < c.x + c.width / 2 && mario.x + mario.width > c.x - c.width / 2 && mario.y < c.y + c.height / 2 && mario.y + mario.height > c.y - c.height / 2) { coins.splice(i, 1); score += 1; playSound(coinSound); } else if (c.x + c.width / 2 < 0) coins.splice(i, 1); } }
     function applyPhysics() { if(!mario || gameOver) return; mario.dy += mario.gravity; mario.y += mario.dy; const groundY = gameCanvas.height - 50; if (mario.y + mario.height >= groundY) { mario.y = groundY - mario.height; mario.dy = 0; mario.onGround = true; if(mario.isJumping) { mario.isJumping = false; canDoubleJump = false; } } else mario.onGround = false; if (mario.y < 0) { mario.y = 0; mario.dy = 0; } }
     function checkCollision() { if(!mario || gameOver) return; for(let i = obstacles.length - 1; i >= 0; i--){ let obs = obstacles[i]; const mX=mario.x+5, mY=mario.y+5, mW=mario.width-10, mH=mario.height-10; const oX=obs.x+5, oY=obs.y+5, oW=obs.width-10, oH=obs.height-10; if (mX < oX + oW && mX + mW > oX && mY < oY + oH && mY + mH > oY) { console.log("Collision!"); gameOver = true; stopBackgroundMusic(); break; } } }
     function jump() { if(!gameStarted || gameOver || !mario) return; const now = Date.now(); if (mario.isJumping && !mario.onGround && canDoubleJump && (now - lastJumpInputTime < doubleJumpWindow)) { mario.dy = mario.doubleJumpPower; canDoubleJump = false; lastJumpInputTime = 0; console.log("Double Jump!"); playSound(jumpSound); } else if (mario.onGround) { mario.dy = mario.jumpPower; mario.isJumping = true; mario.onGround = false; canDoubleJump = true; lastJumpInputTime = now; console.log("First Jump!"); playSound(jumpSound); } }
     function gameLoop() {
         if(gameOver || !gameStarted) { if (gameOver) handleGameOver(); return; }
         applyPhysics(); checkCollision(); if (gameOver) { handleGameOver(); return; }
         spawnObstacles(); spawnCoins();
         ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
         drawBackground(); drawPlatform(); drawObstacles(); drawCoinsAndCollect(); drawMario();
         ctx.fillStyle="#FFF";
         ctx.font="18px 'Press Start 2P'"; // Slightly larger score font
         ctx.textAlign="left"; ctx.textBaseline="top"; ctx.shadowColor='rgba(0,0,0,0.8)'; ctx.shadowBlur=5; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2;
         ctx.fillText("Score: " + score, 25, 25); // Draw score with more padding
         ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
         animationFrameId = requestAnimationFrame(gameLoop);
     }
     function handleGameOver() {
         console.log(`Game Over! Score: ${score}`); gameStarted = false; gameOver = true;
         if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
         const user = auth.currentUser;
         if (user && score > 0 && currentUsername) {
             const userRef = ref(db, `users/${user.uid}`);
             // Use update with the locally known totalCoins + score
             // The listener will correct the totalCoins value shortly if needed
             update(userRef, { totalCoins: totalCoins + score })
             .then(() => console.log(`Score submitted. Local state might update soon.`))
             .catch(e => { console.error("Error saving score:", e); showStatusMessage("Error saving score.", "error"); });
         } else if (user && score === 0) { console.log("Score 0, no save needed."); }
         else { console.log("Guest or incomplete profile, score not saved."); }
         showGameOverMenu(); console.log("Game Over Menu shown.");
     }

     // --- Game Control Buttons ---
     startBtn.addEventListener("click", () => { if (!allImagesLoaded) { showStatusMessage("Assets loading...", "info"); return; } if (gameStarted) return; console.log("Start clicked."); showInterstitialAd(() => { console.log("Ad callback: Starting game."); mainMenu.style.display = "none"; gameCanvas.style.display = 'block'; initGame(); }); });
     restartBtn.addEventListener("click", () => { if (!allImagesLoaded) { showStatusMessage("Assets error.", "error"); showMainMenu(); return; } if (gameStarted) return; console.log("Restart clicked."); console.log("Direct restart..."); gameOverMenu.style.display = "none"; gameCanvas.style.display = 'block'; initGame(); });
     backMenuBtn.addEventListener("click", () => { console.log("Back to Menu clicked."); showInterstitialAd(() => { console.log("Ad callback: Showing main menu."); showMainMenu(); }); });

     // --- Jump Listeners ---
     document.addEventListener("keydown", (e) => { if ((e.code === "Space" || e.code === "ArrowUp") && gameStarted && !gameOver) { e.preventDefault(); jump(); } });
     gameCanvas.addEventListener("click", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } });
     gameCanvas.addEventListener("touchstart", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } }, { passive: false });

     // --- Initial Setup on Page Load ---
     function initializeAppUI() {
         console.log("Initializing UI (Google Sign-In)...");
         mainMenu.style.display = "none"; gameCanvas.style.display = "none"; gameOverMenu.style.display = "none"; completeProfileModal.style.display = 'none'; spinModal.style.display = "none"; spinHistoryModal.style.display = "none"; googleSignInPanel.style.display = "flex";
         if (whatsappBtn) whatsappBtn.style.display = 'none'; // Ensure WhatsApp button is hidden initially
         setAuthProcessing(false); updateSoundButton(); updateInviteLinkDisplay(); updateCoinAndPkrDisplay(); updateSpinButtonState();
         if (startBtn) startBtn.disabled = true; if (restartBtn) restartBtn.disabled = true;
         console.log("Initial UI setup complete.");
     }
     initializeAppUI();

   </script>

   <!-- Social Bar Script -->
   <script type='text/javascript' src='//pl26479822.profitableratecpm.com/11/f3/83/11f3830187c378aedebef88b0bcd83a0.js'></script>

 </body>
 </html>
 