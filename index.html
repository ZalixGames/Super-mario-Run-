

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Super Mario Run - Play Online & Earn Money</title>
  <meta name="description" content="Play Super Mario Run online and earn real money. Classic Mario gameplay on browser. No download needed!" />
  <meta name="keywords" content="Super Mario Run, Mario game, Earn money playing, Play Super Mario online, Free Mario Run game, Super Mario browser game" />
  <meta name="author" content="Zalix Games" />
  <meta property="og:title" content="Play Super Mario Run – Earn While You Play!" />
  <meta property="og:description" content="Enjoy classic Mario Run online and earn rewards while having fun!" />
  <meta property="og:image" content="https://supermariorun.site/assets/preview.png" />
  <meta property="og:url" content="https://supermariorun.site" />
  <meta property="og:type" content="website" />
  <meta name="robots" content="index, follow" />


  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#3761bd" />
  <!-- Description already present above, no need to duplicate if identical -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Mario Run" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./20250517_001646.png" />

  <!-- Existing Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />

  <!-- SEO: Structured Data for Video Game -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "VideoGame",
    "name": "Super Mario Run - Play Online & Earn Money",
    "url": "https://supermariorun.site",
    "description": "Play Super Mario Run online and earn real money. Classic Mario gameplay on browser. No download needed!",
    "applicationCategory": "Game",
    "operatingSystem": "Web browser",
    "browserRequirements": "Requires HTML5 Canvas and JavaScript",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "genre": ["Arcade game", "Platform game", "Endless runner"],
    "playMode": "SinglePlayer",
    "publisher": {
      "@type": "Organization",
      "name": "Zalix Games"
    },
    "image": "https://supermariorun.site/assets/preview.png",
    "keywords": "Super Mario Run, Mario game, Earn money playing, Play Super Mario online, Free Mario Run game, Super Mario browser game"
  }
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
  <!-- Ad Script 1 (Placeholder - REMOVED OLD SCRIPT) -->
  <style>
    /* --- CSS Styles --- */
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Press Start 2P', cursive; overflow: hidden;
      background: #050505 url('https://www.transparenttextures.com/patterns/stardust.png'); /* Darker background */
      color: #e0e0e0; /* Slightly off-white text */
      margin-bottom: 50px; /* Space for banner */
    }
    canvas { display: block; background-color: #60a5fa; /* Brighter sky blue */ }
    .text-glow { text-shadow: 0 0 4px #fff, 0 0 8px #fff, 0 0 12px #ff38a1, 0 0 16px #ff38a1; } /* Enhanced Pink Glow */
    .box-glow { box-shadow: 0 0 6px rgba(255, 255, 255, 0.7), 0 0 12px rgba(255, 56, 161, 0.6); } /* Enhanced Pink Glow */

    /* --- Enhanced General Button Styles --- */
    .game-btn {
      padding: 14px 28px; /* Slightly larger padding */
      margin: 10px;
      font-size: 14px; /* Keep font size readable */
      border: none;
      border-radius: 10px; /* Slightly more rounded */
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease; /* Faster transform */
      background: linear-gradient(145deg, #ff5252, #e53935); /* Base Red Gradient */
      color: #ffffff; /* Pure white text */
      font-family: 'Press Start 2P', cursive;
      text-transform: uppercase;
      text-shadow: 2px 2px 3px rgba(0,0,0,0.8); /* Sharper text shadow */
      border-bottom: 5px solid #b71c1c; /* Darker, thicker bottom border */
      box-shadow: 0 5px 8px rgba(0, 0, 0, 0.3); /* Enhanced shadow */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1.3; /* Adjusted line-height */
      text-decoration: none;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    .game-btn:hover:not(:disabled) {
      transform: translateY(-3px) scale(1.04); /* More pronounced hover effect */
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 18px rgba(255, 82, 82, 0.7); /* Enhanced shadow + red glow */
      background: linear-gradient(145deg, #ff6161, #ef5350); /* Slightly brighter hover gradient */
    }
    .game-btn:active:not(:disabled) {
         transform: translateY(1px) scale(1.01); /* Subtle press effect */
         border-bottom-width: 3px; /* Reduce border on press */
         box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3); /* Reduced shadow on press */
    }
    .game-btn:disabled {
        background: linear-gradient(145deg, #666, #444); /* Dark grey gradient */
        cursor: not-allowed;
        border-bottom-color: #222; /* Very dark border */
        box-shadow: none; transform: none; opacity: 0.6; /* More faded */
        color: #aaa; /* Grey text */
        text-shadow: none;
    }

    /* --- Google Sign-in Panel Styles --- */
    #googleSignInPanel {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: url('https://i.imgur.com/nxRZ03R.png') no-repeat center center;
        background-size: cover; background-color: rgba(0, 0, 0, 0.75); /* Slightly darker overlay */
        background-blend-mode: darken; z-index: 100; display: none;
        flex-direction: column; justify-content: center; align-items: center;
        color: #fff; padding: 20px; text-align: center;
    }
     #googleSignInPanel h2 {
        font-size: 2.8em; /* Slightly larger */
        color: #ff38a1; /* Consistent pink */
        margin-bottom: 35px;
        text-shadow: 4px 4px 0px #000, 0 0 18px #ff38a1, 0 0 25px #ff38a1; /* Enhanced text shadow */
    }
    #googleSignInBtn {
        background: linear-gradient(145deg, #4f8ef7, #3678e6); /* Brighter Google blue */
        border-bottom-color: #1a5ac4;
        color: white; width: 300px; /* Slightly wider */
        padding: 16px 28px; /* More padding */
        font-size: 16px;
        display: inline-flex; align-items: center; justify-content: center;
    }
    #googleSignInBtn img { width: 26px; height: 26px; margin-right: 18px; background-color: white; padding: 3px; border-radius: 3px; }
    #googleSignInBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #5a95f8, #4185f4);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(66, 133, 244, 0.7); /* Blue glow on hover */
    }
     #guestButtonAlt {
        background: linear-gradient(145deg, #95a5a6, #7f8c8d); /* Muted grey/blue */
        border-bottom-color: #525e5f;
        width: 300px; margin-top: 15px;
     }
     #guestButtonAlt:hover:not(:disabled) {
         background-image: linear-gradient(145deg, #aab5b6, #95a5a6);
         box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 15px rgba(149, 165, 166, 0.6); /* Grey glow */
     }

    /* --- Main Menu --- */
    #mainMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/KFWJlte.png') no-repeat center center; background-size: cover;
      background-color: rgba(10, 10, 10, 0.6); background-blend-mode: darken; /* Add subtle overlay */
      z-index: 30; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center; padding-top: 90px; /* Adjusted padding */
    }
    /* --- Adjusted Coin Counter Display --- */
    #topRightStatus {
      position: absolute; top: 15px; right: 15px;
      background: rgba(0,0,0,0.88); /* Darker, less transparent */
      padding: 8px 12px; /* Adjusted Padding: Reduced space */
      border-radius: 10px; /* Match button radius */
      font-size: 14px; /* Adjusted Font Size: Smaller text */
      color: #FFD700; /* Keep Gold */
      z-index: 35;
      border: 2px solid #b8860b; /* Darker gold border */
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.6), inset 0 0 5px rgba(0,0,0,0.5); /* Gold glow + inner shadow */
      display: none; /* Handled by JS */
      /* --- Updated to use flex for inline layout --- */
      align-items: center;
       font-family: Arial, sans-serif; /* Use more readable font for numbers */
       line-height: 1.2;
    }
    #topRightStatus img#coinIcon {
      width: 20px; /* Adjusted Image Size: Smaller icon */
      height: 20px; /* Adjusted Image Size: Smaller icon */
      margin-right: 8px; /* Adjusted Margin: Less space between icon and text */
      vertical-align: middle;
      filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.8));
    }
     /* --- New styles for Coin/PKR display --- */
     #topRightStatus > div { /* Use direct child selector for grouping */
         display: inline-block;
         margin-right: 15px; /* Space between coin display and PKR balance */
     }
      #topRightStatus #coinDisplay span {
         font-family: 'Press Start 2P', cursive; /* Game font for coin count */
         color: #FFD700;
      }
      #topRightStatus #pkrValueDisplay {
         font-size: 0.9em; /* Slightly smaller for value */
         color: #ccc; /* Muted color */
          margin-left: 5px; /* Space from coin count */
      }
      #topRightStatus #pkrBalanceDisplay {
         font-size: 1em;
         color: #66bb6a; /* Greenish for PKR Balance */
         font-family: 'Press Start 2P', cursive; /* Game font for balance */
      }
       #topRightStatus #pkrBalanceDisplay span {
            color: #66bb6a; /* Keep green */
       }
    /* --- End Adjusted Coin Counter Display --- */
    #settingsBtn {
      position: absolute; top: 15px; left: 15px; background: rgba(30,30,30,0.85); /* Slightly less dark */
      border: 2px solid #bbb;
      border-radius: 50%; cursor: pointer; z-index: 35; width: 50px; height: 50px; /* Slightly larger */
      display: none;
      justify-content: center; align-items: center; transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    #settingsBtn svg { width: 26px; height: 26px; fill: #ddd; }
    #settingsBtn:hover {
        transform: rotate(60deg) scale(1.12); /* Faster rotation, larger scale */
        box-shadow: 0 0 18px rgba(255,255,255,0.8); /* Brighter glow */
        border-color: #fff;
    }
    #mainMenu .menu-btn { width: 250px; margin-bottom: 18px; } /* Wider buttons, more spacing */
    /* Specific Main Menu Button Colors */
    #mainMenu #startBtn { background: linear-gradient(145deg, #ff5252, #e53935); border-bottom-color: #b71c1c; } /* Base Red */
    #mainMenu #startBtn:hover:not(:disabled) { background: linear-gradient(145deg, #ff6161, #ef5350); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 18px rgba(255, 82, 82, 0.7); }

    #mainMenu #withdrawBtn { background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; display: none; } /* Positive Green */
    #mainMenu #withdrawBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); } /* Green glow */

    #mainMenu #inviteFriend { background: linear-gradient(145deg, #2196f3, #1976d2); border-bottom-color: #0d47a1; display: none; } /* Action Blue */
    #mainMenu #inviteFriend:hover:not(:disabled) { background-image: linear-gradient(145deg, #42a5f5, #1e88e5); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(33, 150, 243, 0.7); } /* Blue glow */

    #mainMenu #infoBtn { background: linear-gradient(145deg, #ffc107, #ffa000); border-bottom-color: #ff6f00; } /* Info Yellow/Amber */
    #mainMenu #infoBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #ffca28, #ffb300); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 193, 7, 0.7); } /* Yellow glow */

    #mainMenu #logoutBtn { background: linear-gradient(145deg, #9e9e9e, #757575); border-bottom-color: #424242; display: none; } /* Neutral Grey */
    #mainMenu #logoutBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #bdbdbd, #9e9e9e); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 15px rgba(158, 158, 158, 0.6); } /* Grey glow */

    /* REMOVED #downloadApkLink styles */

    /* --- Bottom Fixed Buttons (WhatsApp & Spin) --- */
    .fixed-bottom-btn {
       position: fixed;
       bottom: 65px; /* Adjust based on banner height + padding */
       z-index: 900; /* High z-index */
       width: 60px; /* Slightly larger */
       height: 60px;
       border-radius: 50%; /* Circular shape */
       display: none; /* Handled by JS */
       justify-content: center;
       align-items: center;
       box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
       cursor: pointer;
       transition: transform 0.2s ease, box-shadow 0.2s ease;
       text-decoration: none; /* Remove underline */
       border: 3px solid #ccc; /* Default border */
       padding: 5px; /* Padding inside for the image */
    }
    .fixed-bottom-btn img {
        width: 100%; /* Make image fill the button */
        height: 100%;
        object-fit: contain; /* Ensure image is scaled correctly */
         border-radius: 50%; /* Make image circular */
    }
    .fixed-bottom-btn:hover {
       transform: scale(1.15); /* Grow slightly on hover */
       box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5); /* More pronounced shadow */
    }
     .fixed-bottom-btn:active {
         transform: scale(1.05); /* Shrink slightly on click */
         box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
     }

    /* WhatsApp Button Specifics */
     #whatsappBtn {
        right: 20px;
        background-color: #25D366; /* WhatsApp Green */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), 0 0 15px rgba(37, 211, 102, 0.6); /* Shadow and green glow */
        border-color: #128C7E; /* Darker green border */
     }
     #whatsappBtn:hover {
         box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5), 0 0 20px rgba(37, 211, 102, 0.8); /* More pronounced shadow/glow */
     }

     /* Spin Wheel Button Specifics */
     #spinWheelBtn {
         right: 95px; /* Position next to WhatsApp button */
         background-color: #ffc107; /* Amber/Yellow */
         box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), 0 0 15px rgba(255, 193, 7, 0.6); /* Shadow and amber glow */
         border-color: #ff8f00; /* Darker amber border */
     }
     #spinWheelBtn:hover {
         box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 193, 7, 0.8); /* More pronounced shadow/glow */
     }


    /* --- Game Over Menu --- */
    #gameOverMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.88); /* Darker overlay */
      z-index: 40; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: #f44336; /* Consistent Error Red */
      padding: 20px; text-align: center;
    }
    #gameOverMenu h2 {
        font-size: 4.5em; /* Larger text */
        text-shadow: 5px 5px 0px #000, 0 0 25px #ff0000, 0 0 35px #ff0000; /* More intense shadow/glow */
        margin-bottom: 25px;
    }
    #gameOverMenu p {
        font-size: 1.8em; /* Larger score text */
        color: #fff;
        margin-bottom: 15px;
        text-shadow: 2px 2px 4px #000; /* Sharper shadow */
    }
    #gameOverMenu .menu-btn { width: 220px; } /* Standard button size */
    #gameOverMenu #restartBtn {
        background: linear-gradient(145deg, #4caf50, #388e3c); /* Positive Green */
        border-bottom-color: #1b5e20;
    }
    #gameOverMenu #restartBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #66bb6a, #43a047);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); /* Green glow */
    }
    #gameOverMenu #backMenuBtn {
        background: linear-gradient(145deg, #2196f3, #1976d2); /* Action Blue */
        border-bottom-color: #0d47a1;
    }
    #gameOverMenu #backMenuBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #42a5f5, #1e88e5);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(33, 150, 243, 0.7); /* Blue glow */
    }

    /* --- Modal Common Styles --- */
    .modal { display: none; position: fixed; z-index: 70; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(6px); } /* Slightly stronger blur */
    .modal .modal-content {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #212121; /* Darker modal background */
        padding: 25px 30px; /* More padding */
        border-radius: 12px; /* Rounded corners */
        width: 90%; color: #eee; text-align: center; font-family: 'Press Start 2P', cursive;
        border: 4px solid #ff38a1; /* Thicker Pink border */
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 56, 161, 0.5), inset 0 0 10px rgba(0,0,0,0.4); /* Outer shadow + Pink glow + Inner shadow */
        max-height: 85vh; overflow-y: auto;
    }
    .modal h2 {
        margin-bottom: 25px; /* More space */
        font-size: 1.5em; /* Larger title */
        color: #ff38a1; /* Consistent Pink */
        text-shadow: 2px 2px 2px #000, 0 0 8px #ff38a1; /* Sharper shadow + glow */
    }
    .modal button.game-btn { width: 100%; margin: 10px 0; padding: 12px 20px; font-size: 13px; } /* Adjusted modal button size */
    .modal input[type="text"], .modal input[type="email"], .modal input[type="password"] {
        width: 100%; padding: 12px; margin-top: 8px; margin-bottom: 18px; /* Adjusted spacing */
        border: 2px solid #555; border-radius: 8px; /* Rounded input */
        background: #333; color: #fff; font-family: 'Arial', sans-serif; font-size: 16px; outline: none;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .modal input:focus { border-color: #ff38a1; box-shadow: 0 0 10px rgba(255, 56, 161, 0.7); } /* Pink focus glow */
    .close-btn {
        position: absolute; top: 8px; right: 12px; /* Adjusted position */
        background: none; border: none; font-size: 32px; /* Larger close icon */
        cursor: pointer; color: #aaa; font-family: Arial, sans-serif;
        transition: color 0.2s, transform 0.2s; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    .close-btn:hover { color: #ff38a1; transform: scale(1.25) rotate(90deg); } /* Rotate on hover */

    /* --- Specific Modal Sizes --- */
    #settingsModal .modal-content { max-width: 340px; }
    #profileModal .modal-content { max-width: 400px; text-align: left; }
    #inviteModal .modal-content { max-width: 380px; }
    #withdrawModal .modal-content { max-width: 400px; }
    #infoModal .modal-content { max-width: 400px; }
    #withdrawalHistoryModal .modal-content { max-width: 480px; }
    #completeProfileModal .modal-content { max-width: 370px; }
    /* --- Spin Wheel Modal Specific Size --- */
    #spinWheelModal .modal-content { max-width: 450px; padding-bottom: 40px; }


    /* --- Settings Modal Button Styles (Using New Theme Colors) --- */
    #profileBtn { background: linear-gradient(145deg, #ab47bc, #8e24aa); border-bottom-color: #6a1b9a; } /* Purple */
    #toggleSound { background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; } /* Green */
    #customerService { background: linear-gradient(145deg, #2196f3, #1976d2); border-bottom-color: #0d47a1; } /* Blue */
    #withdrawalHistoryBtn { background: linear-gradient(145deg, #ffc107, #ffa000); border-bottom-color: #ff6f00; } /* Amber */
    /* Hover states for settings buttons */
    #profileBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #ba68c8, #9c27b0); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(171, 71, 188, 0.7); }
    #toggleSound:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); }
    #customerService:hover:not(:disabled) { background-image: linear-gradient(145deg, #42a5f5, #1e88e5); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(33, 150, 243, 0.7); }
    #withdrawalHistoryBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #ffca28, #ffb300); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 193, 7, 0.7); }

    /* --- Profile Modal Styles --- */
    #profileModal .modal-content h2 { color: #ab47bc; } /* Purple Title */
    #profileModal .modal-content p {
        margin: 16px 0; /* Increased spacing */
        font-family: 'Arial', sans-serif; /* More readable font */
        font-size: 16px; /* Slightly larger */
        line-height: 1.7; /* Better line spacing */
        color: #ddd; border-bottom: 1px solid #444; padding-bottom: 10px; /* Separator line */
    }
    #profileModal .modal-content p:last-child { border-bottom: none; } /* Remove last border */
    #profileModal .modal-content p strong { color: #fff; display: inline-block; min-width: 130px; /* Wider label */ }
    #profileModal .modal-content span { color: #ffc107; word-break: break-all; font-weight: bold; } /* Amber data */
    #profileInfo { border-top: 1px solid #555; margin-top: 20px; padding-top: 20px; }
     /* Added styles for new profile fields */
    #profileModal .modal-content p span#profile10kStatus { color: #eee; }
    #profileModal .modal-content p span#profileDynamicWithdrawals { color: #eee; }


    /* --- Invite Modal Styles --- */
    #inviteModal .section { margin: 25px 0; border-top: 1px solid #555; padding-top: 20px; }
    #inviteModal .section h3 { font-size: 1.2em; margin-bottom: 12px; color: #eee; text-shadow: 1px 1px 1px #000; }
    #inviteModal .section p { font-size: 1em; margin-bottom: 14px; font-family: Arial, sans-serif; color: #ccc; }
    #inviteModal #yourInviteLinkDisplay {
        font-size: 1.1em; color: #FFD700; background: #383838; padding: 10px 14px; /* More padding */
        border-radius: 6px; display: block; border: 1px solid #666;
        word-break: break-all; text-align: center; margin-bottom: 12px; /* Centered link */
        font-family: monospace; /* Monospace for code feel */
    }
    #copyInviteCode { background: linear-gradient(145deg, #ffc107, #ffa000); border-bottom-color: #ff6f00; } /* Amber */
    #redeemCodeBtn { background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; } /* Green */
    #copyInviteCode:hover:not(:disabled) { background-image: linear-gradient(145deg, #ffca28, #ffb300); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 193, 7, 0.7); }
    #redeemCodeBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); }

    /* --- Withdraw Modal Styles --- */
    #withdrawModal .modal-content p { margin-bottom: 25px; font-family: Arial, sans-serif; line-height: 1.6; font-size: 15px; }
    .withdraw-info {
        font-size: 12px; /* Smaller font */
        color: #bbb; /* Muted color */
        margin-top: -15px; /* Pull up slightly */
        margin-bottom: 20px; /* Add space below */
        font-family: Arial, sans-serif;
        line-height: 1.5;
    }
    .withdraw-info strong { color: #fff; }

    #withdrawModal .redeem-option { /* Inherits from .game-btn, override specifics */
        background: linear-gradient(145deg, #1e88e5, #1565c0); /* Default: Blue (implies action possible) */
        border-bottom: 4px solid #0d47a1;
        color: #fff; padding: 12px 18px; margin: 8px 0; border-radius: 8px;
        font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
        transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
        width: 100%; display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 4px 7px rgba(0, 0, 0, 0.25);
    }
     /* --- Style for the "One-Time" span --- */
    #withdrawModal .redeem-option .one-time-text {
        color: #f44336; /* Error Red */
        margin-left: 8px; /* Space it out */
        font-size: 0.9em; /* Slightly smaller */
         text-shadow: 1px 1px 1px rgba(0,0,0,0.5); /* Add shadow */
    }
    #withdrawModal .redeem-option:hover:not(:disabled) {
        background: linear-gradient(145deg, #42a5f5, #1e88e5); /* Lighter blue hover */
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 7px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(33, 150, 243, 0.6); /* Blue glow */
    }
    #withdrawModal .redeem-option:active:not(:disabled) {
        transform: translateY(1px) scale(1); border-bottom-width: 2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    /* DISABLED options (Coins not met OR 10k already redeemed) */
    #withdrawModal .redeem-option:disabled { /* Use the general disabled style */
        background: linear-gradient(145deg, #666, #444); cursor: not-allowed; border-bottom-color: #222;
        box-shadow: none; transform: none; opacity: 0.6; color: #aaa; text-shadow: none;
    }
     /* PERMANENTLY DISABLED 10k option */
    #withdrawModal .redeem-option.redeemed-once {
        background: linear-gradient(145deg, #666, #444); /* Same as disabled */
        border-bottom-color: #222;
        cursor: not-allowed;
        opacity: 0.5; /* More faded */
        text-decoration: line-through; /* Strike through */
        color: #aaa;
        text-shadow: none;
        box-shadow: none;
        transform: none;
    }
    #withdrawModal .redeem-option.redeemed-once:hover {
         transform: none; /* No hover effect */
         box-shadow: none;
    }
     #withdrawModal .redeem-option.redeemed-once .one-time-text {
          color: #f44336; /* Keep red color */
          text-decoration: none; /* Remove strike-through on just the span */
     }


    /* FULLY AVAILABLE options (Coins AND Referrals met) - HIGHLIGHT */
    #withdrawModal .redeem-option.available-option {
        background: linear-gradient(145deg, #66bb6a, #43a047); /* Brighter Green */
        border-bottom-color: #1b5e20;
        box-shadow: 0 4px 7px rgba(0, 0, 0, 0.25), 0 0 12px rgba(76, 175, 80, 0.5); /* Subtle green glow */
    }
    #withdrawModal .redeem-option.available-option:hover:not(:disabled) {
        background: linear-gradient(145deg, #81c784, #4caf50); /* Lighter green hover */
        box-shadow: 0 7px 12px rgba(0, 0, 0, 0.3), 0 0 18px rgba(76, 175, 80, 0.7); /* Enhanced green glow */
        transform: translateY(-3px) scale(1.02);
    }
     /* --- Style for the "One-Time" span when available --- */
     #withdrawModal .redeem-option.available-option .one-time-text {
          color: #ffeb3b; /* Yellow highlight for one-time available */
     }

    #redeemForm { display: none; margin-top: 25px; font-family: Arial, sans-serif; font-size: 16px; line-height: 1.6; text-align: left; }
    #redeemForm h3 { font-family: 'Press Start 2P', cursive; font-size: 1.3em; color: #eee; margin-bottom: 20px; text-align: center; text-shadow: 1px 1px 1px #000; }
    #referralTaskDisplay {
        margin-bottom: 25px; padding: 12px 18px; border-radius: 8px;
        border: 2px solid #555; background-color: #2c2c2c;
        font-family: 'Press Start 2P', cursive; font-size: 12px; /* Use game font */
        text-align: center; line-height: 1.5; letter-spacing: 0.5px;
    }
    #referralTaskDisplay.task-complete { border-color: #4caf50; color: #66bb6a; background-color: #2e4430; } /* Green theme */
    #referralTaskDisplay.task-incomplete { border-color: #ffa000; color: #ffca28; background-color: #4d3f21; } /* Amber theme */
    #referralTaskDisplay strong { color: #fff; }
    #referralTaskDisplay .status-icon { font-weight: bold; font-size: 1.2em; margin-left: 10px; display: inline-block; vertical-align: middle; }
    #redeemForm label { display: block; margin-bottom: 6px; color: #ccc; font-size: 14px; font-family: 'Press Start 2P', cursive; } /* Use game font for labels */
    #redeemForm input[type="text"] { margin-bottom: 18px; border-radius: 8px; padding: 12px; } /* Match modal input style */
    #redeemForm input[type="radio"] { margin-right: 10px; vertical-align: middle; transform: scale(1.2); /* Larger radio */ }
    #redeemForm label input[type="radio"] { display: inline; margin-bottom: 0; }
    #redeemForm .payment-options label { margin-bottom: 12px; display: block; font-family: Arial, sans-serif; font-size: 15px; } /* Arial for payment options */
    #redeemSubmitBtn {
         background: linear-gradient(145deg, #4caf50, #388e3c); /* Green */
         border-bottom-color: #1b5e20; width: 100%; margin-top: 25px; font-size: 15px; padding: 14px 24px; /* Adjust padding */
     }
    #redeemSubmitBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #66bb6a, #43a047);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); /* Green glow */
    }
    #redeemSubmitBtn:disabled { /* Use general disabled style */
        background: linear-gradient(145deg, #666, #444); cursor: not-allowed; border-bottom-color: #222;
        box-shadow: none; transform: none; opacity: 0.6; color: #aaa; text-shadow: none;
    }

    /* --- Info Modal Styles --- */
    #infoModal .modal-content h2 { color: #2196f3; } /* Blue Title */
    #infoModal .modal-content p { margin: 18px 0; font-family: 'Arial', sans-serif; font-size: 15px; line-height: 1.7; color: #ddd; text-align: left; padding-bottom: 10px; border-bottom: 1px solid #444; }
    #infoModal .modal-content p:last-child { border-bottom: none; }
    #infoModal .modal-content p strong { color: #fff; }
    #infoModal .modal-content .highlight { color: #ffee58; font-weight: bold; /* Brighter Yellow Highlight */ }

    /* --- Withdrawal History Modal Styles --- */
    #withdrawalHistoryModal .modal-content h2 { color: #ffc107; } /* Amber Title */
    #historyList { margin-top: 25px; max-height: 55vh; overflow-y: auto; padding-right: 15px; text-align: left; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6; }
    .history-item { background: #2a2a2a; border: 1px solid #4f4f4f; border-radius: 8px; padding: 14px 18px; margin-bottom: 12px; color: #ccc; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .history-item span { display: block; margin-bottom: 5px; font-size: 13px; }
    .history-item .details { flex-grow: 1; margin-right: 15px; }
    .history-item .details span:first-child { font-weight: bold; color: #eee; font-size: 14px; } /* Highlight amount */
    .history-item .status { font-family: 'Press Start 2P', cursive; font-size: 11px; padding: 5px 10px; border-radius: 5px; text-transform: uppercase; min-width: 90px; text-align: center; margin-top: 5px; font-weight: bold; letter-spacing: 0.5px; }
    .history-item .status-pending { background-color: #ffa000; color: #4d3f21; border: 1px solid #e67e22;} /* Amber */
    .history-item .status-approved { background-color: #4caf50; color: #1b5e20; border: 1px solid #10ac84;} /* Green */
    .history-item .status-rejected { background-color: #f44336; color: #5e141e; border: 1px solid #c0392b;} /* Red */
    .history-item .date { font-size: 11px; color: #999; width: 100%; text-align: right; margin-top: 6px; }
    #historyList .no-history { color: #888; text-align: center; padding: 25px; font-size: 1.1em; font-style: italic;}

     /* --- Complete Profile Modal Styles --- */
    #completeProfileModal .modal-content h2 { color: #4caf50; } /* Green Title */
    #completeProfileModal .modal-content p { margin-bottom: 18px; font-family: Arial, sans-serif; line-height: 1.6; font-size: 15px; text-align: left; color: #ddd; }
    #completeProfileModal .modal-content p.subtle { font-size: 12px; color: #aaa; font-style: italic; margin-top: -12px; }
    #completeProfileModal .modal-content label { font-family: 'Press Start 2P', cursive; font-size: 13px; }
    #completeProfileModal .modal-content input[type="text"] { margin-bottom: 25px; border-radius: 8px; padding: 12px; }
    #completeProfileModal #saveProfileBtn { background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; } /* Green */
    #completeProfileModal #saveProfileBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); }

    /* --- Ad Container Styles --- */
    #bannerAdContainer { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background-color: #080808; z-index: 1000; display: flex; justify-content: center; align-items: center; overflow: hidden; border-top: 3px solid #333; }
    #bannerAdContainer iframe { max-width: 100%; }
    #interstitialAdOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.92); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; font-family: 'Press Start 2P', cursive; padding: 20px; backdrop-filter: blur(4px); }
    #interstitialAdOverlay p#adInfoText { font-size: 1.2em; margin-bottom: 30px; color: #eee; line-height: 1.6; text-shadow: 1px 1px 2px #000; }
    #interstitialAdCloseButton { /* Use game-btn styles */
        padding: 14px 28px; font-size: 1em; cursor: pointer;
        background: linear-gradient(145deg, #f44336, #d32f2f); border-bottom-color: #b71c1c; /* Error Red */
        color: white; border-radius: 10px; font-family: 'Press Start 2P', cursive;
        display: none; text-transform: uppercase; margin-top: 25px;
        text-shadow: 2px 2px 3px rgba(0,0,0,0.8); border: none;
        box-shadow: 0 5px 8px rgba(0, 0, 0, 0.3);
    }
    #interstitialAdCloseButton:hover { /* Match game-btn hover */
        transform: translateY(-3px) scale(1.04);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 18px rgba(244, 67, 54, 0.7); /* Red glow */
        background: linear-gradient(145deg, #ef5350, #e53935);
    }
    #interstitialAdTimer { margin-top: 18px; font-size: 0.9em; color: #bbb; }
    #interstitialAdOverlay p.skip-info { font-size: 0.8em; color: #aaa; margin-top: 35px; font-family: Arial, sans-serif; line-height: 1.5; }

    /* --- Status Message Container --- */
    #statusMessageContainer {
        display: none; position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
        background-color: rgba(10, 10, 10, 0.92); /* Darker background */
        color: white; padding: 14px 28px; /* More padding */
        border-radius: 10px; z-index: 5000; font-family: 'Press Start 2P', cursive; font-size: 1.0em; /* Larger font */
        text-align: center; border: 3px solid #fff; /* Thicker border */
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6); /* Corrected: 5mario to 5px */
        opacity: 0;
        transition: opacity 0.4s ease-in-out, top 0.4s ease-in-out, transform 0.4s ease-in-out; /* Added transform transition */
        max-width: 90%; pointer-events: none; letter-spacing: 0.5px;
    }
    #statusMessageContainer.show {
        display: block; opacity: 1; top: 30px; /* Start slightly higher */
        transform: translateX(-50%) scale(1); /* Scale in */
    }
    /* Status colors matching button themes */
    #statusMessageContainer.success { border-color: #4caf50; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px rgba(76, 175, 80, 0.6); } /* Green */
    #statusMessageContainer.error { border-color: #f44336; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px rgba(244, 67, 54, 0.6); } /* Red */
    #statusMessageContainer.info { border-color: #2196f3; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px rgba(33, 150, 243, 0.6); } /* Blue */

    /* --- Spin Wheel Styles --- */
    .spin-wheel-container {
        position: relative; /* Needed for pointer positioning */
        width: 300px; /* Size of the wheel area */
        height: 300px;
        margin: 0 auto 20px auto; /* Center and space below */
    }

    .wheel {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 10px solid #FFD700; /* Gold border */
        position: relative;
        overflow: hidden; /* Hide segment overflow */
        /* transition handled by JS */
         box-shadow: 0 0 20px rgba(255,215,0,0.7); /* Gold glow */
    }

    .segment {
        position: absolute;
        top: 0;
        right: 0; /* Anchor point for wedges */
        width: 50%; /* Half the circle radius */
        height: 50%;
        transform-origin: 0% 100%; /* Rotate around the center bottom of this half-square */
        box-sizing: border-box;
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Align text towards the tip */
        overflow: hidden; /* Clip text outside segment */
         padding-top: 20px; /* Push text down the segment */
         text-align: center; /* Center text horizontally */
         font-size: 10px; /* Smaller font for segment text */
         font-family: Arial, sans-serif; /* Use readable font */
         font-weight: bold;
         color: #333; /* Dark text for readability */
         border-right: 1px solid #555; /* Visual separators */
         border-bottom: 1px solid #555;
    }
     .segment .prize-text {
         position: absolute;
         transform: rotate(90deg); /* Rotate text to read horizontally */
         white-space: nowrap; /* Prevent text wrapping */
         top: 20px; /* Adjust vertical position */
         left: 50%; /* Center horizontally within the segment's width */
         transform-origin: 0% 0%; /* Rotate around the center of the text block */
     }
      /* Example colors for segments */
     .segment:nth-child(odd) { background-color: #ffcc00; } /* Amber */
     .segment:nth-child(even) { background-color: #ff9900; } /* Darker Amber/Orange */
     /* Use inline style for specific rotation angles */
     .segment:nth-child(1) { transform: rotate(0deg) skewY(45deg); }
     .segment:nth-child(2) { transform: rotate(45deg) skewY(45deg); }
     .segment:nth-child(3) { transform: rotate(90deg) skewY(45deg); }
     .segment:nth-child(4) { transform: rotate(135deg) skewY(45deg); }
     .segment:nth-child(5) { transform: rotate(180deg) skewY(45deg); }
     .segment:nth-child(6) { transform: rotate(225deg) skewY(45deg); }
     .segment:nth-child(7) { transform: rotate(270deg) skewY(45deg); }
     .segment:nth-child(8) { transform: rotate(315deg) skewY(45deg); }


    .pointer {
        position: absolute;
        top: -10px; /* Position above the wheel */
        left: 50%;
        transform: translateX(-50%); /* Center horizontally */
        width: 0;
        height: 0;
        border-left: 15px solid transparent; /* Create triangle shape */
        border-right: 15px solid transparent;
        border-top: 25px solid #f44336; /* Red pointer */
        z-index: 2;
    }

    .spin-info-text {
        margin-top: 10px;
        font-size: 0.9em;
        color: #bbb;
        font-family: Arial, sans-serif;
    }

    .prize-result {
        margin-top: 20px;
        font-size: 1.2em;
        color: #ffeb3b; /* Yellow */
        text-shadow: 2px 2px 2px rgba(0,0,0,0.7);
        min-height: 1.5em; /* Reserve space */
    }

    /* Animation Keyframe (Applied via JS by setting style.transform) */
    /* @keyframes spin {
        to { transform: rotate(CalculatedAngle); }
    } */


    /* --- End of CSS --- */
  </style>

</head>
<body>
  <!-- Status Message Container -->
  <div id="statusMessageContainer"> <span id="statusMessageText"></span> </div>

  <!-- Audio Elements -->
  <audio id="backgroundAudio" loop> <source src="mines background .mp3" type="audio/mp3"> Your browser does not support the audio element. </audio>
  <audio id="jumpSound"> <source src="gruntjumpland-101soundboards.mp3" type="audio/mp3"> </audio>
  <audio id="coinSound"> <source src="coin-recieved-230517.mp3" type="audio/mp3"> </audio>
  <audio id="gameOverSound"> <source src="game-over-arcade-6435.mp3" type="audio/mp3"> </audio>
   <!-- Added Spin sound -->
  <audio id="spinSound"> <source src="spin-sound.mp3" type="audio/mp3"> </audio>
   <!-- Added Win sound -->
  <audio id="winSound"> <source src="win-sound.mp3" type="audio/mp3"> </audio>


  <!-- Google Sign-in Panel -->
  <div id="googleSignInPanel" style="display: flex;">
      <h2>Welcome Gamer!</h2>
      <button id="googleSignInBtn" class="game-btn">
          <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google G Logo"/>
          Sign in with Google
      </button>
      <button id="guestButtonAlt" class="game-btn">Continue as Guest</button>
  </div>

  <!-- Complete Profile Modal -->
  <div id="completeProfileModal" class="modal">
      <div class="modal-content">
          <h2>Complete Your Profile</h2>
          <p>Welcome! Please set your username and optionally enter a referral code.</p>
          <div>
              <label for="profileUsernameInput">Username:</label>
              <input type="text" id="profileUsernameInput" placeholder="Choose a username (min 3 chars)" required />
          </div>
           <div>
              <label for="profileReferralInput">Referral Code (Optional):</label>
              <input type="text" id="profileReferralInput" placeholder="Enter friend's code" />
              <p class="subtle">Enter a code to get a bonus!</p>
          </div>
          <button id="saveProfileBtn" class="game-btn">Save and Play</button>
      </div>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas" style="display: none;"></canvas>

  <!-- Main Menu -->
  <div id="mainMenu" style="display: none;">
     <button id="settingsBtn" title="Open Settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M487.4 315.7l-42.1-24.3c2.8-12.8 4.3-26 4.3-39.4s-1.5-26.6-4.3-39.4l42.1-24.3c9.4-5.4 13.3-17.1 9.4-27.2l-45.3-78.4c-3.9-10.1-14.2-14.8-24.7-11.5l-49.5 19.9c-20.5-16.1-43-29.2-67.2-38.1l-7.5-52.8C309 3.7 300.3-2.5 290.3.1l-90.6 18.5c-10 2.1-17.6 9.9-19.8 19.8l-7.5 52.8c-24.3 8.9-46.8 22-67.2 38.1L54.6 83.1c-10.5-3.3-20.8.4-24.7 11.5L-15.4 172.9c-3.9 10.1-.1 21.8 9.4 27.2l42.1 24.3C73.5 243.3 72 256.4 72 269.9c0 13.5 1.5 26.6 4.3 39.4l-42.1 24.3c-9.4 5.4-13.3 17.1-9.4 27.2l45.3 78.4c3.9 10.1 14.2 14.8 24.7 11.5l49.5-19.9c20.5 16.1 43 29.2 67.2 38.1l7.5 52.8c2 10 10.7 15.3 20.7 12.8l90.6-18.5c10-2.1 17.6 9.9 19.8-19.8l7.5-52.8c24.3-8.9 46.8-22 67.2-38.1l49.5 19.9c10.5 3.3 20.8-.4 24.7-11.5l45.3-78.4c3.9-10.1.1 21.8-9.4-27.2zM256 336c-44.2 0-80-35.8-80-80s35.8-80 80-80c44.2 0 80 35.8 80 80s-35.8 80-80 80z"></path></svg>
     </button>
     <div id="topRightStatus">
          <img id="coinIcon" src="https://i.imgur.com/PCDgdlS.png" alt="Coin">
          <div id="coinDisplay">Coins: <span id="menuCoinCount">0</span></div>
          <div id="pkrValueDisplay">(<span id="menuPkrValue">0.00</span> PKR Value)</div>
          <div id="pkrBalanceDisplay">PKR Balance: <span id="menuPkrBalance">0</span></div>
     </div>
     <button id="startBtn" class="menu-btn game-btn">Play Now</button>
     <button id="withdrawBtn" class="menu-btn game-btn">Withdraw Coins</button>
     <button id="inviteFriend" class="menu-btn game-btn">Invite (0)</button>
     <button id="infoBtn" class="menu-btn game-btn">Game Info</button>
     <!-- REMOVED: Download APK Button -->
     <button id="logoutBtn" class="menu-btn game-btn">Exit</button>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeSettings">×</button>
      <h2>Settings</h2>
      <button id="profileBtn" class="game-btn">View Profile</button>
      <button id="toggleSound" class="game-btn">Sound: On</button>
      <button id="withdrawalHistoryBtn" class="game-btn">Withdrawal History</button>
      <button id="customerService" class="game-btn">Customer Service</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
      <div class="modal-content">
          <button class="close-btn" id="closeProfileModal">×</button>
          <h2>Gamer Profile</h2>
          <div id="profileInfo">
              <p><strong>Username:</strong> <span id="profileUsername">...</span></p>
              <p><strong>Email:</strong> <span id="profileEmail">...</span></p>
              <p><strong>Total Coins:</strong> <span id="profileTotalCoins">...</span></p>
               <!-- Added PKR Balance to Profile -->
              <p><strong>PKR Balance:</strong> <span id="profilePkrBalance">...</span></p>
              <p><strong>Referrals:</strong> <span id="profileReferralCount">...</span></p>
              <p><strong>Your Code:</strong> <span id="profileInviteCode">...</span></p>
              <p><strong>Joined:</strong> <span id="profileJoinedDate">...</span></p>
               <!-- Added fields for withdrawal status -->
              <p><strong>10k Redeemed:</strong> <span id="profile10kStatus">...</span></p>
               <p><strong>Dynamic Withdrawals:</strong> <span id="profileDynamicWithdrawals">...</span></p>
          </div>
      </div>
  </div>

  <!-- Invite Modal -->
  <div id="inviteModal" class="modal">
      <div class="modal-content">
          <button class="close-btn" id="closeInviteModal">×</button>
          <h2>Invite Friend</h2>
          <div class="section">
              <h3>Your Invite Link</h3>
              <div id="yourInviteLinkDisplay">Generating link...</div>
              <button id="copyInviteCode" class="game-btn">Copy Link</button>
          </div>
          <div class="section">
              <h3>Redeem Invite Code</h3>
              <input type="text" id="redeemCodeInput" placeholder="Enter friend's code" />
              <button id="redeemCodeBtn" class="game-btn">Redeem</button>
          </div>
      </div>
  </div>

  <!-- Game Over Overlay -->
  <div id="gameOverMenu" style="display: none;">
      <h2>Game Over</h2>
      <p>Session Coins: <span id="sessionCoinCount">0</span></p>
      <p>Total Coins: <span id="finalTotalCoins">0</span></p>
      <button id="restartBtn" class="menu-btn game-btn">Restart</button>
      <button id="backMenuBtn" class="menu-btn game-btn">Back to Menu</button>
  </div>

  <!-- Withdraw Modal -->
  <div id="withdrawModal" class="modal">
     <div class="modal-content">
         <button class="close-btn" id="closeWithdraw">×</button>
         <h2>Redeem Coins</h2>
          <p class="withdraw-info">
              The 10k Coin option is a <strong>one-time</strong> withdrawal.
              <br>Higher tiers require referrals, and each successful withdrawal (above 10k) adds <strong>one more referral</strong> needed for future withdrawals.
          </p>
         <div id="redeemOptions">
             <!-- The 10k option - Added span for styling -->
             <button class="redeem-option" data-coins="10000" data-pkr="100">10k Coins - 100 PKR <span class="one-time-text">(One-Time)</span></button>
             <!-- Other options triggering dynamic referral increase -->
             <button class="redeem-option" data-coins="30000" data-pkr="300">30k Coins - 300 PKR</button>
             <button class="redeem-option" data-coins="50000" data-pkr="500">50k Coins - 500 PKR</button>
             <button class="redeem-option" data-coins="80000" data-pkr="800">80k Coins - 800 PKR</button>
             <button class="redeem-option" data-coins="100000" data-pkr="1000">100k Coins - 1000 PKR</button>
             <button class="redeem-option" data-coins="500000" data-pkr="5000">500k Coins - 5000 PKR</button>
         </div>
         <div id="redeemForm" style="display: none;">
             <h3>Enter Details</h3>
             <!-- Referral Task Display -->
             <div id="referralTaskDisplay">
                <!-- Content dynamically set by JS -->
             </div>
             <!-- End Referral Task Display -->
             <form id="redeemDetailsForm">
                 <div><label for="accountHolderName">Account Name:</label><input type="text" id="accountHolderName" required /></div>
                 <div><label for="accountNumber">Account Number:</label><input type="text" id="accountNumber" required /></div>
                 <div class="payment-options" style="margin-top: 15px;">
                     <label>Method:</label>
                     <label><input type="radio" name="paymentMethod" value="JazzCash" required> JazzCash</label>
                     <label><input type="radio" name="paymentMethod" value="EasyPaisa" required> EasyPaisa</label>
                 </div>
                 <button type="submit" id="redeemSubmitBtn" class="game-btn">Submit Request</button>
             </form>
         </div>
     </div>
  </div>

  <!-- Game Info Modal -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeInfo">×</button>
      <h2>Game Info</h2>
      <p>Welcome to <strong>Mario Run Earn Real Money</strong>! Run, jump, collect coins, and avoid obstacles.</p>
      <p><strong>Login:</strong> Use your Google Account to Sign in and save your progress.</p>
      <p><strong>Guest Play:</strong> Play for fun without saving coins. Great for practice!</p>
      <p><strong>Bonuses:</strong>
          <br>- Get <strong class="highlight">100 Coins</strong> just for signing up!
          <br>- Invite friends using your unique link (find it in the Invite menu).
          <br>- When your friend signs up using your code, they get an <strong class="highlight">extra 100 Coins</strong> (total 200 start!), and YOU get <strong class="highlight">200 Coins!</strong>
          <br>- Existing users can also redeem a code once for a <strong class="highlight">100 Coin</strong> bonus.
          <br>- Try your luck on the <strong class="highlight">Spin Wheel</strong>! Costs 100 Coins per spin for a chance to win coins or PKR!
      </p> <!-- Updated info text -->
      <p><strong>Withdrawals:</strong> Redeem your earned coins for real rewards via JazzCash or EasyPaisa. <strong class="highlight">Withdrawals require meeting coin and referral tasks.</strong> The 10k PKR option is one-time. Higher tiers require additional referrals for each successful withdrawal. Check the Withdraw menu for details.</p> <!-- Updated info text -->
      <p><strong>Profile:</strong> Check your stats, email, and invite code in Settings > View Profile.</p>
      <!-- REMOVED INFO ABOUT DOWNLOAD APP -->
    </div>
  </div>

  <!-- Withdrawal History Modal -->
  <div id="withdrawalHistoryModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeHistoryModal">×</button>
      <h2>Withdrawal History</h2>
      <div id="historyList"> <p class="no-history">Loading...</p> </div>
    </div>
  </div>

    <!-- Spin Wheel Modal -->
    <div id="spinWheelModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" id="closeSpinWheel">×</button>
            <h2>Spin to Win!</h2>
            <div class="spin-wheel-container">
                <div class="pointer"></div>
                <div class="wheel">
                    <!-- Segments will be dynamically created or styled via CSS -->
                    <!-- For 8 segments (45 deg each), we can pre-define divs and rotate them -->
                     <div class="segment" style="--rotation: 0deg;"><div class="prize-text">100 Coins</div></div>
                     <div class="segment" style="--rotation: 45deg;"><div class="prize-text">1 PKR</div></div>
                     <div class="segment" style="--rotation: 90deg;"><div class="prize-text">200 Coins</div></div>
                     <div class="segment" style="--rotation: 135deg;"><div class="prize-text">5 PKR</div></div>
                     <div class="segment" style="--rotation: 180deg;"><div class="prize-text">500 Coins</div></div>
                     <div class="segment" style="--rotation: 225deg;"><div class="prize-text">50 PKR</div></div>
                     <div class="segment" style="--rotation: 270deg;"><div class="prize-text">1000 Coins</div></div>
                     <div class="segment" style="--rotation: 315deg;"><div class="prize-text">100 PKR</div></div>

                </div>
            </div>
            <p class="spin-info-text">Cost: 100 Coins per spin</p>
            <p class="prize-result" id="spinPrizeResult"></p>
            <button id="spinBtn" class="game-btn">Spin Now!</button>
        </div>
    </div>


  <!-- AD INTEGRATION -->
  <div id="bannerAdContainer">
    <script type="text/javascript">
        atOptions = {
            'key' : '34daa95d37aa866e4d5dc188a89f19b2',
            'format' : 'iframe',
            'height' : 50,
            'width' : 320,
            'params' : {}
        };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/34daa95d37aa866e4d5dc188a89f19b2/invoke.js"></script>
  </div>
  <div id="interstitialAdOverlay" style="display: none;">
      <p id="adInfoText">Loading ad...</p>
      <div id="interstitialAdTimer"></div>
      <button id="interstitialAdCloseButton" class="game-btn">Skip Ad</button>
      <p class="skip-info">(Click 'Skip Ad' or close ad tab manually if needed)</p>
  </div>

    <!-- WhatsApp Button -->
    <a href="https://whatsapp.com/channel/0029VbAKXCi2ER6lhPezY50a" target="_blank" id="whatsappBtn" class="fixed-bottom-btn" title="Join our WhatsApp Channel">
        <img src="https://i.imgur.com/d2UlLQN.png" alt="WhatsApp Icon"> <!-- CORRECTED IMAGE LINK -->
    </a>

    <!-- Spin Wheel Button -->
    <button id="spinWheelBtn" class="fixed-bottom-btn" title="Spin to Win!">
        <img src="https://i.imgur.com/xxxxxxx.png" alt="Spin Icon"> <!-- Placeholder - Replace with actual Spin Wheel icon -->
    </button>


  <!-- Firebase and Game Scripts -->
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, query, orderByChild, equalTo, onValue, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

    // --- DOM Element References ---
    const googleSignInPanel = document.getElementById('googleSignInPanel');
    const googleSignInBtn = document.getElementById('googleSignInBtn');
    const guestButtonAlt = document.getElementById('guestButtonAlt');
    const completeProfileModal = document.getElementById('completeProfileModal');
    const profileUsernameInput = document.getElementById('profileUsernameInput');
    const profileReferralInput = document.getElementById('profileReferralInput');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const mainMenu = document.getElementById('mainMenu');
    const gameOverMenu = document.getElementById('gameOverMenu');
    const gameCanvas = document.getElementById('gameCanvas');
    const settingsModal = document.getElementById('settingsModal');
    const profileModal = document.getElementById('profileModal');
    const inviteModal = document.getElementById('inviteModal');
    const withdrawModal = document.getElementById('withdrawModal');
    const infoModal = document.getElementById('infoModal');
    const withdrawalHistoryModal = document.getElementById('withdrawalHistoryModal');
    const historyListDiv = document.getElementById('historyList');
    const interstitialAdOverlay = document.getElementById('interstitialAdOverlay');
    const interstitialAdCloseButton = document.getElementById('interstitialAdCloseButton');
    const interstitialAdTimer = document.getElementById('interstitialAdTimer');
    const adInfoText = document.getElementById('adInfoText');
    // --- Updated top-right status display references ---
    const topRightStatus = document.getElementById('topRightStatus');
    const menuCoinCountSpan = document.getElementById('menuCoinCount');
    const menuPkrValueSpan = document.getElementById('menuPkrValue');
    const menuPkrBalanceSpan = document.getElementById('menuPkrBalance');

    const finalTotalCoinsSpan = document.getElementById('finalTotalCoins');
    const sessionCoinCountSpan = document.getElementById('sessionCoinCount');
    const inviteFriendBtn = document.getElementById('inviteFriend');
    const yourInviteLinkDisplay = document.getElementById('yourInviteLinkDisplay');
    const redeemCodeInput = document.getElementById("redeemCodeInput");
    const toggleSoundBtn = document.getElementById("toggleSound");
    const redeemOptionsDiv = document.getElementById("redeemOptions");
    const redeemFormDiv = document.getElementById("redeemForm");
    const redeemDetailsForm = document.getElementById("redeemDetailsForm");
    const redeemSubmitBtn = document.getElementById('redeemSubmitBtn');
    const withdrawalHistoryBtn = document.getElementById('withdrawalHistoryBtn');
    const closeHistoryModalBtn = document.getElementById('closeHistoryModal');
    const profileBtn = document.getElementById('profileBtn');
    const closeProfileModalBtn = document.getElementById('closeProfileModal');
    const profileUsernameSpan = document.getElementById('profileUsername');
    const profileEmailSpan = document.getElementById('profileEmail');
    const profileTotalCoinsSpan = document.getElementById('profileTotalCoins');
     // Added reference for PKR Balance in Profile
    const profilePkrBalanceSpan = document.getElementById('profilePkrBalance');

    const profileReferralCountSpan = document.getElementById('profileReferralCount');
    const profileInviteCodeSpan = document.getElementById('profileInviteCode');
    const profileJoinedDateSpan = document.getElementById('profileJoinedDate');
    const profile10kStatusSpan = document.getElementById('profile10kStatus');
    const profileDynamicWithdrawalsSpan = document.getElementById('profileDynamicWithdrawals');

    const statusMessageContainer = document.getElementById('statusMessageContainer');
    const statusMessageText = document.getElementById('statusMessageText');
    let statusMessageTimeoutId = null;
    const backgroundAudio = document.getElementById("backgroundAudio");
    const jumpSound = document.getElementById("jumpSound");
    const coinSound = document.getElementById("coinSound");
    const gameOverSound = document.getElementById("gameOverSound");
     // Added Spin Wheel sounds
    const spinSound = document.getElementById("spinSound");
    const winSound = document.getElementById("winSound");

    const settingsBtn = document.getElementById('settingsBtn');
    const closeSettings = document.getElementById('closeSettings');
    const infoBtn = document.getElementById('infoBtn');
    const closeInfo = document.getElementById('closeInfo');
    const copyInviteCode = document.getElementById('copyInviteCode');
    const redeemCodeBtn = document.getElementById('redeemCodeBtn');
    const closeInviteModal = document.getElementById('closeInviteModal');
    const withdrawBtn = document.getElementById('withdrawBtn');
    const closeWithdraw = document.getElementById('closeWithdraw');
    const logoutBtn = document.getElementById('logoutBtn');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const backMenuBtn = document.getElementById('backMenuBtn');
    const customerService = document.getElementById('customerService');
    const accountHolderName = document.getElementById('accountHolderName');
    const accountNumber = document.getElementById('accountNumber');
    const referralTaskDisplay = document.getElementById('referralTaskDisplay');
    const whatsappBtn = document.getElementById('whatsappBtn');
     // Added Spin Wheel DOM references
    const spinWheelBtn = document.getElementById('spinWheelBtn');
    const spinWheelModal = document.getElementById('spinWheelModal');
    const closeSpinWheelBtn = document.getElementById('closeSpinWheel');
    const wheelElement = document.querySelector('#spinWheelModal .wheel');
    const spinBtn = document.getElementById('spinBtn');
    const spinPrizeResultSpan = document.getElementById('spinPrizeResult');


    const firebaseConfig = {
      // --- Your Firebase Config --- // Copied from original
      apiKey: "AIzaSyCpheUGTtliJyTXjVlm1VnfvGTbaeykQ7E", authDomain: "super-mario-earn-real-money.firebaseapp.com",
      databaseURL: "https://super-mario-earn-real-money-default-rtdb.firebaseio.com", projectId: "super-mario-earn-real-money",
      storageBucket: "super-mario-earn-real-money.firebasestorage.app", messagingSenderId: "527750706733",
      appId: "1:527750706733:web:71f31dc125468ca645eaa4", measurementId: "G-Z25ZFF8PWT"
      // --- End Firebase Config --- //
    };

    // --- Firebase Initialization ---
    let appFirebase, db, auth;
    try {
        appFirebase = initializeApp(firebaseConfig);
        db = getDatabase(appFirebase);
        auth = getAuth();
        console.log("Firebase initialized successfully.");
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        showStatusMessage("Connection error. Cannot initialize.", "error", 10000);
        if (googleSignInBtn) googleSignInBtn.disabled = true;
        if (guestButtonAlt) guestButtonAlt.disabled = true;
    }

    // --- Global State ---
    let totalCoins = 0, totalPKR = 0, soundEnabled = true, currentUserInviteCode = null, currentUsername = null; // Added totalPKR
    let currentReferralCount = 0, currentJoinedDate = null, gameStarted = false, gameOver = false;
    let hasRedeemed10kOnce = false;
    let successfulDynamicWithdrawals = 0;

    let score = 0, mario, obstacles, coins, speed, bgX, platformX;
    let lastJumpInputTime = 0; const doubleJumpWindow = 350; let canDoubleJump = false;
    let animationFrameId = null, allImagesLoaded = false, isProcessingAuth = false;
    let userDataListenerUnsubscribe = null; // Renamed listener variable
    let profileCompleteListener = null;

    // --- Constants ---
    const SIGNUP_BONUS = 100;
    const REFERRER_BONUS = 200;
    const REDEEMER_BONUS = 100;
    const SPIN_COST = 100; // Cost to spin the wheel
    const COIN_TO_PKR_RATE = 0.01; // 1000 Coins = 10 PKR => 1 Coin = 0.01 PKR
    const baseInviteUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
    const withdrawalRequirements = { // Coin amount: base required referrals
        10000: 5,
        30000: 10,
        50000: 20,
        80000: 30,
        100000: 40,
        500000: 50
    };

     // Spin Wheel Prizes and Weights
     // Weights sum: 90+80+50+30+10+1+5+0.5 = 266.5
    const prizes = [
        { name: "100 Coins", type: "coins", value: 100, weight: 90 }, // ~33.8%
        { name: "1 PKR", type: "pkr", value: 1, weight: 80 },       // ~30.0%
        { name: "200 Coins", type: "coins", value: 200, weight: 50 },  // ~18.7%
        { name: "5 PKR", type: "pkr", value: 5, weight: 30 },        // ~11.2%
        { name: "500 Coins", type: "coins", value: 500, weight: 10 },  // ~3.75%
        { name: "50 PKR", type: "pkr", value: 50, weight: 1 },       // ~0.375%
        { name: "1000 Coins", type: "coins", value: 1000, weight: 5 }, // ~1.87%
        { name: "100 PKR", type: "pkr", value: 100, weight: 0.5 }    // ~0.187%
    ];
    const segments = prizes.map(p => p.name); // Order matters for segment mapping and display
    const segmentAngle = 360 / segments.length; // 360 / 8 = 45 degrees per segment
    const spinDuration = 5000; // milliseconds
    let isSpinning = false;


    // --- Status Message Function ---
    function showStatusMessage(message, type = 'info', duration = 3000) {
        if (statusMessageTimeoutId) { clearTimeout(statusMessageTimeoutId); statusMessageContainer.classList.remove('show'); }
        console.log(`Status [${type}]: ${message}`);
        statusMessageText.textContent = message;
        statusMessageContainer.className = 'statusMessageContainer'; statusMessageContainer.classList.add(type);
        statusMessageContainer.style.display = 'block'; statusMessageContainer.style.top = '15px'; statusMessageContainer.style.transform = 'translateX(-50%) scale(0.9)';
        void statusMessageContainer.offsetWidth; statusMessageContainer.classList.add('show');
        statusMessageTimeoutId = setTimeout(() => {
            statusMessageContainer.classList.remove('show'); statusMessageTimeoutId = null;
            setTimeout(() => { if (!statusMessageContainer.classList.contains('show')) statusMessageContainer.style.display = 'none'; }, 400);
        }, duration);
    }

    // --- AD INTEGRATION ---
    const directLinkUrl = "https://www.profitableratecpm.com/zi30dfhjnn?key=b78830ea0cb80a28c4b278ee2e122b06";
    let adCloseTimerInterval; let adCloseTimeout; let currentAdCallback = null;
    function showInterstitialAd(callback) {
         console.log("Attempting to show Interstitial Ad...");
         if (typeof callback !== 'function') { console.error("Invalid ad callback."); return; }
         currentAdCallback = callback; adInfoText.textContent = "Ad loading...";
         interstitialAdOverlay.style.display = 'flex'; interstitialAdCloseButton.style.display = 'none'; interstitialAdTimer.textContent = "";
         let adWindow = null; try { adWindow = window.open(directLinkUrl, '_blank'); } catch (e) { console.error("Error opening ad window:", e); }
         if (!adWindow) { console.warn("Pop-up blocked."); showStatusMessage("Ad might be blocked.", "info"); interstitialAdOverlay.style.display = 'none'; if (currentAdCallback) { try { currentAdCallback(); } catch (e) { console.error("Error in ad callback after block:", e); } } currentAdCallback = null; return; }
         let secondsRemaining = 3; interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`;
         if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
         adCloseTimerInterval = setInterval(() => { secondsRemaining--; if (secondsRemaining > 0) interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`; else { interstitialAdTimer.textContent = "Skip available"; clearInterval(adCloseTimerInterval); } }, 1000);
         adCloseTimeout = setTimeout(() => { interstitialAdCloseButton.style.display = 'inline-flex'; if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); interstitialAdTimer.textContent = "Skip available"; }, secondsRemaining * 1000 + 100);
    }
    interstitialAdCloseButton.addEventListener('click', () => {
         console.log("Ad Skip Button clicked."); interstitialAdOverlay.style.display = 'none';
         if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
         interstitialAdTimer.textContent = "";
         if (typeof currentAdCallback === 'function') { console.log("Executing ad callback after skip."); try { currentAdCallback(); } catch(e) { console.error("Error in ad callback:", e); showStatusMessage("Error proceeding.", "error"); } currentAdCallback = null; }
         else { console.warn("No ad callback found after skipping."); }
    });

    // --- Sound Functions ---
    function playSound(audioElement) { if (soundEnabled && audioElement) { try { audioElement.currentTime=0; audioElement.play().catch(e=>console.warn(`Sound play error (${audioElement.id}):`, e)); } catch(e) { console.warn("Sound play failed:", e); } } }
    function playBackgroundMusic() { if (soundEnabled && backgroundAudio && backgroundAudio.paused) { backgroundAudio.play().catch(e=>console.warn("Background music play failed:",e)); } }
    function stopBackgroundMusic() { if (backgroundAudio && !backgroundAudio.paused) { backgroundAudio.pause(); backgroundAudio.currentTime=0; } }

    // --- Authentication Logic ---
    function setAuthProcessing(isProcessing) {
        console.log(`Setting Auth Processing: ${isProcessing}`); isProcessingAuth = isProcessing;
        if(googleSignInBtn) googleSignInBtn.disabled = isProcessing;
        if(guestButtonAlt) guestButtonAlt.disabled = isProcessing;
        if(saveProfileBtn) saveProfileBtn.disabled = isProcessing;
        if(logoutBtn) logoutBtn.disabled = isProcessing;
        if(spinBtn) spinBtn.disabled = isProcessing || isSpinning; // Disable spin button if auth processing OR already spinning
    }

    async function handleGoogleSignInSuccess(userCredential) {
        const user = userCredential.user;
        console.log(`Google Sign-In Success for: ${user.uid}. Checking profile...`);
        setAuthProcessing(true); // Indicate auth process is running
        try {
            const userRef = ref(db, `users/${user.uid}`); const snapshot = await get(userRef);
            if (snapshot.exists() && snapshot.val().username) {
                console.log("Existing user with username found.");
                showStatusMessage(`Welcome back!`, "success", 2000);
                showInterstitialAd(async () => {
                    try {
                        await loadUserData(user.uid);
                        setupUserDataListener(user.uid); // Renamed listener
                        showMainMenu();
                        checkUrlForReferral();
                    } catch (loadError) {
                        console.error("Failed to load user data after ad:", loadError);
                        showStatusMessage("Error loading profile data.", "error");
                        // Decide if you want to sign out on data load failure or just show limited UI
                         signOut(auth).catch(e => console.error("Sign out error:", e)); // Log out on critical error
                    } finally {
                        setAuthProcessing(false); // End auth processing
                    }
                });
            } else {
                console.log("New user or profile incomplete.");
                showStatusMessage("Complete your profile.", "info", 3000);
                profileUsernameInput.value = user.displayName || ""; profileReferralInput.value = "";
                const urlParams = new URLSearchParams(window.location.search); const refCode = urlParams.get('ref');
                 if (refCode) { profileReferralInput.value = refCode.trim().toUpperCase(); console.log("Referral code pre-filled."); const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname; window.history.replaceState({path:cleanUrl},'',cleanUrl); }
                completeProfileModal.style.display = "block"; googleSignInPanel.style.display = "none";
                if(profileCompleteListener) saveProfileBtn.removeEventListener('click', profileCompleteListener);
                profileCompleteListener = createProfileCompletionHandler(user); saveProfileBtn.addEventListener('click', profileCompleteListener);
                setAuthProcessing(false); // End auth processing
            }
        } catch (error) {
            console.error("Error checking user existence after Google Sign-in:", error);
            showStatusMessage("Error verifying profile data.", "error");
            // Ensure they are signed out if profile check fails after successful auth
             signOut(auth).catch(e => console.error("Sign out error:", e));
            setAuthProcessing(false); // End auth processing
        }
    }

    function createProfileCompletionHandler(user) {
        return async () => {
            if (isProcessingAuth) return; // Prevent double click
            const chosenUsername = profileUsernameInput.value.trim(); const referralCode = profileReferralInput.value.trim().toUpperCase();
            if (chosenUsername.length < 3) { showStatusMessage("Username must be >= 3 chars.", "error"); return; }
            if (!/^[a-zA-Z0-9_]+$/.test(chosenUsername)) { showStatusMessage("Invalid username characters.", "error"); return; }
            console.log(`Saving profile for ${user.uid}. User: ${chosenUsername}, Ref: ${referralCode}`);
            setAuthProcessing(true); saveProfileBtn.disabled = true; showStatusMessage("Creating profile...", "info");
            try {
                const generatedInviteCode = generateRandomCode(); const creationTime = serverTimestamp();
                 // Added new fields: hasRedeemed10kOnce, successfulDynamicWithdrawals, totalPKR
                const initialUserData = { email: user.email, username: chosenUsername, uid: user.uid, totalCoins: SIGNUP_BONUS, totalPKR: 0, referralCount: 0, referralRedeemed: false, codeRedeemedFrom: null, inviteCode: generatedInviteCode, createdAt: creationTime, provider: 'google', hasRedeemed10kOnce: false, successfulDynamicWithdrawals: 0 };
                console.log(`1: Setting initial data (+${SIGNUP_BONUS} coins, 0 PKR)...`);
                await set(ref(db, `users/${user.uid}`), initialUserData);
                console.log("2: Initial DB data set.");
                let referralMessage = ""; let finalCoins = SIGNUP_BONUS;
                if (referralCode) {
                    console.log(`3: Attempting referral: ${referralCode}`);
                    try {
                        // Pass the *just created* initial data for the check
                        const { newCoinsForRedeemer, referrerUid } = await redeemInviteCode(referralCode, user.uid, initialUserData);
                        console.log("4: Referral success.");
                        finalCoins = newCoinsForRedeemer; // This already includes the bonus
                        // Update the user's record AGAIN to mark redeemed status and set final coins
                        await update(ref(db, `users/${user.uid}`), {
                            referralRedeemed: true,
                            codeRedeemedFrom: referrerUid,
                            totalCoins: finalCoins // Update coins again explicitly
                        });
                        console.log("5: User record updated with redemption details.");
                        referralMessage = ` +${REDEEMER_BONUS} referral bonus!`;
                        // No need to update currentReferralCount here, loadUserData will fetch it
                    } catch (redeemError) {
                        console.warn("4: Referral error:", redeemError.message);
                        referralMessage = ` (Referral error: ${redeemError.message})`;
                        // Even if referral fails, keep the signup bonus
                        finalCoins = SIGNUP_BONUS;
                         // Ensure the DB has at least the signup bonus if referral failed after initial set
                        await update(ref(db, `users/${user.uid}`), { totalCoins: finalCoins });
                    }
                } else {
                    // Ensure the DB has the signup bonus if no referral code was entered
                    await update(ref(db, `users/${user.uid}`), { totalCoins: SIGNUP_BONUS });
                    finalCoins = SIGNUP_BONUS;
                }
                totalCoins = finalCoins; // Update local state immediately
                totalPKR = 0; // Ensure local state for PKR is correct after creation

                showStatusMessage(`Profile created! +${SIGNUP_BONUS} bonus${referralMessage}`, "success", 6000);
                completeProfileModal.style.display = "none";
                 showInterstitialAd(async () => {
                    try {
                        await loadUserData(user.uid);
                        setupUserDataListener(user.uid); // Renamed listener
                        showMainMenu();
                    } catch (loadError) {
                        console.error("Failed to load data after profile creation/ad:", loadError);
                        showStatusMessage("Error loading profile data.", "error");
                         signOut(auth).catch(e => console.error("Sign out error:", e)); // Log out on critical error
                    } finally {
                        setAuthProcessing(false); // End auth processing
                    }
                 });
            } catch (dbError) {
                console.error("Error saving profile:", dbError); showStatusMessage("Error saving profile.", "error");
                setAuthProcessing(false); saveProfileBtn.disabled = false;
            }
        };
    }

    googleSignInBtn.addEventListener("click", () => {
        if (isProcessingAuth) return; console.log("Google Sign In clicked."); setAuthProcessing(true); showStatusMessage("Opening Google Sign-in...", "info", 2000);
        const provider = new GoogleAuthProvider();
        // Call Firebase Auth sign-in method
        signInWithPopup(auth, provider)
            .then(handleGoogleSignInSuccess) // Handle successful sign-in and profile check
            .catch((error) => {
                console.error("Google Sign-In Error:", error);
                let errorMsg = "Google Sign-in failed.";
                if (error.code === 'auth/popup-closed-by-user') errorMsg = "Sign-in cancelled by user.";
                else if (error.code === 'auth/network-request-failed') errorMsg = "Network error during sign-in.";
                 else if (error.code === 'auth/cancelled-popup-request') {
                    // This happens if the user clicks the button multiple times quickly
                    // and a previous popup is still open or was just closed. It's common
                    // and often doesn't need a user-facing error message.
                    console.warn("Pop-up request cancelled.");
                    setAuthProcessing(false); // Still need to reset processing flag
                    return; // Exit without showing error message
                 }
                 else if (error.code === 'auth/unauthorized-domain') errorMsg = "Unauthorized domain. Check Firebase settings.";
                 else if (error.code === 'auth/operation-not-allowed') errorMsg = "Google sign-in not enabled in Firebase Auth.";
                 else errorMsg = `Sign-in error: ${error.message}`; // Generic fallback

                showStatusMessage(errorMsg, "error", 5000); // Show informative error
                setAuthProcessing(false); // Reset processing flag
            });
    });


    guestButtonAlt.addEventListener("click", () => {
        console.log("Guest button clicked."); if (isProcessingAuth) return; setAuthProcessing(true);
        try { googleSignInPanel.style.display = "none"; resetAppStateToLoggedOut(); showMainMenu(); showStatusMessage("Playing as Guest.", "info", 4000); }
        catch (error) { console.error("Error entering guest mode:", error); showStatusMessage("Error starting guest mode.", "error"); googleSignInPanel.style.display = "flex"; }
        finally { setAuthProcessing(false); }
    });

     // --- Real-time User Data Listener Setup (Combined) ---
     // Listens for changes to coins, PKR, referral count, and withdrawal status
    function setupUserDataListener(userId) {
         if (!userId) { console.error("No userId for data listener."); return; }
         if (userDataListenerUnsubscribe) { console.warn("Removing existing data listener."); userDataListenerUnsubscribe(); userDataListenerUnsubscribe = null; }
         const userRefPath = `users/${userId}`;
         const userRef = ref(db, userRefPath);
         console.log(`Setting up user data listener for ${userId}`);
         userDataListenerUnsubscribe = onValue(userRef, (snapshot) => { // Re-using the same variable name
            if (snapshot.exists()) {
                 const userData = snapshot.val();
                 const newCoins = userData.totalCoins ?? 0;
                 const newPKR = userData.totalPKR ?? 0;
                 const newRefCount = userData.referralCount ?? 0;
                 const newHasRedeemed10kOnce = userData.hasRedeemed10kOnce ?? false;
                 const newSuccessfulDynamicWithdrawals = userData.successfulDynamicWithdrawals ?? 0;

                 console.log(`RT Data update: Coins=${newCoins}, PKR=${newPKR}, Refs=${newRefCount}, 10kOnce=${newHasRedeemed10kOnce}, DynamicWithdrawals=${newSuccessfulDynamicWithdrawals}`);

                 // Update global state only if changed
                 let stateChanged = false;
                 if (totalCoins !== newCoins) { totalCoins = newCoins; stateChanged = true; }
                 if (totalPKR !== newPKR) { totalPKR = newPKR; stateChanged = true; }
                 if (currentReferralCount !== newRefCount) { currentReferralCount = newRefCount; stateChanged = true; }
                 if (hasRedeemed10kOnce !== newHasRedeemed10kOnce) { hasRedeemed10kOnce = newHasRedeemed10kOnce; stateChanged = true; }
                 if (successfulDynamicWithdrawals !== newSuccessfulDynamicWithdrawals) { successfulDynamicWithdrawals = newSuccessfulDynamicWithdrawals; stateChanged = true; }


                 // Update UI if any state changed
                 if (stateChanged) {
                     console.log("State changed, updating relevant UI...");
                     updateTopRightStatus(); // Update top-right display
                     if (finalTotalCoinsSpan && gameOverMenu.style.display === 'flex') finalTotalCoinsSpan.innerText = totalCoins; // Keep total coins for game over
                     if (profileModal.style.display === 'block') { // Update profile modal if open
                         profileTotalCoinsSpan.textContent = totalCoins;
                         profilePkrBalanceSpan.textContent = totalPKR;
                         profileReferralCountSpan.textContent = currentReferralCount;
                         profile10kStatusSpan.textContent = hasRedeemed10kOnce ? "Yes" : "No";
                         profileDynamicWithdrawalsSpan.textContent = successfulDynamicWithdrawals;
                     }
                     updateInviteButtonText(currentReferralCount);
                     updateWithdrawalOptionStates(); // Update withdraw buttons
                     // No need to update spin wheel button state here, it's handled when the modal opens or on spin click
                     console.log(`UI updated with ${totalCoins} coins, ${totalPKR} PKR, ${currentReferralCount} refs.`);
                 } else {
                    // console.log("RT Data update received, but no change in relevant state.");
                 }
            } else {
                console.warn(`RT Listener: User node ${userId} no longer exists. Logging out.`);
                if (userDataListenerUnsubscribe) { userDataListenerUnsubscribe(); userDataListenerUnsubscribe = null; }
                signOut(auth).catch(e => console.error("Sign out error on missing node:", e));
            }
         }, (error) => {
             console.error("Firebase user data listener error:", error); showStatusMessage("Data sync error.", "error");
             if (userDataListenerUnsubscribe) { userDataListenerUnsubscribe(); userDataListenerUnsubscribe = null; }
         });
     }

    // --- Reset & Load Data ---
    function resetAppStateToLoggedOut() {
        console.log("Resetting app state to logged-out...");
        if (userDataListenerUnsubscribe) { userDataListenerUnsubscribe(); userDataListenerUnsubscribe = null; }
        totalCoins = 0; totalPKR = 0; currentUserInviteCode = null; currentUsername = null; currentReferralCount = 0; currentJoinedDate = null;
        hasRedeemed10kOnce = false;
        successfulDynamicWithdrawals = 0;

        gameStarted = false; gameOver = false; score = 0; if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null;
        stopBackgroundMusic();

        updateTopRightStatus(); // Reset top-right display
        if (finalTotalCoinsSpan) finalTotalCoinsSpan.innerText = "0"; if (sessionCoinCountSpan) sessionCoinCountSpan.innerText = "0";
        updateInviteButtonText(0); if (yourInviteLinkDisplay) yourInviteLinkDisplay.textContent = "N/A (Log in)";
        if (profileUsernameSpan) profileUsernameSpan.textContent = "..."; if (profileEmailSpan) profileEmailSpan.textContent = "...";
        if (profileTotalCoinsSpan) profileTotalCoinsSpan.textContent = "0";
        if (profilePkrBalanceSpan) profilePkrBalanceSpan.textContent = "0";
        if (profileReferralCountSpan) profileReferralCountSpan.textContent = "0";
        if (profileInviteCodeSpan) profileInviteCodeSpan.textContent = "..."; if (profileJoinedDateSpan) profileJoinedDateSpan.textContent = "...";
        if (profile10kStatusSpan) profile10kStatusSpan.textContent = "...";
        if (profileDynamicWithdrawalsSpan) profileDynamicWithdrawalsSpan.textContent = "...";

        mario = null; obstacles = []; coins = []; isProcessingAuth = false;
        console.log("App state reset complete.");
    }

    function loadUserData(userId) {
       return new Promise((resolve, reject) => {
           if (!userId) {
               console.error("loadUserData: No userId.");
               showStatusMessage("Cannot load data.", "error");
               return reject(new Error("No userId provided"));
           }
           console.log(`Loading data for: ${userId}`);
           const userRef = ref(db, `users/${userId}`);
           get(userRef).then(snapshot => {
               if (snapshot.exists()) {
                   const userData = snapshot.val();
                   console.log("User data fetched:", userData);
                   totalCoins = userData.totalCoins || 0;
                   totalPKR = userData.totalPKR || 0;
                   currentUsername = userData.username || 'Gamer';
                   currentReferralCount = userData.referralCount || 0;
                   currentUserInviteCode = userData.inviteCode;
                   hasRedeemed10kOnce = userData.hasRedeemed10kOnce ?? false;
                   successfulDynamicWithdrawals = userData.successfulDynamicWithdrawals ?? 0;

                   if (userData.createdAt) {
                       if (typeof userData.createdAt === 'number') {
                           try { currentJoinedDate = new Date(userData.createdAt).toLocaleDateString(); }
                           catch (e) { console.warn("Error parsing numeric timestamp:", e); currentJoinedDate = "N/A"; }
                       } else if (typeof userData.createdAt === 'object' && userData.createdAt.seconds) {
                           try { currentJoinedDate = new Date(userData.createdAt.seconds * 1000).toLocaleDateString(); }
                           catch (e) { console.warn("Error parsing timestamp object:", e); currentJoinedDate = "N/A"; }
                       } else {
                           console.warn("Unrecognized createdAt format:", userData.createdAt); currentJoinedDate = "N/A";
                       }
                   } else { currentJoinedDate = "N/A"; }

                   updateTopRightStatus(); // Update top-right display after loading
                   updateInviteButtonText(currentReferralCount);
                   updateInviteLinkDisplay();
                   updateWithdrawalOptionStates();

                   if (!currentUserInviteCode && auth.currentUser?.uid === userId) {
                        console.log("Generating invite code...");
                        const newCode = generateRandomCode();
                        set(ref(db, `users/${userId}/inviteCode`), newCode)
                           .then(() => {
                               console.log("New invite code saved:", newCode);
                               currentUserInviteCode = newCode;
                               updateInviteLinkDisplay();
                               if (profileModal.style.display === 'block') profileInviteCodeSpan.textContent = newCode;
                               resolve();
                           })
                           .catch(e => {
                               console.error("Error saving invite code:", e);
                               if(yourInviteLinkDisplay) yourInviteLinkDisplay.textContent = "Error";
                               resolve();
                           });
                   } else {
                       resolve();
                   }
               } else {
                   console.error(`CRITICAL: User node missing: ${userId}. Logging out.`);
                   showStatusMessage("Profile data missing! Logging out.", "error", 5000);
                   signOut(auth).catch(e => console.error("Sign out error:", e));
                   reject(new Error(`User node missing: ${userId}`));
               }
           }).catch(error => {
               console.error("Error fetching user data:", error);
               showStatusMessage("Failed to load user data.", "error");
               reject(error);
           });
       });
    }

    function checkUrlForReferral() {
        try {
            const urlParams = new URLSearchParams(window.location.search); const refCode = urlParams.get('ref');
            if (refCode) { const cleanCode = refCode.trim().toUpperCase(); console.log("URL Referral code:", cleanCode); if (auth.currentUser && redeemCodeInput) { redeemCodeInput.value = cleanCode; console.log("Referral code pre-filled."); showStatusMessage(`Ready to redeem code: ${cleanCode}?`, "info", 4000); } const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname; window.history.replaceState({path:cleanUrl},'',cleanUrl); console.log("Cleaned URL."); }
        } catch (e) { console.error("Error processing URL params:", e); }
    }

    // --- UI Update & View Navigation ---
    function updateInviteButtonText(count) { inviteFriendBtn.innerText = `Invite (${count || 0} Refs)`; }
    function updateSoundButton() {
        toggleSoundBtn.textContent=`Sound: ${soundEnabled?'On':'Off'}`;
        // Use the correct green/grey theme colors from the updated CSS
        const onGradient="linear-gradient(145deg, #4caf50, #388e3c)";
        const offGradient="linear-gradient(145deg, #9e9e9e, #757575)";
        const onBorder='#1b5e20';
        const offBorder='#424242';
        toggleSoundBtn.style.background=soundEnabled?onGradient:offGradient;
        toggleSoundBtn.style.borderBottomColor=soundEnabled?onBorder:offBorder;
    }
    function updateInviteLinkDisplay() { if (yourInviteLinkDisplay) { if (currentUserInviteCode && auth.currentUser) yourInviteLinkDisplay.textContent = `${baseInviteUrl}?ref=${currentUserInviteCode}`; else if (auth.currentUser) yourInviteLinkDisplay.textContent = "Generating link..."; else yourInviteLinkDisplay.textContent = "Log in to get your invite link"; } if (profileInviteCodeSpan && profileModal.style.display === 'block') profileInviteCodeSpan.textContent = currentUserInviteCode || '...'; }

    // --- Update Top Right Status Display ---
    function updateTopRightStatus() {
        if (!menuCoinCountSpan || !menuPkrValueSpan || !menuPkrBalanceSpan) {
             console.warn("Top right status spans not found.");
            return;
        }
         const user = auth.currentUser;
        if (!user || !currentUsername) {
            // Hide the container if not logged in with a complete profile
            topRightStatus.style.display = 'none';
            return;
        } else {
             topRightStatus.style.display = 'inline-flex';
        }

        menuCoinCountSpan.innerText = totalCoins;
        const pkrValueFromCoins = (totalCoins * COIN_TO_PKR_RATE);
        menuPkrValueSpan.innerText = `(${pkrValueFromCoins.toFixed(2)} PKR Value)`; // Format to 2 decimal places
        menuPkrBalanceSpan.innerHTML = `PKR Balance: <span id="menuPkrBalance">${totalPKR}</span>`;
    }


    function showMainMenu() {
        console.log("Showing Main Menu...");
        gameStarted = false; gameOver = false; if (animationFrameId) cancelAnimationFrame(animationFrameId);
        googleSignInPanel.style.display = "none"; completeProfileModal.style.display = 'none'; gameOverMenu.style.display = "none"; gameCanvas.style.display = "none";
        settingsModal.style.display = "none"; profileModal.style.display = "none"; inviteModal.style.display = "none"; withdrawModal.style.display = "none"; infoModal.style.display = "none"; withdrawalHistoryModal.style.display = "none";
        spinWheelModal.style.display = "none"; // Ensure spin wheel modal is hidden
        mainMenu.style.display = "flex";

        const user = auth.currentUser;
        if (user && currentUsername) {
             console.log("User logged in, showing full menu.");
             logoutBtn.style.display = 'inline-flex';
             withdrawBtn.style.display = 'inline-flex';
             inviteFriendBtn.style.display = 'inline-flex';
             settingsBtn.style.display = 'flex';

             whatsappBtn.style.display = 'flex'; // Ensure WhatsApp button is shown
             spinWheelBtn.style.display = 'flex'; // Ensure Spin button is shown

             updateTopRightStatus(); // Update display with current data
             updateInviteButtonText(currentReferralCount);
             updateInviteLinkDisplay();
             updateWithdrawalOptionStates(); // Ensure states are correct when showing menu
        } else {
             console.log("Guest/Incomplete profile, showing limited menu.");
             // Hide logged-in features for guest/incomplete
             logoutBtn.style.display = 'none';
             withdrawBtn.style.display = 'none';
             inviteFriendBtn.style.display = 'none';
             settingsBtn.style.display = 'none';

             whatsappBtn.style.display = 'flex'; // Still show WhatsApp for guests
             spinWheelBtn.style.display = 'none'; // Hide Spin button for guests
             topRightStatus.style.display = 'none'; // Hide top right status for guests


             // Display placeholders or zeros for guest/incomplete
             if (menuCoinCountSpan) menuCoinCountSpan.innerText = "0";
             if (menuPkrValueSpan) menuPkrValueSpan.innerText = "(0.00 PKR Value)";
             if (menuPkrBalanceSpan) menuPkrBalanceSpan.innerHTML = "PKR Balance: <span>0</span>";
             updateInviteButtonText(0);
             updateInviteLinkDisplay();
             updateWithdrawalOptionStates(); // This will disable all options
        }

        playBackgroundMusic();
        console.log("showMainMenu finished.");
    }


    function showGameOverMenu() {
        console.log("Showing Game Over Menu"); gameStarted = false; gameOver = true;
        sessionCoinCountSpan.innerText = score;
        finalTotalCoinsSpan.innerText = auth.currentUser ? totalCoins : 0; // totalCoins should be updated by listener by now
        gameCanvas.style.display='none';
        gameOverMenu.style.display="flex";
        mainMenu.style.display="none";
         // Hide fixed buttons when game over screen is active
        if (whatsappBtn) whatsappBtn.style.display = 'none';
        if (spinWheelBtn) spinWheelBtn.style.display = 'none';
        // Top right status might already be hidden by showMainMenu, but hide just in case game starts from guest mode
         topRightStatus.style.display = 'none';


        stopBackgroundMusic();
        playSound(gameOverSound);
    }


    // --- Spin Wheel Logic ---
    spinWheelBtn.addEventListener("click", () => {
        const user = auth.currentUser;
        if (!user || !currentUsername) {
            showStatusMessage("Log in & complete profile to use the Spin Wheel.", "error", 4000);
            return;
        }

        // Show Ad before showing the modal
        showInterstitialAd(() => {
            console.log("Spin Wheel clicked. Ad shown, showing modal.");
             spinPrizeResultSpan.textContent = ""; // Clear previous result
             // Reset wheel rotation for a clean start each time the modal is opened
             if (wheelElement) {
                 wheelElement.style.transition = 'none';
                 wheelElement.style.transform = 'rotate(0deg)';
             }
             spinBtn.disabled = isSpinning; // Ensure spin button state is correct on open
             spinBtn.textContent = isSpinning ? "Spinning..." : "Spin Now!";
            spinWheelModal.style.display = "block"; // Show the modal
        });
    });

    closeSpinWheelBtn.addEventListener("click", () => {
        spinWheelModal.style.display = "none"; // Close the modal
         spinPrizeResultSpan.textContent = ""; // Clear result on close
         if (wheelElement) {
             wheelElement.style.transition = 'none';
             wheelElement.style.transform = 'rotate(0deg)'; // Reset rotation on close
         }
         isSpinning = false; // Ensure spinning state is reset if modal is closed manually
         if (spinBtn) spinBtn.disabled = false; // Ensure button is enabled next time
         if (spinBtn) spinBtn.textContent = "Spin Now!";
    });

    spinBtn.addEventListener("click", handleSpin);

     // Function to pick a prize based on weights
     function pickPrize(prizes) {
         const totalWeight = prizes.reduce((sum, p) => sum + p.weight, 0);
         let random = Math.random() * totalWeight;
         console.log("Picking prize. Total weight:", totalWeight, "Random:", random);
         let cumulativeWeight = 0;
         for (let i = 0; i < prizes.length; i++) {
              const prize = prizes[i];
              cumulativeWeight += prize.weight;
             if (random < cumulativeWeight) {
                  console.log("Picked:", prize.name, "Index:", i);
                 return { prize, index: i };
             }
         }
         // Fallback in case of floating point issues, return the last prize
         const lastIndex = prizes.length - 1;
         console.log("Fallback: Picked last prize:", prizes[lastIndex].name, "Index:", lastIndex);
         return { prize: prizes[lastIndex], index: lastIndex };
     }


    async function handleSpin() {
        if (isSpinning) return; // Prevent multiple spins

        const user = auth.currentUser;
         if (!user) {
             showStatusMessage("Log in to spin.", "error");
             spinWheelModal.style.display = "none"; // Close modal if somehow got here logged out
             return;
         }

         if (totalCoins < SPIN_COST) {
             showStatusMessage(`Not enough coins! Need ${SPIN_COST}.`, "error", 3000);
             return;
         }

        isSpinning = true;
        spinBtn.disabled = true;
        spinBtn.textContent = "Spinning...";
        spinPrizeResultSpan.textContent = "Good luck!"; // Initial text while spinning
        spinPrizeResultSpan.style.color = '#ffeb3b'; // Set color to yellow


         // Deduct coin cost *before* picking prize visually and before animation
        const updates = {};
        const newTotalCoinsAfterCost = totalCoins - SPIN_COST;
        updates[`/users/${user.uid}/totalCoins`] = newTotalCoinsAfterCost;

        try {
            // Perform the atomic update to deduct coins
            await update(ref(db, `users/${user.uid}`), updates);
            console.log("Coins deducted for spin:", SPIN_COST);
            // Update locally for immediate UI feedback (listener will sync later)
            totalCoins = newTotalCoinsAfterCost;
            updateTopRightStatus();

            // Pick the prize based on weights *after* successful deduction
            const { prize: wonPrize, index: wonSegmentIndex } = pickPrize(prizes);
            console.log("Prize selected:", wonPrize.name, "Segment Index:", wonSegmentIndex);

            // Calculate rotation angle
            // The pointer is at the top (0 degrees). Segments are defined clockwise starting from the right edge.
            // Segment 0: 0-45 deg (center 22.5)
            // Segment 1: 45-90 deg (center 67.5)
            // ...
            // Segment 7: 315-360 deg (center 337.5)
            // We want the *center* of the won segment to land at the top (under the pointer).
            // Segment 0 (100 Coins) center is at 22.5 degrees (0*45 + 22.5). To point this to 0 deg, rotate by -22.5.
            // Segment 1 (1 PKR) center is at 67.5 degrees (1*45 + 22.5). To point this to 0 deg, rotate by -67.5.
            // In general, segment i (i*45 + 22.5). To point this to 0 deg, rotate by -(i*45 + 22.5).
             const targetAngle = -(wonSegmentIndex * segmentAngle + segmentAngle / 2); // Negative because we rotate clockwise
             const baseRotation = 10 * 360; // Add multiple full turns for dramatic effect
             const randomOffset = (Math.random() - 0.5) * (segmentAngle * 0.6); // +/- up to 30% of segment angle for randomness
             const finalRotation = baseRotation + targetAngle + randomOffset;
             console.log(`Target segment: ${wonSegmentIndex} (${wonPrize.name}), Center angle: ${wonSegmentIndex * segmentAngle + segmentAngle / 2}, Target rotation: ${targetAngle}, Final rotation: ${finalRotation}`);


            // Apply rotation and transition
            if (wheelElement) {
                 wheelElement.style.transition = `transform ${spinDuration / 1000}s cubic-bezier(0.25, 0.1, 0.25, 1)`; // Apply transition
                 wheelElement.style.transform = `rotate(${finalRotation}deg)`; // Start spinning
            } else {
                 throw new Error("Wheel element not found.");
            }


            playSound(spinSound); // Play spin sound


            // Wait for the animation to finish
             let transitionEndHandler = async function handleSpinEnd() {
                 if (wheelElement) {
                    wheelElement.removeEventListener('transitionend', transitionEndHandler); // Remove listener
                 }
                 isSpinning = false;
                 spinBtn.disabled = false;
                 spinBtn.textContent = "Spin Again!";
                 playSound(winSound); // Play win sound

                // Award the prize
                let prizeMessage = "";
                const prizeUpdates = {};
                 if (wonPrize.type === 'coins') {
                     // The totalCoins local state was updated after cost deduction. The listener will handle the final sync.
                      // No need to update totalCoins here again as it's handled by the RTDB listener detecting the award.
                     prizeUpdates[`/users/${user.uid}/totalCoins`] = totalCoins + wonPrize.value; // Update DB with awarded coins
                     prizeMessage = `You won ${wonPrize.value} Coins!`;
                     console.log("Awarding Coins:", wonPrize.value);
                 } else if (wonPrize.type === 'pkr') {
                     // The totalPKR local state will be updated by the RTDB listener.
                      // Use transaction or update function for robustness if possible, but a simple update is okay here if conflicts are rare.
                     prizeUpdates[`/users/${user.uid}/totalPKR`] = totalPKR + wonPrize.value; // Update DB with awarded PKR
                     prizeMessage = `You won ${wonPrize.value} PKR!`;
                     console.log("Awarding PKR:", wonPrize.value);
                 }

                // Update user data with the prize atomically
                if (Object.keys(prizeUpdates).length > 0) {
                     try {
                          await update(ref(db, `users/${user.uid}`), prizeUpdates);
                          console.log("Prize updates saved to DB.");
                          // The RT listener will now update local state (totalCoins, totalPKR) and UI
                     } catch (dbError) {
                         console.error("Error saving prize:", dbError);
                         showStatusMessage("Error saving prize! Contact support.", "error", 5000);
                     }
                 }

                spinPrizeResultSpan.textContent = prizeMessage; // Display the result
                spinPrizeResultSpan.style.color = '#66bb6a'; // Change color to green for win


             };
             if (wheelElement) {
                 wheelElement.addEventListener('transitionend', transitionEndHandler);
             }


        } catch (error) {
            console.error("Error during spin process (deduction or prize saving):", error);
            showStatusMessage("Spin failed or prize error. Try again.", "error", 5000);
            isSpinning = false;
            spinBtn.disabled = false;
            spinBtn.textContent = "Spin Again!";
             if (wheelElement) {
                 wheelElement.style.transition = 'none'; // Stop any ongoing animation
                 // You might want to rotate it slightly randomly here to avoid it looking stuck
             }
             spinPrizeResultSpan.textContent = "Spin failed.";
             spinPrizeResultSpan.style.color = '#f44336'; // Red for failure
        }
    }


    // --- Settings & Profile Modals ---
    settingsBtn.addEventListener("click", () => {
        if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "info"); return; }
         showInterstitialAd(() => { // Show ad before opening settings
            console.log("Settings clicked. Ad shown, showing modal.");
            updateSoundButton();
            settingsModal.style.display = "block";
         });
    });
    closeSettings.addEventListener("click", () => { settingsModal.style.display = "none"; });
    toggleSoundBtn.addEventListener("click", () => { soundEnabled = !soundEnabled; updateSoundButton(); if (!soundEnabled) stopBackgroundMusic(); else if (mainMenu.style.display==='flex'||(gameStarted&&!gameOver)) playBackgroundMusic(); showStatusMessage(`Sound ${soundEnabled ? 'On' : 'Off'}`, 'info', 1500); });
    customerService.addEventListener("click", () => { window.open("https://wa.me/923019022815", "_blank"); });
    profileBtn.addEventListener('click', () => {
        const user = auth.currentUser;
         if (!user || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; }
         showInterstitialAd(() => { // Show ad before opening profile
             console.log("Profile clicked. Ad shown, showing modal.");
             // Update profile spans (already done in showProfileModal)
             profileUsernameSpan.textContent = currentUsername || '...';
             profileEmailSpan.textContent = user.email || 'N/A';
             profileTotalCoinsSpan.textContent = totalCoins;
             profilePkrBalanceSpan.textContent = totalPKR; // Update PKR balance in profile modal
             profileReferralCountSpan.textContent = currentReferralCount;
             profileInviteCodeSpan.textContent = currentUserInviteCode || '...';
             profileJoinedDateSpan.textContent = currentJoinedDate || '...';
             profile10kStatusSpan.textContent = hasRedeemed10kOnce ? "Yes" : "No";
             profileDynamicWithdrawalsSpan.textContent = successfulDynamicWithdrawals;

             settingsModal.style.display = 'none';
             profileModal.style.display = 'block';
         });
    });
    closeProfileModalBtn.addEventListener('click', () => { profileModal.style.display = 'none'; });
    // Simplified showProfileModal - the ad wrapper handles the display logic now
     function showProfileModal() {
         // This function is now primarily for populating data, display handled by ad callback
     }


    // --- Withdrawal History ---
    withdrawalHistoryBtn.addEventListener('click', () => {
         const user = auth.currentUser;
         if (!user) { showStatusMessage("Log in first.", "error"); return; }
         showInterstitialAd(() => { // Show ad before opening history
             console.log("Withdrawal History clicked. Ad shown, showing modal.");
             showWithdrawalHistory(); // This function now only fetches and displays
         });
    });
    closeHistoryModalBtn.addEventListener('click', () => { withdrawalHistoryModal.style.display = 'none'; });

     // showWithdrawalHistory now just fetches and displays, display is handled by the ad callback wrapper


    // --- Invite Logic ---
    inviteFriendBtn.addEventListener("click", () => {
         if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; }
         showInterstitialAd(() => { // Show ad before opening invite modal
              console.log("Invite clicked. Ad shown, showing modal.");
              updateInviteLinkDisplay();
              inviteModal.style.display = "block";
         });
     });
    closeInviteModal.addEventListener("click", () => { inviteModal.style.display = "none"; });

    copyInviteCode.addEventListener("click", () => {
         const link = yourInviteLinkDisplay.textContent;
         if (link && link.startsWith('http') && currentUserInviteCode) {
              // No ad needed for simple copy action
              navigator.clipboard.writeText(link).then(() => showStatusMessage("Link copied!", "success")).catch(err => { showStatusMessage("Failed to copy.", "error"); console.error('Copy error:', err); try { const r=document.createRange(); r.selectNodeContents(yourInviteLinkDisplay); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); showStatusMessage("Link selected.", "info", 4000); } catch (e) { console.error("Select fallback fail:", e); } });
         } else { showStatusMessage("Link not ready.", "error"); console.warn("Invalid link copy attempt:", link); }
    });

    redeemCodeBtn.addEventListener("click", async () => {
         const code = redeemCodeInput.value.trim().toUpperCase();
         if (!code) { showStatusMessage("Enter code.", "error"); return; }
         const user = auth.currentUser;
         if (!user || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; }

         showInterstitialAd(() => { // Show ad before attempting redemption
             console.log("Redeem Code clicked. Ad shown, attempting redemption.");
              // Moved redemption logic inside the ad callback
             redeemCodeBtn.disabled = true; // Disable button during processing
             showStatusMessage("Redeeming...", "info");
             const userRef = ref(db, `users/${user.uid}`);
             get(userRef).then(snap => {
                  if (!snap.exists()) throw new Error("User data not found.");
                  const userData = snap.val();
                  return redeemInviteCode(code, user.uid, userData); // This function now handles the update
             })
             .then(({ newCoinsForRedeemer, referrerUid }) => {
                  console.log(`User ${user.uid} redeemed from ${referrerUid}`);
                  showStatusMessage(`Code redeemed! +${REDEEMER_BONUS} coins.`, "success", 5000);
                  inviteModal.style.display = "none"; redeemCodeInput.value = "";
             })
             .catch(e => {
                  console.error("Redeem error:", e);
                  showStatusMessage(`Error: ${e.message}`, "error", 4000);
             })
             .finally(() => {
                  redeemCodeBtn.disabled = false; // Re-enable button
             });
         });
     });


    // --- Withdraw Logic ---
    let selectedWithdrawCoins = 0; let selectedWithdrawPKR = 0;

    // *** REVISED: updateWithdrawalOptionStates ***
    function updateWithdrawalOptionStates() {
        const user = auth.currentUser;
        const isLoggedInAndProfileComplete = user && currentUsername;

        if (!redeemOptionsDiv) {
            console.error("Redeem options container not found!");
            return;
        }

        redeemOptionsDiv.querySelectorAll('.redeem-option').forEach(button => {
            const coinsNeeded = parseInt(button.dataset.coins, 10);
            button.classList.remove('available-option', 'redeemed-once'); // Reset highlight and one-time class
            button.disabled = false; // Assume enabled initially for checks
            button.title = ""; // Reset title

            if (!isLoggedInAndProfileComplete) {
                button.disabled = true;
                button.title = "Log in & complete profile to withdraw.";
                return; // Skip further checks if not logged in
            }

            // --- Handle 10k Option (One-Time) ---
            if (coinsNeeded === 10000) {
                const oneTimeSpan = button.querySelector('.one-time-text');
                if (hasRedeemed10kOnce) {
                    button.disabled = true;
                    button.classList.add('redeemed-once');
                    button.title = "This option has already been redeemed.";
                     if (oneTimeSpan) oneTimeSpan.textContent = '(Redeemed)';
                } else if (totalCoins < coinsNeeded) {
                    button.disabled = true;
                    button.title = `Need ${coinsNeeded - totalCoins} more coins for this one-time withdrawal`;
                    if (oneTimeSpan) oneTimeSpan.textContent = '(One-Time)'; // Still one-time if not enough coins
                } else {
                    // Check initial referral requirement for 10k
                    const initialReferralsNeeded10k = withdrawalRequirements[10000] ?? 0;
                     if (currentReferralCount < initialReferralsNeeded10k) {
                        button.disabled = true;
                        button.title = `Need ${initialReferralsNeeded10k - currentReferralCount} more refs (${currentReferralCount}/${initialReferralsNeeded10k}) for the 10k option`;
                        if (oneTimeSpan) oneTimeSpan.textContent = '(One-Time)';
                     } else {
                         // Coins >= 10k AND Referrals >= base 10k requirement
                         button.classList.add('available-option');
                          // No title needed if fully available
                          if (oneTimeSpan) oneTimeSpan.textContent = '(Ready)'; // Indicate ready
                     }
                }
                // Ensure one-time text is visible for the 10k option
                 if (oneTimeSpan) oneTimeSpan.style.display = 'inline';
                return; // Move to next button
            }

            // --- Handle Higher Tier Options (Dynamic Referrals) ---
            const baseReferralsNeeded = withdrawalRequirements[coinsNeeded] ?? 999999; // Use a large number if undefined
            const actualReferralsNeeded = baseReferralsNeeded + successfulDynamicWithdrawals; // Dynamic requirement

             // Check Coin Requirement
            if (totalCoins < coinsNeeded) {
                button.disabled = true;
                button.title = `Need ${coinsNeeded - totalCoins} more coins`;
            } else {
                 // Coin requirement met, now check Referral Requirement
                if (currentReferralCount < actualReferralsNeeded) {
                    button.disabled = true;
                    button.title = `Need ${actualReferralsNeeded - currentReferralCount} more refs (${currentReferralCount}/${actualReferralsNeeded}) for this tier`;
                 } else {
                    // Coins met AND Referrals met
                    button.classList.add('available-option');
                     // No title needed if fully available
                 }
            }
             // Ensure one-time text is hidden for non-10k options
             const oneTimeSpan = button.querySelector('.one-time-text');
             if (oneTimeSpan) {
                  oneTimeSpan.style.display = 'none';
             }
        });
    }

    withdrawBtn.addEventListener("click", () => {
        if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; }
        showInterstitialAd(() => { // Show ad before opening withdraw modal
            console.log("Withdraw clicked. Ad shown, showing modal.");
            updateWithdrawalOptionStates(); // Update button states/styles just before showing
            redeemOptionsDiv.style.display="block"; redeemFormDiv.style.display="none";
            referralTaskDisplay.innerHTML = ""; // Clear task display initially
            referralTaskDisplay.className = 'referralTaskDisplay'; // Clear task display classes
            redeemDetailsForm.reset();
            redeemSubmitBtn.disabled=false; // Ensure submit button is enabled initially
            redeemSubmitBtn.textContent="Submit Request";
            withdrawModal.style.display="block"; // Ensure modal opens
        });
    });
    closeWithdraw.addEventListener("click", () => { withdrawModal.style.display = "none"; });

     // Event listener for redeem option buttons using event delegation
     if (redeemOptionsDiv) {
         redeemOptionsDiv.addEventListener('click', (event) => {
             const button = event.target.closest('.redeem-option');
             if (!button) return; // Not a redeem option button

             // Button is disabled only if coins/10k used are insufficient (checked by updateWithdrawalOptionStates)
             if (button.disabled) {
                 showStatusMessage(button.title || "Cannot select this option.", "error", 4000);
                 return;
             }

            selectedWithdrawCoins = parseInt(button.dataset.coins, 10);
            selectedWithdrawPKR = parseInt(button.dataset.pkr, 10);

            if(isNaN(selectedWithdrawCoins) || isNaN(selectedWithdrawPKR) || selectedWithdrawCoins <= 0) {
                console.error("Invalid button data:", button.dataset);
                showStatusMessage("Error selecting option.", "error"); return;
            }

            console.log(`Selected: ${selectedWithdrawCoins} coins.`);

            const baseReferralsNeeded = withdrawalRequirements[selectedWithdrawCoins];
            // Calculate actual required referrals dynamically
             let actualReferralsNeeded;
             if (selectedWithdrawCoins === 10000) {
                 actualReferralsNeeded = baseReferralsNeeded; // 10k uses base requirement
             } else {
                 actualReferralsNeeded = (baseReferralsNeeded ?? 0) + successfulDynamicWithdrawals; // Higher tiers add successful dynamic withdrawals
             }
              // Ensure actualReferralsNeeded is never negative (shouldn't happen with current logic, but safety)
             actualReferralsNeeded = Math.max(0, actualReferralsNeeded);


            // --- Populate Referral Task Display ---
            const hasEnoughReferrals = currentReferralCount >= actualReferralsNeeded;
            referralTaskDisplay.className = 'referralTaskDisplay'; // Clear previous classes
             if (selectedWithdrawCoins === 10000) {
                  referralTaskDisplay.innerHTML = `<strong>Task:</strong> Invite ${baseReferralsNeeded} friends`; // 10k task is fixed
             } else {
                  referralTaskDisplay.innerHTML = `<strong>Task:</strong> Invite ${actualReferralsNeeded} friends`; // Dynamic task
             }


            if (hasEnoughReferrals) {
                referralTaskDisplay.classList.add('task-complete');
                 referralTaskDisplay.innerHTML += ` <span class="status-icon">✔</span><br>(Completed: ${currentReferralCount}/${actualReferralsNeeded} referrals)`;
            } else {
                referralTaskDisplay.classList.add('task-incomplete');
                 referralTaskDisplay.innerHTML += ` <span class="status-icon">❌</span><br>(Required: ${actualReferralsNeeded - currentReferralCount} more. Have: ${currentReferralCount})`;
            }
            // --- End Populate Referral Task Display ---

            // We still show the form even if referrals aren't met here, but submission will be blocked.
            // This allows the user to see the required task.
            redeemOptionsDiv.style.display='none';
            redeemFormDiv.style.display='block';
            redeemFormDiv.querySelector('h3').textContent = `Redeem ${selectedWithdrawCoins} Coins for ${selectedWithdrawPKR} PKR`;
         });
     } else {
          console.error("Failed to attach click listeners to withdrawal options: redeemOptionsDiv not found.");
     }


    // *** REVISED: redeemDetailsForm Submit Handler (Referral check remains crucial here) ***
    redeemDetailsForm.addEventListener('submit', (e) => {
         e.preventDefault();

         const user=auth.currentUser; if(!user){ showStatusMessage("Authentication error.", "error"); withdrawModal.style.display="none"; return; }

         const name = accountHolderName.value.trim();
         const number = accountNumber.value.trim();
         const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked');

         if(!name || !number || !paymentMethodInput){ showStatusMessage("Please fill all details.", "error"); return; }
         if(!/^\d+$/.test(number)) { showStatusMessage("Account number is invalid.", "error"); return; }

         // --- START: Final Checks Before Submission ---
         const coinsToWithdraw = selectedWithdrawCoins;
         const baseReferralsNeeded = withdrawalRequirements[coinsToWithdraw];
         if (baseReferralsNeeded === undefined) {
              console.error("Cannot find base referral requirement for final check:", coinsToWithdraw);
              showStatusMessage("Error processing request. Invalid selection.", "error");
              return;
         }

         // Calculate actual required referrals dynamically for the check
         let actualReferralsNeeded;
         if (coinsToWithdraw === 10000) {
              actualReferralsNeeded = baseReferralsNeeded; // 10k uses base requirement
         } else {
              actualReferralsNeeded = (baseReferralsNeeded ?? 0) + successfulDynamicWithdrawals; // Higher tiers add successful dynamic withdrawals
         }
          // Ensure actualReferralsNeeded is never negative (shouldn't happen with current logic, but safety)
         actualReferralsNeeded = Math.max(0, actualReferralsNeeded);


         // Check 10k specific rule first
         if (coinsToWithdraw === 10000) {
             if (hasRedeemed10kOnce) {
                  showStatusMessage("You have already redeemed the 10k option.", "error", 5000);
                  // Keep modal open, maybe reset form to options? Or close? Let's close for simplicity now.
                  withdrawModal.style.display = "none";
                  return;
             }
             // For 10k, check against the base requirement only
             if (currentReferralCount < actualReferralsNeeded) { // actualRefNeeded is base for 10k
                  showStatusMessage(`Referral task incomplete! Need ${actualReferralsNeeded - currentReferralCount} more friends for the 10k option.`, "error", 5000);
                   // Update the task display again just in case (optional, but helpful)
                 referralTaskDisplay.classList.remove('task-complete');
                 referralTaskDisplay.classList.add('task-incomplete');
                 referralTaskDisplay.innerHTML = `<strong>Task:</strong> Invite ${actualReferralsNeeded} friends <span class="status-icon">❌</span><br>(Required: ${actualReferralsNeeded - currentReferralCount} more. Have: ${currentReferralCount})`;
                  return; // Prevent submission
             }
         } else {
             // For tiers > 10k, check against the dynamic requirement
              if (currentReferralCount < actualReferralsNeeded) {
                  showStatusMessage(`Referral task incomplete! Need ${actualReferralsNeeded - currentReferralCount} more friends for this withdrawal tier.`, "error", 5000);
                   // Update the task display again just in case
                 referralTaskDisplay.classList.remove('task-complete');
                 referralTaskDisplay.classList.add('task-incomplete');
                 referralTaskDisplay.innerHTML = `<strong>Task:</strong> Invite ${actualReferralsNeeded} friends <span class="status-icon">❌</span><br>(Required: ${actualReferralsNeeded - currentReferralCount} more. Have: ${currentReferralsNeeded})`;
                  return; // Prevent submission
              }
         }

         // Final coin check (should still be sufficient, but good practice)
         if(totalCoins < coinsToWithdraw){ showStatusMessage(`Insufficient coins. Need ${coinsToWithdraw} (${totalCoins}).`, "error", 5000); withdrawModal.style.display = "none"; return; }

         // --- END: Final Checks Before Submission ---

         const method = paymentMethodInput.value; const timestamp = serverTimestamp();
         const requestData = { uid: user.uid, email: user.email || "N/A", username: currentUsername || "N/A", withdrawalAmountCoins: coinsToWithdraw, pkrAmount: selectedWithdrawPKR, accountHolderName: name, accountNumber: number, paymentMethod: method, status: "pending", referralsAtRequest: currentReferralCount, successfulDynamicWithdrawalsAtRequest: successfulDynamicWithdrawals, timestamp: timestamp }; // Added current dynamic withdrawal count

         console.log("Attempting to save withdrawal request:", JSON.stringify(requestData, null, 2)); // Log request data

         redeemSubmitBtn.disabled = true; redeemSubmitBtn.textContent = "Submitting..."; showStatusMessage("Processing request...", "info");

         // Use update for atomic decrement and request creation + status updates
         const updates = {};
         const newTotalCoins = totalCoins - coinsToWithdraw;
         const newRequestKey = push(ref(db, 'withdrawRequests')).key;

         updates[`/users/${user.uid}/totalCoins`] = newTotalCoins;
         updates[`/withdrawRequests/${newRequestKey}`] = requestData;

          // Add withdrawal status updates based on the tier
         if (coinsToWithdraw === 10000) {
             updates[`/users/${user.uid}/hasRedeemed10kOnce`] = true;
         } else { // For tiers > 10k
             // Increment successfulDynamicWithdrawals atomically
             updates[`/users/${user.uid}/successfulDynamicWithdrawals`] = successfulDynamicWithdrawals + 1;
         }


         console.log("Update object for Firebase:", JSON.stringify(updates, null, 2)); // Log update object

         update(ref(db), updates).then(() => {
            console.log(`Withdraw request ${newRequestKey} submitted and user coins/status updated for UID: ${requestData.uid}. New coin total on server: ${newTotalCoins}`);
            showStatusMessage(`Request submitted successfully! Status: Pending.`, "success", 5000);
            // The RT listener will update local state variables (totalCoins, hasRedeemed10kOnce, successfulDynamicWithdrawals)
            // and trigger updateWithdrawalOptionStates().
            withdrawModal.style.display = "none";
         }).catch(err => {
            showStatusMessage("Submission failed: "+err.message, "error", 5000);
            console.error("Withdraw submission error:", err);
            redeemSubmitBtn.disabled = false;
            redeemSubmitBtn.textContent = "Submit Request";
         });
    });

    // --- Info Modal ---
    infoBtn.addEventListener("click", () => {
         showInterstitialAd(() => { // Show ad before opening info modal
              console.log("Info clicked. Ad shown, showing modal.");
              infoModal.style.display = "block";
         });
    });
    closeInfo.addEventListener("click", () => { infoModal.style.display = "none"; });

    // --- Logout ---
    logoutBtn.addEventListener("click", () => {
         console.log("Logout clicked.");
         if (isProcessingAuth) return;
         showInterstitialAd(() => { // Show ad before logging out
              console.log("Logout clicked. Ad shown, logging out.");
              setAuthProcessing(true); showStatusMessage("Logging out...", "info", 1500);
              signOut(auth).then(() => { showStatusMessage("Logged out.", "info"); console.log("SignOut ok."); }).catch((e) => { showStatusMessage("Logout error: "+e.message, "error"); console.error("Sign out error:", e); setAuthProcessing(false); });
         });
    });


    // --- Game Engine ---
    const ctx = gameCanvas.getContext("2d");
    function resizeCanvas() { gameCanvas.width=window.innerWidth; const bannerHeight=document.getElementById('bannerAdContainer')?.offsetHeight||50; gameCanvas.height=window.innerHeight-bannerHeight; if(gameStarted&&mario){const groundY=gameCanvas.height-50; if(mario.y+mario.height>=groundY-5){mario.y=groundY-mario.height;mario.dy=0;if(mario.isJumping){mario.isJumping=false;canDoubleJump=false;}}} } window.addEventListener("resize", resizeCanvas);
    const imagesToLoad = { character:"https://i.imgur.com/AbfH2aB.png", background:"https://i.imgur.com/xZpZqGt.png", enemy:"https://i.imgur.com/TsR4WXH.png", coin:"https://i.imgur.com/cMQ9X0d.png", platform:"https://i.imgur.com/06ptzal.png" }; const gameImages = {}; let imagesLoadedCount = 0; let totalImagesToLoad = Object.keys(imagesToLoad).length;
    function checkAllImagesLoaded() { imagesLoadedCount++; console.log(`Image loaded (${imagesLoadedCount}/${totalImagesToLoad})`); if (imagesLoadedCount === totalImagesToLoad) { allImagesLoaded = true; console.log("All images loaded."); if(startBtn) startBtn.disabled = false; if(restartBtn) restartBtn.disabled = false; showStatusMessage("Ready!", "success", 1500); } }
    console.log("Loading assets..."); if (startBtn) startBtn.disabled = true; if (restartBtn) restartBtn.disabled = true; showStatusMessage("Loading assets...", "info", 5000); for (const key in imagesToLoad) { gameImages[key] = new Image(); gameImages[key].onload = checkAllImagesLoaded; gameImages[key].onerror = () => { console.error(`Failed load: ${key}`); totalImagesToLoad--; showStatusMessage(`Error loading asset: ${key}.`, "error", 5000); if (startBtn) startBtn.disabled = true; if (restartBtn) restartBtn.disabled = true; }; gameImages[key].src = imagesToLoad[key]; }
    function initGame() { if (!allImagesLoaded) { showStatusMessage("Assets loading...", "info"); return; } console.log("Initializing game..."); resizeCanvas(); bgX = 0; platformX = 0; const groundY = gameCanvas.height - 50; mario = { x: 60, y: groundY - 60, width: 40, height: 60, dy: 0, gravity: 1.6, jumpPower: -22, doubleJumpPower: -18, isJumping: false, onGround: true }; obstacles = []; coins = []; speed = 6; score = 0; gameOver = false; gameStarted = true; lastJumpInputTime = 0; canDoubleJump = false; if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null; playBackgroundMusic(); console.log("Game initialized. Starting loop."); gameLoop(); if (whatsappBtn) whatsappBtn.style.display = 'none'; if (spinWheelBtn) spinWheelBtn.style.display = 'none'; topRightStatus.style.display = 'none';} // Hide fixed buttons and status during game
    function drawBackground() { if (!gameImages.background?.complete || gameImages.background.naturalHeight === 0) { ctx.fillStyle = '#60a5fa'; ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height); return; }; bgX = (bgX - speed * 0.4) % gameImages.background.width; ctx.drawImage(gameImages.background, bgX, 0, gameImages.background.width, gameCanvas.height); ctx.drawImage(gameImages.background, bgX + gameImages.background.width, 0, gameImages.background.width, gameCanvas.height); }
    function drawPlatform() { if (!gameImages.platform?.complete || gameImages.platform.naturalHeight === 0) { ctx.fillStyle = '#E0A070'; ctx.fillRect(0, gameCanvas.height - 50, gameCanvas.width, 50); return; }; const groundY = gameCanvas.height - 50; platformX = (platformX - speed) % gameImages.platform.width; ctx.drawImage(gameImages.platform, platformX, groundY, gameImages.platform.width, 50); ctx.drawImage(gameImages.platform, platformX + gameImages.platform.width, groundY, gameImages.platform.width, 50); }
    function drawMario() { if(!mario || !gameImages.character?.complete || gameImages.character.naturalHeight === 0) return; ctx.drawImage(gameImages.character, mario.x, mario.y, mario.width, mario.height); }
    function drawObstacles() { if (!gameImages.enemy?.complete || gameImages.enemy.naturalHeight === 0) return; for (let i = obstacles.length - 1; i >= 0; i--){ let obs = obstacles[i]; obs.x -= speed; ctx.drawImage(gameImages.enemy, obs.x, obs.y, obs.width, obs.height); if(obs.x + obs.width < 0) obstacles.splice(i, 1); } }
    function spawnObstacles() { if(gameOver || !gameImages.enemy?.complete || gameImages.enemy.naturalHeight === 0) return; const bMin=350, bMax=650; const dF=Math.max(0.3,1-(score/1000)); const cMin=bMin*dF, cMax=bMax*dF; const dR=Math.max(50,cMax-cMin); const rD=cMin+Math.random()*dR; let lastX=-rD; if(obstacles.length>0) lastX=obstacles[obstacles.length-1].x; if(gameCanvas.width-lastX>rD && obstacles.length<5){ const gY=gameCanvas.height-50; obstacles.push({x:gameCanvas.width+10,y:gY-50,width:50,height:50}); } }
    function spawnCoins() {
        if(!gameImages.coin?.complete || gameImages.coin.naturalHeight === 0 || gameOver) return;
        const spawnChance = 0.014; // REDUCED chance
        const maxGroups = 3;
        if(coins.length < (maxGroups * 2) && Math.random() < spawnChance) {
            const groundY = gameCanvas.height - 50; let startY; const hChance=Math.random();
            if(hChance<0.5) startY=groundY-30; else if(hChance<0.85) startY=groundY-100-(Math.random()*40); else startY=groundY-160-(Math.random()*50);
            let coinCount = Math.floor(Math.random() * 2) + 1; // REDUCED: 1 to 2 coins
            let startX = gameCanvas.width + Math.random() * 150; const spacing = 45;
            for(let i=0; i<coinCount; i++) coins.push({x:startX+i*spacing,y:startY,width:25,height:25});
        }
    }
    function drawCoinsAndCollect() { if (!gameImages.coin?.complete || gameImages.coin.naturalHeight === 0 || !mario || gameOver) return; for (let i = coins.length - 1; i >= 0; i--) { let c = coins[i]; c.x -= speed; ctx.drawImage(gameImages.coin, c.x - c.width / 2, c.y - c.height / 2, c.width, c.height); if (mario.x < c.x + c.width / 2 && mario.x + mario.width > c.x - c.width / 2 && mario.y < c.y + c.height / 2 && mario.y + mario.height > c.y - c.height / 2) { coins.splice(i, 1); score += 1; playSound(coinSound); } else if (c.x + c.width / 2 < 0) coins.splice(i, 1); } }
    function applyPhysics() { if(!mario || gameOver) return; mario.dy += mario.gravity; mario.y += mario.dy; const groundY = gameCanvas.height - 50; if (mario.y + mario.height >= groundY) { mario.y = groundY - mario.height; mario.dy = 0; mario.onGround = true; if(mario.isJumping) { mario.isJumping = false; canDoubleJump = false; } } else mario.onGround = false; if (mario.y < 0) { mario.y = 0; mario.dy = 0; } }
    function checkCollision() { if(!mario || gameOver) return; for(let i = obstacles.length - 1; i >= 0; i--){ let obs = obstacles[i]; const mX=mario.x+5, mY=mario.y+5, mW=mario.width-10, mH=mario.height-10; const oX=obs.x+5, oY=obs.y+5, oW=obs.width-10, oH=obs.height-10; if (mX < oX + oW && mX + mW > oX && mY < oY + oH && mY + mH > oY) { console.log("Collision!"); gameOver = true; stopBackgroundMusic(); break; } } }
    function jump() { if(!gameStarted || gameOver || !mario) return; const now = Date.now(); if (mario.isJumping && !mario.onGround && canDoubleJump && (now - lastJumpInputTime < doubleJumpWindow)) { mario.dy = mario.doubleJumpPower; canDoubleJump = false; lastJumpInputTime = 0; console.log("Double Jump!"); playSound(jumpSound); } else if (mario.onGround) { mario.dy = mario.jumpPower; mario.isJumping = true; mario.onGround = false; canDoubleJump = true; lastJumpInputTime = now; console.log("First Jump!"); playSound(jumpSound); } }
    function gameLoop() {
        if(gameOver || !gameStarted) { if (gameOver) handleGameOver(); return; }
        applyPhysics(); checkCollision(); if (gameOver) { handleGameOver(); return; }
        spawnObstacles(); spawnCoins();
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        drawBackground(); drawPlatform(); drawObstacles(); drawCoinsAndCollect(); drawMario();
        ctx.fillStyle="#FFF";
        ctx.font="18px 'Press Start 2P'"; // Slightly larger score font
        ctx.textAlign="left"; ctx.textBaseline="top"; ctx.shadowColor='rgba(0,0,0,0.8)'; ctx.shadowBlur=5; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2;
        ctx.fillText("Score: " + score, 25, 25); // Draw score with more padding
        ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
        animationFrameId = requestAnimationFrame(gameLoop);
    }
    function handleGameOver() {
        console.log(`Game Over! Score: ${score}`); gameStarted = false; gameOver = true;
        if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
        const user = auth.currentUser;
        if (user && score > 0 && currentUsername) {
            const userRef = ref(db, `users/${user.uid}`);
            // Update local state for display immediately
            totalCoins += score;
            // Update DB with the new total coins
            update(userRef, { totalCoins: totalCoins })
            .then(() => console.log(`Score submitted. Local state updated. RT listener might sync shortly.`))
            .catch(e => { console.error("Error saving score:", e); showStatusMessage("Error saving score.", "error"); });
        } else if (user && score === 0) { console.log("Score 0, no save needed."); }
        else { console.log("Guest or incomplete profile, score not saved."); }
        showGameOverMenu(); console.log("Game Over Menu shown.");
    }

    // --- Game Control Buttons ---
    startBtn.addEventListener("click", () => { if (!allImagesLoaded) { showStatusMessage("Assets loading...", "info"); return; } if (gameStarted) return; console.log("Start clicked."); showInterstitialAd(() => { console.log("Ad callback: Starting game."); mainMenu.style.display = "none"; gameCanvas.style.display = 'block'; initGame(); }); });
    // No ad on Restart button as requested
    restartBtn.addEventListener("click", () => { if (!allImagesLoaded) { showStatusMessage("Assets error.", "error"); showMainMenu(); return; } if (gameStarted) return; console.log("Restart clicked."); console.log("Direct restart..."); gameOverMenu.style.display = "none"; gameCanvas.style.display = 'block'; initGame(); });
    backMenuBtn.addEventListener("click", () => { console.log("Back to Menu clicked."); showInterstitialAd(() => { console.log("Ad callback: Showing main menu."); showMainMenu(); }); });

    // --- Jump Listeners ---
    document.addEventListener("keydown", (e) => { if ((e.code === "Space" || e.code === "ArrowUp") && gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    gameCanvas.addEventListener("click", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    gameCanvas.addEventListener("touchstart", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } }, { passive: false });

    // --- Initial Setup on Page Load ---
    function initializeAppUI() {
        console.log("Initializing UI (Google Sign-In)...");
        mainMenu.style.display = "none"; gameCanvas.style.display = "none"; gameOverMenu.style.display = "none"; completeProfileModal.style.display = 'none'; spinWheelModal.style.display = 'none'; withdrawalHistoryModal.style.display = 'none'; settingsModal.style.display = 'none'; profileModal.style.display = 'none'; inviteModal.style.display = 'none'; withdrawModal.style.display = 'none'; infoModal.style.display = 'none'; // Hide all modals initially

         // Hide fixed buttons initially
        if (whatsappBtn) whatsappBtn.style.display = 'none';
        if (spinWheelBtn) spinWheelBtn.style.display = 'none';

        setAuthProcessing(false); updateSoundButton(); updateInviteLinkDisplay();
        if (startBtn) startBtn.disabled = true; if (restartBtn) restartBtn.disabled = true;

         // Initial auth state check determines what screen to show
         onAuthStateChanged(auth, async (user) => {
             console.log("Initial Auth State Check. User:", user ? user.uid : 'null');
             // This listener is already set up globally and handles the flow (showMainMenu or completeProfileModal)
             // No need to duplicate the login/profile check logic here, just ensure the main listener runs.
             // The global onAuthStateChanged handles the initial display based on auth state.
         });

        // Ensure top right status is handled by the onAuthStateChanged listener
        // It will be hidden initially if no user, shown if logged in with profile.
        updateTopRightStatus(); // Update display placeholders if not logged in

        console.log("Initial UI setup complete.");
    }
    initializeAppUI();

  </script>

  <!-- Social Bar Script -->
  <script type='text/javascript' src='//pl26479822.profitableratecpm.com/11/f3/83/11f3830187c378aedebef88b0bcd83a0.js'></script>

</body>
</html>