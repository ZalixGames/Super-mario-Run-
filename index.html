
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mario Run â€“ Earn Real money </title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <!-- Ad Script 1 (Placeholder - REMOVED OLD SCRIPT) -->
  <style>
    /* --- CSS Styles --- */
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Press Start 2P', cursive; overflow: hidden;
      background: #0a0a0a url('https://www.transparenttextures.com/patterns/stardust.png');
      color: #fff; margin-bottom: 50px; /* Space for banner */
    }
    canvas { display: block; background-color: #70c5ce; /* Default sky color if bg image fails */ }
    .text-glow { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff007f; }
    .box-glow { box-shadow: 0 0 8px rgba(255, 255, 255, 0.6), 0 0 15px rgba(255, 0, 127, 0.5); }
    .game-btn {
      padding: 12px 25px; margin: 10px; font-size: 14px; border: none;
      border-radius: 8px; cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, background-image 0.2s ease; /* Added background-image to transition */
      background: linear-gradient(145deg, #ff4757, #ff6348); color: #fff;
      font-family: 'Press Start 2P', cursive; text-transform: uppercase;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7); border-bottom: 4px solid #c0392b;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); display: inline-flex; /* Use inline-flex for alignment */
      align-items: center; justify-content: center; line-height: 1.2;
      text-decoration: none; /* Remove underline from <a> tags styled as buttons */
      background-size: cover; /* Default background size */
      background-position: center; /* Default background position */
      background-repeat: no-repeat; /* Default background repeat */
    }
    .game-btn:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 100, 100, 0.6);
      /* Keep background gradient change for standard buttons, will be overridden for download btn if needed */
      background-color: #ff6348; /* Fallback */
      background-image: linear-gradient(145deg, #ff6348, #ff7f50);
    }
    .game-btn:active:not(:disabled) {
         transform: translateY(1px) scale(1); border-bottom-width: 2px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .game-btn:disabled { background: #555; cursor: not-allowed; border-bottom-color: #333; box-shadow: none; transform: none; opacity: 0.7; }

    /* --- Google Sign-in Panel Styles --- */
    #googleSignInPanel {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: url('https://i.imgur.com/nxRZ03R.png') no-repeat center center;
        background-size: cover; background-color: rgba(0, 0, 0, 0.65);
        background-blend-mode: darken; z-index: 100; display: none;
        flex-direction: column; justify-content: center; align-items: center;
        color: #fff; padding: 20px; text-align: center;
    }
     #googleSignInPanel h2 {
        font-size: 2.5em; color: #ff007f; margin-bottom: 30px;
        text-shadow: 3px 3px 0px #000, 0 0 15px #ff007f;
    }
    #googleSignInBtn {
        background: linear-gradient(145deg, #4285F4, #357AE8); border-bottom-color: #2a65c8;
        color: white; width: 280px; padding: 15px 25px; font-size: 16px;
        display: inline-flex; align-items: center; justify-content: center;
    }
    #googleSignInBtn img { width: 24px; height: 24px; margin-right: 15px; background-color: white; padding: 2px; border-radius: 2px; }
    #googleSignInBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #357AE8, #2a65c8);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(66, 133, 244, 0.6);
    }
     #guestButtonAlt {
        background: linear-gradient(145deg, #8395a7, #576574); border-bottom-color: #2f3640;
        width: 280px; margin-top: 15px;
     }
     #guestButtonAlt:hover:not(:disabled) { background-image: linear-gradient(145deg, #576574, #434c58); }

    /* --- Main Menu --- */
    #mainMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/KFWJlte.png') no-repeat center center; background-size: cover;
      z-index: 30; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center; padding-top: 80px; /* Adjusted padding */
    }
    #topRightStatus {
      position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.85); padding: 10px 15px;
      border-radius: 8px; font-size: 18px; color: #FFD700; z-index: 35; border: 2px solid #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); display: none; align-items: center;
    }
    #topRightStatus img#coinIcon { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; }
    #settingsBtn {
      position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); border: 2px solid #ccc;
      border-radius: 50%; cursor: pointer; z-index: 35; width: 45px; height: 45px; display: none;
      justify-content: center; align-items: center; transition: transform 0.2s, box-shadow 0.2s;
    }
    #settingsBtn svg { width: 24px; height: 24px; fill: #fff; }
    #settingsBtn:hover { transform: rotate(45deg) scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.7); border-color: #fff; }
    #mainMenu .menu-btn { width: 220px; margin-bottom: 15px; }
    #mainMenu #withdrawBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; display: none; } /* Initially hidden */
    #mainMenu #withdrawBtn:hover { background-image: linear-gradient(145deg, #1dd1a1, #00b894); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(46, 213, 115, 0.6); }
    #mainMenu #inviteFriend { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; display: none; } /* Initially hidden */
    #mainMenu #inviteFriend:hover { background-image: linear-gradient(145deg, #2e86de, #1e66b0); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(84, 160, 255, 0.6); }
    #mainMenu #logoutBtn { background: linear-gradient(145deg, #8395a7, #576574); border-bottom-color: #2f3640; display: none; } /* Initially hidden */
    #mainMenu #logoutBtn:hover { background-image: linear-gradient(145deg, #576574, #434c58); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(131, 149, 167, 0.6); }

    /* --- Download Button Specific Style --- */
    #downloadApkLink {
      padding: 0; height: 70px;
      background-image: url('https://imgur.com/QJZ5IJp.png');
      background-color: transparent; background-size: contain; background-repeat: no-repeat;
      background-position: center center; border: none; border-bottom: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); text-indent: -9999px; font-size: 0; color: transparent;
      display: none; /* Initially hidden, shown by showMainMenu */
    }
    #downloadApkLink:hover {
       transform: translateY(-2px) scale(1.03);
       box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.5);
       background-image: url('https://imgur.com/QJZ5IJp.png'); /* Keep same image */
    }
    #downloadApkLink:active {
       transform: translateY(1px) scale(1); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* --- Game Over Menu --- */
    #gameOverMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
      z-index: 40; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: #ff4757; padding: 20px; text-align: center;
    }
    #gameOverMenu h2 { font-size: 4em; text-shadow: 4px 4px 0px #000, 0 0 20px #ff0000; margin-bottom: 20px; }
    #gameOverMenu p { font-size: 1.5em; color: #fff; margin-bottom: 10px; text-shadow: 1px 1px 2px #000; }
    #gameOverMenu .menu-btn { width: 200px; }
    #gameOverMenu #restartBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #gameOverMenu #restartBtn:hover { background-image: linear-gradient(145deg, #1dd1a1, #00b894); }
    #gameOverMenu #backMenuBtn { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    #gameOverMenu #backMenuBtn:hover { background-image: linear-gradient(145deg, #2e86de, #1e66b0); }

    /* --- Modal Common Styles --- */
    .modal { display: none; position: fixed; z-index: 70; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
    .modal .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e1e1e; padding: 20px 25px; border-radius: 10px; width: 90%; color: #eee; text-align: center; font-family: 'Press Start 2P', cursive; border: 3px solid #ff007f; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(255, 0, 127, 0.4); max-height: 85vh; overflow-y: auto; }
    .modal h2 { margin-bottom: 20px; font-size: 1.4em; color: #ff007f; text-shadow: 1px 1px 2px #000; }
    .modal button.game-btn { width: 100%; margin: 8px 0; padding: 10px 15px; font-size: 12px; }
    .modal input[type="text"], .modal input[type="email"], .modal input[type="password"] { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border: 2px solid #555; border-radius: 5px; background: #333; color: #fff; font-family: 'Arial', sans-serif; font-size: 16px; outline: none; transition: border-color 0.3s, box-shadow 0.3s; }
    .modal input:focus { border-color: #ff007f; box-shadow: 0 0 8px rgba(255, 0, 127, 0.6); }
    .close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #aaa; font-family: Arial, sans-serif; transition: color 0.2s, transform 0.2s; font-weight: bold; }
    .close-btn:hover { color: #ff007f; transform: scale(1.2); }

    /* --- Specific Modal Sizes --- */
    #settingsModal .modal-content { max-width: 320px; }
    #profileModal .modal-content { max-width: 380px; text-align: left; }
    #inviteModal .modal-content { max-width: 360px; }
    #withdrawModal .modal-content { max-width: 380px; }
    #infoModal .modal-content { max-width: 360px; }
    #withdrawalHistoryModal .modal-content { max-width: 450px; }
    #completeProfileModal .modal-content { max-width: 350px; }

    /* --- Settings Modal Button Styles --- */
    #profileBtn { background: linear-gradient(145deg, #9b59b6, #8e44ad); border-bottom-color: #6c3483; }
    #toggleSound { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #customerService { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    #withdrawalHistoryBtn { background: linear-gradient(145deg, #feca57, #ff9f43); border-bottom-color: #e67e22; }
    #profileBtn:hover { background-image: linear-gradient(145deg, #8e44ad, #a569bd); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(155, 89, 182, 0.6); }
    #toggleSound:hover { background-image: linear-gradient(145deg, #1dd1a1, #00b894); }
    #customerService:hover { background-image: linear-gradient(145deg, #2e86de, #1e66b0); }
    #withdrawalHistoryBtn:hover { background-image: linear-gradient(145deg, #ff9f43, #f39c12); }

    /* --- Profile Modal Styles --- */
    #profileModal .modal-content h2 { color: #9b59b6; }
    #profileModal .modal-content p { margin: 12px 0; font-family: Arial, sans-serif; font-size: 15px; line-height: 1.6; color: #ddd; }
    #profileModal .modal-content p strong { color: #fff; display: inline-block; min-width: 120px; }
    #profileModal .modal-content span { color: #feca57; word-break: break-all; }
    #profileInfo { border-top: 1px solid #444; margin-top: 15px; padding-top: 15px; }

    /* --- Invite Modal Styles --- */
    #inviteModal .section { margin: 20px 0; border-top: 1px solid #444; padding-top: 15px; }
    #inviteModal .section h3 { font-size: 1.1em; margin-bottom: 10px; color: #eee; }
    #inviteModal .section p { font-size: 1em; margin-bottom: 12px; font-family: Arial, sans-serif; }
    #inviteModal #yourInviteLinkDisplay {
        font-size: 1.0em; color: #FFD700; background: #333; padding: 8px 12px;
        border-radius: 5px; display: block; border: 1px solid #555;
        word-break: break-all; text-align: left; margin-bottom: 10px;
    }
    #copyInviteCode { background: linear-gradient(145deg, #feca57, #ff9f43); border-bottom-color: #e67e22; }
    #redeemCodeBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #copyInviteCode:hover { background-image: linear-gradient(145deg, #ff9f43, #f39c12); }
    #redeemCodeBtn:hover { background-image: linear-gradient(145deg, #1dd1a1, #00b894); }

    /* --- Withdraw Modal Styles --- */
    #withdrawModal .modal-content p { margin-bottom: 15px; font-family: Arial, sans-serif; line-height: 1.5; font-size: 0.95em; } /* Adjusted margin/size */
    #withdrawModal .redeem-option {
        background: linear-gradient(145deg, #1abc9c, #16a085); border-bottom: 4px solid #117a65;
        color: #fff; padding: 10px 15px; margin: 6px 0; border-radius: 8px;
        font-size: 13px; text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, opacity 0.2s ease; /* Added opacity transition */
        width: 100%; display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
        position: relative; /* Needed for pseudo-elements if used for icons, etc. */
    }
    #withdrawModal .redeem-option:hover:not(:disabled) {
        background: linear-gradient(145deg, #1dd1a1, #1abc9c);
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3), 0 0 15px rgba(26, 188, 156, 0.5);
    }
    #withdrawModal .redeem-option:active:not(:disabled) {
        transform: translateY(1px); border-bottom-width: 2px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    #withdrawModal .redeem-option:disabled { /* Style for disabled options */
        background: #555; cursor: not-allowed; border-bottom-color: #333;
        box-shadow: none; transform: none; opacity: 0.55; /* Slightly more faded */
        /* Tooltip styles might be needed if browser default isn't good enough */
        cursor: help; /* Indicate there's a reason it's disabled */
    }
    #redeemForm {
      display: none; margin-top: 20px; font-family: Arial, sans-serif;
      font-size: 16px; line-height: 1.5; text-align: left;
      border-top: 2px solid #444; /* Separator */
      padding-top: 20px;
    }
    #redeemForm h3 {
        font-family: 'Press Start 2P', cursive; font-size: 1.2em; color: #eee;
        margin-bottom: 15px; text-align: center; text-shadow: 1px 1px 1px #000;
    }
    #redeemForm label { display: block; margin-bottom: 5px; color: #ccc; font-size: 14px; }
    #redeemForm input[type="text"] { margin-bottom: 15px; }
    #redeemForm input[type="radio"] { margin-right: 8px; vertical-align: middle; }
    #redeemForm label input[type="radio"] { display: inline; margin-bottom: 0; }
    #redeemForm .payment-options { margin-top: 15px;} /* Add spacing */
    #redeemForm .payment-options label { margin-bottom: 10px; display: block;}
    #redeemSubmitBtn {
        background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84;
        width: 100%; margin-top: 20px; font-size: 14px;
    }
    #redeemSubmitBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #1dd1a1, #00b894); }
    #redeemSubmitBtn:disabled { background: #555; cursor: not-allowed; border-bottom-color: #333; box-shadow: none; transform: none; opacity: 0.7;}

    /* --- Info Modal Styles --- */
    #infoModal .modal-content h2 { color: #54a0ff; }
    #infoModal .modal-content p { margin: 15px 0; font-family: Arial, sans-serif; font-size: 15px; line-height: 1.6; color: #ddd; text-align: left; }
    #infoModal .modal-content p strong { color: #fff; }
    #infoModal .modal-content .highlight { color: #ffeb3b; }

    /* --- Withdrawal History Modal Styles --- */
    #withdrawalHistoryModal .modal-content h2 { color: #feca57; }
    #historyList { margin-top: 20px; max-height: 50vh; overflow-y: auto; padding-right: 10px; text-align: left; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.5; }
    .history-item { background: #2a2a2a; border: 1px solid #444; border-radius: 6px; padding: 12px 15px; margin-bottom: 10px; color: #ccc; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
    .history-item span { display: block; margin-bottom: 4px; }
    .history-item .details { flex-grow: 1; margin-right: 10px; }
    .history-item .status { font-family: 'Press Start 2P', cursive; font-size: 12px; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; min-width: 80px; text-align: center; margin-top: 5px; }
    .history-item .status-pending { background-color: #ff9f43; color: #573a0a; border: 1px solid #e67e22;}
    .history-item .status-approved { background-color: #2ed573; color: #0a4a2f; border: 1px solid #10ac84;}
    .history-item .status-rejected { background-color: #ff4757; color: #5e141e; border: 1px solid #c0392b;}
    .history-item .date { font-size: 12px; color: #888; width: 100%; text-align: right; margin-top: 5px; }
    #historyList .no-history { color: #888; text-align: center; padding: 20px; font-size: 1em;}

     /* --- Complete Profile Modal Styles --- */
    #completeProfileModal .modal-content h2 { color: #2ed573; }
    #completeProfileModal .modal-content p { margin-bottom: 15px; font-family: Arial, sans-serif; line-height: 1.5; font-size: 15px; text-align: left; }
    #completeProfileModal .modal-content p.subtle { font-size: 13px; color: #aaa; }
    #completeProfileModal .modal-content input[type="text"] { margin-bottom: 20px; }
    #completeProfileModal #saveProfileBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #completeProfileModal #saveProfileBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #1dd1a1, #00b894); }

    /* --- Ad Container Styles --- */
    #bannerAdContainer { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background-color: #000; z-index: 1000; display: flex; justify-content: center; align-items: center; overflow: hidden; border-top: 2px solid #333; }
    #bannerAdContainer iframe { max-width: 100%; }
    #interstitialAdOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; font-family: 'Press Start 2P', cursive; padding: 20px; backdrop-filter: blur(3px); }
    #interstitialAdOverlay p#adInfoText { font-size: 1.1em; margin-bottom: 25px; color: #eee; line-height: 1.5; }
    #interstitialAdCloseButton { padding: 12px 25px; font-size: 1em; cursor: pointer; background: linear-gradient(145deg, #ff4757, #e84118); border-bottom-color: #c23616; color: white; border-radius: 8px; font-family: 'Press Start 2P', cursive; display: none; text-transform: uppercase; margin-top: 20px; }
    #interstitialAdCloseButton:hover { background-image: linear-gradient(145deg, #e84118, #d63031); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 71, 87, 0.6); }
    #interstitialAdTimer { margin-top: 15px; font-size: 0.9em; color: #ccc; }
    #interstitialAdOverlay p.skip-info { font-size: 0.8em; color: #aaa; margin-top: 30px; font-family: Arial, sans-serif; line-height: 1.4; }

    /* --- Status Message Container --- */
    #statusMessageContainer { display: none; position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.85); color: white; padding: 12px 25px; border-radius: 8px; z-index: 5000; font-family: 'Press Start 2P', cursive; font-size: 0.9em; text-align: center; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); opacity: 0; transition: opacity 0.4s ease-in-out, top 0.4s ease-in-out; max-width: 90%; pointer-events: none; }
    #statusMessageContainer.show { display: block; opacity: 1; top: 25px; }
    #statusMessageContainer.success { border-color: #2ed573; }
    #statusMessageContainer.error { border-color: #ff4757; }
    #statusMessageContainer.info { border-color: #54a0ff; }

    /* --- End of CSS --- */
  </style>
</head>
<body>
  <!-- Status Message Container -->
  <div id="statusMessageContainer"> <span id="statusMessageText"></span> </div>

  <!-- Audio Elements -->
  <audio id="backgroundAudio" loop> <source src="mines background .mp3" type="audio/mp3"> Your browser does not support the audio element. </audio>
  <audio id="jumpSound"> <source src="gruntjumpland-101soundboards.mp3" type="audio/mp3"> </audio>
  <audio id="coinSound"> <source src="coin-recieved-230517.mp3" type="audio/mp3"> </audio>
  <audio id="gameOverSound"> <source src="game-over-arcade-6435.mp3" type="audio/mp3"> </audio>

  <!-- Google Sign-in Panel -->
  <div id="googleSignInPanel" style="display: flex;">
      <h2>Welcome Gamer!</h2>
      <button id="googleSignInBtn" class="game-btn">
          <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google G Logo"/>
          Sign in with Google
      </button>
      <button id="guestButtonAlt" class="game-btn">Continue as Guest</button>
  </div>

  <!-- Complete Profile Modal -->
  <div id="completeProfileModal" class="modal">
      <div class="modal-content">
          <h2>Complete Your Profile</h2>
          <p>Welcome! Please set your username and optionally enter a referral code.</p>
          <div>
              <label for="profileUsernameInput" style="display:block; text-align:left; margin-bottom:5px; font-family: Arial, sans-serif; font-size: 14px;">Username:</label>
              <input type="text" id="profileUsernameInput" placeholder="Choose a username (min 3 chars)" required />
          </div>
           <div>
              <label for="profileReferralInput" style="display:block; text-align:left; margin-bottom:5px; font-family: Arial, sans-serif; font-size: 14px;">Referral Code (Optional):</label>
              <input type="text" id="profileReferralInput" placeholder="Enter friend's code" />
              <p class="subtle">Enter a code to get a bonus!</p>
          </div>
          <button id="saveProfileBtn" class="game-btn">Save and Play</button>
      </div>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas" style="display: none;"></canvas>

  <!-- Main Menu -->
  <div id="mainMenu" style="display: none;">
     <button id="settingsBtn" title="Open Settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M487.4 315.7l-42.1-24.3c2.8-12.8 4.3-26 4.3-39.4s-1.5-26.6-4.3-39.4l42.1-24.3c9.4-5.4 13.3-17.1 9.4-27.2l-45.3-78.4c-3.9-10.1-14.2-14.8-24.7-11.5l-49.5 19.9c-20.5-16.1-43-29.2-67.2-38.1l-7.5-52.8C309 3.7 300.3-2.5 290.3.1l-90.6 18.5c-10 2.1-17.6 9.9-19.8 19.8l-7.5 52.8c-24.3 8.9-46.8 22-67.2 38.1L54.6 83.1c-10.5-3.3-20.8.4-24.7 11.5L-15.4 172.9c-3.9 10.1-.1 21.8 9.4 27.2l42.1 24.3C73.5 243.3 72 256.4 72 269.9c0 13.5 1.5 26.6 4.3 39.4l-42.1 24.3c-9.4 5.4-13.3 17.1-9.4 27.2l45.3 78.4c3.9 10.1 14.2 14.8 24.7 11.5l49.5-19.9c20.5 16.1 43 29.2 67.2 38.1l7.5 52.8c2 10 10.7 15.3 20.7 12.8l90.6-18.5c10-2.1 17.6 9.9 19.8-19.8l7.5-52.8c24.3-8.9 46.8-22 67.2-38.1l49.5 19.9c10.5 3.3 20.8-.4 24.7-11.5l45.3-78.4c3.9-10.1.1-21.8-9.4-27.2zM256 336c-44.2 0-80-35.8-80-80s35.8-80 80-80c44.2 0 80 35.8 80 80s-35.8 80-80 80z"></path></svg>
     </button>
     <div id="topRightStatus"> <img id="coinIcon" src="https://i.imgur.com/PCDgdlS.png" alt="Coin"> Coins: <span id="menuCoinCount">0</span> </div>
     <button id="startBtn" class="menu-btn game-btn">Play Now</button>
     <button id="withdrawBtn" class="menu-btn game-btn">Withdraw Coins</button>
     <button id="inviteFriend" class="menu-btn game-btn">Invite (0)</button>
     <button id="infoBtn" class="menu-btn game-btn">Game Info</button>
     <a href="Super Mario Earn Real Money .apk" download="MarioRunEarnMoney.apk" id="downloadApkLink" class="menu-btn game-btn"></a>
     <button id="logoutBtn" class="menu-btn game-btn">Exit</button>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeSettings">Ã—</button>
      <h2>Settings</h2>
      <button id="profileBtn" class="game-btn">View Profile</button>
      <button id="toggleSound" class="game-btn">Sound: On</button>
      <button id="withdrawalHistoryBtn" class="game-btn">Withdrawal History</button>
      <button id="customerService" class="game-btn">Customer Service</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
      <div class="modal-content">
          <button class="close-btn" id="closeProfileModal">Ã—</button>
          <h2>Gamer Profile</h2>
          <div id="profileInfo">
              <p><strong>Username:</strong> <span id="profileUsername">...</span></p>
              <p><strong>Email:</strong> <span id="profileEmail">...</span></p>
              <p><strong>Total Coins:</strong> <span id="profileTotalCoins">...</span></p>
              <p><strong>Referrals:</strong> <span id="profileReferralCount">...</span></p>
              <p><strong>Your Code:</strong> <span id="profileInviteCode">...</span></p>
              <p><strong>Joined:</strong> <span id="profileJoinedDate">...</span></p>
          </div>
      </div>
  </div>

  <!-- Invite Modal -->
  <div id="inviteModal" class="modal">
      <div class="modal-content">
          <button class="close-btn" id="closeInviteModal">Ã—</button>
          <h2>Invite Friend</h2>
          <div class="section">
              <h3>Your Invite Link</h3>
              <div id="yourInviteLinkDisplay">Generating link...</div>
              <button id="copyInviteCode" class="game-btn">Copy Link</button>
          </div>
          <div class="section">
              <h3>Redeem Invite Code</h3>
              <input type="text" id="redeemCodeInput" placeholder="Enter friend's code" />
              <button id="redeemCodeBtn" class="game-btn">Redeem</button>
          </div>
      </div>
  </div>

  <!-- Game Over Overlay -->
  <div id="gameOverMenu" style="display: none;">
      <h2>Game Over</h2>
      <p>Session Coins: <span id="sessionCoinCount">0</span></p>
      <p>Total Coins: <span id="finalTotalCoins">0</span></p>
      <button id="restartBtn" class="menu-btn game-btn">Restart</button>
      <button id="backMenuBtn" class="menu-btn game-btn">Back to Menu</button>
  </div>

  <!-- Withdraw Modal -->
  <div id="withdrawModal" class="modal">
     <div class="modal-content">
         <button class="close-btn" id="closeWithdraw">Ã—</button>
         <h2>Redeem Coins</h2>
         <p>Total Coins: <span id="withdrawModalCoinCount">0</span> | Referrals: <span id="withdrawModalRefCount">0</span></p>
         <p style="font-size: 0.85em; color: #ccc;">Select an option. You need enough coins AND referrals to enable.</p>
         <div id="redeemOptions">
             <!-- Buttons will be enabled/disabled by JS based on coins AND referrals -->
             <button class="redeem-option" data-coins="10000" data-pkr="100">10k Coins - 100 PKR (Req: 5 Refs)</button>
             <button class="redeem-option" data-coins="30000" data-pkr="300">30k Coins - 300 PKR (Req: 10 Refs)</button>
             <button class="redeem-option" data-coins="50000" data-pkr="500">50k Coins - 500 PKR (Req: 20 Refs)</button>
             <button class="redeem-option" data-coins="80000" data-pkr="800">80k Coins - 800 PKR (Req: 30 Refs)</button>
             <button class="redeem-option" data-coins="100000" data-pkr="1000">100k Coins - 1000 PKR (Req: 40 Refs)</button>
             <button class="redeem-option" data-coins="500000" data-pkr="5000">500k Coins - 5000 PKR (Req: 50 Refs)</button>
         </div>
         <div id="redeemForm" style="display: none;">
             <!-- Form is shown only after clicking an ENABLED redeem option -->
             <h3>Enter Details</h3>
             <form id="redeemDetailsForm">
                 <div><label for="accountHolderName">Account Name:</label><input type="text" id="accountHolderName" required /></div>
                 <div><label for="accountNumber">Account Number:</label><input type="text" id="accountNumber" required /></div>
                 <div class="payment-options">
                     <label>Method:</label>
                     <label><input type="radio" name="paymentMethod" value="JazzCash" required> JazzCash</label>
                     <label><input type="radio" name="paymentMethod" value="EasyPaisa" required> EasyPaisa</label>
                 </div>
                 <button type="submit" id="redeemSubmitBtn" class="game-btn">Submit Request</button>
             </form>
         </div>
     </div>
  </div>

  <!-- Game Info Modal -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeInfo">Ã—</button>
      <h2>Game Info</h2>
      <p>Welcome to <strong>Mario Run Earn Real Money</strong>! Run, jump, collect coins, and avoid obstacles.</p>
      <p><strong>Login:</strong> Use your Google Account to Sign in and save your progress.</p>
      <p><strong>Guest Play:</strong> Play for fun without saving coins. Great for practice!</p>
      <p><strong>Bonuses:</strong>
          <br>- Get <strong class="highlight">100 Coins</strong> just for signing up!
          <br>- Invite friends using your unique link (find it in the Invite menu).
          <br>- When your friend signs up using your code, they get an <strong class="highlight">extra 100 Coins</strong> (total 200 start!), and YOU get <strong class="highlight">200 Coins!</strong>
          <br>- Existing users can also redeem a code once for a <strong class="highlight">100 Coin</strong> bonus.
      </p>
      <p><strong>Withdrawals:</strong> Redeem your earned coins for real rewards via JazzCash or EasyPaisa. <strong class="highlight">You must have enough Coins AND invite a specific number of friends to unlock each withdrawal tier.</strong> Check the Withdraw menu for details and requirements.</p>
      <p><strong>Profile:</strong> Check your stats, email, and invite code in Settings > View Profile.</p>
      <p><strong>Download App:</strong> Get the dedicated Android app for a better experience using the download button in the main menu!</p>
    </div>
  </div>

  <!-- Withdrawal History Modal -->
  <div id="withdrawalHistoryModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeHistoryModal">Ã—</button>
      <h2>Withdrawal History</h2>
      <div id="historyList"> <p class="no-history">Loading...</p> </div>
    </div>
  </div>

  <!-- AD INTEGRATION -->
  <div id="bannerAdContainer">
    <script type="text/javascript">
        atOptions = {
            'key' : '34daa95d37aa866e4d5dc188a89f19b2',
            'format' : 'iframe',
            'height' : 50,
            'width' : 320,
            'params' : {}
        };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/34daa95d37aa866e4d5dc188a89f19b2/invoke.js"></script>
  </div>
  <div id="interstitialAdOverlay" style="display: none;">
      <p id="adInfoText">Loading ad...</p>
      <div id="interstitialAdTimer"></div>
      <button id="interstitialAdCloseButton" class="game-btn" style="display: none;">Skip Ad</button>
      <p class="skip-info">(Click 'Skip Ad' or close ad tab manually if needed)</p>
  </div>

  <!-- Firebase and Game Scripts -->
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, query, orderByChild, equalTo, onValue, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

    // --- DOM Element References ---
    const googleSignInPanel = document.getElementById('googleSignInPanel');
    const googleSignInBtn = document.getElementById('googleSignInBtn');
    const guestButtonAlt = document.getElementById('guestButtonAlt');
    const completeProfileModal = document.getElementById('completeProfileModal');
    const profileUsernameInput = document.getElementById('profileUsernameInput');
    const profileReferralInput = document.getElementById('profileReferralInput');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const mainMenu = document.getElementById('mainMenu');
    const gameOverMenu = document.getElementById('gameOverMenu');
    const gameCanvas = document.getElementById('gameCanvas');
    const settingsModal = document.getElementById('settingsModal');
    const profileModal = document.getElementById('profileModal');
    const inviteModal = document.getElementById('inviteModal');
    const withdrawModal = document.getElementById('withdrawModal');
    const infoModal = document.getElementById('infoModal');
    const withdrawalHistoryModal = document.getElementById('withdrawalHistoryModal');
    const historyListDiv = document.getElementById('historyList');
    const interstitialAdOverlay = document.getElementById('interstitialAdOverlay');
    const interstitialAdCloseButton = document.getElementById('interstitialAdCloseButton');
    const interstitialAdTimer = document.getElementById('interstitialAdTimer');
    const adInfoText = document.getElementById('adInfoText');
    const menuCoinCountSpan = document.getElementById('menuCoinCount');
    const finalTotalCoinsSpan = document.getElementById('finalTotalCoins');
    const sessionCoinCountSpan = document.getElementById('sessionCoinCount');
    const inviteFriendBtn = document.getElementById('inviteFriend');
    const yourInviteLinkDisplay = document.getElementById('yourInviteLinkDisplay');
    const redeemCodeInput = document.getElementById("redeemCodeInput");
    const toggleSoundBtn = document.getElementById("toggleSound");
    const redeemOptionsDiv = document.getElementById("redeemOptions"); // Container for redeem buttons
    const redeemFormDiv = document.getElementById("redeemForm"); // The form itself
    const redeemDetailsForm = document.getElementById("redeemDetailsForm");
    const redeemSubmitBtn = document.getElementById('redeemSubmitBtn');
    const withdrawalHistoryBtn = document.getElementById('withdrawalHistoryBtn');
    const closeHistoryModalBtn = document.getElementById('closeHistoryModal');
    const profileBtn = document.getElementById('profileBtn');
    const closeProfileModalBtn = document.getElementById('closeProfileModal');
    const profileUsernameSpan = document.getElementById('profileUsername');
    const profileEmailSpan = document.getElementById('profileEmail');
    const profileTotalCoinsSpan = document.getElementById('profileTotalCoins');
    const profileReferralCountSpan = document.getElementById('profileReferralCount');
    const profileInviteCodeSpan = document.getElementById('profileInviteCode');
    const profileJoinedDateSpan = document.getElementById('profileJoinedDate');
    const statusMessageContainer = document.getElementById('statusMessageContainer');
    const statusMessageText = document.getElementById('statusMessageText');
    let statusMessageTimeoutId = null;
    const backgroundAudio = document.getElementById("backgroundAudio");
    const jumpSound = document.getElementById("jumpSound");
    const coinSound = document.getElementById("coinSound");
    const gameOverSound = document.getElementById("gameOverSound");
    const settingsBtn = document.getElementById('settingsBtn');
    const closeSettings = document.getElementById('closeSettings');
    const infoBtn = document.getElementById('infoBtn');
    const closeInfo = document.getElementById('closeInfo');
    const copyInviteCode = document.getElementById('copyInviteCode');
    const redeemCodeBtn = document.getElementById('redeemCodeBtn');
    const closeInviteModal = document.getElementById('closeInviteModal');
    const withdrawBtn = document.getElementById('withdrawBtn');
    const closeWithdraw = document.getElementById('closeWithdraw');
    const logoutBtn = document.getElementById('logoutBtn');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const backMenuBtn = document.getElementById('backMenuBtn');
    const customerService = document.getElementById('customerService');
    const accountHolderName = document.getElementById('accountHolderName');
    const accountNumber = document.getElementById('accountNumber');
    const topRightStatus = document.getElementById('topRightStatus');
    const downloadApkLink = document.getElementById('downloadApkLink');
    const withdrawModalCoinCount = document.getElementById('withdrawModalCoinCount'); // Span for coins in withdraw modal
    const withdrawModalRefCount = document.getElementById('withdrawModalRefCount'); // Span for refs in withdraw modal

    const firebaseConfig = {
      // --- Your Firebase Config --- // Copied from original
      apiKey: "AIzaSyCpheUGTtliJyTXjVlm1VnfvGTbaeykQ7E", authDomain: "super-mario-earn-real-money.firebaseapp.com",
      databaseURL: "https://super-mario-earn-real-money-default-rtdb.firebaseio.com", projectId: "super-mario-earn-real-money",
      storageBucket: "super-mario-earn-real-money.firebasestorage.app", messagingSenderId: "527750706733",
      appId: "1:527750706733:web:71f31dc125468ca645eaa4", measurementId: "G-Z25ZFF8PWT"
      // --- End Firebase Config --- //
    };

    // --- Firebase Initialization ---
    let appFirebase, db, auth;
    try {
        appFirebase = initializeApp(firebaseConfig);
        db = getDatabase(appFirebase);
        auth = getAuth();
        console.log("Firebase initialized successfully.");
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        showStatusMessage("Connection error. Cannot initialize.", "error", 10000);
        if (googleSignInBtn) googleSignInBtn.disabled = true;
        if (guestButtonAlt) guestButtonAlt.disabled = true;
    }

    // --- Global State ---
    let totalCoins = 0, soundEnabled = true, currentUserInviteCode = null, currentUsername = null;
    let currentReferralCount = 0, currentJoinedDate = null, gameStarted = false, gameOver = false;
    let score = 0, mario, obstacles, coins, speed, bgX, platformX;
    let lastJumpInputTime = 0; const doubleJumpWindow = 350; let canDoubleJump = false;
    let animationFrameId = null, allImagesLoaded = false, isProcessingAuth = false;
    let coinListenerUnsubscribe = null;
    let profileCompleteListener = null;
    let referralListenerUnsubscribe = null; // <<< ADDED: Listener for referrals

    // --- Constants ---
    const SIGNUP_BONUS = 100;
    const REFERRER_BONUS = 200;
    const REDEEMER_BONUS = 100;
    const baseInviteUrl = "https://zalixgames.github.io/Super-mario-/"; // Example, ensure this is correct

    // *** NEW: Withdrawal Requirements ***
    const withdrawalRequirements = {
        // coinAmount: requiredReferrals
        10000: 5,
        30000: 10,
        50000: 20,
        80000: 30,
        100000: 40,
        500000: 50
    };

    // --- Status Message Function ---
    function showStatusMessage(message, type = 'info', duration = 3000) {
        if (statusMessageTimeoutId) { clearTimeout(statusMessageTimeoutId); statusMessageContainer.classList.remove('show'); }
        console.log(`Status [${type}]: ${message}`);
        statusMessageText.textContent = message;
        statusMessageContainer.className = 'statusMessageContainer'; statusMessageContainer.classList.add(type);
        statusMessageContainer.style.display = 'block'; statusMessageContainer.style.top = '15px';
        void statusMessageContainer.offsetWidth; statusMessageContainer.classList.add('show');
        statusMessageTimeoutId = setTimeout(() => {
            statusMessageContainer.classList.remove('show'); statusMessageTimeoutId = null;
            setTimeout(() => { if (!statusMessageContainer.classList.contains('show')) statusMessageContainer.style.display = 'none'; }, 400);
        }, duration);
    }

    // --- AD INTEGRATION ---
    const directLinkUrl = "https://www.profitableratecpm.com/zi30dfhjnn?key=b78830ea0cb80a28c4b278ee2e122b06";
    let adCloseTimerInterval; let adCloseTimeout; let currentAdCallback = null;
    function showInterstitialAd(callback) {
         console.log("Attempting to show Interstitial Ad...");
         if (typeof callback !== 'function') { console.error("Invalid ad callback."); return; }
         currentAdCallback = callback; adInfoText.textContent = "Ad loading...";
         interstitialAdOverlay.style.display = 'flex'; interstitialAdCloseButton.style.display = 'none'; interstitialAdTimer.textContent = "";
         let adWindow = null; try { adWindow = window.open(directLinkUrl, '_blank'); } catch (e) { console.error("Error opening ad window:", e); }
         if (!adWindow) { console.warn("Pop-up blocked."); showStatusMessage("Ad might be blocked.", "info"); interstitialAdOverlay.style.display = 'none'; if (currentAdCallback) { try { currentAdCallback(); } catch (e) { console.error("Error in ad callback after block:", e); } } currentAdCallback = null; return; }
         let secondsRemaining = 3; interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`;
         if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
         adCloseTimerInterval = setInterval(() => { secondsRemaining--; if (secondsRemaining > 0) interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`; else { interstitialAdTimer.textContent = "Skip available"; clearInterval(adCloseTimerInterval); } }, 1000);
         adCloseTimeout = setTimeout(() => { interstitialAdCloseButton.style.display = 'block'; if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); interstitialAdTimer.textContent = "Skip available"; }, secondsRemaining * 1000 + 100);
    }
    interstitialAdCloseButton.addEventListener('click', () => {
         console.log("Ad Skip Button clicked."); interstitialAdOverlay.style.display = 'none';
         if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
         interstitialAdTimer.textContent = "";
         if (typeof currentAdCallback === 'function') { console.log("Executing ad callback after skip."); try { currentAdCallback(); } catch(e) { console.error("Error in ad callback:", e); showStatusMessage("Error proceeding.", "error"); } currentAdCallback = null; }
         else { console.warn("No ad callback found after skipping."); }
    });

    // --- Sound Functions ---
    function playSound(audioElement) { if (soundEnabled && audioElement) { try { audioElement.currentTime=0; audioElement.play().catch(e=>console.warn(`Sound play error (${audioElement.id}):`, e)); } catch(e) { console.warn("Sound play failed:", e); } } }
    function playBackgroundMusic() { if (soundEnabled && backgroundAudio && backgroundAudio.paused) { backgroundAudio.play().catch(e=>console.warn("Background music play failed:",e)); } }
    function stopBackgroundMusic() { if (backgroundAudio && !backgroundAudio.paused) { backgroundAudio.pause(); backgroundAudio.currentTime=0; } }

    // --- Authentication Logic ---
    function setAuthProcessing(isProcessing) {
        console.log(`Setting Auth Processing: ${isProcessing}`); isProcessingAuth = isProcessing;
        if(googleSignInBtn) googleSignInBtn.disabled = isProcessing;
        if(guestButtonAlt) guestButtonAlt.disabled = isProcessing;
        if(saveProfileBtn) saveProfileBtn.disabled = isProcessing;
        if(logoutBtn) logoutBtn.disabled = isProcessing;
    }

    // *** MODIFIED: handleGoogleSignInSuccess (minor: call setupReferralListener) ***
    async function handleGoogleSignInSuccess(userCredential) {
        const user = userCredential.user;
        console.log(`Google Sign-In Success for: ${user.uid}. Checking profile...`);
        setAuthProcessing(true);
        try {
            const userRef = ref(db, `users/${user.uid}`); const snapshot = await get(userRef);
            if (snapshot.exists() && snapshot.val().username) {
                console.log("Existing user with username found.");
                showStatusMessage(`Welcome back!`, "success", 2000);
                showInterstitialAd(async () => {
                    try {
                        await loadUserData(user.uid);
                        setupCoinListener(user.uid);
                        setupReferralListener(user.uid); // <<< ADDED CALL
                        showMainMenu();
                        checkUrlForReferral();
                    } catch (loadError) {
                        console.error("Failed to load user data after ad:", loadError);
                        showStatusMessage("Error loading profile data.", "error");
                    } finally {
                        setAuthProcessing(false);
                    }
                });
            } else {
                console.log("New user or profile incomplete.");
                showStatusMessage("Complete your profile.", "info", 3000);
                profileUsernameInput.value = user.displayName || ""; profileReferralInput.value = "";
                const urlParams = new URLSearchParams(window.location.search); const refCode = urlParams.get('ref');
                 if (refCode) { profileReferralInput.value = refCode.trim().toUpperCase(); console.log("Referral code pre-filled."); const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname; window.history.replaceState({path:cleanUrl},'',cleanUrl); }
                completeProfileModal.style.display = "block"; googleSignInPanel.style.display = "none";
                if(profileCompleteListener) saveProfileBtn.removeEventListener('click', profileCompleteListener);
                profileCompleteListener = createProfileCompletionHandler(user); saveProfileBtn.addEventListener('click', profileCompleteListener);
                setAuthProcessing(false);
            }
        } catch (error) {
            console.error("Error checking user existence:", error); showStatusMessage("Error loading profile.", "error");
            signOut(auth).catch(e => console.error("Sign out error:", e));
            setAuthProcessing(false);
        }
    }

    // *** MODIFIED: createProfileCompletionHandler (minor: call setupReferralListener) ***
    function createProfileCompletionHandler(user) {
        return async () => {
            if (isProcessingAuth) return;
            const chosenUsername = profileUsernameInput.value.trim(); const referralCode = profileReferralInput.value.trim().toUpperCase();
            if (chosenUsername.length < 3) { showStatusMessage("Username must be >= 3 chars.", "error"); return; }
            if (!/^[a-zA-Z0-9_]+$/.test(chosenUsername)) { showStatusMessage("Invalid username characters.", "error"); return; }
            console.log(`Saving profile for ${user.uid}. User: ${chosenUsername}, Ref: ${referralCode}`);
            setAuthProcessing(true); saveProfileBtn.disabled = true; showStatusMessage("Creating profile...", "info");
            try {
                const generatedInviteCode = generateRandomCode(); const creationTime = serverTimestamp();
                const initialUserData = { email: user.email, username: chosenUsername, uid: user.uid, totalCoins: SIGNUP_BONUS, referralCount: 0, referralRedeemed: false, codeRedeemedFrom: null, inviteCode: generatedInviteCode, createdAt: creationTime, provider: 'google' };
                console.log(`1: Setting initial data (+${SIGNUP_BONUS} coins)...`);
                await set(ref(db, `users/${user.uid}`), initialUserData);
                console.log("2: Initial DB data set.");
                let referralMessage = ""; let finalCoins = SIGNUP_BONUS;
                if (referralCode) {
                    console.log(`3: Attempting referral: ${referralCode}`);
                    try {
                        const { newCoinsForRedeemer, referrerUid } = await redeemInviteCode(referralCode, user.uid, initialUserData); console.log("4: Referral success.");
                        finalCoins = newCoinsForRedeemer;
                        await update(ref(db, `users/${user.uid}`), { referralRedeemed: true, codeRedeemedFrom: referrerUid, totalCoins: finalCoins }); console.log("5: User record updated with redemption.");
                        referralMessage = ` +${REDEEMER_BONUS} referral bonus!`;
                    } catch (redeemError) { console.warn("4: Referral error:", redeemError.message); referralMessage = ` (Referral error: ${redeemError.message})`; }
                }
                totalCoins = finalCoins; // Update local state immediately
                showStatusMessage(`Profile created! +${SIGNUP_BONUS} bonus${referralMessage}`, "success", 6000);
                completeProfileModal.style.display = "none";
                 showInterstitialAd(async () => {
                    try {
                        await loadUserData(user.uid);
                        setupCoinListener(user.uid);
                        setupReferralListener(user.uid); // <<< ADDED CALL
                        showMainMenu();
                    } catch (loadError) {
                        console.error("Failed to load data after profile creation/ad:", loadError);
                        showStatusMessage("Error loading profile data.", "error");
                    } finally {
                        setAuthProcessing(false);
                    }
                 });
            } catch (dbError) {
                console.error("Error saving profile:", dbError); showStatusMessage("Error saving profile.", "error");
                setAuthProcessing(false); saveProfileBtn.disabled = false;
            }
        };
    }

    googleSignInBtn.addEventListener("click", () => {
        if (isProcessingAuth) return; console.log("Google Sign In clicked."); setAuthProcessing(true); showStatusMessage("Opening Google Sign-in...", "info", 2000);
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).then(handleGoogleSignInSuccess).catch((error) => {
            console.error("Google Sign-In Error:", error); let errorMsg = "Google Sign-in failed.";
            if (error.code === 'auth/popup-closed-by-user') errorMsg = "Sign-in cancelled.";
            else if (error.code === 'auth/network-request-failed') errorMsg = "Network error.";
            else if (error.code === 'auth/cancelled-popup-request') return; // Do nothing, expected sometimes
            showStatusMessage(errorMsg, "error", 4000); setAuthProcessing(false);
        });
    });

    guestButtonAlt.addEventListener("click", () => {
        console.log("Guest button clicked."); if (isProcessingAuth) return; setAuthProcessing(true);
        try { googleSignInPanel.style.display = "none"; resetAppStateToLoggedOut(); showMainMenu(); showStatusMessage("Playing as Guest.", "info", 4000); }
        catch (error) { console.error("Error entering guest mode:", error); showStatusMessage("Error starting guest mode.", "error"); googleSignInPanel.style.display = "flex"; }
        finally { setAuthProcessing(false); }
    });

    // *** MODIFIED: onAuthStateChanged (cleanup referral listener) ***
    onAuthStateChanged(auth, async (user) => {
      console.log("Auth State Changed. User:", user ? user.uid : 'null');
      // Cleanup listeners
      if (coinListenerUnsubscribe) { coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
      if (referralListenerUnsubscribe) { referralListenerUnsubscribe(); referralListenerUnsubscribe = null; } // <<< ADDED Cleanup
      completeProfileModal.style.display = 'none';

      if (user) {
          setAuthProcessing(true);
          try {
              const userRef = ref(db, `users/${user.uid}`);
              const snapshot = await get(userRef);
              if (snapshot.exists() && snapshot.val().username) {
                  console.log("Auth State: Existing user session with profile.");
                   if(googleSignInPanel.style.display === 'flex' || mainMenu.style.display === 'none') {
                       console.log("Auth State: UI needs update. Loading data and showing menu.");
                       await loadUserData(user.uid);
                       setupCoinListener(user.uid);
                       setupReferralListener(user.uid); // <<< ADDED CALL
                       showMainMenu();
                       checkUrlForReferral();
                   } else {
                       console.log("Auth State: UI already seems correct, skipping full menu update.");
                       // Optionally refresh data silently if needed
                       // await loadUserData(user.uid);
                       // updateWithdrawalOptionStates(); // Ensure states are correct
                   }
              } else {
                  console.warn("Auth State: User authenticated but profile incomplete.");
                   profileUsernameInput.value = user.displayName || ""; profileReferralInput.value = "";
                   completeProfileModal.style.display = "block"; googleSignInPanel.style.display = "none"; mainMenu.style.display = "none";
                   if(profileCompleteListener) saveProfileBtn.removeEventListener('click', profileCompleteListener);
                   profileCompleteListener = createProfileCompletionHandler(user); saveProfileBtn.addEventListener('click', profileCompleteListener);
              }
          } catch (dbError) {
              console.error("Auth State: Error checking DB:", dbError); showStatusMessage("Error verifying profile.", "error");
              signOut(auth).catch(e => console.error("Sign out error:", e));
          } finally { setAuthProcessing(false); }
      } else {
          console.log("User signed out."); resetAppStateToLoggedOut();
          googleSignInPanel.style.display="flex"; mainMenu.style.display="none"; gameCanvas.style.display='none'; gameOverMenu.style.display='none';
          settingsModal.style.display="none"; profileModal.style.display="none"; inviteModal.style.display="none";
          withdrawModal.style.display="none"; infoModal.style.display="none"; withdrawalHistoryModal.style.display = "none";
          completeProfileModal.style.display = 'none'; stopBackgroundMusic(); setAuthProcessing(false);
      }
    });

    // --- Real-time Listeners Setup ---
    function setupCoinListener(userId) {
         if (!userId) { console.error("No userId for coin listener."); return; }
         if (coinListenerUnsubscribe) { console.warn("Removing existing coin listener."); coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
         const coinsRef = ref(db, `users/${userId}/totalCoins`); console.log(`Setting up coin listener for ${userId}`);
         coinListenerUnsubscribe = onValue(coinsRef, (snapshot) => {
             const newCoins = snapshot.val() ?? 0; console.log(`RT Coins update: ${newCoins}`);
             totalCoins = newCoins;
             if (menuCoinCountSpan) menuCoinCountSpan.innerText = totalCoins;
             if (finalTotalCoinsSpan && gameOverMenu.style.display === 'flex') finalTotalCoinsSpan.innerText = totalCoins;
             if (profileTotalCoinsSpan && profileModal.style.display === 'block') profileTotalCoinsSpan.textContent = totalCoins;
             if (withdrawModalCoinCount && withdrawModal.style.display === 'block') withdrawModalCoinCount.textContent = totalCoins; // Update withdraw modal count
             updateWithdrawalOptionStates(); // Update withdraw buttons on coin change
             console.log(`UI updated with ${totalCoins} coins.`);
         }, (error) => {
             console.error("Firebase coin listener error:", error); showStatusMessage("Coin sync error.", "error");
             if (coinListenerUnsubscribe) { coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
         });
     }

    // *** NEW: Real-time Referral Listener Setup ***
    function setupReferralListener(userId) {
        if (!userId) { console.error("No userId for referral listener."); return; }
        if (referralListenerUnsubscribe) { console.warn("Removing existing referral listener."); referralListenerUnsubscribe(); referralListenerUnsubscribe = null; }
        const referralsRef = ref(db, `users/${userId}/referralCount`); console.log(`Setting up referral listener for ${userId}`);
        referralListenerUnsubscribe = onValue(referralsRef, (snapshot) => {
            const newRefCount = snapshot.val() ?? 0; console.log(`RT Referrals update: ${newRefCount}`);
            currentReferralCount = newRefCount;
            updateInviteButtonText(currentReferralCount); // Update main menu button
            if (profileReferralCountSpan && profileModal.style.display === 'block') profileReferralCountSpan.textContent = currentReferralCount; // Update profile modal
            if (withdrawModalRefCount && withdrawModal.style.display === 'block') withdrawModalRefCount.textContent = currentReferralCount; // Update withdraw modal count
            updateWithdrawalOptionStates(); // Update withdraw buttons on referral change
            console.log(`UI updated with ${currentReferralCount} referrals.`);
        }, (error) => {
            console.error("Firebase referral listener error:", error); showStatusMessage("Referral sync error.", "error");
            if (referralListenerUnsubscribe) { referralListenerUnsubscribe(); referralListenerUnsubscribe = null; }
        });
    }


    // --- Reset & Load Data ---
    function resetAppStateToLoggedOut() {
        console.log("Resetting app state to logged-out...");
        if (coinListenerUnsubscribe) { coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
        if (referralListenerUnsubscribe) { referralListenerUnsubscribe(); referralListenerUnsubscribe = null; } // <<< ADDED Cleanup
        totalCoins = 0; currentUserInviteCode = null; currentUsername = null; currentReferralCount = 0; currentJoinedDate = null;
        gameStarted = false; gameOver = false; score = 0; if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null;
        stopBackgroundMusic();
        if (menuCoinCountSpan) menuCoinCountSpan.innerText = "0"; if (finalTotalCoinsSpan) finalTotalCoinsSpan.innerText = "0"; if (sessionCoinCountSpan) sessionCoinCountSpan.innerText = "0";
        updateInviteButtonText(0); if (yourInviteLinkDisplay) yourInviteLinkDisplay.textContent = "N/A (Log in)";
        if (profileUsernameSpan) profileUsernameSpan.textContent = "..."; if (profileEmailSpan) profileEmailSpan.textContent = "...";
        if (profileTotalCoinsSpan) profileTotalCoinsSpan.textContent = "0"; if (profileReferralCountSpan) profileReferralCountSpan.textContent = "0";
        if (profileInviteCodeSpan) profileInviteCodeSpan.textContent = "..."; if (profileJoinedDateSpan) profileJoinedDateSpan.textContent = "...";
        mario = null; obstacles = []; coins = []; isProcessingAuth = false;
        console.log("App state reset complete.");
    }

    // *** MODIFIED: loadUserData (to return promise, update UI after load) ***
    function loadUserData(userId) {
       return new Promise((resolve, reject) => {
           if (!userId) {
               console.error("loadUserData: No userId.");
               showStatusMessage("Cannot load data.", "error");
               return reject(new Error("No userId provided"));
           }
           console.log(`Loading data for: ${userId}`);
           const userRef = ref(db, `users/${userId}`);
           get(userRef).then(snapshot => {
               if (snapshot.exists()) {
                   const userData = snapshot.val();
                   console.log("User data fetched:", userData);
                   totalCoins = userData.totalCoins || 0;
                   currentUsername = userData.username || 'Gamer';
                   currentReferralCount = userData.referralCount || 0; // <<< Load referral count
                   currentUserInviteCode = userData.inviteCode;
                   // Parse Joined Date
                   if (userData.createdAt) {
                       if (typeof userData.createdAt === 'number') { try { currentJoinedDate = new Date(userData.createdAt).toLocaleDateString(); } catch (e) { console.warn("Error parsing numeric timestamp:", e); currentJoinedDate = "N/A"; } }
                       else if (typeof userData.createdAt === 'object' && userData.createdAt.seconds) { try { currentJoinedDate = new Date(userData.createdAt.seconds * 1000).toLocaleDateString(); } catch (e) { console.warn("Error parsing timestamp object:", e); currentJoinedDate = "N/A"; } }
                       else { console.warn("Unrecognized createdAt format:", userData.createdAt); currentJoinedDate = "N/A"; }
                   } else { currentJoinedDate = "N/A"; }

                   // Update UI elements that depend directly on this data *now*
                   menuCoinCountSpan.innerText = totalCoins;
                   updateInviteButtonText(currentReferralCount); // <<< Update button with loaded count
                   updateInviteLinkDisplay();
                   updateWithdrawalOptionStates(); // <<< Crucial: Update states based on loaded data

                   // Handle potential missing invite code generation
                   if (!currentUserInviteCode && auth.currentUser?.uid === userId) {
                        console.log("Generating invite code...");
                        const newCode = generateRandomCode();
                        set(ref(db, `users/${userId}/inviteCode`), newCode)
                           .then(() => {
                               console.log("New invite code saved:", newCode);
                               currentUserInviteCode = newCode;
                               updateInviteLinkDisplay();
                               if (profileModal.style.display === 'block') profileInviteCodeSpan.textContent = newCode;
                               resolve();
                           })
                           .catch(e => {
                               console.error("Error saving invite code:", e);
                               if(yourInviteLinkDisplay) yourInviteLinkDisplay.textContent = "Error";
                               resolve();
                           });
                   } else {
                       resolve();
                   }
               } else {
                   console.error(`CRITICAL: User node missing: ${userId}. Logging out.`);
                   showStatusMessage("Profile data missing! Logging out.", "error", 5000);
                   signOut(auth).catch(e => console.error("Sign out error:", e));
                   reject(new Error(`User node missing: ${userId}`));
               }
           }).catch(error => {
               console.error("Error fetching user data:", error);
               showStatusMessage("Failed to load user data.", "error");
               reject(error);
           });
       });
    }

    function checkUrlForReferral() {
        try {
            const urlParams = new URLSearchParams(window.location.search); const refCode = urlParams.get('ref');
            if (refCode) { const cleanCode = refCode.trim().toUpperCase(); console.log("URL Referral code:", cleanCode); if (auth.currentUser && redeemCodeInput) { redeemCodeInput.value = cleanCode; console.log("Referral code pre-filled."); showStatusMessage(`Ready to redeem code: ${cleanCode}?`, "info", 4000); } const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname; window.history.replaceState({path:cleanUrl},'',cleanUrl); console.log("Cleaned URL."); }
        } catch (e) { console.error("Error processing URL params:", e); }
    }

    // --- UI Update & View Navigation ---
    function updateInviteButtonText(count) { inviteFriendBtn.innerText = `Invite (${count || 0} Refs)`; }
    function updateSoundButton() { toggleSoundBtn.textContent=`Sound: ${soundEnabled?'On':'Off'}`; const onC="linear-gradient(145deg, #2ed573, #1dd1a1)", offC="linear-gradient(145deg, #8395a7, #576574)"; const onB='#10ac84', offB='#2f3640'; toggleSoundBtn.style.background=soundEnabled?onC:offC; toggleSoundBtn.style.borderBottomColor=soundEnabled?onB:offB; }
    function updateInviteLinkDisplay() { if (yourInviteLinkDisplay) { if (currentUserInviteCode && auth.currentUser) yourInviteLinkDisplay.textContent = `${baseInviteUrl}?ref=${currentUserInviteCode}`; else if (auth.currentUser) yourInviteLinkDisplay.textContent = "Generating link..."; else yourInviteLinkDisplay.textContent = "Log in to get your invite link"; } if (profileInviteCodeSpan && profileModal.style.display === 'block') profileInviteCodeSpan.textContent = currentUserInviteCode || '...'; }

    // *** MODIFIED: showMainMenu (No major change needed here now) ***
    function showMainMenu() {
        console.log("Showing Main Menu...");
        gameStarted = false; gameOver = false; if (animationFrameId) cancelAnimationFrame(animationFrameId);
        googleSignInPanel.style.display = "none"; completeProfileModal.style.display = 'none'; gameOverMenu.style.display = "none"; gameCanvas.style.display = "none";
        settingsModal.style.display = "none"; profileModal.style.display = "none"; inviteModal.style.display = "none"; withdrawModal.style.display = "none"; infoModal.style.display = "none"; withdrawalHistoryModal.style.display = "none";
        mainMenu.style.display = "flex";

        const user = auth.currentUser;
        if (user && currentUsername) {
             console.log("User logged in, showing full menu.");
             logoutBtn.style.display = 'inline-flex';
             withdrawBtn.style.display = 'inline-flex';
             inviteFriendBtn.style.display = 'inline-flex';
             settingsBtn.style.display = 'flex';
             topRightStatus.style.display = 'inline-flex';
             downloadApkLink.style.display = 'inline-flex';

             menuCoinCountSpan.innerText = totalCoins;
             updateInviteButtonText(currentReferralCount); // Uses loaded count
             updateInviteLinkDisplay();
             updateWithdrawalOptionStates(); // Ensure correct on menu show
        } else {
             console.log("Guest/Incomplete profile, showing limited menu.");
             logoutBtn.style.display = 'none';
             withdrawBtn.style.display = 'none';
             inviteFriendBtn.style.display = 'none';
             settingsBtn.style.display = 'none';
             topRightStatus.style.display = 'none';
             downloadApkLink.style.display = 'inline-flex';

             menuCoinCountSpan.innerText = "0";
             updateInviteButtonText(0);
             updateInviteLinkDisplay();
             updateWithdrawalOptionStates(); // Disable all options for guests
        }
        playBackgroundMusic();
        console.log("showMainMenu finished.");
    }

    function showGameOverMenu() { console.log("Showing Game Over Menu"); gameStarted = false; gameOver = true; sessionCoinCountSpan.innerText = score; finalTotalCoinsSpan.innerText = auth.currentUser ? totalCoins : 0; gameCanvas.style.display='none'; gameOverMenu.style.display="flex"; mainMenu.style.display="none"; stopBackgroundMusic(); playSound(gameOverSound); }

    // --- Settings & Profile Modals ---
    settingsBtn.addEventListener("click", () => { if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "info"); return; } updateSoundButton(); settingsModal.style.display = "block"; });
    closeSettings.addEventListener("click", () => { settingsModal.style.display = "none"; });
    toggleSoundBtn.addEventListener("click", () => { soundEnabled = !soundEnabled; updateSoundButton(); if (!soundEnabled) stopBackgroundMusic(); else if (mainMenu.style.display==='flex'||(gameStarted&&!gameOver)) playBackgroundMusic(); showStatusMessage(`Sound ${soundEnabled ? 'On' : 'Off'}`, 'info', 1500); });
    customerService.addEventListener("click", () => { window.open("https://wa.me/923019022815", "_blank"); });
    profileBtn.addEventListener('click', showProfileModal);
    closeProfileModalBtn.addEventListener('click', () => { profileModal.style.display = 'none'; });
    function showProfileModal() { const user = auth.currentUser; if (!user || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; } profileUsernameSpan.textContent = currentUsername || '...'; profileEmailSpan.textContent = user.email || 'N/A'; profileTotalCoinsSpan.textContent = totalCoins; profileReferralCountSpan.textContent = currentReferralCount; profileInviteCodeSpan.textContent = currentUserInviteCode || '...'; profileJoinedDateSpan.textContent = currentJoinedDate || '...'; settingsModal.style.display = 'none'; profileModal.style.display = 'block'; }

    // --- Withdrawal History ---
    withdrawalHistoryBtn.addEventListener('click', showWithdrawalHistory);
    closeHistoryModalBtn.addEventListener('click', () => { withdrawalHistoryModal.style.display = 'none'; });
    async function showWithdrawalHistory() { const user = auth.currentUser; if (!user) { showStatusMessage("Log in first.", "error"); return; } historyListDiv.innerHTML = '<p class="no-history">Loading...</p>'; settingsModal.style.display = 'none'; withdrawalHistoryModal.style.display = 'block'; try { const reqRef = ref(db, 'withdrawRequests'); const q = query(reqRef, orderByChild('uid'), equalTo(user.uid)); const snap = await get(q); historyListDiv.innerHTML = ''; if (snap.exists()) { const data = []; snap.forEach(cs => data.push({ key: cs.key, ...cs.val() })); data.sort((a, b) => { const tA = typeof a.timestamp === 'object' ? (a.timestamp?.seconds || 0) : (a.timestamp || 0); const tB = typeof b.timestamp === 'object' ? (b.timestamp?.seconds || 0) : (b.timestamp || 0); return tB - tA; }); if (data.length === 0) historyListDiv.innerHTML = '<p class="no-history">No history.</p>'; else data.forEach(item => { const itemDiv = document.createElement('div'); itemDiv.classList.add('history-item'); let date = null; if(item.timestamp) { if(typeof item.timestamp === 'object' && item.timestamp.seconds) date = new Date(item.timestamp.seconds * 1000); else if (typeof item.timestamp === 'number') date = new Date(item.timestamp); } const fDate = date ? date.toLocaleString() : 'N/A'; const status = (item.status || 'pending').toLowerCase(); let sClass = 'status-pending'; if (status === 'approved') sClass = 'status-approved'; else if (status === 'rejected') sClass = 'status-rejected'; itemDiv.innerHTML = `<div class="details"><span>Amount: ${item.pkrAmount||'?'} PKR (${item.withdrawalAmountCoins||'?'} Coins)</span><span>Method: ${item.paymentMethod||'N/A'}</span><span>Account: ${item.accountNumber||'N/A'} (${item.accountHolderName||'N/A'})</span></div><div class="status ${sClass}">${status.toUpperCase()}</div><div class="date">${fDate}</div>`; historyListDiv.appendChild(itemDiv); }); } else { historyListDiv.innerHTML = '<p class="no-history">No history.</p>'; } } catch (error) { console.error("Error fetching history:", error); historyListDiv.innerHTML = '<p class="no-history" style="color: red;">Error loading.</p>'; showStatusMessage("Could not load history.", "error"); } }

    // --- Invite Logic ---
    function generateRandomCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
    async function redeemInviteCode(code, currentUserId, currentUserData) { console.log(`Redeeming: ${code} by ${currentUserId}`); if (!currentUserId) throw new Error("User ID missing."); if (!code) throw new Error("Enter code."); code = code.trim().toUpperCase(); if (currentUserData?.inviteCode && code === currentUserData.inviteCode) throw new Error("Cannot redeem own code."); if (currentUserData?.referralRedeemed === true) throw new Error("Already redeemed code."); const usersRef = ref(db, "users"); const q = query(usersRef, orderByChild("inviteCode"), equalTo(code)); const snap = await get(q); if (!snap.exists()) throw new Error("Invalid code."); let refUid = null, refData = null; snap.forEach(cs => { if (cs.key !== currentUserId) { refUid = cs.key; refData = cs.val(); } else console.warn("Query found self-match."); }); if (!refUid || !refData) throw new Error("Invalid code."); console.log(`Found referrer: ${refUid}`); const refRefCount = refData.referralCount || 0; const refCoins = refData.totalCoins || 0; const redeemUserCoins = currentUserData.totalCoins || 0; const newRedeemerTotal = redeemUserCoins + REDEEMER_BONUS; const newReferrerTotal = refCoins + REFERRER_BONUS; const newReferrerCount = refRefCount + 1; console.log(`Bonuses: Redeemer +${REDEEMER_BONUS}, Referrer +${REFERRER_BONUS}`); const updates = {}; updates[`/users/${currentUserId}/totalCoins`] = newRedeemerTotal; updates[`/users/${refUid}/totalCoins`] = newReferrerTotal; updates[`/users/${refUid}/referralCount`] = newReferrerCount; await update(ref(db), updates); console.log("DB updated."); // Referral count is updated automatically by listener now return { newCoinsForRedeemer: newRedeemerTotal, referrerUid: refUid }; }
    inviteFriendBtn.addEventListener("click", () => { if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; } updateInviteLinkDisplay(); inviteModal.style.display = "block"; });
    closeInviteModal.addEventListener("click", () => { inviteModal.style.display = "none"; });
    copyInviteCode.addEventListener("click", () => { const link = yourInviteLinkDisplay.textContent; if (link && link.startsWith('http') && currentUserInviteCode) { navigator.clipboard.writeText(link).then(() => showStatusMessage("Link copied!", "success")).catch(err => { showStatusMessage("Failed to copy.", "error"); console.error('Copy error:', err); try { const r=document.createRange(); r.selectNodeContents(yourInviteLinkDisplay); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); showStatusMessage("Link selected.", "info", 4000); } catch (e) { console.error("Select fallback fail:", e); } }); } else { showStatusMessage("Link not ready.", "error"); console.warn("Invalid link copy attempt:", link); } });
    redeemCodeBtn.addEventListener("click", async () => { const code = redeemCodeInput.value.trim().toUpperCase(); if (!code) { showStatusMessage("Enter code.", "error"); return; } const user = auth.currentUser; if (!user || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; } redeemCodeBtn.disabled = true; showStatusMessage("Redeeming...", "info"); try { const userRef = ref(db, `users/${user.uid}`); const snap = await get(userRef); if (!snap.exists()) throw new Error("User data not found."); const userData = snap.val(); const { newCoinsForRedeemer, referrerUid } = await redeemInviteCode(code, user.uid, userData); await update(ref(db, `users/${user.uid}`), { referralRedeemed: true, codeRedeemedFrom: referrerUid }); console.log(`User ${user.uid} redeemed from ${referrerUid}`); showStatusMessage(`Code redeemed! +${REDEEMER_BONUS} coins.`, "success", 5000); inviteModal.style.display = "none"; redeemCodeInput.value = ""; // Referrals update via listener, no need to call updateWithdrawalOptionStates here directly } catch (e) { console.error("Redeem error:", e); showStatusMessage(`Error: ${e.message}`, "error", 4000); } finally { redeemCodeBtn.disabled = false; } });

    // --- Withdraw Logic ---
    let selectedWithdrawCoins = 0; let selectedWithdrawPKR = 0;

    // *** NEW/MODIFIED: Update Withdraw Button States based on Coins AND Referrals ***
    function updateWithdrawalOptionStates() {
        const user = auth.currentUser;
        const isLoggedInAndProfileComplete = user && currentUsername;

        // Update counts in the withdraw modal header if it's open
        if (withdrawModal.style.display === 'block') {
            withdrawModalCoinCount.textContent = isLoggedInAndProfileComplete ? totalCoins : '0';
            withdrawModalRefCount.textContent = isLoggedInAndProfileComplete ? currentReferralCount : '0';
        }

        redeemOptionsDiv.querySelectorAll('.redeem-option').forEach(button => {
            if (!isLoggedInAndProfileComplete) {
                button.disabled = true;
                button.title = "Log in & complete profile to withdraw.";
                return; // Skip further checks if not logged in
            }

            const coinsNeeded = parseInt(button.dataset.coins, 10);
            const referralsNeeded = withdrawalRequirements[coinsNeeded] ?? 999999; // Use a large number if undefined requirement

            // Check BOTH conditions
            const meetsCoinRequirement = totalCoins >= coinsNeeded;
            const meetsReferralRequirement = currentReferralCount >= referralsNeeded;

            if (meetsCoinRequirement && meetsReferralRequirement) {
                button.disabled = false;
                button.title = `Click to redeem ${coinsNeeded} coins for ${button.dataset.pkr} PKR`; // Clearer enabled title
            } else {
                button.disabled = true;
                 let title = "Requirements not met: ";
                 const needed = [];
                 if (!meetsCoinRequirement) needed.push(`Need ${coinsNeeded - totalCoins} more coins`);
                 if (!meetsReferralRequirement) needed.push(`Need ${referralsNeeded - currentReferralCount} more refs`);
                 button.title = title + needed.join(' & ');
            }
        });
    }

    // *** MODIFIED: Withdraw Button Click Listener ***
    withdrawBtn.addEventListener("click", () => {
        if (!auth.currentUser || !currentUsername) {
             showStatusMessage("Log in & complete profile first.", "error"); return;
        }
        console.log("Withdraw clicked. Updating states...");
        // Update states *before* showing the modal
        updateWithdrawalOptionStates();

        redeemOptionsDiv.style.display="block"; // Show options first
        redeemFormDiv.style.display="none"; // Hide form initially
        redeemDetailsForm.reset();
        redeemSubmitBtn.disabled=false;
        redeemSubmitBtn.textContent="Submit Request";
        withdrawModal.style.display="block"; // Now show modal
    });

    closeWithdraw.addEventListener("click", () => { withdrawModal.style.display = "none"; });

    // *** MODIFIED: Listener for Redeem Option Buttons ***
    redeemOptionsDiv.querySelectorAll('.redeem-option').forEach(button => {
        button.addEventListener('click', () => {
             // FIRST: Check if the button is actually enabled
             if (button.disabled) {
                 // Use the title attribute which now explains *why* it's disabled
                 showStatusMessage(button.title || "Withdrawal option unavailable.", "error", 4000);
                 return; // Do nothing if disabled
             }

            // If enabled, proceed...
            selectedWithdrawCoins = parseInt(button.dataset.coins, 10);
            selectedWithdrawPKR = parseInt(button.dataset.pkr, 10);
            const referralsNeeded = withdrawalRequirements[selectedWithdrawCoins]; // Already checked, but good practice

            if(isNaN(selectedWithdrawCoins) || isNaN(selectedWithdrawPKR) || selectedWithdrawCoins <= 0) {
                console.error("Invalid button data:", button.dataset);
                showStatusMessage("Error selecting option.", "error");
                return;
            }

            // Double-check requirements right before showing the form (belt-and-suspenders)
            if(totalCoins < selectedWithdrawCoins){
                showStatusMessage(`Insufficient coins. Need ${selectedWithdrawCoins}.`, "error", 4000);
                updateWithdrawalOptionStates(); // Refresh states in case something changed
                return;
            }
             if(currentReferralCount < referralsNeeded) {
                showStatusMessage(`Insufficient referrals. Need ${referralsNeeded}.`, "error", 4000);
                updateWithdrawalOptionStates(); // Refresh states
                return;
            }

            console.log(`Selected: ${selectedWithdrawCoins} coins for ${selectedWithdrawPKR} PKR. Requirements met.`);

            // Show the form, hide the options
            redeemOptionsDiv.style.display='none';
            redeemFormDiv.style.display='block';
            redeemFormDiv.querySelector('h3').textContent = `Redeem ${selectedWithdrawCoins} Coins for ${selectedWithdrawPKR} PKR`;
            redeemDetailsForm.reset(); // Ensure form is clear
            accountHolderName.focus(); // Focus first field
        });
    });

    // *** MODIFIED: Redeem Form Submission Listener ***
    redeemDetailsForm.addEventListener('submit', (e) => {
         e.preventDefault();
         const name = accountHolderName.value.trim();
         const number = accountNumber.value.trim();
         const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked');

         if(!name || !number || !paymentMethodInput){ showStatusMessage("Please fill all details.", "error"); return; }
         if(!/^\d+$/.test(number)) { showStatusMessage("Account number should contain only digits.", "error"); return; }

         const user = auth.currentUser;
         if(!user){ showStatusMessage("Authentication error. Please log in again.", "error"); withdrawModal.style.display="none"; return; }

         // *** CRITICAL CHECK: Verify requirements AGAIN before submitting ***
         const requiredReferrals = withdrawalRequirements[selectedWithdrawCoins];
         if (typeof requiredReferrals === 'undefined' || selectedWithdrawCoins <= 0) {
            showStatusMessage("Invalid withdrawal amount selected.", "error", 5000);
            console.error("Invalid selectedWithdrawCoins:", selectedWithdrawCoins);
            withdrawModal.style.display = "none"; // Close modal on critical error
            return;
         }
         if(totalCoins < selectedWithdrawCoins || currentReferralCount < requiredReferrals){
             showStatusMessage(`Requirements no longer met. Please check your coins and referrals.`, "error", 5000);
             withdrawModal.style.display = "none"; // Close modal
             updateWithdrawalOptionStates(); // Update main menu / other UI
             return; // Stop submission
         }

         const method = paymentMethodInput.value;
         const timestamp = serverTimestamp();
         const requestData = {
             uid: user.uid,
             email: user.email || "N/A",
             username: currentUsername || "N/A",
             withdrawalAmountCoins: selectedWithdrawCoins,
             pkrAmount: selectedWithdrawPKR,
             accountHolderName: name,
             accountNumber: number,
             paymentMethod: method,
             status: "pending",
             timestamp: timestamp,
             referralsAtTimeOfRequest: currentReferralCount // Optional: store refs count at time of request
         };

         redeemSubmitBtn.disabled = true;
         redeemSubmitBtn.textContent = "Submitting...";
         showStatusMessage("Processing withdrawal request...", "info");

         const newRequestRef = push(ref(db,"withdrawRequests"), requestData);

         newRequestRef.then(async (reqRef)=>{
             console.log("Withdraw request submitted:", reqRef.key);
             const newTotalCoins = totalCoins - selectedWithdrawCoins;
             if (newTotalCoins < 0) {
                 // This should ideally not happen due to the checks above, but handle defensively
                 console.error("Coin calculation error resulted in negative balance attempt.");
                 throw new Error("Coin calculation resulted in negative balance.");
             }
             // Update user's coin balance in Firebase
             await set(ref(db,`users/${user.uid}/totalCoins`), newTotalCoins);
             console.log(`User coins updated in DB: ${newTotalCoins}`);
             // totalCoins will update automatically via the listener, triggering UI updates
             showStatusMessage(`Request submitted successfully! Status: Pending.`, "success", 5000);
             withdrawModal.style.display = "none"; // Close modal on success
         }).catch(err=>{
             showStatusMessage("Submission error: "+err.message, "error", 5000);
             console.error("Withdrawal submission error:", err);
             redeemSubmitBtn.disabled = false; // Re-enable button on error
             redeemSubmitBtn.textContent = "Submit Request";
         });
    });

    // --- Info Modal ---
    infoBtn.addEventListener("click", () => { infoModal.style.display = "block"; });
    closeInfo.addEventListener("click", () => { infoModal.style.display = "none"; });

    // --- Logout ---
    logoutBtn.addEventListener("click", () => { console.log("Logout clicked."); if (isProcessingAuth) return; setAuthProcessing(true); showStatusMessage("Logging out...", "info", 1500); signOut(auth).then(() => { showStatusMessage("Logged out.", "info"); console.log("SignOut ok."); }).catch((e) => { showStatusMessage("Logout error: "+e.message, "error"); console.error("Sign out error:", e); setAuthProcessing(false); }); });

    // --- Game Engine ---
    const ctx = gameCanvas.getContext("2d");
    function resizeCanvas() { gameCanvas.width=window.innerWidth; const bannerHeight=document.getElementById('bannerAdContainer')?.offsetHeight||50; gameCanvas.height=window.innerHeight-bannerHeight; if(gameStarted&&mario){const groundY=gameCanvas.height-50; if(mario.y+mario.height>=groundY-5){mario.y=groundY-mario.height;mario.dy=0;if(mario.isJumping){mario.isJumping=false;canDoubleJump=false;}}} } window.addEventListener("resize", resizeCanvas);
    const imagesToLoad = { character:"https://i.imgur.com/AbfH2aB.png", background:"https://i.imgur.com/xZpZqGt.png", enemy:"https://i.imgur.com/TsR4WXH.png", coin:"https://i.imgur.com/cMQ9X0d.png", platform:"https://i.imgur.com/06ptzal.png" }; const gameImages = {}; let imagesLoadedCount = 0; let totalImagesToLoad = Object.keys(imagesToLoad).length;
    function checkAllImagesLoaded() { imagesLoadedCount++; console.log(`Image loaded (${imagesLoadedCount}/${totalImagesToLoad})`); if (imagesLoadedCount === totalImagesToLoad) { allImagesLoaded = true; console.log("All images loaded."); if(startBtn) startBtn.disabled = false; if(restartBtn) restartBtn.disabled = false; showStatusMessage("Ready!", "success", 1500); } }
    console.log("Loading assets..."); if (startBtn) startBtn.disabled = true; if (restartBtn) restartBtn.disabled = true; showStatusMessage("Loading assets...", "info", 5000); for (const key in imagesToLoad) { gameImages[key] = new Image(); gameImages[key].onload = checkAllImagesLoaded; gameImages[key].onerror = () => { console.error(`Failed load: ${key}`); totalImagesToLoad--; showStatusMessage(`Error loading asset: ${key}.`, "error", 5000); if (startBtn) startBtn.disabled = true; if (restartBtn) restartBtn.disabled = true; }; gameImages[key].src = imagesToLoad[key]; }
    function initGame() { if (!allImagesLoaded) { showStatusMessage("Assets loading...", "info"); return; } console.log("Initializing game..."); resizeCanvas(); bgX = 0; platformX = 0; const groundY = gameCanvas.height - 50; mario = { x: 60, y: groundY - 60, width: 40, height: 60, dy: 0, gravity: 1.6, jumpPower: -22, doubleJumpPower: -18, isJumping: false, onGround: true }; obstacles = []; coins = []; speed = 6; score = 0; gameOver = false; gameStarted = true; lastJumpInputTime = 0; canDoubleJump = false; if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null; playBackgroundMusic(); console.log("Game initialized. Starting loop."); gameLoop(); }
    function drawBackground() { if (!gameImages.background?.complete || gameImages.background.naturalHeight === 0) { ctx.fillStyle = '#70c5ce'; ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height); return; }; bgX = (bgX - speed * 0.4) % gameImages.background.width; ctx.drawImage(gameImages.background, bgX, 0, gameImages.background.width, gameCanvas.height); ctx.drawImage(gameImages.background, bgX + gameImages.background.width, 0, gameImages.background.width, gameCanvas.height); }
    function drawPlatform() { if (!gameImages.platform?.complete || gameImages.platform.naturalHeight === 0) { ctx.fillStyle = '#E0A070'; ctx.fillRect(0, gameCanvas.height - 50, gameCanvas.width, 50); return; }; const groundY = gameCanvas.height - 50; platformX = (platformX - speed) % gameImages.platform.width; ctx.drawImage(gameImages.platform, platformX, groundY, gameImages.platform.width, 50); ctx.drawImage(gameImages.platform, platformX + gameImages.platform.width, groundY, gameImages.platform.width, 50); }
    function drawMario() { if(!mario || !gameImages.character?.complete || gameImages.character.naturalHeight === 0) return; ctx.drawImage(gameImages.character, mario.x, mario.y, mario.width, mario.height); }
    function drawObstacles() { if (!gameImages.enemy?.complete || gameImages.enemy.naturalHeight === 0) return; for (let i = obstacles.length - 1; i >= 0; i--){ let obs = obstacles[i]; obs.x -= speed; ctx.drawImage(gameImages.enemy, obs.x, obs.y, obs.width, obs.height); if(obs.x + obs.width < 0) obstacles.splice(i, 1); } }
    function spawnObstacles() { if(gameOver || !gameImages.enemy?.complete || gameImages.enemy.naturalHeight === 0) return; const bMin=350, bMax=650; const dF=Math.max(0.3,1-(score/1000)); const cMin=bMin*dF, cMax=bMax*dF; const dR=Math.max(50,cMax-cMin); const rD=cMin+Math.random()*dR; let lastX=-rD; if(obstacles.length>0) lastX=obstacles[obstacles.length-1].x; if(gameCanvas.width-lastX>rD && obstacles.length<5){ const gY=gameCanvas.height-50; obstacles.push({x:gameCanvas.width+10,y:gY-50,width:50,height:50}); } }
    function spawnCoins() { if(!gameImages.coin?.complete || gameImages.coin.naturalHeight === 0 || gameOver) return; const spawnChance = 0.014; const maxGroups = 3; if(coins.length < (maxGroups * 2) && Math.random() < spawnChance) { const groundY = gameCanvas.height - 50; let startY; const hChance=Math.random(); if(hChance<0.5) startY=groundY-30; else if(hChance<0.85) startY=groundY-100-(Math.random()*40); else startY=groundY-160-(Math.random()*50); let coinCount = Math.floor(Math.random() * 2) + 1; let startX = gameCanvas.width + Math.random() * 150; const spacing = 45; for(let i=0; i<coinCount; i++) coins.push({x:startX+i*spacing,y:startY,width:25,height:25}); } }
    function drawCoinsAndCollect() { if (!gameImages.coin?.complete || gameImages.coin.naturalHeight === 0 || !mario || gameOver) return; for (let i = coins.length - 1; i >= 0; i--) { let c = coins[i]; c.x -= speed; ctx.drawImage(gameImages.coin, c.x - c.width / 2, c.y - c.height / 2, c.width, c.height); if (mario.x < c.x + c.width / 2 && mario.x + mario.width > c.x - c.width / 2 && mario.y < c.y + c.height / 2 && mario.y + mario.height > c.y - c.height / 2) { coins.splice(i, 1); score += 1; playSound(coinSound); } else if (c.x + c.width / 2 < 0) coins.splice(i, 1); } }
    function applyPhysics() { if(!mario || gameOver) return; mario.dy += mario.gravity; mario.y += mario.dy; const groundY = gameCanvas.height - 50; if (mario.y + mario.height >= groundY) { mario.y = groundY - mario.height; mario.dy = 0; mario.onGround = true; if(mario.isJumping) { mario.isJumping = false; canDoubleJump = false; } } else mario.onGround = false; if (mario.y < 0) { mario.y = 0; mario.dy = 0; } }
    function checkCollision() { if(!mario || gameOver) return; for(let i = obstacles.length - 1; i >= 0; i--){ let obs = obstacles[i]; const mX=mario.x+5, mY=mario.y+5, mW=mario.width-10, mH=mario.height-10; const oX=obs.x+5, oY=obs.y+5, oW=obs.width-10, oH=obs.height-10; if (mX < oX + oW && mX + mW > oX && mY < oY + oH && mY + mH > oY) { console.log("Collision!"); gameOver = true; stopBackgroundMusic(); break; } } }
    function jump() { if(!gameStarted || gameOver || !mario) return; const now = Date.now(); if (mario.isJumping && !mario.onGround && canDoubleJump && (now - lastJumpInputTime < doubleJumpWindow)) { mario.dy = mario.doubleJumpPower; canDoubleJump = false; lastJumpInputTime = 0; console.log("Double Jump!"); playSound(jumpSound); } else if (mario.onGround) { mario.dy = mario.jumpPower; mario.isJumping = true; mario.onGround = false; canDoubleJump = true; lastJumpInputTime = now; console.log("First Jump!"); playSound(jumpSound); } }
    function gameLoop() { if(gameOver || !gameStarted) { if (gameOver) handleGameOver(); return; } applyPhysics(); checkCollision(); if (gameOver) { handleGameOver(); return; } spawnObstacles(); spawnCoins(); ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height); drawBackground(); drawPlatform(); drawObstacles(); drawCoinsAndCollect(); drawMario(); ctx.fillStyle="#FFF"; ctx.font="16px 'Press Start 2P'"; ctx.textAlign="left"; ctx.textBaseline="top"; ctx.shadowColor='rgba(0,0,0,0.7)'; ctx.shadowBlur=4; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2; ctx.fillText("Score: " + score, 20, 20); ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0; animationFrameId = requestAnimationFrame(gameLoop); }
    function handleGameOver() { console.log(`Game Over! Score: ${score}`); gameStarted = false; gameOver = true; if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } const user = auth.currentUser; if (user && score > 0 && currentUsername) { const refCoins = ref(db, `users/${user.uid}/totalCoins`); get(refCoins).then(snap => { const curDB = snap.val() || 0; const finalSave = curDB + score; console.log(`Saving score: ${finalSave}`); return set(refCoins, finalSave); }).then(() => console.log("Score saved.")).catch(e => { console.error("Error saving score:", e); showStatusMessage("Error saving score.", "error"); }); } else if (user && score === 0) console.log("Score 0, no save."); else console.log("Guest/incomplete, score not saved."); showGameOverMenu(); console.log("Game Over Menu shown."); }

    // --- Game Control Buttons ---
    startBtn.addEventListener("click", () => { if (!allImagesLoaded) { showStatusMessage("Assets loading...", "info"); return; } if (gameStarted) return; console.log("Start clicked."); showInterstitialAd(() => { console.log("Ad callback: Starting game."); mainMenu.style.display = "none"; gameCanvas.style.display = 'block'; initGame(); }); });
    restartBtn.addEventListener("click", () => { if (!allImagesLoaded) { showStatusMessage("Assets error.", "error"); showMainMenu(); return; } if (gameStarted) return; console.log("Restart clicked."); console.log("Direct restart..."); gameOverMenu.style.display = "none"; gameCanvas.style.display = 'block'; initGame(); });
    backMenuBtn.addEventListener("click", () => { console.log("Back to Menu clicked."); showInterstitialAd(() => { console.log("Ad callback: Showing main menu."); showMainMenu(); }); });

    // --- Jump Listeners ---
    document.addEventListener("keydown", (e) => { if ((e.code === "Space" || e.code === "ArrowUp") && gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    gameCanvas.addEventListener("click", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    gameCanvas.addEventListener("touchstart", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } }, { passive: false });

    // --- Initial Setup on Page Load ---
    function initializeAppUI() {
        console.log("Initializing UI (Google Sign-In)...");
        mainMenu.style.display = "none"; gameCanvas.style.display = "none"; gameOverMenu.style.display = "none"; completeProfileModal.style.display = 'none'; googleSignInPanel.style.display = "flex";
        setAuthProcessing(false); updateSoundButton(); updateInviteLinkDisplay();
        if (startBtn) startBtn.disabled = true; if (restartBtn) restartBtn.disabled = true;
        console.log("Initial UI setup complete.");
    }
    initializeAppUI();

  </script>

  <!-- Social Bar Script -->
  <script type='text/javascript' src='//pl26479822.profitableratecpm.com/11/f3/83/11f3830187c378aedebef88b0bcd83a0.js'></script>

</body>
</html>
