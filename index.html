
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Super Mario Run - Play Online & Earn Money</title>
  <meta name="description" content="Play Super Mario Run online and earn real money. Classic Mario gameplay on browser. No download needed!" />
  <meta name="keywords" content="Super Mario Run, Mario game, Earn money playing, Play Super Mario online, Free Mario Run game, Super Mario browser game" />
  <meta name="author" content="Zalix Games" />
  <meta property="og:title" content="Play Super Mario Run – Earn While You Play!" />
  <meta property="og:description" content="Enjoy classic Mario Run online and earn rewards while having fun!" />
  <meta property="og:image" content="https://supermariorun.site/assets/preview.png" />
  <meta property="og:url" content="https://supermariorun.site" />
  <meta property="og:type" content="website" />
  <meta name="robots" content="index, follow" />

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#3761bd" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Mario Run" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="./20250517_001646.png" />

  <!-- Existing Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />

  <!-- SEO: Structured Data for Video Game -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "VideoGame",
    "name": "Super Mario Run - Play Online & Earn Money",
    "url": "https://supermariorun.site",
    "description": "Play Super Mario Run online and earn real money. Classic Mario gameplay on browser. No download needed!",
    "applicationCategory": "Game",
    "operatingSystem": "Web browser",
    "browserRequirements": "Requires HTML5 Canvas and JavaScript",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "genre": ["Arcade game", "Platform game", "Endless runner"],
    "playMode": "SinglePlayer",
    "publisher": {
      "@type": "Organization",
      "name": "Zalix Games"
    },
    "image": "https://supermariorun.site/assets/preview.png",
    "keywords": "Super Mario Run, Mario game, Earn money playing, Play Super Mario online, Free Mario Run game, Super Mario browser game"
  }
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style type="text/tailwindcss">
    @layer utilities {
      /* Add custom Tailwind classes here if needed */
    }
  </style>

  <!-- Ad Script 1 (Placeholder) -->
  <style>
    /* --- CSS Variables for Dynamic Backgrounds --- */
    :root {
        --bg-login-panel: url('https://i.imgur.com/nxRZ03R.png');
        --bg-main-menu: url('https://i.imgur.com/KFWJlte.png');
        --bg-modal-default: url('https://i.imgur.com/KFWJlte.png'); /* Default for all modals */
        --bg-char-select: url('https://i.imgur.com/KFWJlte.png');
    }

    /* --- CSS Styles --- */
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Press Start 2P', cursive; overflow: hidden;
      background: #050505 url('https://www.transparenttextures.com/patterns/stardust.png'); /* Darker background */
      color: #e0e0e0; /* Slightly off-white text */
      margin-bottom: 50px; /* Space for banner */
    }
    canvas { display: block; background-color: #60a5fa; /* Brighter sky blue */ }
    .text-glow { text-shadow: 0 0 4px #fff, 0 0 8px #fff, 0 0 12px #ff38a1, 0 0 16px #ff38a1; } /* Enhanced Pink Glow */
    .box-glow { box-shadow: 0 0 6px rgba(255, 255, 255, 0.7), 0 0 12px rgba(255, 56, 161, 0.6); } /* Enhanced Pink Glow */

    /* --- Enhanced General Button Styles --- */
    .game-btn {
      padding: 15px 30px; /* More padding */
      margin: 10px;
      font-size: 15px; /* Slightly larger font */
      border: none;
      border-radius: 12px; /* Smoother radius */
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smoother transition */
      background: linear-gradient(145deg, #ff6b6b, #ee5253); /* New Red Gradient */
      color: #ffffff; /* Pure white text */
      font-family: 'Press Start 2P', cursive;
      text-transform: uppercase;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7); /* Deeper text shadow */
      border-bottom: 6px solid #c0392b; /* Darker, thicker bottom border */
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.35), inset 0 -2px 5px rgba(0,0,0,0.2); /* Enhanced shadow */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1.4;
      text-decoration: none;
    }
    .game-btn:hover:not(:disabled) {
      transform: translateY(-4px) scale(1.05); /* More pronounced hover effect */
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 107, 107, 0.7); /* Enhanced shadow + red glow */
      background: linear-gradient(145deg, #ff7979, #ff6b6b); /* Slightly brighter hover gradient */
    }
    .game-btn:active:not(:disabled) {
         transform: translateY(0px) scale(1); /* Reset transform on press */
         border-bottom-width: 3px; /* Reduce border on press */
         box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(0,0,0,0.3); /* Reduced shadow on press */
    }
    .game-btn:disabled {
        background: linear-gradient(145deg, #666, #444); /* Dark grey gradient */
        cursor: not-allowed;
        border-bottom-color: #222; /* Very dark border */
        box-shadow: none; transform: none; opacity: 0.6; /* More faded */
        color: #aaa; /* Grey text */
        text-shadow: none;
    }

    /* --- PWA Install Banner --- */
    #pwaInstallBanner {
        display: none; /* Hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: white;
        z-index: 9999;
        padding: 12px 15px;
        text-align: center;
        font-family: Arial, sans-serif;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        border-bottom: 2px solid #fff;
    }
    #pwaInstallBanner p {
        margin: 0;
        display: inline-block;
        vertical-align: middle;
    }
    #pwaInstallBanner .buttons {
        display: inline-block;
        margin-left: 20px;
        vertical-align: middle;
    }
    .pwa-btn {
        padding: 6px 14px;
        border: 2px solid white;
        border-radius: 8px;
        background: transparent;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 0 5px;
        font-family: 'Press Start 2P', cursive;
        font-size: 10px;
    }
    .pwa-btn.install {
        background: white;
        color: #3761bd;
    }
    .pwa-btn:hover {
        transform: scale(1.05);
    }
    .pwa-btn.install:hover {
        background: #eee;
    }


    /* --- Google Sign-in Panel Styles --- */
    #googleSignInPanel {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-image: var(--bg-login-panel);
        background-repeat: no-repeat;
        background-position: center center;
        background-size: cover; background-color: rgba(0, 0, 0, 0.75); /* Slightly darker overlay */
        background-blend-mode: darken; z-index: 100; /* display handled by JS */
        flex-direction: column; justify-content: center; align-items: center;
        color: #fff; padding: 20px; text-align: center;
    }
     #googleSignInPanel h2 {
        font-size: 2.8em; /* Slightly larger */
        color: #ff38a1; /* Consistent pink */
        margin-bottom: 35px;
        text-shadow: 4px 4px 0px #000, 0 0 18px #ff38a1, 0 0 25px #ff38a1; /* Enhanced text shadow */
    }
    #googleSignInBtn {
        background: linear-gradient(145deg, #4f8ef7, #3678e6); /* Brighter Google blue */
        border-bottom-color: #1a5ac4;
        color: white; width: 300px; /* Slightly wider */
        padding: 16px 28px; /* More padding */
        font-size: 16px;
        display: inline-flex; align-items: center; justify-content: center;
    }
    #googleSignInBtn img { width: 26px; height: 26px; margin-right: 18px; background-color: white; padding: 3px; border-radius: 3px; }
    #googleSignInBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #5a95f8, #4185f4);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(66, 133, 244, 0.7); /* Blue glow on hover */
    }
     #guestButtonAlt {
        background: linear-gradient(145deg, #95a5a6, #7f8c8d); /* Muted grey/blue */
        border-bottom-color: #525e5f;
        width: 300px; margin-top: 15px;
     }
     #guestButtonAlt:hover:not(:disabled) {
         background-image: linear-gradient(145deg, #aab5b6, #95a5a6);
         box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 15px rgba(149, 165, 166, 0.6); /* Grey glow */
     }

    /* --- Main Menu --- */
    #mainMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-image: var(--bg-main-menu);
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
      background-color: rgba(10, 10, 10, 0.6); background-blend-mode: darken; /* Add subtle overlay */
      z-index: 30; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center; padding-top: 90px; /* Adjusted padding */
    }
    
    /* --- MODIFIED Coin & PKR Counter Display --- */
    #topRightStatusContainer {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 35;
      display: none; /* Controlled by JS */
      flex-direction: row; /* Align boxes horizontally */
      gap: 10px; /* Space between the boxes */
    }
    .status-box {
      background: rgba(0,0,0,0.88);
      padding: 8px 15px;
      border-radius: 10px;
      font-size: 14px;
      color: #e0e0e0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .status-box:hover {
      transform: translateY(-2px) scale(1.05);
    }
    .status-box img {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.8));
    }
    .status-box span {
      font-weight: bold;
    }
    #coinStatusBox {
      border: 2px solid #b8860b; /* Darker gold border */
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.6), inset 0 0 5px rgba(0,0,0,0.5); /* Gold glow */
    }
    #coinStatusBox:hover {
      box-shadow: 0 0 18px rgba(255, 215, 0, 0.8), inset 0 0 5px rgba(0,0,0,0.5);
    }
    #pkrStatusBox {
      border: 2px solid #27ae60; /* Green border */
      box-shadow: 0 0 12px rgba(39, 174, 96, 0.6), inset 0 0 5px rgba(0,0,0,0.5); /* Green glow */
    }
    #pkrStatusBox:hover {
        box-shadow: 0 0 18px rgba(39, 174, 96, 0.8), inset 0 0 5px rgba(0,0,0,0.5);
    }
    .coin-value { color: #FFD700; } /* Gold for Coins */
    .pkr-value { color: #2ecc71; } /* Bright Green for PKR */
    
    /* --- End Modified Display --- */

    #settingsBtn {
      position: absolute; top: 15px; left: 15px; background: rgba(30,30,30,0.85); /* Slightly less dark */
      border: 2px solid #bbb;
      border-radius: 50%; cursor: pointer; z-index: 35; width: 50px; height: 50px; /* Slightly larger */
      display: none;
      justify-content: center; align-items: center; transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    #settingsBtn svg { width: 26px; height: 26px; fill: #ddd; }
    #settingsBtn:hover {
        transform: rotate(60deg) scale(1.12); /* Faster rotation, larger scale */
        box-shadow: 0 0 18px rgba(255,255,255,0.8); /* Brighter glow */
        border-color: #fff;
    }
    #mainMenu .menu-btn { width: 280px; margin-bottom: 20px; } /* Wider buttons, more spacing */
    
    /* Specific Main Menu Button Colors */
    #mainMenu #startBtn { background: linear-gradient(145deg, #ff6b6b, #ee5253); border-bottom-color: #c0392b; }
    #mainMenu #startBtn:hover:not(:disabled) { background: linear-gradient(145deg, #ff7979, #ff6b6b); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 107, 107, 0.7); }

    #mainMenu #withdrawBtn { background: linear-gradient(145deg, #2ecc71, #27ae60); border-bottom-color: #16a085; display: none; } /* Positive Green */
    #mainMenu #withdrawBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #58d68d, #2ecc71); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(46, 204, 113, 0.7); }

    #mainMenu #inviteFriend { background: linear-gradient(145deg, #3498db, #2980b9); border-bottom-color: #1f618d; display: none; } /* Action Blue */
    #mainMenu #inviteFriend:hover:not(:disabled) { background-image: linear-gradient(145deg, #5dade2, #3498db); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(52, 152, 219, 0.7); }

    #mainMenu #infoBtn { background: linear-gradient(145deg, #f1c40f, #f39c12); border-bottom-color: #d35400; } /* Info Yellow/Amber */
    #mainMenu #infoBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #f4d03f, #f1c40f); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(241, 196, 15, 0.7); }

    /* NEW: PWA Install Button - Enhanced Style */
    #mainMenu #installPwaBtn {
        background: linear-gradient(145deg, #9b59b6, #8e44ad); /* Purple */
        border-bottom-color: #6c3483;
        display: none; /* Initially hidden, shown by JS */
        animation: pulse 2s infinite; /* Add a subtle pulse animation */
    }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(155, 89, 182, 0.4); }
      50% { transform: scale(1.03); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.5), 0 0 30px rgba(155, 89, 182, 0.8); }
      100% { transform: scale(1); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(155, 89, 182, 0.4); }
    }
    #mainMenu #installPwaBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #af7ac5, #9b59b6);
        animation-play-state: paused; /* Pause animation on hover */
    }

    #mainMenu #logoutBtn { background: linear-gradient(145deg, #95a5a6, #7f8c8d); border-bottom-color: #566573; display: none; } /* Neutral Grey */
    #mainMenu #logoutBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #aab7b8, #95a5a6); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 15px rgba(149, 165, 166, 0.6); }


    /* --- WhatsApp Button Styles --- */
    .whatsapp-btn {
       position: fixed;
       bottom: 65px; /* Adjust based on banner height + padding */
       right: 20px;
       z-index: 900; /* High z-index */
       width: 60px; /* Slightly larger */
       height: 60px;
       background-color: #25D366; /* WhatsApp Green */
       border-radius: 50%; /* Circular shape */
       display: none; /* Handled by JS */
       justify-content: center;
       align-items: center;
       box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), 0 0 15px rgba(37, 211, 102, 0.6); /* Shadow and green glow */
       cursor: pointer;
       transition: transform 0.2s ease, box-shadow 0.2s ease;
       text-decoration: none; /* Remove underline */
       border: 3px solid #128C7E; /* Darker green border */
       padding: 5px; /* Padding inside for the image */
    }
    .whatsapp-btn img {
        width: 100%; /* Make image fill the button */
        height: 100%;
        object-fit: contain; /* Ensure image is scaled correctly */
         border-radius: 50%; /* Make image circular */
    }
    .whatsapp-btn:hover {
       transform: scale(1.15); /* Grow slightly on hover */
       box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5), 0 0 20px rgba(37, 211, 102, 0.8); /* More pronounced shadow/glow */
    }
     .whatsapp-btn:active {
         transform: scale(1.05); /* Shrink slightly on click */
         box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
     }


     /* --- Spin Button Styles (Tailwind takes over most) --- */
    #spinBtn {
       position: fixed;
       bottom: 65px; /* Align with WhatsApp */
       right: 90px; /* Position next to WhatsApp */
       z-index: 900; /* High z-index */
       width: 60px;
       height: 60px;
       border-radius: 50%; /* Circular */
       display: none; /* Handled by JS */
       justify-content: center;
       align-items: center;
       cursor: pointer;
       transition: transform 0.2s ease, box-shadow 0.2s ease;
       text-decoration: none;
       border: 3px solid rgba(255,255,255,0.5); /* Subtle border */
       padding: 5px;
       /* Tailwind classes will handle background, shadow, hover */
    }
    #spinBtn img {
        width: 100%; height: 100%; object-fit: contain; border-radius: 50%;
    }
     #spinBtn:hover {
       transform: scale(1.15);
     }
      #spinBtn:active {
         transform: scale(1.05);
     }


    /* --- Game Over Menu --- */
    #gameOverMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.88); /* Darker overlay */
      z-index: 40; display: none; flex-direction: column; justify-content: center; align-items: center;
      color: #f44336; /* Consistent Error Red */
      padding: 20px; text-align: center;
    }
    #gameOverMenu h2 {
        font-size: 2.25em; /* UPDATED: 50% smaller (was 4.5em) */
        text-shadow: 2px 2px 0px #000, 0 0 12px #ff0000, 0 0 18px #ff0000; /* UPDATED: Roughly 50% smaller shadow/glow */
        margin-bottom: 12px; /* UPDATED: 50% smaller (was 25px) */
    }
    #gameOverMenu p {
        font-size: 0.9em; /* UPDATED: 50% smaller (was 1.8em) */
        color: #fff;
        margin-bottom: 8px; /* UPDATED: Roughly 50% smaller (was 15px) */
        text-shadow: 1px 1px 2px #000; /* UPDATED: 50% smaller shadow */
    }
    #gameOverMenu .menu-btn { width: 220px; } /* Standard button size */
    #gameOverMenu #restartBtn {
        background: linear-gradient(145deg, #4caf50, #388e3c); /* Positive Green */
        border-bottom-color: #1b5e20;
    }
    #gameOverMenu #restartBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #66bb6a, #43a047);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); /* Green glow */
    }
    #gameOverMenu #backMenuBtn {
        background: linear-gradient(145deg, #2196f3, #1976d2); /* Action Blue */
        border-bottom-color: #0d47a1;
    }
    #gameOverMenu #backMenuBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #42a5f5, #1e88e5);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(33, 150, 243, 0.7); } /* Blue glow */

    /* --- MODIFIED Modal Styles (Full Screen) --- */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.75); /* Dark overlay */
      display: none; /* Controlled by JS */
      align-items: center;
      justify-content: center;
      z-index: 50;
      overflow-y: auto;
    }

    .modal-content {
        position: relative;
        background-color: #1c1c1c; /* Dark background */
        background-image: var(--bg-modal-default); /* DYNAMIC BACKGROUND */
        background-size: cover;
        background-position: center;
        background-blend-mode: darken;
        width: 100%;
        height: 100%;
        color: #eee;
        font-family: 'Press Start 2P', cursive;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px; /* Add padding for content */
        overflow-y: auto; /* Allow scrolling */
        /* REMOVED: border, border-radius, box-shadow, max-width, max-height */
    }
    .modal h2 {
        margin-bottom: 30px;
        font-size: 2em; /* Larger title for full screen */
        color: #ff38a1;
        text-shadow: 2px 2px 2px #000, 0 0 10px #ff38a1;
        position: absolute;
        top: 60px; /* Position title at the top */
    }
    .modal button.game-btn { width: 80%; max-width: 300px; margin: 12px 0; }
    .modal input[type="text"], .modal input[type="email"], .modal input[type="password"] {
        width: 80%; max-width: 350px; padding: 14px; margin-top: 10px; margin-bottom: 20px;
        border: 2px solid #555; border-radius: 8px;
        background: #333; color: #fff; font-family: 'Arial', sans-serif; font-size: 16px; outline: none;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .modal input:focus { border-color: #ff38a1; box-shadow: 0 0 10px rgba(255, 56, 161, 0.7); }
    .close-btn {
        position: absolute; top: 15px; right: 20px;
        background: none; border: none; font-size: 40px; /* Larger close icon */
        cursor: pointer; color: #aaa; font-family: Arial, sans-serif;
        transition: color 0.2s, transform 0.2s; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        z-index: 10;
    }
    .close-btn:hover { color: #ff38a1; transform: scale(1.25) rotate(90deg); }

    /* --- Settings Modal Button Styles --- */
    #profileBtn { background: linear-gradient(145deg, #ab47bc, #8e24aa); border-bottom-color: #6a1b9a; } /* Purple */
    #toggleSound { background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; } /* Green */
    #withdrawalHistoryBtn { background: linear-gradient(145deg, #ffc107, #ffa000); border-bottom-color: #ff6f00; } /* Amber */
     #gameTransactionsBtn { background: linear-gradient(145deg, #00bcd4, #0097a7); border-bottom-color: #006064; } /* Teal */
    #customerService { background: linear-gradient(145deg, #2196f3, #1976d2); border-bottom-color: #0d47a1; } /* Blue */

    /* Hover states for settings buttons */
    #profileBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #ba68c8, #9c27b0); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(171, 71, 188, 0.7); }
    #toggleSound:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); }
    #withdrawalHistoryBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #ffca28, #ffb300); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 193, 7, 0.7); }
    #gameTransactionsBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #4dd0e1, #00bcd4); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(0, 188, 212, 0.7); } /* Teal glow */
    #customerService:hover:not(:disabled) { background-image: linear-gradient(145deg, #42a5f5, #1e88e5); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(33, 150, 243, 0.7); }


    /* --- Profile Modal Styles --- */
    #profileModal .modal-content h2 { color: #ab47bc; } /* Purple Title */
    #profileModal .modal-content p {
        margin: 16px 0; font-family: 'Arial', sans-serif; font-size: 16px; 
        line-height: 1.7; color: #ddd; border-bottom: 1px solid #444; padding-bottom: 10px;
    }
    #profileModal .modal-content p:last-child { border-bottom: none; }
    #profileModal .modal-content p strong { color: #fff; display: inline-block; min-width: 130px; }
    #profileModal .modal-content span { color: #ffc107; word-break: break-all; font-weight: bold; }
    #profileInfo { border-top: 1px solid #555; margin-top: 20px; padding-top: 20px; width: 90%; max-width: 450px; }

     #profileModal .modal-content .profile-data-group {
         display: flex; justify-content: space-between; align-items: center;
         margin: 8px 0; padding-bottom: 8px; border-bottom: 1px solid #444;
         font-size: 15px; line-height: 1.5; font-family: 'Arial', sans-serif;
     }
     #profileModal .modal-content .profile-data-group strong {
         min-width: 160px; margin-right: 10px; flex-shrink: 0;
         font-family: 'Arial', sans-serif;
     }
     #profileModal .modal-content .profile-data-group span {
         flex-grow: 1; text-align: right; word-break: break-word;
         font-weight: normal; color: #eee; font-family: 'Arial', sans-serif;
     }
     #profileModal .modal-content .profile-data-group .coin-value { color: #FFD700; }
     #profileModal .modal-content .profile-data-group .pkr-value { color: #4caf50; }


    /* --- Invite Modal Styles --- */
    #inviteModal .section { margin: 25px 0; border-top: 1px solid #555; padding-top: 20px; width: 80%; max-width: 380px; text-align: center; }
    #inviteModal .section h3 { font-size: 1.2em; margin-bottom: 12px; color: #eee; text-shadow: 1px 1px 1px #000; }
    #inviteModal .section p { font-size: 1em; margin-bottom: 14px; font-family: Arial, sans-serif; color: #ccc; }
    #inviteModal #yourInviteLinkDisplay {
        font-size: 1.1em; color: #FFD700; background: #383838; padding: 10px 14px;
        border-radius: 6px; display: block; border: 1px solid #666;
        word-break: break-all; text-align: center; margin-bottom: 12px;
        font-family: monospace;
    }
    #copyInviteCode { background: linear-gradient(145deg, #ffc107, #ffa000); border-bottom-color: #ff6f00; } /* Amber */
    #redeemCodeBtn { background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; } /* Green */
    #copyInviteCode:hover:not(:disabled) { background-image: linear-gradient(145deg, #ffca28, #ffb300); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 193, 7, 0.7); }
    #redeemCodeBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); }

    /* --- Withdraw Modal Styles --- */
    #withdrawModal .modal-content .scroll-container { width: 90%; max-width: 450px; text-align: center; }
    #withdrawModal .modal-content p { margin-bottom: 25px; font-family: Arial, sans-serif; line-height: 1.6; font-size: 15px; }
    #withdrawModal .redeem-option { /* Inherits from .game-btn, override specifics */
        background: linear-gradient(145deg, #1e88e5, #1565c0);
        border-bottom: 4px solid #0d47a1;
        color: #fff; padding: 12px 18px; margin: 8px 0; border-radius: 8px;
        font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
        transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
        width: 100%; display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 4px 7px rgba(0, 0, 0, 0.25);
    }
    #withdrawModal .redeem-option:hover:not(:disabled) {
        background: linear-gradient(145deg, #42a5f5, #1e88e5);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 7px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(33, 150, 243, 0.6);
    }
    #withdrawModal .redeem-option:active:not(:disabled) {
         transform: translateY(1px) scale(1); border-bottom-width: 2px;
         box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    #withdrawModal .redeem-option:disabled {
        background: linear-gradient(145deg, #666, #444); cursor: not-allowed; border-bottom-color: #222;
        box-shadow: none; transform: none; opacity: 0.6; color: #aaa; text-shadow: none;
    }
    #withdrawModal .redeem-option.available-option {
        background: linear-gradient(145deg, #66bb6a, #43a047); /* Brighter Green */
        border-bottom-color: #1b5e20;
        box-shadow: 0 4px 7px rgba(0, 0, 0, 0.25), 0 0 12px rgba(76, 175, 80, 0.5);
    }
    #withdrawModal .redeem-option.available-option:hover:not(:disabled) {
        background: linear-gradient(145deg, #81c784, #4caf50);
        box-shadow: 0 7px 12px rgba(0, 0, 0, 0.3), 0 0 18px rgba(76, 175, 80, 0.7);
        transform: translateY(-3px) scale(1.02);
    }
     #withdrawModal .redeem-option.redeemed-once {
         background: linear-gradient(145deg, #5a5a5a, #404040);
         border-bottom-color: #202020;
         cursor: not-allowed; opacity: 0.8;
         text-decoration: line-through;
     }
     #withdrawModal .redeem-option.redeemed-once:hover {
         transform: none;
         box-shadow: 0 4px 7px rgba(0, 0, 0, 0.25);
         background: linear-gradient(145deg, #5a5a5a, #404040);
     }
    #swapCoinsBtnWithdraw {
        background: linear-gradient(145deg, #f1c40f, #f39c12); border-bottom-color: #d35400;
        margin-top: 20px;
    }

    #redeemForm { display: none; margin-top: 25px; font-family: Arial, sans-serif; font-size: 16px; line-height: 1.6; text-align: left; width: 100%; }
    #redeemForm h3 { font-family: 'Press Start 2P', cursive; font-size: 1.3em; color: #eee; margin-bottom: 20px; text-align: center; text-shadow: 1px 1px 1px #000; }
    #referralTaskDisplay {
        margin-bottom: 25px; padding: 12px 18px; border-radius: 8px;
        border: 2px solid #555; background-color: #2c2c2c;
        font-family: 'Press Start 2P', cursive; font-size: 12px;
        text-align: center; line-height: 1.5; letter-spacing: 0.5px;
    }
    #referralTaskDisplay.task-complete { border-color: #4caf50; color: #66bb6a; background-color: #2e4430; }
    #referralTaskDisplay.task-incomplete { border-color: #ffa000; color: #ffca28; background-color: #4d3f21; }
    #referralTaskDisplay strong { color: #fff; }
    #referralTaskDisplay .status-icon { font-weight: bold; font-size: 1.2em; margin-left: 10px; display: inline-block; vertical-align: middle; }
    #redeemForm label { display: block; margin-bottom: 6px; color: #ccc; font-size: 14px; font-family: 'Press Start 2P', cursive; }
    #redeemForm input[type="text"] { margin-bottom: 18px; border-radius: 8px; padding: 12px; width: 100%; }
    #redeemForm input[type="radio"] { margin-right: 10px; vertical-align: middle; transform: scale(1.2); }
    #redeemForm label input[type="radio"] { display: inline; margin-bottom: 0; }
    #redeemForm .payment-options label { margin-bottom: 12px; display: block; font-family: Arial, sans-serif; font-size: 15px; }
    #redeemSubmitBtn {
         background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; width: 100%; margin-top: 25px; font-size: 15px; padding: 14px 24px;
     }
    #redeemSubmitBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #66bb6a, #43a047);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7);
    }
    #redeemSubmitBtn:disabled {
        background: linear-gradient(145deg, #666, #444); cursor: not-allowed; border-bottom-color: #222;
        box-shadow: none; transform: none; opacity: 0.6; color: #aaa; text-shadow: none;
    }

    /* --- Info Modal Styles --- */
    #infoModal .modal-content h2 { color: #2196f3; } /* Blue Title */
    #infoModal .modal-content p { margin: 18px 0; font-family: 'Arial', sans-serif; font-size: 15px; line-height: 1.7; color: #ddd; text-align: left; padding-bottom: 10px; border-bottom: 1px solid #444; }
    #infoModal .modal-content p:last-child { border-bottom: none; }
    #infoModal .modal-content p strong { color: #fff; }
    #infoModal .modal-content .highlight { color: #ffee58; font-weight: bold; }
    #infoModal .info-scroll-container { width: 90%; max-width: 500px; text-align: left; }

    /* --- Withdrawal History Modal Styles --- */
    #withdrawalHistoryModal .modal-content h2 { color: #ffc107; }
    #historyList { margin-top: 25px; max-height: 70vh; overflow-y: auto; padding-right: 15px; text-align: left; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6; width: 90%; max-width: 500px; }
    .history-item { background: #2a2a2a; border: 1px solid #4f4f4f; border-radius: 8px; padding: 14px 18px; margin-bottom: 12px; color: #ccc; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .history-item span { display: block; margin-bottom: 5px; font-size: 13px; }
    .history-item .details { flex-grow: 1; margin-right: 15px; }
    .history-item .details span:first-child { font-weight: bold; color: #eee; font-size: 14px; }
    .history-item .status { font-family: 'Press Start 2P', cursive; font-size: 11px; padding: 5px 10px; border-radius: 5px; text-transform: uppercase; min-width: 90px; text-align: center; margin-top: 5px; font-weight: bold; letter-spacing: 0.5px; }
    .history-item .status-pending { background-color: #ffa000; color: #4d3f21; border: 1px solid #e67e22;}
    .history-item .status-approved { background-color: #4caf50; color: #1b5e20; border: 1px solid #10ac84;}
    .history-item .status-rejected { background-color: #f44336; color: #5e141e; border: 1px solid #c0392b;}
    .history-item .date { font-size: 11px; color: #999; width: 100%; text-align: right; margin-top: 6px; }
    #historyList .no-history { color: #888; text-align: center; padding: 25px; font-size: 1.1em; font-style: italic;}

     /* --- Complete Profile Modal Styles --- */
    #completeProfileModal .modal-content h2 { color: #4caf50; }
    #completeProfileModal .modal-content p { margin-bottom: 18px; font-family: Arial, sans-serif; line-height: 1.6; font-size: 15px; text-align: center; color: #ddd; width: 80%; max-width: 370px; }
    #completeProfileModal .modal-content p.subtle { font-size: 12px; color: #aaa; font-style: italic; margin-top: -12px; }
    #completeProfileModal .modal-content label { font-family: 'Press Start 2P', cursive; font-size: 13px; }
    #completeProfileModal .modal-content input[type="text"] { margin-bottom: 25px; border-radius: 8px; padding: 12px; }
    #completeProfileModal #saveProfileBtn { background: linear-gradient(145deg, #4caf50, #388e3c); border-bottom-color: #1b5e20; }
    #completeProfileModal #saveProfileBtn:hover:not(:disabled) { background-image: linear-gradient(145deg, #66bb6a, #43a047); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 175, 80, 0.7); }

    /* --- Ad Container Styles --- */
    #bannerAdContainer { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background-color: #080808; z-index: 1000; display: flex; justify-content: center; align-items: center; overflow: hidden; border-top: 3px solid #333; }
    #bannerAdContainer iframe { max-width: 100%; }
    #interstitialAdOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.92); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; font-family: 'Press Start 2P', cursive; padding: 20px; backdrop-filter: blur(4px); }
    #interstitialAdOverlay p#adInfoText { font-size: 1.2em; margin-bottom: 30px; color: #eee; line-height: 1.6; text-shadow: 1px 1px 2px #000; }
    #interstitialAdCloseButton {
        padding: 14px 28px; font-size: 1em; cursor: pointer;
        background: linear-gradient(145deg, #f44336, #d32f2f); border-bottom-color: #b71c1c;
        color: white; border-radius: 10px; font-family: 'Press Start 2P', cursive;
        display: none; text-transform: uppercase; margin-top: 25px;
        text-shadow: 2px 2px 3px rgba(0,0,0,0.8); border: none;
        box-shadow: 0 5px 8px rgba(0, 0, 0, 0.3);
    }
    #interstitialAdCloseButton:hover {
        transform: translateY(-3px) scale(1.04);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 18px rgba(244, 67, 54, 0.7);
        background: linear-gradient(145deg, #ef5350, #e53935);
    }
    #interstitialAdTimer { margin-top: 18px; font-size: 0.9em; color: #bbb; }
    #interstitialAdOverlay p.skip-info { font-size: 0.8em; color: #aaa; margin-top: 35px; font-family: Arial, sans-serif; line-height: 1.5; }

    /* --- Status Message Container --- */
    #statusMessageContainer {
        display: none; position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
        background-color: rgba(10, 10, 10, 0.92); color: white; padding: 14px 28px;
        border-radius: 10px; z-index: 5000; font-family: 'Press Start 2P', cursive; font-size: 1.0em;
        text-align: center; border: 3px solid #fff; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6);
        opacity: 0;
        transition: opacity 0.4s ease-in-out, top 0.4s ease-in-out, transform 0.4s ease-in-out;
        max-width: 90%; pointer-events: none; letter-spacing: 0.5px;
    }
    #statusMessageContainer.show {
        display: block; opacity: 1; top: 30px;
        transform: translateX(-50%) scale(1);
    }
    #statusMessageContainer.success { border-color: #4caf50; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px rgba(76, 175, 80, 0.6); }
    #statusMessageContainer.error { border-color: #f44336; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px rgba(244, 67, 54, 0.6); }
    #statusMessageContainer.info { border-color: #2196f3; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6), 0 0 15px rgba(33, 150, 243, 0.6); }

    /* --- Spin Wheel Specific Styles (some custom, some Tailwind) --- */
    .wheel-container {
        position: relative;
        width: 100%;
        max-width: 350px;
        margin: 0 auto 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .wheel-svg {
        display: block;
        transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    .wheel-arrow {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        width: 30px;
        height: 30px;
        color: #ff38a1;
        filter: drop-shadow(0 0 5px rgba(255, 56, 161, 0.8));
        z-index: 10;
    }
    .wheel-center-pin {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        background-color: #4caf50;
        border-radius: 50%;
        border: 4px solid #eee;
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: 'Press Start 2P', cursive;
        color: white;
        font-size: 14px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        text-transform: uppercase;
        box-shadow: 0 0 15px rgba(76, 175, 80, 0.7), inset 0 0 8px rgba(0,0,0,0.5);
    }
    .wheel-text {
        font-family: Arial, sans-serif; font-size: 10px;
        fill: #000; font-weight: bold;
        text-anchor: middle; dominant-baseline: central;
    }
    .wheel-text-outline {
        stroke: #fff; stroke-width: 1;
        paint-order: stroke fill;
    }

     .timer-display {
         font-family: Arial, sans-serif;
         font-size: 14px;
         color: #bbb;
         margin-top: 15px;
         min-height: 1.2em;
     }
      .buy-spin-option {
          font-size: 13px;
          padding: 12px 20px;
          margin-top: 15px;
          background: linear-gradient(145deg, #ffc107, #ffa000);
          border-bottom-color: #ff6f00;
      }
      .buy-spin-option:hover:not(:disabled) {
          background-image: linear-gradient(145deg, #ffca28, #ffb300);
          box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 193, 7, 0.7);
      }
      .buy-spin-option:disabled {
           background: linear-gradient(145deg, #666, #444); cursor: not-allowed; border-bottom-color: #222;
            box-shadow: none; transform: none; opacity: 0.6; color: #aaa; text-shadow: none;
      }

     /* --- Swap Modal Styles --- */
    #swapModal .modal-content h2 { color: #2196f3; }
    #swapModal .modal-content p { margin: 15px 0; font-family: Arial, sans-serif; font-size: 15px; line-height: 1.6; color: #ddd; }
    #swapModal .modal-content p strong { color: #fff; display: inline-block; min-width: 100px; }
     #swapModal .swap-info {
         background: #383838; padding: 10px 14px; margin-bottom: 20px;
         border-radius: 6px; border: 1px solid #666;
         font-family: 'Press Start 2P', cursive; font-size: 12px; line-height: 1.5;
         text-align: center;
     }
     #swapModal .swap-info .status-group {
         display: flex;
         align-items: center;
         justify-content: center;
         margin: 2px 0;
          padding: 0;
     }
     #swapModal .swap-info .status-group img {
         width: 14px; height: 14px; margin-right: 5px;
         display: none;
     }
      #swapModal .swap-info .status-group span {
          font-weight: bold;
          font-size: 1em;
      }
     #swapModal .swap-info strong { color: #ffc107; }
     #swapModal .swap-info .pkr-highlight { color: #4caf50; }
     #swapToPkrBtn {
         background: linear-gradient(145deg, #2196f3, #1976d2); border-bottom-color: #0d47a1;
         width: 100%; margin-top: 20px; font-size: 15px;
     }
     #swapToPkrBtn:hover:not(:disabled) {
        background-image: linear-gradient(145deg, #42a5f5, #1e88e5);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 20px rgba(33, 150, 243, 0.7);
     }
     #swapToPkrBtn:disabled {
        background: linear-gradient(145deg, #666, #444); cursor: not-allowed; border-bottom-color: #222;
        box-shadow: none; transform: none; opacity: 0.6; color: #aaa; text-shadow: none;
     }

     /* --- Game Transactions Modal Styles --- */
    #gameTransactionsModal .modal-content h2 { color: #00bcd4; }
    #transactionsList { margin-top: 25px; max-height: 70vh; overflow-y: auto; padding-right: 15px; text-align: left; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6; width: 90%; max-width: 500px; }
    .transaction-item { background: #2a2a2a; border: 1px solid #4f4f4f; border-radius: 8px; padding: 14px 18px; margin-bottom: 12px; color: #ccc; display: flex; flex-direction: column; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .transaction-item .details { flex-grow: 1; margin-bottom: 8px; }
    .transaction-item .details strong { color: #eee; font-size: 15px; margin-right: 8px;}
    .transaction-item .details span { font-size: 14px; color: #ddd; }
    .transaction-item .meta { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #999; }
    .transaction-item .type { font-family: 'Press Start 2P', cursive; font-size: 10px; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; min-width: 70px; text-align: center; font-weight: bold; letter-spacing: 0.5px; }
    .transaction-item .type-game_score { background-color: #ffc107; color: #4d3f21; border: 1px solid #e67e22;}
    .transaction-item .type-spin_coins { background-color: #9c27b0; color: #4a148c; border: 1px solid #7b1fa2;}
    .transaction-item .type-spin_pkr { background-color: #00bcd4; color: #006064; border: 1px solid #00838f;}
    .transaction-item .type-swap_coins { background-color: #2196f3; color: #0d47a1; border: 1px solid #1565c0;}
    #transactionsList .no-transactions { color: #888; text-align: center; padding: 25px; font-size: 1.1em; font-style: italic;}

    /* --- Character Selection Modal Styles --- */
    #characterSelectionModal .modal-content {
        background-image: var(--bg-char-select);
    }
    #characterSelectionModal h2 {
        color: #f1c40f;
    }
    #characterContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 20px;
        width: 100%;
        max-width: 800px;
        margin-top: 100px;
        padding: 20px;
    }
    .character-card {
        background: rgba(40, 40, 40, 0.85);
        border: 3px solid #777;
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .character-card.selected {
        border-color: #f1c40f;
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(241, 196, 15, 0.7);
    }
    .character-card:not(.selected):hover {
        transform: translateY(-5px);
        border-color: #fff;
    }
    .character-card img {
        width: 80px;
        height: 80px;
        object-fit: contain;
        margin: 0 auto 10px auto;
        border-radius: 10px;
        background: rgba(0,0,0,0.3);
    }
    .character-card h3 {
        font-size: 1em;
        margin-bottom: 10px;
        color: #fff;
    }
    .character-card .char-btn {
        padding: 10px 15px;
        font-size: 12px;
        margin: 5px 0 0 0;
        width: 100%;
    }
    .char-price {
        font-size: 0.8em;
        color: #FFD700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }
    .char-price img {
        width: 14px; height: 14px; margin: 0;
    }


    /* --- End of CSS --- */
  </style>

</head>
<body>

  <!-- NEW: PWA Install Banner -->
  <div id="pwaInstallBanner">
      <p>For a better experience, install the app!</p>
      <div class="buttons">
          <button id="pwaInstallBtn" class="pwa-btn install">Install</button>
          <button id="pwaDismissBtn" class="pwa-btn">Dismiss</button>
      </div>
  </div>

  <!-- Status Message Container -->
  <div id="statusMessageContainer"> <span id="statusMessageText"></span> </div>

  <!-- Audio Elements -->
  <audio id="backgroundAudio" loop> <source src="mines background .mp3" type="audio/mp3"> Your browser does not support the audio element. </audio>
  <audio id="jumpSound"> <source src="gruntjumpland-101soundboards.mp3" type="audio/mp3"> </audio>
  <audio id="coinSound"> <source src="coin-recieved-230517.mp3" type="audio/mp3"> </audio>
  <audio id="gameOverSound"> <source src="game-over-arcade-6435.mp3" type="audio/mp3"> </audio>
  <!-- New Audio for Spin -->
  <audio id="spinStartSound"><source src="https://file-examples-com.github.io/uploads/2017/11/file_example_WAV_1MG.wav" type="audio/wav"></audio>
  <audio id="spinWinSound"><source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" type="audio/mp3"></audio>


  <!-- Google Sign-in Panel -->
  <div id="googleSignInPanel" class="flex">
      <h2>Welcome Gamer!</h2>
      <button id="googleSignInBtn" class="game-btn">
          <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google G Logo"/>
          Sign in with Google
      </button>
      <button id="guestButtonAlt" class="game-btn">Continue as Guest</button>
  </div>

  <!-- Complete Profile Modal -->
  <div id="completeProfileModal" class="modal hidden">
      <div class="modal-content">
          <h2>Complete Your Profile</h2>
          <p>Welcome! Please set your username and optionally enter a referral code.</p>
          <div>
              <label for="profileUsernameInput">Username:</label>
              <input type="text" id="profileUsernameInput" placeholder="Choose a username (min 3 chars)" required />
          </div>
           <div>
              <label for="profileReferralInput">Referral Code (Optional):</label>
              <input type="text" id="profileReferralInput" placeholder="Enter friend's code" />
              <p class="subtle">Enter a code to get a bonus!</p>
          </div>
          <button id="saveProfileBtn" class="game-btn">Save and Play</button>
      </div>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas" class="hidden"></canvas>

  <!-- Main Menu -->
  <div id="mainMenu" class="hidden">
     <button id="settingsBtn" title="Open Settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M487.4 315.7l-42.1-24.3c2.8-12.8 4.3-26 4.3-39.4s-1.5-26.6-4.3-39.4l42.1-24.3c9.4-5.4 13.3-17.1 9.4-27.2l-45.3-78.4c-3.9-10.1-14.2-14.8-24.7-11.5l-49.5 19.9c-20.5-16.1-43-29.2-67.2-38.1l-7.5-52.8C309 3.7 300.3-2.5 290.3.1l-90.6 18.5c-10 2.1-17.6 9.9-19.8 19.8l-7.5 52.8c-24.3 8.9-46.8 22-67.2 38.1L54.6 83.1c-10.5-3.3-20.8.4-24.7 11.5L-15.4 172.9c-3.9 10.1-.1 21.8 9.4 27.2l42.1 24.3C73.5 243.3 72 256.4 72 269.9c0 13.5 1.5 26.6 4.3 39.4l-42.1 24.3c-9.4 5.4-13.3 17.1-9.4 27.2l45.3 78.4c3.9 10.1 14.2 14.8 24.7 11.5l49.5-19.9c20.5 16.1 43 29.2 67.2 38.1l7.5 52.8c2 10 10.7 15.3 20.7 12.8l90.6-18.5c10-2.1 17.6 9.9 19.8-19.8l7.5-52.8c24.3-8.9 46.8-22 67.2-38.1l49.5 19.9c10.5 3.3 20.8-.4 24.7-11.5l45.3-78.4c3.9-10.1.1 21.8-9.4-27.2zM256 336c-44.2 0-80-35.8-80-80s35.8-80 80-80c44.2 0 80 35.8 80 80s-35.8 80-80 80z"></path></svg>
     </button>
     
     <!-- MODIFIED STATUS DISPLAY -->
     <div id="topRightStatusContainer">
         <div id="coinStatusBox" class="status-box" title="Click to Swap Coins">
             <img src="https://i.imgur.com/PCDgdlS.png" alt="Coin">
             <span id="menuCoinCount" class="coin-value">0</span>
         </div>
         <div id="pkrStatusBox" class="status-box">
             <span class="pkr-value" style="margin-right: 5px;">Rs</span>
             <span id="menuPkrCount" class="pkr-value">0</span>
         </div>
     </div>
     
     <button id="startBtn" class="menu-btn game-btn">Play Now</button>
     <button id="withdrawBtn" class="menu-btn game-btn">Withdraw</button>
     <button id="inviteFriend" class="menu-btn game-btn">Invite (0)</button>
     <button id="infoBtn" class="menu-btn game-btn">Game Info</button>
     <button id="installPwaBtn" class="menu-btn game-btn">Install App</button>
     <button id="logoutBtn" class="menu-btn game-btn">Exit</button>
  </div>
  
  <!-- NEW: Character Selection Modal -->
  <div id="characterSelectionModal" class="modal hidden">
      <div class="modal-content">
          <button class="close-btn" id="closeCharacterSelection">×</button>
          <h2>Select Character</h2>
          <div id="characterContainer">
              <!-- Character cards will be dynamically inserted here -->
          </div>
      </div>
  </div>


  <!-- Settings Modal -->
  <div id="settingsModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-btn" id="closeSettings">×</button>
      <h2>Settings</h2>
      <button id="profileBtn" class="game-btn">View Profile</button>
      <button id="toggleSound" class="game-btn">Sound: On</button>
      <button id="withdrawalHistoryBtn" class="game-btn">Withdrawal History</button>
       <button id="gameTransactionsBtn" class="game-btn">Game Transactions</button>
      <button id="customerService" class="game-btn">Customer Service</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal hidden">
      <div class="modal-content">
          <button class="close-btn" id="closeProfileModal">×</button>
          <h2>Gamer Profile</h2>
          <div id="profileInfo">
              <div class="profile-data-group"><strong>Username:</strong> <span id="profileUsername">...</span></div>
              <div class="profile-data-group"><strong>Email:</strong> <span id="profileEmail">...</span></div>
              <div class="profile-data-group"><strong>Total Coins:</strong> <span id="profileTotalCoins" class="coin-value">...</span></div>
               <div class="profile-data-group"><strong>Total Rs Balance:</strong> <span id="profileTotalPkr" class="pkr-value">...</span></div>
              <div class="profile-data-group"><strong>Referrals:</strong> <span id="profileReferralCount">...</span></div>
               <div class="profile-data-group"><strong>Total Play Time:</strong> <span id="profileTotalPlayTime">...</span></div>
               <div class="profile-data-group"><strong>Spin Coins Won:</strong> <span id="profileTotalSpinCoins" class="coin-value">...</span></div>
               <div class="profile-data-group"><strong>Spin Rs Won:</strong> <span id="profileTotalSpinPkr" class="pkr-value">...</span></div>
               <div class="profile-data-group"><strong>Total Coins Swapped:</strong> <span id="profileTotalCoinsSwapped" class="coin-value">...</span></div>
               <div class="profile-data-group"><strong>Last Active:</strong> <span id="profileLastActive">...</span></div>
              <div class="profile-data-group"><strong>Your Code:</strong> <span id="profileInviteCode">...</span></div>
              <div class="profile-data-group"><strong>Joined:</strong> <span id="profileJoinedDate">...</span></div>
          </div>
      </div>
  </div>

  <!-- Invite Modal -->
  <div id="inviteModal" class="modal hidden">
      <div class="modal-content">
          <button class="close-btn" id="closeInviteModal">×</button>
          <h2>Invite Friend</h2>
          <div class="section">
              <h3>Your Invite Link</h3>
              <div id="yourInviteLinkDisplay">Generating link...</div>
              <button id="copyInviteCode" class="game-btn">Copy Link</button>
          </div>
          <div class="section">
              <h3>Redeem Invite Code</h3>
              <input type="text" id="redeemCodeInput" placeholder="Enter friend's code" />
              <button id="redeemCodeBtn" class="game-btn">Redeem</button>
          </div>
      </div>
  </div>

  <!-- Game Over Overlay -->
  <div id="gameOverMenu" class="hidden">
      <h2>Game Over</h2>
      <p>Session Coins: <span id="sessionCoinCount">0</span></p>
      <p>Total Coins: <span id="finalTotalCoins">0</span></p>
      <p>Total Rs: <span id="finalTotalPkr">0</span></p>
      <button id="restartBtn" class="menu-btn game-btn">Restart</button>
      <button id="backMenuBtn" class="menu-btn game-btn">Back to Menu</button>
  </div>

  <!-- Withdraw Modal -->
  <div id="withdrawModal" class="modal hidden">
     <div class="modal-content">
         <button class="close-btn" id="closeWithdraw">×</button>
         <h2>Redeem Coins</h2>
         <div class="scroll-container">
             <p>Select an option (Requires invites):</p>
             <div id="redeemOptions">
                 <!-- Options will be dynamically loaded here -->
                 <p class="no-history">Loading withdrawal options...</p>
             </div>
             <!-- ADDED SWAP BUTTON -->
             <button id="swapCoinsBtnWithdraw" class="game-btn">Swap Coins</button>
             
             <div id="redeemForm" class="hidden">
                 <h3>Enter Details</h3>
                 <div id="referralTaskDisplay"></div>
                 <form id="redeemDetailsForm">
                     <div><label for="accountHolderName">Account Name:</label><input type="text" id="accountHolderName" required /></div>
                     <div><label for="accountNumber">Account Number:</label><input type="text" id="accountNumber" required /></div>
                     <div class="payment-options" style="margin-top: 15px;">
                         <label>Method:</label>
                         <label><input type="radio" name="paymentMethod" value="JazzCash" required> JazzCash</label>
                         <label><input type="radio" name="paymentMethod" value="EasyPaisa" required> EasyPaisa</label>
                     </div>
                     <button type="submit" id="redeemSubmitBtn" class="game-btn">Submit Request</button>
                 </form>
             </div>
         </div>
     </div>
  </div>

  <!-- Game Info Modal -->
  <div id="infoModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-btn" id="closeInfo">×</button>
      <h2>Game Info</h2>
      <div class="info-scroll-container">
          <p>Welcome to <strong>Mario Run Earn Real Money</strong>! Run, jump, collect coins, and avoid obstacles.</p>
          <p><strong>Login:</strong> Use your Google Account to Sign in and save your progress.</p>
          <p><strong>Guest Play:</strong> Play for fun without saving coins. Great for practice!</p>
          <p><strong>Bonuses:</strong>
              <br>- Get <strong class="highlight">100 Coins</strong> just for signing up!
              <br>- Invite friends using your unique link (find it in the Invite menu).
              <br>- When your friend signs up using your code, they get an <strong class="highlight">extra 100 Coins</strong> (total 200 start!), and YOU get <strong class="highlight">200 Coins!</strong>
              <br>- Existing users can also redeem a code once for a <strong class="highlight">100 Coin</strong> bonus.
          </p>
           <p><strong>Spin Wheel:</strong> Test your luck! Get a free spin every 3 hours, or buy extra spins with coins. Earn bonus coins or PKR!</p>
            <p><strong>Swap Coins:</strong> Tap on your balance at the top right to swap Coins for PKR (10,000 Coins = 100 Rs). Swap amount must be in blocks of 10,000 Coins.</p>
          <p><strong>Withdrawals:</strong> Redeem your earned coins or PKR for real rewards via JazzCash or EasyPaisa. <strong class="highlight">You must invite a certain number of friends to unlock each withdrawal tier (except the one-time 10k Coin / 100 Rs option).</strong> Check the Withdraw menu for details.</p>
           <p><strong>One-Time Withdrawal:</strong> The 100 Rs withdrawal option (for 10k Coins) is available only once per user for demonstrating trustworthiness.</p>
          <p><strong>Developer:</strong> This game was proudly developed by Wajid Ali, a passionate game developer dedicated to delivering fun and engaging gaming experiences for players around the world.

    <p><strong>Developer Name: Wajid Ali<p><strong>

    <p><strong>Email: mbhia78@gmail.com<p><strong>

    <p><strong>Address: Warsak Road, Chehil Ghazi Baba, Peshawar, Pakistan <p><strong>

    <p><strong>Phone: +92 313 9071038<p><strong>
      </div>
    </div>
  </div>

  <!-- Withdrawal History Modal -->
  <div id="withdrawalHistoryModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-btn" id="closeHistoryModal">×</button>
      <h2>Withdrawal History</h2>
      <div id="historyList"> <p class="no-history">Loading...</p> </div>
    </div>
  </div>

  <!-- Spin Wheel Modal -->
    <div id="spinWheelModal" class="modal hidden">
        <div class="modal-content w-full max-w-sm bg-zinc-800 text-white rounded-xl shadow-lg p-6 border-4 border-pink-500 relative overflow-y-auto">
            <button class="close-btn absolute top-2 right-3 text-3xl font-bold text-gray-400 hover:text-pink-500 transform hover:rotate-90 transition-transform" id="closeSpinWheel">×</button>
            <h2 class="text-2xl font-bold text-pink-500 mb-6 text-shadow-md">Spin the Wheel!</h2>

            <div class="wheel-container relative flex justify-center items-center">
                <svg id="wheelSvg" viewBox="0 0 400 400" class="wheel-svg w-full max-w-xs sm:max-w-sm rotate-0" style="transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);"></svg>
                <svg class="wheel-arrow absolute top-[-25px] left-1/2 transform -translate-x-1/2 w-8 h-8 text-pink-500 drop-shadow-lg" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.707-10.293a1 1 0 00-1.414 1.414L8.586 10H7a1 1 0 100 2h1.586l-1.293 1.293a1 1 0 001.414 1.414L10 13.414l1.293 1.293a1 1 0 001.414-1.414L11.414 12H13a1 1 0 100-2h-1.586l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586z" clip-rule="evenodd"></path>
                </svg>
                <div class="wheel-center-pin absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-green-500 rounded-full border-4 border-white flex items-center justify-center font-press-start text-white text-sm uppercase shadow-lg z-10">Spin</div>
            </div>

            <div id="spinStatus" class="text-center text-sm mb-4 font-press-start text-yellow-400 min-h-[1.2em]">Ready to spin!</div>
            <div id="spinsLeftDisplay" class="text-center text-sm mb-4 font-press-start text-gray-300 min-h-[1.2em]">Spins left: 0</div>
            <div id="cooldownTimerDisplay" class="text-center timer-display text-gray-400 min-h-[1.2em]"></div>

            <button id="freeSpinBtn" class="game-btn bg-blue-600 hover:bg-blue-700 border-b-4 border-blue-800 w-full mt-4">
                Free Spin
            </button>
            <button id="buySpinBtn" class="buy-spin-option game-btn w-full mt-3 disabled:opacity-50 disabled:cursor-not-allowed">
                Buy Spin (1000 Coins)
            </button>
        </div>
    </div>

    <!-- Swap Modal -->
    <div id="swapModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-btn" id="closeSwapModal">×</button>
            <h2>Swap Coins to Rs</h2>
             <p>Convert your game Coins into real PKR balance.</p>
            <div class="swap-info">
                <div class="status-group"><img src="https://i.imgur.com/PCDgdlS.png" alt="Coin" style="display: none;">Coins: <strong id="swapCurrentCoins">0</strong></div>
                 <div class="status-group">Rs <span class="pkr-highlight" id="swapCurrentPkr">0</span></div>
            </div>
             <p>Swap Rate: <strong>10,000 Coins</strong> = <span class="pkr-highlight">100 Rs</span></p>
             <p class="subtle">(Swap amount must be in blocks of 10,000 Coins)</p>
            <button id="swapToPkrBtn" class="game-btn">Swap 10,000 Coins</button>
        </div>
    </div>

     <!-- Game Transactions Modal (NEW) -->
    <div id="gameTransactionsModal" class="modal hidden">
      <div class="modal-content">
        <button class="close-btn" id="closeTransactionsModal">×</button>
        <h2>Game Transactions</h2>
        <div id="transactionsList"> <p class="no-transactions">Loading...</p> </div>
      </div>
    </div>


  <!-- AD INTEGRATION -->
  <div id="bannerAdContainer">
    <script type="text/javascript">
        atOptions = {
            'key' : '34daa95d37aa866e4d5dc188a89f19b2',
            'format' : 'iframe',
            'height' : 50,
            'width' : 320,
            'params' : {}
        };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/34daa95d37aa866e4d5dc188a89f19b2/invoke.js"></script>
  </div>
  <div id="interstitialAdOverlay" class="hidden">
      <p id="adInfoText">Loading ad...</p>
      <div id="interstitialAdTimer"></div>
      <button id="interstitialAdCloseButton" class="game-btn hidden">Skip Ad</button>
      <p class="skip-info">(Click 'Skip Ad' or close ad tab manually if needed)</p>
  </div>

    <!-- WhatsApp Button -->
    <a href="https://whatsapp.com/channel/0029VbAKXCi2ER6lhPezY50a" target="_blank" id="whatsappBtn" class="whatsapp-btn" title="Join our WhatsApp Channel">
        <img src="https://i.imgur.com/d2UlLQN.png" alt="WhatsApp Icon">
    </a>

    <!-- Spin Button -->
    <div id="spinBtn" class="hidden bg-yellow-500 hover:bg-yellow-600 shadow-lg hover:shadow-xl">
        <img src="./Picsart_25-06-03_14-44-00-310.png" alt="Spin Wheel Icon">
    </div>


  <!-- Firebase and Game Scripts -->
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, query, orderByChild, equalTo, onValue, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

    // --- DOM Element References ---
    const googleSignInPanel = document.getElementById('googleSignInPanel');
    const googleSignInBtn = document.getElementById('googleSignInBtn');
    const guestButtonAlt = document.getElementById('guestButtonAlt');
    const completeProfileModal = document.getElementById('completeProfileModal');
    const profileUsernameInput = document.getElementById('profileUsernameInput');
    const profileReferralInput = document.getElementById('profileReferralInput');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const mainMenu = document.getElementById('mainMenu');
    const gameOverMenu = document.getElementById('gameOverMenu');
    const gameCanvas = document.getElementById('gameCanvas');
    const settingsModal = document.getElementById('settingsModal');
    const profileModal = document.getElementById('profileModal');
    const inviteModal = document.getElementById('inviteModal');
    const withdrawModal = document.getElementById('withdrawModal');
    const infoModal = document.getElementById('infoModal');
    const withdrawalHistoryModal = document.getElementById('withdrawalHistoryModal');
    const historyListDiv = document.getElementById('historyList');
    const interstitialAdOverlay = document.getElementById('interstitialAdOverlay');
    const interstitialAdCloseButton = document.getElementById('interstitialAdCloseButton');
    const interstitialAdTimer = document.getElementById('interstitialAdTimer');
    const adInfoText = document.getElementById('adInfoText');
    const installPwaBtn = document.getElementById('installPwaBtn');
    const pwaInstallBanner = document.getElementById('pwaInstallBanner');
    const pwaInstallBtn = document.getElementById('pwaInstallBtn');
    const pwaDismissBtn = document.getElementById('pwaDismissBtn');
    const characterSelectionModal = document.getElementById('characterSelectionModal');
    const closeCharacterSelectionBtn = document.getElementById('closeCharacterSelection');
    const characterContainer = document.getElementById('characterContainer');


    // Updated Coin/PKR Display Refs
    const topRightStatusContainer = document.getElementById('topRightStatusContainer');
    const coinStatusBox = document.getElementById('coinStatusBox');
    const menuCoinCountSpan = document.getElementById('menuCoinCount');
    const menuPkrCountSpan = document.getElementById('menuPkrCount');

    const finalTotalCoinsSpan = document.getElementById('finalTotalCoins');
    const finalTotalPkrSpan = document.getElementById('finalTotalPkr');
    const sessionCoinCountSpan = document.getElementById('sessionCoinCount');
    const inviteFriendBtn = document.getElementById('inviteFriend');
    const yourInviteLinkDisplay = document.getElementById('yourInviteLinkDisplay');
    const redeemCodeInput = document.getElementById("redeemCodeInput");
    const toggleSoundBtn = document.getElementById("toggleSound");
    const redeemOptionsDiv = document.getElementById("redeemOptions");
    const redeemFormDiv = document.getElementById("redeemForm");
    const redeemDetailsForm = document.getElementById("redeemDetailsForm");
    const redeemSubmitBtn = document.getElementById('redeemSubmitBtn');
    const withdrawalHistoryBtn = document.getElementById('withdrawalHistoryBtn');
    const closeHistoryModalBtn = document.getElementById('closeHistoryModal');
    const profileBtn = document.getElementById('profileBtn');
    const closeProfileModalBtn = document.getElementById('closeProfileModal');
    const profileUsernameSpan = document.getElementById('profileUsername');
    const profileEmailSpan = document.getElementById('profileEmail');
    const profileTotalCoinsSpan = document.getElementById('profileTotalCoins');
    const profileTotalPkrSpan = document.getElementById('profileTotalPkr');
    const profileReferralCountSpan = document.getElementById('profileReferralCount');
    const profileInviteCodeSpan = document.getElementById('profileInviteCode');
    const profileJoinedDateSpan = document.getElementById('profileJoinedDate');
    const statusMessageContainer = document.getElementById('statusMessageContainer');
    const statusMessageText = document.getElementById('statusMessageText');
    let statusMessageTimeoutId = null;
    const backgroundAudio = document.getElementById("backgroundAudio");
    const jumpSound = document.getElementById("jumpSound");
    const coinSound = document.getElementById("coinSound");
    const gameOverSound = document.getElementById("gameOverSound");
    const settingsBtn = document.getElementById('settingsBtn');
    const closeSettings = document.getElementById('closeSettings');
    const infoBtn = document.getElementById('infoBtn');
    const closeInfo = document.getElementById('closeInfo');
    const copyInviteCode = document.getElementById('copyInviteCode');
    const redeemCodeBtn = document.getElementById('redeemCodeBtn');
    const closeInviteModal = document.getElementById('closeInviteModal');
    const withdrawBtn = document.getElementById('withdrawBtn');
    const closeWithdraw = document.getElementById('closeWithdraw');
    const logoutBtn = document.getElementById('logoutBtn');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const backMenuBtn = document.getElementById('backMenuBtn');
    const customerService = document.getElementById('customerService');
    const accountHolderName = document.getElementById('accountHolderName');
    const accountNumber = document.getElementById('accountNumber');
    const referralTaskDisplay = document.getElementById('referralTaskDisplay');
    const whatsappBtn = document.getElementById('whatsappBtn');
    const swapCoinsBtnWithdraw = document.getElementById('swapCoinsBtnWithdraw'); // New Button in Withdraw Modal

    // --- Spin Wheel Elements ---
    const spinBtn = document.getElementById('spinBtn');
    const spinWheelModal = document.getElementById('spinWheelModal');
    const closeSpinWheelBtn = document.getElementById('closeSpinWheel');
    const wheelSvg = document.getElementById('wheelSvg');
    const freeSpinBtn = document.getElementById('freeSpinBtn');
    const buySpinBtn = document.getElementById('buySpinBtn');
    const spinsLeftDisplay = document.getElementById('spinsLeftDisplay');
    const cooldownTimerDisplay = document.getElementById('cooldownTimerDisplay');
    const spinStatusDisplay = document.getElementById('spinStatus');
    const spinStartSound = document.getElementById('spinStartSound');
    const spinWinSound = document.getElementById('spinWinSound');

    // --- Swap Modal Elements ---
    const swapModal = document.getElementById('swapModal');
    const closeSwapModalBtn = document.getElementById('closeSwapModal');
    const swapCurrentCoinsSpan = document.getElementById('swapCurrentCoins');
    const swapCurrentPkrSpan = document.getElementById('swapCurrentPkr');
    const swapToPkrBtn = document.getElementById('swapToPkrBtn');

    // --- Game Transactions Elements (NEW) ---
    const gameTransactionsBtn = document.getElementById('gameTransactionsBtn');
    const gameTransactionsModal = document.getElementById('gameTransactionsModal');
    const closeTransactionsModalBtn = document.getElementById('closeTransactionsModal');
    const transactionsListDiv = document.getElementById('transactionsList');


    // --- New Profile Info Elements ---
    const profileTotalPlayTimeSpan = document.getElementById('profileTotalPlayTime');
    const profileTotalSpinCoinsSpan = document.getElementById('profileTotalSpinCoins');
    const profileTotalSpinPkrSpan = document.getElementById('profileTotalSpinPkr');
    const profileTotalCoinsSwappedSpan = document.getElementById('profileTotalCoinsSwapped');
    const profileLastActiveSpan = document.getElementById('profileLastActive');


    const firebaseConfig = {
      apiKey: "AIzaSyCpheUGTtliJyTXjVlm1VnfvGTbaeykQ7E", authDomain: "super-mario-earn-real-money.firebaseapp.com",
      databaseURL: "https://super-mario-earn-real-money-default-rtdb.firebaseio.com", projectId: "super-mario-earn-real-money",
      storageBucket: "super-mario-earn-real-money.firebasestorage.app", messagingSenderId: "527750706733",
      appId: "1:527750706733:web:71f31dc125468ca645eaa4", measurementId: "G-Z25ZFF8PWT"
    };

    // --- Firebase Initialization ---
    let appFirebase, db, auth;
    try {
        appFirebase = initializeApp(firebaseConfig);
        db = getDatabase(appFirebase);
        auth = getAuth();
        console.log("Firebase initialized successfully.");
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        showStatusMessage("Connection error. Cannot initialize.", "error", 10000);
    }
    
    // --- NEW: Game Configuration ---
    let gameConfig = {
        backgrounds: {
            login: 'https://i.imgur.com/nxRZ03R.png',
            mainMenu: 'https://i.imgur.com/KFWJlte.png',
            modalDefault: 'https://i.imgur.com/KFWJlte.png',
            characterSelect: 'https://i.imgur.com/KFWJlte.png'
        },
        coinToPkrRate: 100, // 100 coins = 1 PKR
        swapBlock: 10000,
        characters: {
            "default_mario": {
                name: "Mario",
                iconUrl: "https://i.imgur.com/AbfH2aB.png",
                spriteUrl: "https://i.imgur.com/AbfH2aB.png",
                price: 0,
                width: 40,
                height: 60
            }
        },
        withdrawalOptions: {
            "option1": { coins: 10000, pkr: 100, referralsNeeded: 5, isOneTime: true, text: "10k Coins - 100 Rs (One-Time)" },
            "option2": { coins: 30000, pkr: 300, referralsNeeded: 10, isOneTime: false, text: "30k Coins - 300 Rs" },
            "option3": { coins: 50000, pkr: 500, referralsNeeded: 20, isOneTime: false, text: "50k Coins - 500 Rs" },
            "option4": { coins: 80000, pkr: 800, referralsNeeded: 30, isOneTime: false, text: "80k Coins - 800 Rs" },
            "option5": { coins: 100000, pkr: 1000, referralsNeeded: 40, isOneTime: false, text: "100k Coins - 1000 Rs" },
            "option6": { coins: 500000, pkr: 5000, referralsNeeded: 50, isOneTime: false, text: "500k Coins - 5000 Rs" }
        }
    };
    let selectedCharacter = gameConfig.characters.default_mario;


    // --- Global State ---
    let totalCoins = 0;
    let totalPKR = 0;
    let totalSpinCoinsEarned = 0;
    let totalSpinPkrEarned = 0;
    let totalPlayTimeMinutes = 0;
    let totalCoinsSwapped = 0;
    let lastActiveTimestamp = 0;
    let soundEnabled = true;
    let currentUserInviteCode = null;
    let currentUsername = null;
    let currentReferralCount = 0;
    let currentJoinedDate = null;
    let userPurchasedCharacters = ["default_mario"]; // Always own the default
    let hasWithdrawnOneTime = {};
    let gameStarted = false;
    let gameOver = false;
    let score = 0;
    let mario, obstacles, coins, speed, bgX, platformX;
    let lastJumpInputTime = 0;
    const doubleJumpWindow = 350;
    let canDoubleJump = false;
    let animationFrameId = null;
    let allImagesLoaded = false;
    let isProcessingAuth = false;
    let coinListenerUnsubscribe = null;
    let profileCompleteListener = null;
    let gameStartTime = 0;
    let deferredInstallPrompt = null;

    // --- Spin Wheel State ---
    let spinsLeft = 0;
    let lastSpinTime = 0;
    const spinCooldownHours = 3;
    const spinCooldownMilliseconds = spinCooldownHours * 60 * 60 * 1000;
    const spinBuyPrice = 1000;


    // --- Constants ---
    const SIGNUP_BONUS = 100;
    const REFERRER_BONUS = 200;
    const REDEEMER_BONUS = 100;
    const baseInviteUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;

    const spinWheelRewards = [
        { name: '1 Rs', type: 'pkr', amount: 1, weight: 50, color: '#f44336' },
        { name: '5 Rs', type: 'pkr', amount: 5, weight: 40, color: '#ff9800' },
        { name: '10 Rs', type: 'pkr', amount: 10, weight: 20, color: '#ffeb3b' },
        { name: '50 Rs', type: 'pkr', amount: 50, weight: 1, color: '#4caf50' },
        { name: '100 Rs', type: 'pkr', amount: 100, weight: 0.1, color: '#2196f3' },
        { name: '100 Coins', type: 'coins', amount: 100, weight: 50, color: '#9c27b0' },
        { name: '200 Coins', type: 'coins', amount: 200, weight: 40, color: '#e91e63' },
        { name: '500 Coins', type: 'coins', amount: 500, weight: 30, color: '#00bcd4' },
        { name: '5000 Coins', type: 'coins', amount: 5000, weight: 1, color: '#8bc34a' },
        { name: '10000 Coins', type: 'coins', amount: 10000, weight: 0.1, color: '#ff5722' }
    ];
    const totalSpinWeight = spinWheelRewards.reduce((sum, reward) => sum + reward.weight, 0);


    // --- Status Message Function ---
    function showStatusMessage(message, type = 'info', duration = 3000) {
        if (statusMessageTimeoutId) { clearTimeout(statusMessageTimeoutId); statusMessageContainer.classList.remove('show'); }
        console.log(`Status [${type}]: ${message}`);
        statusMessageText.textContent = message;
        statusMessageContainer.className = 'statusMessageContainer'; statusMessageContainer.classList.add(type);
        statusMessageContainer.style.display = 'block'; statusMessageContainer.style.top = '15px'; statusMessageContainer.style.transform = 'translateX(-50%) scale(0.9)';
        void statusMessageContainer.offsetWidth; statusMessageContainer.classList.add('show');
        statusMessageTimeoutId = setTimeout(() => {
            statusMessageContainer.classList.remove('show'); statusMessageTimeoutId = null;
            setTimeout(() => { if (!statusMessageContainer.classList.contains('show')) statusMessageContainer.style.display = 'none'; }, 400);
        }, duration);
    }
    
    // --- NEW: Config Functions ---
    async function fetchGameConfig() {
        console.log("Fetching remote game config...");
        try {
            const configRef = ref(db, 'gameConfig');
            const snapshot = await get(configRef);
            if (snapshot.exists()) {
                const remoteConfig = snapshot.val();
                // Merge remote config with default config
                gameConfig = { ...gameConfig, ...remoteConfig };
                console.log("Remote config fetched and merged:", gameConfig);
            } else {
                console.log("No remote config found, using default.");
            }
        } catch (error) {
            console.error("Error fetching remote config, using default:", error);
        }
    }

    function applyGameConfig() {
        console.log("Applying game config to UI...");
        const root = document.documentElement;
        root.style.setProperty('--bg-login-panel', `url('${gameConfig.backgrounds.login}')`);
        root.style.setProperty('--bg-main-menu', `url('${gameConfig.backgrounds.mainMenu}')`);
        root.style.setProperty('--bg-modal-default', `url('${gameConfig.backgrounds.modalDefault}')`);
        root.style.setProperty('--bg-char-select', `url('${gameConfig.backgrounds.characterSelect}')`);
        // Update any other UI elements that depend on config
        const pkrPerBlock = gameConfig.swapBlock / gameConfig.coinToPkrRate;
        const swapRateP = document.querySelector("#swapModal p:nth-of-type(2)");
        if (swapRateP) {
            swapRateP.innerHTML = `Swap Rate: <strong>${gameConfig.swapBlock} Coins</strong> = <span class="pkr-highlight">${pkrPerBlock} Rs</span>`;
        }
    }


    // --- AD INTEGRATION ---
    const directLinkUrl = "https://www.profitableratecpm.com/zi30dfhjnn?key=b78830ea0cb80a28c4b278ee2e122b06";
    let adCloseTimerInterval; let adCloseTimeout; let currentAdCallback = null;
    function showInterstitialAd(callback) {
         console.log("Attempting to show Interstitial Ad...");
         const user = auth?.currentUser;
         const isLoggedAndProfiled = user && currentUsername;

         if (!isLoggedAndProfiled) {
             console.log("Not logged in or profile incomplete, skipping ad.");
             if (typeof callback === 'function') { try { callback(); } catch (e) { console.error("Error in ad callback after skip:", e); } }
             return;
         }

         if (typeof callback !== 'function') { console.error("Invalid ad callback."); return; }
         currentAdCallback = callback; adInfoText.textContent = "Ad loading...";
         interstitialAdOverlay.style.display = 'flex';
         interstitialAdCloseButton.style.display = 'none'; interstitialAdTimer.textContent = "";
         let adWindow = null; try { adWindow = window.open(directLinkUrl, '_blank'); } catch (e) { console.error("Error opening ad window:", e); }
         if (!adWindow) { console.warn("Pop-up blocked."); showStatusMessage("Ad might be blocked.", "info"); interstitialAdOverlay.style.display = 'none'; if (currentAdCallback) { try { currentAdCallback(); } catch (e) { console.error("Error in ad callback after block:", e); } } currentAdCallback = null; return; }
         let secondsRemaining = 3; interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`;
         if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
         adCloseTimerInterval = setInterval(() => { secondsRemaining--; if (secondsRemaining > 0) interstitialAdTimer.textContent = `Skip in ${secondsRemaining}s`; else { interstitialAdTimer.textContent = "Skip available"; clearInterval(adCloseTimerInterval); } }, 1000);
         adCloseTimeout = setTimeout(() => { interstitialAdCloseButton.style.display = 'inline-flex'; if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); interstitialAdTimer.textContent = "Skip available"; }, secondsRemaining * 1000 + 100);
    }
    interstitialAdCloseButton.addEventListener('click', () => {
         console.log("Ad Skip Button clicked."); interstitialAdOverlay.style.display = 'none';
         if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); if (adCloseTimeout) clearTimeout(adCloseTimeout);
         interstitialAdTimer.textContent = "";
         if (typeof currentAdCallback === 'function') { console.log("Executing ad callback after skip."); try { currentAdCallback(); } catch(e) { console.error("Error in ad callback:", e); showStatusMessage("Error proceeding.", "error"); } currentAdCallback = null; }
         else { console.warn("No ad callback found after skipping."); }
    });

    // --- Sound Functions ---
    function playSound(audioElement) { if (soundEnabled && audioElement) { try { audioElement.currentTime=0; audioElement.play().catch(e=>console.warn(`Sound play error (${audioElement.id}):`, e)); } catch(e) { console.warn("Sound play failed:", e); } } }
    function playBackgroundMusic() { if (soundEnabled && backgroundAudio && backgroundAudio.paused) { backgroundAudio.play().catch(e=>console.warn("Background music play failed:",e)); } }
    function stopBackgroundMusic() { if (backgroundAudio && !backgroundAudio.paused) { backgroundAudio.pause(); backgroundAudio.currentTime=0; } }

    // --- Authentication Logic ---
    function setAuthProcessing(isProcessing) {
        console.log(`Setting Auth Processing: ${isProcessing}`); isProcessingAuth = isProcessing;
        const signInPanelVisible = googleSignInPanel.style.display === 'flex';
        const profileModalVisible = completeProfileModal.style.display === 'flex';

        if(signInPanelVisible) {
             if(googleSignInBtn) googleSignInBtn.disabled = isProcessing;
             if(guestButtonAlt) guestButtonAlt.disabled = isProcessing;
        } else {
             if(googleSignInBtn) googleSignInBtn.disabled = false;
             if(guestButtonAlt) guestButtonAlt.disabled = false;
        }

        if(profileModalVisible) {
             if(saveProfileBtn) saveProfileBtn.disabled = isProcessing;
        } else {
             if(saveProfileBtn) saveProfileBtn.disabled = false;
        }

        if(logoutBtn) logoutBtn.disabled = isProcessing;
        if(startBtn) startBtn.disabled = isProcessing || !allImagesLoaded;
        if(withdrawBtn) withdrawBtn.disabled = isProcessing;
        if(inviteFriendBtn) inviteFriendBtn.disabled = isProcessing;
        if(infoBtn) infoBtn.disabled = isProcessing;
        if(installPwaBtn) installPwaBtn.disabled = isProcessing;
        if(settingsBtn) settingsBtn.style.pointerEvents = isProcessing ? 'none' : 'auto';
        if (topRightStatusContainer) topRightStatusContainer.style.pointerEvents = isProcessing ? 'none' : 'auto';
        if (whatsappBtn) whatsappBtn.style.pointerEvents = isProcessing ? 'none' : 'auto';
        if (spinBtn) spinBtn.style.pointerEvents = isProcessing ? 'none' : 'auto';

        const anyModalOpen = settingsModal.style.display === 'flex' || profileModal.style.display === 'flex' || inviteModal.style.display === 'flex' || withdrawModal.style.display === 'flex' || infoModal.style.display === 'flex' || withdrawalHistoryModal.style.display === 'flex' || spinWheelModal.style.display === 'flex' || swapModal.style.display === 'flex' || gameTransactionsModal.style.display === 'flex' || characterSelectionModal.style.display === 'flex';
        if (anyModalOpen) {
             document.querySelectorAll('.modal-content .game-btn, .modal-content .redeem-option, .modal-content .char-btn').forEach(btn => {
                 if (!btn.dataset.preAuthDisabled) {
                     btn.dataset.preAuthDisabled = btn.disabled;
                 }
                 btn.disabled = isProcessing || (btn.dataset.preAuthDisabled === 'true');
             });
        } else {
            document.querySelectorAll('.modal-content .game-btn, .modal-content .redeem-option, .modal-content .char-btn').forEach(btn => {
                 if (btn.dataset.preAuthDisabled !== undefined) {
                     btn.disabled = (btn.dataset.preAuthDisabled === 'true');
                     delete btn.dataset.preAuthDisabled;
                 } else {
                     btn.disabled = isProcessing;
                 }
             });
        }
    }


    async function handleGoogleSignInSuccess(userCredential) {
        const user = userCredential.user;
        console.log(`Google Sign-In Success for: ${user.uid}. Checking profile...`);
        setAuthProcessing(true);
        try {
            const userRef = ref(db, `users/${user.uid}`); const snapshot = await get(userRef);
            if (snapshot.exists() && snapshot.val().username) {
                console.log("Existing user with username found.");
                showStatusMessage(`Welcome back, ${snapshot.val().username}!`, "success", 2000);

                const updates = { lastActiveTimestamp: serverTimestamp() };
                await update(userRef, updates).catch(e => console.error("Error updating last active timestamp on login:", e));

                showInterstitialAd(async () => {
                    try {
                        await loadUserData(user.uid);
                        setupCoinListener(user.uid);
                        showMainMenu();
                        checkUrlForReferral();
                    } catch (loadError) {
                        console.error("Failed to load user data after ad:", loadError);
                        showStatusMessage("Error loading profile data.", "error");
                         hideAllViewsAndModalsExcept(googleSignInPanel);
                         googleSignInPanel.style.display = 'flex';
                    } finally {
                        setAuthProcessing(false);
                    }
                });
            } else {
                console.log("New user or profile incomplete.");
                showStatusMessage("Complete your profile.", "info", 3000);
                profileUsernameInput.value = user.displayName || ""; profileReferralInput.value = "";
                const urlParams = new URLSearchParams(window.location.search); const refCode = urlParams.get('ref');
                 if (refCode) { profileReferralInput.value = refCode.trim().toUpperCase(); console.log("Referral code pre-filled."); const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname; window.history.replaceState({path:cleanUrl},'',cleanUrl); }
                hideAllViewsAndModalsExcept(completeProfileModal);
                completeProfileModal.style.display = "flex";
                if(profileCompleteListener) saveProfileBtn.removeEventListener('click', profileCompleteListener);
                profileCompleteListener = createProfileCompletionHandler(user); saveProfileBtn.addEventListener('click', profileCompleteListener);
                setAuthProcessing(false);
            }
        } catch (error) {
            console.error("Error checking user existence:", error); showStatusMessage("Error loading profile.", "error");
            signOut(auth).catch(e => console.error("Sign out error:", e));
            setAuthProcessing(false);
        }
    }

    function createProfileCompletionHandler(user) {
        return async () => {
            if (isProcessingAuth) return;
            const chosenUsername = profileUsernameInput.value.trim(); const referralCode = profileReferralInput.value.trim().toUpperCase();
            if (chosenUsername.length < 3) { showStatusMessage("Username must be >= 3 chars.", "error"); return; }
            if (!/^[a-zA-Z0-9_]+$/.test(chosenUsername)) { showStatusMessage("Invalid username characters.", "error"); return; }
            console.log(`Saving profile for ${user.uid}. User: ${chosenUsername}, Ref: ${referralCode}`);
            setAuthProcessing(true); saveProfileBtn.disabled = true; showStatusMessage("Creating profile...", "info");
            try {
                const generatedInviteCode = generateRandomCode(); const creationTime = serverTimestamp();
                const initialUserData = {
                     email: user.email,
                     username: chosenUsername,
                     uid: user.uid,
                     totalCoins: SIGNUP_BONUS,
                     totalPKR: 0,
                     referralCount: 0,
                     referralRedeemed: false,
                     codeRedeemedFrom: null,
                     inviteCode: generatedInviteCode,
                     createdAt: creationTime,
                     provider: 'google',
                     spinsLeft: 1,
                     lastSpinTime: creationTime,
                     hasWithdrawnOneTime: {},
                     purchasedCharacters: ["default_mario"],
                     totalSpinCoinsEarned: 0,
                     totalSpinPkrEarned: 0,
                     totalPlayTimeMinutes: 0,
                     totalCoinsSwapped: 0,
                     lastActiveTimestamp: creationTime,
                     transactions: {}
                };
                console.log(`1: Setting initial data (+${SIGNUP_BONUS} coins)...`);
                await set(ref(db, `users/${user.uid}`), initialUserData);
                console.log("2: Initial DB data set.");
                let referralMessage = ""; let finalCoins = SIGNUP_BONUS;
                const updatesAfterReferral = { lastActiveTimestamp: serverTimestamp() };

                if (referralCode) {
                    console.log(`3: Attempting referral: ${referralCode}`);
                    try {
                        const { newCoinsForRedeemer, referrerUid } = await redeemInviteCode(referralCode, user.uid, initialUserData);
                        console.log("4: Referral success.");
                        finalCoins = newCoinsForRedeemer;
                        updatesAfterReferral.referralRedeemed = true;
                        updatesAfterReferral.codeRedeemedFrom = referrerUid;

                        console.log("5: User record updated with redemption details.");
                        referralMessage = ` +${REDEEMER_BONUS} referral bonus!`;
                    } catch (redeemError) {
                        console.warn("4: Referral error:", redeemError.message);
                        referralMessage = ` (Referral error: ${redeemError.message})`;
                    }
                }
                 totalCoins = finalCoins;
                 totalPKR = 0;
                 totalSpinCoinsEarned = 0;
                 totalSpinPkrEarned = 0;
                 totalPlayTimeMinutes = 0;
                 totalCoinsSwapped = 0;
                 lastActiveTimestamp = Date.now();

                 await update(ref(db, `users/${user.uid}`), updatesAfterReferral);

                 if (user && user.uid) {
                    const newTransactionRef = push(ref(db, `users/${user.uid}/transactions`));
                    await set(newTransactionRef, {
                        type: 'signup_bonus',
                        amount: SIGNUP_BONUS,
                        timestamp: serverTimestamp(),
                        details: `Signup Bonus`
                    }).catch(e => console.error("Error saving signup transaction:", e));

                    if (referralCode && updatesAfterReferral.referralRedeemed) {
                        const newReferralTransactionRef = push(ref(db, `users/${user.uid}/transactions`));
                         await set(newReferralTransactionRef, {
                             type: 'referral_bonus',
                             amount: REDEEMER_BONUS,
                             timestamp: serverTimestamp(),
                             details: `Referral bonus from code: ${referralCode}`
                         }).catch(e => console.error("Error saving referral bonus transaction:", e));
                    }
                 }


                showStatusMessage(`Profile created! +${SIGNUP_BONUS} bonus${referralMessage}`, "success", 6000);
                completeProfileModal.style.display = "none";
                 showInterstitialAd(async () => {
                    try {
                        await loadUserData(user.uid);
                        setupCoinListener(user.uid);
                        showMainMenu();
                    } catch (loadError) {
                        console.error("Failed to load data after profile creation/ad:", loadError);
                        showStatusMessage("Error loading profile data.", "error");
                         hideAllViewsAndModalsExcept(googleSignInPanel);
                         googleSignInPanel.style.display = 'flex';
                    } finally {
                        setAuthProcessing(false);
                    }
                 });
            } catch (dbError) {
                console.error("Error saving profile:", dbError); showStatusMessage("Error saving profile.", "error");
                setAuthProcessing(false); saveProfileBtn.disabled = false;
            }
        };
    }

    googleSignInBtn.addEventListener("click", () => {
        if (isProcessingAuth) return; console.log("Google Sign In clicked."); setAuthProcessing(true); showStatusMessage("Opening Google Sign-in...", "info", 2000);
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).then(handleGoogleSignInSuccess).catch((error) => {
            console.error("Google Sign-In Error:", error); let errorMsg = "Google Sign-in failed.";
            if (error.code === 'auth/popup-closed-by-user') errorMsg = "Sign-in cancelled.";
            else if (error.code === 'auth/network-request-failed') errorMsg = "Network error.";
            else if (error.code === 'auth/cancelled-popup-request') return;
            showStatusMessage(errorMsg, "error", 4000); setAuthProcessing(false);
        });
    });

    guestButtonAlt.addEventListener("click", () => {
        console.log("Guest button clicked."); if (isProcessingAuth) return; setAuthProcessing(true);
        try {
             resetAppStateToLoggedOut();
             hideAllViewsAndModalsExcept(mainMenu);
             showMainMenu();
             showStatusMessage("Playing as Guest.", "info", 4000);
        }
        catch (error) { console.error("Error entering guest mode:", error); showStatusMessage("Error starting guest mode.", "error"); hideAllViewsAndModalsExcept(googleSignInPanel); googleSignInPanel.style.display = "flex"; }
        finally { setAuthProcessing(false); }
    });

    function hideAllViewsAndModalsExcept(exceptElement = null) {
        const viewsAndModals = [
            googleSignInPanel, mainMenu, gameCanvas, gameOverMenu, completeProfileModal,
            settingsModal, profileModal, inviteModal, withdrawModal, infoModal,
            withdrawalHistoryModal, spinWheelModal, swapModal, gameTransactionsModal,
            characterSelectionModal
        ];
        viewsAndModals.forEach(el => {
            if (el && el !== exceptElement) {
                el.style.display = 'none';
            }
        });
         if (whatsappBtn && whatsappBtn !== exceptElement) whatsappBtn.style.display = 'none';
         if (spinBtn && spinBtn !== exceptElement) spinBtn.style.display = 'none';
         if (topRightStatusContainer && topRightStatusContainer !== exceptElement) topRightStatusContainer.style.display = 'none';
         if (settingsBtn && settingsBtn !== exceptElement) settingsBtn.style.display = 'none';
    }


    onAuthStateChanged(auth, async (user) => {
      console.log("Auth State Changed. User:", user ? user.uid : 'null');
      if (coinListenerUnsubscribe) { console.log("Removing existing data listener."); coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }

      if (user) {
          setAuthProcessing(true);
          try {
              const userRef = ref(db, `users/${user.uid}`);
              const snapshot = await get(userRef);
              if (snapshot.exists() && snapshot.val().username) {
                  console.log("Auth State: Existing user session with profile.");
                   console.log("Auth State: Loading user data and updating UI.");
                   await loadUserData(user.uid);
                   setupCoinListener(user.uid);

                    const isAnyModalOpen = settingsModal.style.display === 'flex' ||
                                         profileModal.style.display === 'flex' ||
                                         inviteModal.style.display === 'flex' ||
                                         withdrawModal.style.display === 'flex' ||
                                         infoModal.style.display === 'flex' ||
                                         withdrawalHistoryModal.style.display === 'flex' ||
                                         spinWheelModal.style.display === 'flex' ||
                                         swapModal.style.display === 'flex' ||
                                         gameTransactionsModal.style.display === 'flex' ||
                                         characterSelectionModal.style.display === 'flex';


                   if (gameCanvas.style.display === 'block' || gameOverMenu.style.display === 'flex' || isAnyModalOpen) {
                        console.log("Auth State: User logged in, staying on current view (game/modal). Updating UI elements.");
                         updateCoinPkrDisplay();
                         updateWithdrawalOptionStates();
                         updateInviteButtonText(currentReferralCount);
                         updateInviteLinkDisplay();
                         updateSpinUI();
                         updateSwapModalState();
                         if (!gameStarted && !gameOver) {
                             if (whatsappBtn) whatsappBtn.style.display = 'flex';
                             if (spinBtn) spinBtn.style.display = 'flex';
                             if (settingsBtn) settingsBtn.style.display = 'flex';
                             if (topRightStatusContainer) topRightStatusContainer.style.display = 'flex';
                         }


                   } else if (completeProfileModal.style.display === 'flex') {
                        console.log("Auth State: User logged in, profile modal is active. Ensure others are hidden.");
                        hideAllViewsAndModalsExcept(completeProfileModal);

                   } else {
                       console.log("Auth State: User logged in, profile complete, no other view active. Showing main menu.");
                        hideAllViewsAndModalsExcept(mainMenu);
                        showMainMenu();
                   }
                   checkUrlForReferral();

              } else {
                  console.warn("Auth State: User authenticated but profile incomplete.");
                   profileUsernameInput.value = user.displayName || ""; profileReferralInput.value = "";
                   hideAllViewsAndModalsExcept(completeProfileModal);
                   completeProfileModal.style.display = "flex";
                   if(profileCompleteListener) saveProfileBtn.removeEventListener('click', profileCompleteListener);
                   profileCompleteListener = createProfileCompletionHandler(user); saveProfileBtn.addEventListener('click', profileCompleteListener);
              }
          } catch (dbError) {
              console.error("Auth State: Error checking DB:", dbError); showStatusMessage("Error verifying profile.", "error");
              signOut(auth).catch(e => console.error("Sign out error:", e));
              hideAllViewsAndModalsExcept(googleSignInPanel);
              googleSignInPanel.style.display = "flex";
          } finally { setAuthProcessing(false); }
      } else {
          console.log("User signed out.");
          resetAppStateToLoggedOut();
          hideAllViewsAndModalsExcept(googleSignInPanel);
          googleSignInPanel.style.display = "flex";
          stopBackgroundMusic();
          setAuthProcessing(false);
      }
    });


    // --- Real-time User Data Listener Setup ---
    function setupCoinListener(userId) {
         if (!userId) { console.error("No userId for data listener."); return; }
         if (coinListenerUnsubscribe) { console.warn("Removing existing data listener."); coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
         const userRefPath = `users/${userId}`;
         const userRef = ref(db, userRefPath);
         console.log(`Setting up user data listener for ${userId}`);
         coinListenerUnsubscribe = onValue(userRef, (snapshot) => {
            if (snapshot.exists()) {
                 const userData = snapshot.val();
                 const newCoins = userData.totalCoins ?? 0;
                 const newPKR = userData.totalPKR ?? 0;
                 const newRefCount = userData.referralCount ?? 0;
                 const newSpinsLeft = userData.spinsLeft ?? 0;
                 const newLastSpinTime = userData.lastSpinTime ?? 0;
                 const newHasWithdrawnOneTime = userData.hasWithdrawnOneTime ?? {};
                 const newPurchasedChars = userData.purchasedCharacters ?? ["default_mario"];

                 const newSpinCoinsEarned = userData.totalSpinCoinsEarned ?? 0;
                 const newSpinPkrEarned = userData.totalSpinPkrEarned ?? 0;
                 const newPlayTimeMinutes = userData.totalPlayTimeMinutes ?? 0;
                 const newCoinsSwapped = userData.totalCoinsSwapped ?? 0;
                 const processedLastActive = (userData.lastActiveTimestamp && typeof userData.lastActiveTimestamp === 'object' && typeof userData.lastActiveTimestamp.seconds === 'number')
                    ? userData.lastActiveTimestamp.seconds * 1000 + (userData.lastActiveTimestamp.nanoseconds || 0) / 1000000
                    : userData.lastActiveTimestamp || 0;


                 let stateChanged = false;
                 if (totalCoins != newCoins) { totalCoins = newCoins; stateChanged = true; }
                 if (totalPKR != newPKR) { totalPKR = newPKR; stateChanged = true; }
                 if (currentReferralCount != newRefCount) { currentReferralCount = newRefCount; stateChanged = true; }
                 if (spinsLeft != newSpinsLeft) { spinsLeft = newSpinsLeft; stateChanged = true; }
                 if (lastSpinTime != newLastSpinTime) {
                     lastSpinTime = (newLastSpinTime && typeof newLastSpinTime === 'object' && typeof newLastSpinTime.seconds === 'number')
                       ? newLastSpinTime.seconds * 1000 + (newLastSpinTime.nanoseconds || 0) / 1000000
                       : newLastSpinTime || 0;
                     stateChanged = true;
                 }
                 if (JSON.stringify(hasWithdrawnOneTime) != JSON.stringify(newHasWithdrawnOneTime)) { hasWithdrawnOneTime = newHasWithdrawnOneTime; stateChanged = true; }
                 if (JSON.stringify(userPurchasedCharacters) !== JSON.stringify(newPurchasedChars)) { userPurchasedCharacters = newPurchasedChars; stateChanged = true; }

                 if (totalSpinCoinsEarned != newSpinCoinsEarned) { totalSpinCoinsEarned = newSpinCoinsEarned; stateChanged = true; }
                 if (totalSpinPkrEarned != newSpinPkrEarned) { totalSpinPkrEarned = newSpinPkrEarned; stateChanged = true; }
                 if (totalPlayTimeMinutes != newPlayTimeMinutes) { totalPlayTimeMinutes = newPlayTimeMinutes; stateChanged = true; }
                 if (totalCoinsSwapped != newCoinsSwapped) { totalCoinsSwapped = newCoinsSwapped; stateChanged = true; }
                 if (lastActiveTimestamp != processedLastActive) { lastActiveTimestamp = processedLastActive; stateChanged = true; }


                 if (stateChanged) {
                     console.log(`State changed. Updating relevant UI...`);
                     updateCoinPkrDisplay();

                     if (finalTotalCoinsSpan && gameOverMenu.style.display === 'flex') finalTotalCoinsSpan.innerText = totalCoins;
                      if (finalTotalPkrSpan && gameOverMenu.style.display === 'flex') finalTotalPkrSpan.innerText = totalPKR;
                      if (profileModal.style.display === 'flex') {
                         showProfileModal();
                      }


                     updateInviteButtonText(currentReferralCount);
                     updateWithdrawalOptionStates();
                     updateSpinUI();
                      updateSwapModalState();
                      if(characterSelectionModal.style.display === 'flex') {
                        showCharacterSelectionScreen(); // Refresh the character screen if open
                      }

                      if (mainMenu.style.display === 'flex' || settingsModal.style.display === 'flex' || profileModal.style.display === 'flex' || inviteModal.style.display === 'flex' || withdrawModal.style.display === 'flex' || infoModal.style.display === 'flex' || withdrawalHistoryModal.style.display === 'flex' || spinWheelModal.style.display === 'flex' || swapModal.style.display === 'flex' || gameTransactionsModal.style.display === 'flex' || characterSelectionModal.style.display === 'flex') {
                        if (topRightStatusContainer.style.display !== 'flex') topRightStatusContainer.style.display = 'flex';
                        if (whatsappBtn) whatsappBtn.style.display = 'flex';
                        if (spinBtn) spinBtn.style.display = 'flex';
                        if (settingsBtn) settingsBtn.style.display = 'flex';

                     } else {
                         topRightStatusContainer.style.display = 'none';
                         if (whatsappBtn) whatsappBtn.style.display = 'none';
                         if (spinBtn) spinBtn.style.display = 'none';
                         if (settingsBtn) settingsBtn.style.display = 'none';

                     }

                     console.log(`UI updated.`);
                 }
            } else {
                console.warn(`RT Listener: User node ${userId} no longer exists.`);
                if (coinListenerUnsubscribe) { coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
                signOut(auth).catch(e => console.error("Sign out error on missing node:", e));
            }
         }, (error) => {
             console.error("Firebase user data listener error:", error); showStatusMessage("Data sync error.", "error");
             if (coinListenerUnsubscribe) { coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
         });
     }

    function updateCoinPkrDisplay() {
        if (menuCoinCountSpan) menuCoinCountSpan.innerText = totalCoins;
        if (menuPkrCountSpan) menuPkrCountSpan.innerText = totalPKR;
    }

    function formatPlayTime(minutes) {
        if (minutes === 0) return "0 min";
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        let timeString = "";
        if (hours > 0) timeString += `${hours} hr `;
        if (remainingMinutes > 0 || hours === 0) timeString += `${remainingMinutes} min`;
        return timeString.trim();
    }

     function formatTimestamp(timestamp) {
         if (!timestamp) return "N/A";
         try {
              const date = new Date(timestamp);
              if (isNaN(date)) return "Invalid Date";
              return date.toLocaleString();
         } catch (e) {
              console.error("Error formatting timestamp:", e);
              return "Error";
         }
     }


    // --- Reset & Load Data ---
    function resetAppStateToLoggedOut() {
        console.log("Resetting app state to logged-out...");
        if (coinListenerUnsubscribe) { coinListenerUnsubscribe(); coinListenerUnsubscribe = null; }
        totalCoins = 0; totalPKR = 0; hasWithdrawnOneTime = {};
        userPurchasedCharacters = ["default_mario"];
        totalSpinCoinsEarned = 0; totalSpinPkrEarned = 0; totalPlayTimeMinutes = 0; totalCoinsSwapped = 0; lastActiveTimestamp = 0;
        currentUserInviteCode = null; currentUsername = null; currentReferralCount = 0; currentJoinedDate = null;
        spinsLeft = 0; lastSpinTime = 0;
        gameStarted = false; gameOver = false; score = 0; if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null;
        stopBackgroundMusic();
        updateCoinPkrDisplay();
        if (finalTotalCoinsSpan) finalTotalCoinsSpan.innerText = "0";
        if (finalTotalPkrSpan) finalTotalPkrSpan.innerText = "0";
        if (sessionCoinCountSpan) sessionCoinCountSpan.innerText = "0";
        updateInviteButtonText(0); if (yourInviteLinkDisplay) yourInviteLinkDisplay.textContent = "N/A (Log in)";
        if (profileUsernameSpan) profileUsernameSpan.textContent = "..."; if (profileEmailSpan) profileEmailSpan.textContent = "...";
        if (profileTotalCoinsSpan) profileTotalCoinsSpan.textContent = "0";
        if (profileTotalPkrSpan) profileTotalPkrSpan.textContent = "0";
        if (profileReferralCountSpan) profileReferralCountSpan.textContent = "0";
        if (profileTotalPlayTimeSpan) profileTotalPlayTimeSpan.textContent = "...";
        if (profileTotalSpinCoinsSpan) profileTotalSpinCoinsSpan.textContent = "0";
        if (profileTotalSpinPkrSpan) profileTotalSpinPkrSpan.textContent = "0";
        if (profileTotalCoinsSwappedSpan) profileTotalCoinsSwappedSpan.textContent = "0";
        if (profileLastActiveSpan) profileLastActiveSpan.textContent = "...";
        if (profileInviteCodeSpan) profileInviteCodeSpan.textContent = "..."; if (profileJoinedDateSpan) profileJoinedDateSpan.textContent = "...";
        mario = null; obstacles = []; coins = []; isProcessingAuth = false;
        updateSpinUI();
        updateSwapModalState();
        updateWithdrawalOptionStates();
        if (transactionsListDiv) transactionsListDiv.innerHTML = '<p class="no-transactions">Log in to see transactions.</p>';


        mainMenu.style.display = 'none';
        gameCanvas.style.display = 'none';
        gameOverMenu.style.display = 'none';
        completeProfileModal.style.display = 'none';
        settingsModal.style.display = "none";
        profileModal.style.display = "none";
        inviteModal.style.display = "none";
        withdrawModal.style.display = "none";
        infoModal.style.display = "none";
        withdrawalHistoryModal.style.display = "none";
        spinWheelModal.style.display = 'none';
        swapModal.style.display = 'none';
        gameTransactionsModal.style.display = 'none';
        characterSelectionModal.style.display = 'none';
        topRightStatusContainer.style.display = 'none';
        if (whatsappBtn) whatsappBtn.style.display = 'none';
        if (spinBtn) spinBtn.style.display = 'none';
        if (settingsBtn) settingsBtn.style.display = 'none';


        console.log("App state reset complete.");
    }

    function loadUserData(userId) {
       return new Promise((resolve, reject) => {
           if (!userId) {
               console.error("loadUserData: No userId.");
               showStatusMessage("Cannot load data.", "error");
               return reject(new Error("No userId provided"));
           }
           console.log(`Loading data for: ${userId}`);
           const userRef = ref(db, `users/${userId}`);
           get(userRef).then(snapshot => {
               if (snapshot.exists()) {
                   const userData = snapshot.val();
                   console.log("User data fetched:", userData);
                   totalCoins = userData.totalCoins || 0;
                   totalPKR = userData.totalPKR || 0;
                   currentUsername = userData.username || 'Gamer';
                   currentReferralCount = userData.referralCount || 0;
                   currentUserInviteCode = userData.inviteCode;
                   spinsLeft = userData.spinsLeft ?? 0;
                   hasWithdrawnOneTime = userData.hasWithdrawnOneTime ?? {};
                   userPurchasedCharacters = userData.purchasedCharacters ?? ["default_mario"];
                   lastSpinTime = (userData.lastSpinTime && typeof userData.lastSpinTime === 'object' && typeof userData.lastSpinTime.seconds === 'number')
                       ? userData.lastSpinTime.seconds * 1000 + (userData.lastSpinTime.nanoseconds || 0) / 1000000
                       : userData.lastSpinTime || 0;

                   totalSpinCoinsEarned = userData.totalSpinCoinsEarned ?? 0;
                   totalSpinPkrEarned = userData.totalSpinPkrEarned ?? 0;
                   totalPlayTimeMinutes = userData.totalPlayTimeMinutes ?? 0;
                   totalCoinsSwapped = userData.totalCoinsSwapped ?? 0;
                    lastActiveTimestamp = (userData.lastActiveTimestamp && typeof userData.lastActiveTimestamp === 'object' && typeof userData.lastActiveTimestamp.seconds === 'number')
                        ? userData.lastActiveTimestamp.seconds * 1000 + (userData.lastActiveTimestamp.nanoseconds || 0) / 1000000
                        : userData.lastActiveTimestamp || 0;


                   if (userData.createdAt) {
                       if (typeof userData.createdAt === 'number') {
                           try { currentJoinedDate = new Date(userData.createdAt).toLocaleDateString(); }
                           catch (e) { console.warn("Error parsing numeric timestamp:", e); currentJoinedDate = "N/A"; }
                       } else if (typeof userData.createdAt === 'object' && userData.createdAt.seconds) {
                           try { currentJoinedDate = new Date(userData.createdAt.seconds * 1000).toLocaleDateString(); }
                           catch (e) { console.warn("Error parsing timestamp object:", e); currentJoinedDate = "N/A"; }
                       } else {
                           console.warn("Unrecognized createdAt format:", userData.createdAt); currentJoinedDate = "N/A";
                       }
                   } else { currentJoinedDate = "N/A"; }

                   updateCoinPkrDisplay();
                   updateInviteButtonText(currentReferralCount);
                   updateInviteLinkDisplay();
                   updateWithdrawalOptionStates();
                   updateSpinUI();
                   updateSwapModalState();


                   if (!currentUserInviteCode && auth.currentUser?.uid === userId) {
                        console.log("Generating invite code...");
                        const newCode = generateRandomCode();
                        set(ref(db, `users/${userId}/inviteCode`), newCode)
                           .then(() => {
                               console.log("New invite code saved:", newCode);
                               currentUserInviteCode = newCode;
                               updateInviteLinkDisplay();
                               if (profileModal.style.display === 'flex') profileInviteCodeSpan.textContent = newCode;
                               resolve();
                           })
                           .catch(e => {
                               console.error("Error saving invite code:", e);
                               if(yourInviteLinkDisplay) yourInviteLinkDisplay.textContent = "Error";
                               resolve();
                           });
                   } else {
                       resolve();
                   }
               } else {
                   console.error(`CRITICAL: User node missing: ${userId}. Logging out.`);
                   showStatusMessage("Profile data missing! Logging out.", "error", 5000);
                   signOut(auth).catch(e => console.error("Sign out error on missing node:", e));
                   reject(new Error(`User node missing: ${userId}`));
               }
           }).catch(error => {
               console.error("Error fetching user data:", error);
               showStatusMessage("Failed to load user data.", "error");
               reject(error);
           });
       });
    }

    function checkUrlForReferral() {
        try {
            const urlParams = new URLSearchParams(window.location.search); const refCode = urlParams.get('ref');
            if (refCode) { const cleanCode = refCode.trim().toUpperCase(); console.log("URL Referral code:", cleanCode); if (auth.currentUser && redeemCodeInput) { redeemCodeInput.value = cleanCode; console.log("Referral code pre-filled."); showStatusMessage(`Ready to redeem code: ${cleanCode}?`, "info", 4000); } const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname; window.history.replaceState({path:cleanUrl},'',cleanUrl); console.log("Cleaned URL."); }
        } catch (e) { console.error("Error processing URL params:", e); }
    }

    // --- UI Update & View Navigation ---
    function updateInviteButtonText(count) { inviteFriendBtn.innerText = `Invite (${count || 0} Refs)`; }
    function updateSoundButton() {
        toggleSoundBtn.textContent=`Sound: ${soundEnabled?'On':'Off'}`;
        const onGradient="linear-gradient(145deg, #4caf50, #388e3c)";
        const offGradient="linear-gradient(145deg, #9e9e9e, #757575)";
        const onBorder='#1b5e20';
        const offBorder='#424242';
        toggleSoundBtn.style.background=soundEnabled?onGradient:offGradient;
        toggleSoundBtn.style.borderBottomColor=soundEnabled?onBorder:offBorder;
    }
    function updateInviteLinkDisplay() { if (yourInviteLinkDisplay) { if (currentUserInviteCode && auth.currentUser) yourInviteLinkDisplay.textContent = `${baseInviteUrl}?ref=${currentUserInviteCode}`; else if (auth.currentUser) yourInviteLinkDisplay.textContent = "Generating link..."; else yourInviteLinkDisplay.textContent = "Log in to get your invite link"; } if (profileInviteCodeSpan && profileModal.style.display === 'flex') profileInviteCodeSpan.textContent = currentUserInviteCode || '...'; }

    function showMainMenu() {
        console.log("Showing Main Menu...");
        gameStarted = false; gameOver = false; if (animationFrameId) cancelAnimationFrame(animationFrameId);
        stopBackgroundMusic();

        hideAllViewsAndModalsExcept(mainMenu);

        mainMenu.style.display = "flex";

        const user = auth.currentUser;
        if (user && currentUsername) {
             console.log("User logged in, showing full menu.");
             logoutBtn.style.display = 'inline-flex';
             withdrawBtn.style.display = 'inline-flex';
             inviteFriendBtn.style.display = 'inline-flex';
             settingsBtn.style.display = 'flex';
             topRightStatusContainer.style.display = 'flex';
             if (deferredInstallPrompt) {
                installPwaBtn.style.display = 'inline-flex';
                pwaInstallBanner.style.display = 'flex';
             }

             updateCoinPkrDisplay();
             updateInviteButtonText(currentReferralCount);
             updateInviteLinkDisplay();
             updateWithdrawalOptionStates();
             updateSpinUI();
             updateSwapModalState();
             if (whatsappBtn) whatsappBtn.style.display = 'flex';
             if (spinBtn) spinBtn.style.display = 'flex';

             const userRef = ref(db, `users/${user.uid}`);
             update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on menu show:", e));

        } else {
             console.log("Guest/Incomplete profile, showing limited menu.");
             logoutBtn.style.display = 'none';
             withdrawBtn.style.display = 'none';
             inviteFriendBtn.style.display = 'none';
             settingsBtn.style.display = 'none';
             topRightStatusContainer.style.display = 'none';
             if (installPwaBtn) installPwaBtn.style.display = 'none';

             updateCoinPkrDisplay();
             updateInviteButtonText(0);
             updateInviteLinkDisplay();
             updateWithdrawalOptionStates();
             if (whatsappBtn) whatsappBtn.style.display = 'flex';
             if (spinBtn) spinBtn.style.display = 'flex';
        }

        playBackgroundMusic();
        console.log("showMainMenu finished.");
    }

    function showGameOverMenu() {
        console.log("Showing Game Over Menu"); gameStarted = false; gameOver = true;
        if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }

        const user = auth.currentUser;
        if (user && currentUsername && gameStartTime > 0) {
            const userRef = ref(db, `users/${user.uid}`);

             get(userRef).then(snap => {
                 if (!snap.exists()) {
                     console.error("User data missing on game over! Cannot save score.");
                     showStatusMessage("Error saving game data.", "error");
                 } else {
                     const currentData = snap.val();
                     const currentTotalCoins = currentData.totalCoins ?? 0;
                     const currentTotalPlayTimeMinutes = currentData.totalPlayTimeMinutes ?? 0;

                     const sessionDurationMs = gameStartTime > 0 ? Date.now() - gameStartTime : 0;
                     const sessionDurationMinutes = Math.max(0, Math.floor(sessionDurationMs / (1000 * 60)));

                     const newTotalCoins = currentTotalCoins + score;
                     const newTotalPlayTimeMinutes = currentTotalPlayTimeMinutes + sessionDurationMinutes;

                     const updates = {};
                     updates[`/users/${user.uid}/totalCoins`] = newTotalCoins;
                     updates[`/users/${user.uid}/totalPlayTimeMinutes`] = newTotalPlayTimeMinutes;
                     updates[`/users/${user.uid}/lastActiveTimestamp`] = serverTimestamp();


                     console.log(`Saving game over data: Score=${score}, Session Time=${sessionDurationMinutes}min, Total Time=${newTotalPlayTimeMinutes}min`);

                     totalCoins = newTotalCoins;
                     totalPlayTimeMinutes = newTotalPlayTimeMinutes;

                     const newTransactionRef = push(ref(db, `users/${user.uid}/transactions`));
                     updates[`/users/${user.uid}/transactions/${newTransactionRef.key}`] = {
                         type: 'game_score',
                         amount: score,
                         timestamp: serverTimestamp(),
                         details: `Game Score: ${score} Coins`
                     };


                     update(ref(db), updates)
                        .then(() => console.log(`Game over data and transaction submitted for UID: ${user.uid}`))
                        .catch(e => { console.error("Error saving game over data/transaction:", e); showStatusMessage("Error saving game data.", "error"); });
                 }
                  gameStartTime = 0;

             }).catch(e => {
                 console.error("Error fetching user data on game over:", e);
                 showStatusMessage("Error saving game data.", "error");
                  gameStartTime = 0;
             });

        } else { console.log("Guest or incomplete profile, game data not saved.");
             gameStartTime = 0;
        }


        sessionCoinCountSpan.innerText = score;
        finalTotalCoinsSpan.innerText = auth.currentUser ? totalCoins : 0;
        finalTotalPkrSpan.innerText = auth.currentUser ? totalPKR : 0;

        hideAllViewsAndModalsExcept(gameOverMenu);
        gameOverMenu.style.display="flex";

        if (whatsappBtn) whatsappBtn.style.display = 'flex';
        if (spinBtn) spinBtn.style.display = 'flex';
        topRightStatusContainer.style.display = 'none';
        if (settingsBtn) settingsBtn.style.display = 'none';


        stopBackgroundMusic();
        playSound(gameOverSound);
        console.log("Game Over Menu shown.");
    }

    // --- Settings & Profile Modals ---
    settingsBtn.addEventListener("click", () => { if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "info"); return; } updateSoundButton(); hideAllViewsAndModalsExcept(settingsModal); settingsModal.style.display = "flex"; });
    closeSettings.addEventListener("click", () => { settingsModal.style.display = "none"; showMainMenu(); });
    toggleSoundBtn.addEventListener("click", () => { soundEnabled = !soundEnabled; updateSoundButton(); if (!soundEnabled) stopBackgroundMusic(); else if (mainMenu.style.display==='flex'||(gameStarted&&!gameOver)) playBackgroundMusic(); showStatusMessage(`Sound ${soundEnabled ? 'On' : 'Off'}`, 'info', 1500); });
    customerService.addEventListener("click", () => { window.open("https://wa.me/923019022815", "_blank"); });
    profileBtn.addEventListener('click', showProfileModal);
    closeProfileModalBtn.addEventListener('click', () => { profileModal.style.display = 'none'; showMainMenu(); });

    function showProfileModal() {
        const user = auth.currentUser;
        if (!user || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; }

        profileUsernameSpan.textContent = currentUsername || '...';
        profileEmailSpan.textContent = user.email || 'N/A';
        profileTotalCoinsSpan.textContent = totalCoins;
        profileTotalPkrSpan.textContent = totalPKR;
        profileReferralCountSpan.textContent = currentReferralCount;
        profileInviteCodeSpan.textContent = currentUserInviteCode || '...';
        profileJoinedDateSpan.textContent = currentJoinedDate || '...';

        profileTotalPlayTimeSpan.textContent = formatPlayTime(totalPlayTimeMinutes);
        profileTotalSpinCoinsSpan.textContent = totalSpinCoinsEarned;
        profileTotalSpinPkrSpan.textContent = totalSpinPkrEarned;
        profileTotalCoinsSwappedSpan.textContent = totalCoinsSwapped;
        profileLastActiveSpan.textContent = formatTimestamp(lastActiveTimestamp);

         const userRef = ref(db, `users/${user.uid}`);
         update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on profile show:", e));


        hideAllViewsAndModalsExcept(profileModal);
        profileModal.style.display = 'flex';
    }

    // --- Game Transactions Modal ---
    gameTransactionsBtn.addEventListener('click', showGameTransactions);
    closeTransactionsModalBtn.addEventListener('click', () => { gameTransactionsModal.style.display = 'none'; showMainMenu(); });

    async function showGameTransactions() {
         const user = auth.currentUser;
         if (!user) {
             showStatusMessage("Log in first.", "error");
             return;
         }
         if (isProcessingAuth) return;

         transactionsListDiv.innerHTML = '<p class="no-transactions">Loading...</p>';
         hideAllViewsAndModalsExcept(gameTransactionsModal);
         gameTransactionsModal.style.display = 'flex';

         const userRef = ref(db, `users/${user.uid}`);
         update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on transactions show:", e));


         console.log(`Fetching transaction history for UID: ${user.uid}. Ensure Firebase rules allow read and '.indexOn': ['timestamp'] is set for 'users/$uid/transactions'.`);

         try {
             const transactionsRef = ref(db, `users/${user.uid}/transactions`);
             const q = query(transactionsRef, orderByChild('timestamp'));

             const snapshot = await get(q);

             transactionsListDiv.innerHTML = '';

             if (snapshot.empty) {
                 console.log("Query for transactions returned no documents.");
                 transactionsListDiv.innerHTML = '<p class="no-transactions">No transaction history found.</p>';
             } else {
                 console.log(`Transaction history query returned ${snapshot.size} document(s).`);
                 try {
                     const data = [];
                     snapshot.forEach(childSnapshot => {
                         const itemData = childSnapshot.val();
                         if (typeof itemData === 'object' && itemData !== null && itemData.timestamp) {
                              data.push({ key: childSnapshot.key, ...itemData });
                         } else {
                              console.warn("Encountered invalid transaction data for key:", childSnapshot.key, itemData);
                         }
                     });

                     data.sort((a, b) => {
                         const tA = (typeof a.timestamp === 'object' && a.timestamp && typeof a.timestamp.seconds === 'number') ? (a.timestamp.seconds * 1000 + (a.timestamp.nanoseconds || 0) / 1000000) : (typeof a.timestamp === 'number' ? a.timestamp : 0);
                         const tB = (typeof b.timestamp === 'object' && b.timestamp && typeof b.timestamp.seconds === 'number') ? (b.timestamp.seconds * 1000 + (b.timestamp.nanoseconds || 0) / 1000000) : (typeof b.timestamp === 'number' ? b.timestamp : 0);
                         return tB - tA;
                     });
                     console.log("Processed and sorted transaction data:", data);


                     if (data.length === 0) {
                          transactionsListDiv.innerHTML = '<p class="no-transactions">No valid transaction items to display after processing.</p>';
                     } else {
                         data.forEach(item => {
                             const itemDiv = document.createElement('div');
                             itemDiv.classList.add('transaction-item');

                             let date = null;
                             if (item.timestamp) {
                                 if (typeof item.timestamp === 'object' && item.timestamp && typeof item.timestamp.seconds === 'number') {
                                     date = new Date(item.timestamp.seconds * 1000 + (item.timestamp.nanoseconds || 0) / 1000000);
                                 } else if (typeof item.timestamp === 'number') {
                                     date = new Date(item.timestamp);
                                 }
                             }
                             const fDate = date ? date.toLocaleString() : 'N/A';

                              let amountText = `${item.amount || 0} ${item.type.includes('pkr') ? 'Rs' : 'Coins'}`;
                              if (item.type === 'swap_coins' && item.pkr_added !== undefined) {
                                  amountText = `${item.amount || 0} Coins -> ${item.pkr_added || 0} Rs`;
                              }


                             itemDiv.innerHTML = `
 <div class="details">
     <strong>${item.details || item.type}:</strong> <span>${amountText}</span>
 </div>
 <div class="meta">
     <span class="type type-${item.type}">${item.type.replace('_', ' ')}</span>
     <span class="date">${fDate}</span>
 </div>`;
                             transactionsListDiv.appendChild(itemDiv);
                         });
                     }
                 } catch (processingError) {
                     console.error("Error processing transaction history data:", processingError);
                     transactionsListDiv.innerHTML = '<p class="no-transactions" style="color: red;">Error processing history data. Check console.</p>';
                     showStatusMessage("Error displaying transactions.", "error");
                 }
             }

         } catch (fetchError) {
             console.error("Error fetching transaction history:", fetchError);
              transactionsListDiv.innerHTML = '<p class="no-transactions" style="color: red;">Error loading history.</p><p class="no-transactions" style="font-size:0.9em; color:orange;">(This might require correcting database rules or indexing in Firebase console. Check the browser console for technical details.)</p>';
             showStatusMessage("Could not load transaction history.", "error");
         }
    }

    // --- Withdrawal History ---
    withdrawalHistoryBtn.addEventListener('click', showWithdrawalHistory);
    closeHistoryModalBtn.addEventListener('click', () => { withdrawalHistoryModal.style.display = 'none'; showMainMenu(); });

    async function showWithdrawalHistory() {
        const user = auth.currentUser;
        if (!user) {
            showStatusMessage("Log in first.", "error");
            return;
        }
        historyListDiv.innerHTML = '<p class="no-history">Loading...</p>';
        hideAllViewsAndModalsExcept(withdrawalHistoryModal);
        withdrawalHistoryModal.style.display = 'flex';
        console.log(`Fetching withdrawal history for UID: ${user.uid}. Ensure Firebase rules allow read and '.indexOn': ['uid'] is set for 'withdrawRequests'.`);

         const userRef = ref(db, `users/${user.uid}`);
         update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on history show:", e));


        try {
            const reqRef = ref(db, 'withdrawRequests');
            const q = query(reqRef, orderByChild('uid'), equalTo(user.uid));
            const snapshot = await get(q);

            historyListDiv.innerHTML = '';

            if (snapshot.empty) {
                console.log("Query for withdrawal history returned no documents.");
                historyListDiv.innerHTML = '<p class="no-history">No withdrawal history found.</p>';
            } else {
                console.log(`Withdrawal history query returned ${snapshot.size} document(s).`);
                try {
                    const data = [];
                    snapshot.forEach(childSnapshot => {
                        const itemData = childSnapshot.val();
                        if (typeof itemData === 'object' && itemData !== null) {
                             if (itemData.pkrAmount === undefined && itemData.withdrawalAmountCoins !== undefined) {
                                 itemData.pkrAmount = itemData.withdrawalAmountCoins / gameConfig.coinToPkrRate;
                             }
                            data.push({ key: childSnapshot.key, ...itemData });
                        } else {
                            console.warn("Encountered non-object value in withdrawal history for doc ID:", childSnapshot.key, itemData);
                        }
                    });

                    data.sort((a, b) => {
                        const tA = (typeof a.timestamp === 'object' && a.timestamp && typeof a.timestamp.seconds === 'number') ? (a.timestamp.seconds * 1000 + (a.timestamp.nanoseconds || 0) / 1000000) : (typeof a.timestamp === 'number' ? a.timestamp : 0);
                        const tB = (typeof b.timestamp === 'object' && b.timestamp && typeof b.timestamp.seconds === 'number') ? (b.timestamp.seconds * 1000 + (b.timestamp.nanoseconds || 0) / 1000000) : (typeof b.timestamp === 'number' ? b.timestamp : 0);
                        return tB - tA;
                    });
                    console.log("Processed and sorted history data:", data);


                    if (data.length === 0) {
                        historyListDiv.innerHTML = '<p class="no-history">No valid history items to display after processing.</p>';
                    } else {
                        data.forEach(item => {
                            const itemDiv = document.createElement('div');
                            itemDiv.classList.add('history-item');

                            let date = null;
                            if (item.timestamp) {
                                if (typeof item.timestamp === 'object' && item.timestamp && typeof item.timestamp.seconds === 'number') {
                                    date = new Date(item.timestamp.seconds * 1000 + (item.timestamp.nanoseconds || 0) / 1000000);
                                } else if (typeof item.timestamp === 'number') {
                                    date = new Date(item.timestamp);
                                }
                            }
                            const fDate = date ? date.toLocaleString() : 'N/A';
                            const status = (item.status || 'pending').toLowerCase();
                            let sClass = 'status-pending';
                            if (status === 'approved') sClass = 'status-approved';
                            else if (status === 'rejected') sClass = 'status-rejected';

                            const pkrAmount = item.pkrAmount !== undefined ? item.pkrAmount : (item.withdrawalAmountCoins !== undefined ? item.withdrawalAmountCoins / gameConfig.coinToPkrRate : '?');
                            const coinsAmount = item.withdrawalAmountCoins !== undefined ? item.withdrawalAmountCoins : '?';

                            itemDiv.innerHTML = `
<div class="details">
    <span>${pkrAmount} Rs (${coinsAmount} Coins)</span>
    <span>Method: ${item.paymentMethod || 'N/A'}</span>
    <span>Acc: ${item.accountNumber || 'N/A'} (${item.accountHolderName || 'N/A'})</span>
</div>
<div class="status ${sClass}">${status}</div>
<div class="date">${fDate}</div>`;
                            historyListDiv.appendChild(itemDiv);
                        });
                    }
                } catch (processingError) {
                    console.error("Error processing withdrawal history data:", processingError);
                    historyListDiv.innerHTML = '<p class="no-history" style="color: red;">Error processing history data. Check console.</p>';
                    showStatusMessage("Error displaying history.", "error");
                }
            }
        } catch (fetchError) {
            console.error("Error fetching withdrawal history:", fetchError);
            historyListDiv.innerHTML = '<p class="no-history" style="color: red;">Error loading history.</p><p class="no-history" style="font-size:0.9em; color:orange;">(This might require correcting database rules or indexing in Firebase console. Check the browser console for technical details.)</p>';
            showStatusMessage("Could not load withdrawal history.", "error");
        }
    }


    // --- Invite Logic ---
    function generateRandomCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
    async function redeemInviteCode(code, currentUserId, currentUserData) {
        console.log(`Redeeming: ${code} by ${currentUserId}`);
        if (!currentUserId) throw new Error("User ID missing.");
        if (!code) throw new Error("Enter code.");
        code = code.trim().toUpperCase();
        if (currentUserData?.inviteCode && code === currentUserData.inviteCode) throw new Error("Cannot redeem own code.");
        if (currentUserData?.referralRedeemed === true) throw new Error("Already redeemed code.");

        const usersRef = ref(db, "users");
        const q = query(usersRef, orderByChild("inviteCode"), equalTo(code));
        const snap = await get(q);

        if (!snap.exists()) throw new Error("Invalid code.");

        let refUid = null, refData = null;
        snap.forEach(childSnapshot => {
             const data = childSnapshot.val();
             if (childSnapshot.key !== currentUserId && data && data.username) {
                 refUid = childSnapshot.key;
                 refData = data;
             } else if (childSnapshot.key === currentUserId) {
                 console.warn("Query found self-match for invite code.");
             } else {
                 console.warn("Found code but user profile is incomplete/invalid:", childSnapshot.key);
             }
         });

        if (!refUid || !refData) throw new Error("Invalid code.");

        console.log(`Found referrer: ${refUid}`);
         const referrerRef = ref(db, `users/${refUid}`);
         const referrerSnap = await get(referrerRef);
         if (!referrerSnap.exists()) {
              console.error("Referrer data missing during redemption!");
              throw new Error("Referrer profile error.");
         }
         const latestReferrerData = referrerSnap.val();
         const latestRefRefCount = latestReferrerData.referralCount || 0;
         const latestRefCoins = latestReferrerData.totalCoins || 0;


        const redeemUserCoins = currentUserData.totalCoins || 0;
        const newRedeemerTotal = redeemUserCoins + REDEEMER_BONUS;

        const newReferrerTotal = latestRefCoins + REFERRER_BONUS;
        const newReferrerCount = latestRefRefCount + 1;


        console.log(`Bonuses: Redeemer +${REDEEMER_BONUS}, Referrer +${REFERRER_BONUS}`);

        const updates = {};
        updates[`/users/${currentUserId}/totalCoins`] = newRedeemerTotal;
        updates[`/users/${currentUserId}/referralRedeemed`] = true;
        updates[`/users/${currentUserId}/codeRedeemedFrom`] = refUid;
        updates[`/users/${currentUserId}/lastActiveTimestamp`] = serverTimestamp();

        const newRedeemerTransactionRef = push(ref(db, `users/${currentUserId}/transactions`));
        updates[`/users/${currentUserId}/transactions/${newRedeemerTransactionRef.key}`] = {
             type: 'referral_bonus',
             amount: REDEEMER_BONUS,
             timestamp: serverTimestamp(),
             details: `Referral bonus from code: ${code}`
        };

        updates[`/users/${refUid}/totalCoins`] = newReferrerTotal;
        updates[`/users/${refUid}/referralCount`] = newReferrerCount;

         const newReferrerTransactionRef = push(ref(db, `users/${refUid}/transactions`));
         updates[`/users/${refUid}/transactions/${newReferrerTransactionRef.key}`] = {
              type: 'referrer_bonus',
              amount: REFERRER_BONUS,
              timestamp: serverTimestamp(),
              details: `Referrer bonus from user: ${currentUserData?.username || currentUserId}`
         };


        await update(ref(db), updates);
        console.log("DB updated for referral redemption.");

        return { newCoinsForRedeemer: newRedeemerTotal, referrerUid: refUid };
     }


    inviteFriendBtn.addEventListener("click", () => {
        if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; }
        if (isProcessingAuth) return;
        updateInviteLinkDisplay();

         const userRef = ref(db, `users/${auth.currentUser.uid}`);
         update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on invite show:", e));


        showInterstitialAd(() => { console.log("Ad callback: Showing invite modal."); hideAllViewsAndModalsExcept(inviteModal); inviteModal.style.display = "flex"; });
    });
    closeInviteModal.addEventListener("click", () => { inviteModal.style.display = "none"; showMainMenu(); });
    copyInviteCode.addEventListener("click", () => {
        const link = yourInviteLinkDisplay.textContent;
        if (link && link.startsWith('http') && currentUserInviteCode) {
            navigator.clipboard.writeText(link).then(() => showStatusMessage("Link copied!", "success")).catch(err => {
                showStatusMessage("Failed to copy.", "error"); console.error('Copy error:', err);
                try { const r=document.createRange(); r.selectNodeContents(yourInviteLinkDisplay); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); showStatusMessage("Link selected, copy manually.", "info", 4000); } catch (e) { console.error("Select fallback fail:", e); }
            });

             const userRef = ref(db, `users/${auth.currentUser.uid}`);
             update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on copy link:", e));


        } else { showStatusMessage("Link not ready.", "error"); console.warn("Invalid link copy attempt:", link); }
    });
    redeemCodeBtn.addEventListener("click", async () => {
        const code = redeemCodeInput.value.trim().toUpperCase();
        if (!code) { showStatusMessage("Enter code.", "error"); return; }
        const user = auth.currentUser;
        if (!user || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; }
        if (isProcessingAuth) return;
        redeemCodeBtn.disabled = true; showStatusMessage("Redeeming...", "info");

         const userRef = ref(db, `users/${user.uid}`);
         update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on redeem attempt:", e));


        try {
            const snap = await get(userRef);
            if (!snap.exists()) throw new Error("User data not found.");
            const userData = snap.val();

            const { newCoinsForRedeemer, referrerUid } = await redeemInviteCode(code, user.uid, userData);

            console.log(`User ${user.uid} redeemed from ${referrerUid}`);
            showStatusMessage(`Code redeemed! +${REDEEMER_BONUS} coins.`, "success", 5000);
            inviteModal.style.display = "none";
            redeemCodeInput.value = "";
            showMainMenu();

        } catch (e) {
            console.error("Redeem error:", e);
            let displayMessage = "Redemption failed.";
            if (e.message === "Invalid code.") displayMessage = "Invalid referral code.";
            else if (e.message === "Cannot redeem own code.") displayMessage = "Cannot redeem your own code.";
            else if (e.message === "Already redeemed code.") displayMessage = "You have already redeemed a code.";
            else if (e.message === "Referrer profile error.") displayMessage = "Referrer profile issue.";
            else displayMessage = "Error: " + e.message;


            showStatusMessage(displayMessage, "error", 4000);

        } finally { redeemCodeBtn.disabled = false; }
    });

    // --- Withdraw Logic ---
    let selectedWithdrawOptionId = null;

    function updateWithdrawalOptionStates() {
        const user = auth.currentUser;
        const isLoggedInAndProfileComplete = user && currentUsername;
        
        redeemOptionsDiv.innerHTML = ''; // Clear existing options

        for (const optionId in gameConfig.withdrawalOptions) {
            const option = gameConfig.withdrawalOptions[optionId];
            const button = document.createElement('button');
            button.classList.add('redeem-option');
            button.dataset.optionId = optionId;
            button.textContent = option.text;
            
            let isDisabled = false;
            let title = "";

            if (!isLoggedInAndProfileComplete) {
                isDisabled = true;
                title = "Log in & complete profile to withdraw.";
            } else if (option.isOneTime && hasWithdrawnOneTime[optionId]) {
                isDisabled = true;
                button.classList.add('redeemed-once');
                title = "This one-time option has already been used.";
            } else if (totalCoins < option.coins) {
                isDisabled = true;
                title = `Need ${option.coins - totalCoins} more coins`;
                if (currentReferralCount < option.referralsNeeded) {
                    title += ` and ${option.referralsNeeded - currentReferralCount} more refs (${currentReferralCount}/${option.referralsNeeded})`;
                }
            } else if (currentReferralCount < option.referralsNeeded) {
                isDisabled = true;
                title = `Need ${option.referralsNeeded - currentReferralCount} more refs (${currentReferralCount}/${option.referralsNeeded})`;
            } else {
                button.classList.add('available-option');
                title = `Meets requirements: ${option.coins} coins & ${option.referralsNeeded} refs`;
            }

            button.disabled = isDisabled;
            button.title = title;
            redeemOptionsDiv.appendChild(button);
        }

        redeemOptionsDiv.querySelectorAll('.redeem-option').forEach(button => {
            button.addEventListener('click', () => {
                if (button.disabled) {
                    showStatusMessage(button.title || "Requirements not met.", "error", 4000);
                    return;
                }
                
                selectedWithdrawOptionId = button.dataset.optionId;
                const selectedOption = gameConfig.withdrawalOptions[selectedWithdrawOptionId];

                referralTaskDisplay.className = 'referralTaskDisplay task-complete';
                referralTaskDisplay.innerHTML = `<strong>Task:</strong> Invite ${selectedOption.referralsNeeded} friends <span class="status-icon">✔</span><br>(Completed: ${currentReferralCount}/${selectedOption.referralsNeeded} referrals)`;

                redeemOptionsDiv.style.display='none';
                redeemFormDiv.style.display='block';
                redeemFormDiv.querySelector('h3').textContent = `Redeem ${selectedOption.coins} Coins for ${selectedOption.pkr} Rs`;
            });
        });
    }


    withdrawBtn.addEventListener("click", () => {
        if (!auth.currentUser || !currentUsername) { showStatusMessage("Log in & complete profile.", "error"); return; }
        if (isProcessingAuth) return;

         const userRef = ref(db, `users/${auth.currentUser.uid}`);
         update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on withdraw show:", e));

        showInterstitialAd(() => {
            console.log("Ad callback: Showing Withdraw modal.");
            updateWithdrawalOptionStates();
            redeemOptionsDiv.style.display="block"; redeemFormDiv.style.display="none";
            referralTaskDisplay.innerHTML = "";
            referralTaskDisplay.className = 'referralTaskDisplay';
            redeemDetailsForm.reset();
            accountHolderName.value = "";
            accountNumber.value = "";
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => radio.checked = false);
            redeemSubmitBtn.disabled=false;
            redeemSubmitBtn.textContent="Submit Request";
            hideAllViewsAndModalsExcept(withdrawModal);
            withdrawModal.style.display="flex";
        });
    });
    closeWithdraw.addEventListener("click", () => { withdrawModal.style.display = "none"; showMainMenu(); });


    redeemDetailsForm.addEventListener('submit', (e) => {
         e.preventDefault();
         const selectedOption = gameConfig.withdrawalOptions[selectedWithdrawOptionId];
         if (!selectedOption) {
             showStatusMessage("Error: No withdrawal option selected.", "error");
             return;
         }

         if (currentReferralCount < selectedOption.referralsNeeded) {
             showStatusMessage(`Referral task incomplete! Need ${selectedOption.referralsNeeded - currentReferralCount} more friends.`, "error", 5000);
             return;
         }

         const name = accountHolderName.value.trim();
         const number = accountNumber.value.trim();
         const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked');

         if(!name || !number || !paymentMethodInput){ showStatusMessage("Please fill all details.", "error"); return; }
         if(!/^\d+$/.test(number)) { showStatusMessage("Account number is invalid.", "error"); return; }

         if(totalCoins < selectedOption.coins){ showStatusMessage(`Insufficient coins. Need ${selectedOption.coins} (${totalCoins}).`, "error", 5000); withdrawModal.style.display = "none"; return; }

         const user=auth.currentUser; if(!user){ showStatusMessage("Authentication error.", "error"); withdrawModal.style.display="none"; return; }

         if (selectedOption.isOneTime && hasWithdrawnOneTime[selectedWithdrawOptionId]) {
              showStatusMessage("This one-time option has already been used.", "error", 4000);
              withdrawModal.style.display = "none";
              return;
         }

         const userRef = ref(db, `users/${user.uid}`);
         get(userRef).then(snap => {
             if (!snap.exists()) {
                 showStatusMessage("Error processing request.", "error", 5000);
                 return;
             }
             const currentData = snap.val();
             const currentTotalCoins = currentData.totalCoins ?? 0;
             const currentHasWithdrawnOneTime = currentData.hasWithdrawnOneTime ?? {};

              if (currentTotalCoins < selectedOption.coins) {
                  showStatusMessage(`Insufficient coins. Need ${selectedOption.coins} (${currentTotalCoins}).`, "error", 5000);
                  withdrawModal.style.display = "none";
                  return;
              }
              if (selectedOption.isOneTime && currentHasWithdrawnOneTime[selectedWithdrawOptionId]) {
                   showStatusMessage("This one-time option has already been used.", "error", 4000);
                   withdrawModal.style.display = "none";
                   return;
              }

             const method = paymentMethodInput.value; const timestamp = serverTimestamp();
             const requestData = { uid: user.uid, email: user.email || "N/A", username: currentUsername || "N/A", withdrawalAmountCoins: selectedOption.coins, pkrAmount: selectedOption.pkr, accountHolderName: name, accountNumber: number, paymentMethod: method, status: "pending", referralsAtRequest: currentReferralCount, timestamp: timestamp };

             const updates = {};
             const newTotalCoins = currentTotalCoins - selectedOption.coins;
             const newRequestKey = push(ref(db, 'withdrawRequests')).key;

             updates[`/users/${user.uid}/totalCoins`] = newTotalCoins;
             updates[`/withdrawRequests/${newRequestKey}`] = requestData;
             updates[`/users/${user.uid}/lastActiveTimestamp`] = serverTimestamp();

             if (selectedOption.isOneTime) {
                 updates[`/users/${user.uid}/hasWithdrawnOneTime/${selectedWithdrawOptionId}`] = true;
             }

             update(ref(db), updates).then(() => {
                showStatusMessage(`Request submitted successfully! Status: Pending.`, "success", 5000);
                withdrawModal.style.display = "none";
                showMainMenu();
             }).catch(err => {
                showStatusMessage("Submission failed: "+err.message, "error", 5000);
                console.error("Withdraw submission error:", err);
             });

         }).catch(err => {
              showStatusMessage("Error checking user data.", "error", 5000);
         });
    });
    
    // Event Listener for new "Swap Coins" button in Withdraw modal
    swapCoinsBtnWithdraw.addEventListener('click', () => {
        withdrawModal.style.display = 'none'; // Hide withdraw modal
        const user = auth.currentUser;
        if (!user || !currentUsername) {
             showStatusMessage("Log in & complete profile to swap.", "info");
             return;
        }
        hideAllViewsAndModalsExcept(swapModal); // Hide everything EXCEPT Swap modal
        updateSwapModalState();
        swapModal.style.display = 'flex';
    });


    // --- Info Modal ---
    infoBtn.addEventListener("click", () => {
        const user = auth.currentUser;
        if (user && currentUsername) {
            const userRef = ref(db, `users/${user.uid}`);
            update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on info show:", e));
        }
        if (isProcessingAuth) return;


        showInterstitialAd(() => { console.log("Ad callback: Showing Info modal."); hideAllViewsAndModalsExcept(infoModal); infoModal.style.display = "flex"; });
    });
    closeInfo.addEventListener("click", () => { infoModal.style.display = "none"; showMainMenu(); });

    // --- Logout ---
    logoutBtn.addEventListener("click", () => { console.log("Logout clicked."); if (isProcessingAuth) return; setAuthProcessing(true); showStatusMessage("Logging out...", "info", 1500); signOut(auth).then(() => { console.log("SignOut ok."); showStatusMessage("Logged out.", "info"); }).catch((e) => { showStatusMessage("Logout error: "+e.message, "error"); console.error("Sign out error:", e); setAuthProcessing(false); }); });


    // --- Spin Wheel Logic ---

    function createWheelSegments() {
        wheelSvg.innerHTML = '';
        const radius = 200;
        const centerX = 200;
        const centerY = 200;
        const numSegments = spinWheelRewards.length;
        const degreesPerSegment = 360 / numSegments;


        spinWheelRewards.forEach((reward, index) => {
            const startAngle = index * degreesPerSegment;
            const endAngle = startAngle + degreesPerSegment;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const startAngleRad = startAngle * Math.PI / 180;
            const endAngleRad = endAngle * Math.PI / 180;

            const d = [
                `M ${centerX},${centerY}`,
                `L ${centerX + radius * Math.cos(startAngleRad)},${centerY + radius * Math.sin(startAngleRad)}`,
                `A ${radius},${radius} 0 0,1 ${centerX + radius * Math.cos(endAngleRad)},${centerY + radius * Math.sin(endAngleRad)}`,
                `Z`
            ].join(' ');

            path.setAttribute('d', d);
            path.setAttribute('fill', reward.color);
            path.setAttribute('stroke', '#333');
            path.setAttribute('stroke-width', '1');
            wheelSvg.appendChild(path);

            const angleForText = startAngle + degreesPerSegment / 2;
            const textRadius = radius * 0.75;

            const textGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            textGroup.setAttribute('transform', `rotate(${angleForText}, ${centerX}, ${centerY})`);

            const textEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
            textEl.setAttribute('x', centerX + textRadius);
            textEl.setAttribute('y', centerY);
            textEl.classList.add('wheel-text');
            textEl.textContent = reward.name;

             const textOutline = document.createElementNS("http://www.w3.org/2000/svg", "text");
             textOutline.setAttribute('x', centerX + textRadius);
             textOutline.setAttribute('y', centerY);
             textOutline.classList.add('wheel-text', 'wheel-text-outline');
             textOutline.textContent = reward.name;

            textGroup.appendChild(textOutline);
            textGroup.appendChild(textEl);
            wheelSvg.appendChild(textGroup);
        });

         const centerCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
         centerCircle.setAttribute('cx', centerX);
         centerCircle.setAttribute('cy', centerY);
         centerCircle.setAttribute('r', 30);
         centerCircle.setAttribute('fill', 'none');
         centerCircle.setAttribute('stroke', '#eee');
         centerCircle.setAttribute('stroke-width', '4');
         wheelSvg.appendChild(centerCircle);
    }


    function calculateSpinResult(weights) {
        const totalWeight = weights.reduce((sum, w) => sum + w.weight, 0);
        let random = Math.random() * totalWeight;

        for (let i = 0; i < weights.length; i++) {
            if (random < weights[i].weight) {
                return i;
            }
            random -= weights[i].weight;
        }
        return Math.floor(Math.random() * weights.length);
    }

    function animateWheel(targetIndex) {
        const numSegments = spinWheelRewards.length;
        const degreesPerSegment = 360 / numSegments;
        
        const targetSegmentStartAngle = targetIndex * degreesPerSegment;
        let rotationDegrees = -90 - targetSegmentStartAngle + 5 * 360;


        console.log(`Spinning to segment ${targetIndex} (${spinWheelRewards[targetIndex].name}). Target rotation: ${rotationDegrees.toFixed(2)}deg`);

        wheelSvg.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
        wheelSvg.style.transform = `rotate(${rotationDegrees}deg)`;

        return new Promise(resolve => {
            setTimeout(() => {
                 wheelSvg.style.transition = 'none';
                 const normalizedRotation = (rotationDegrees % 360 + 360) % 360;
                 wheelSvg.style.transform = `rotate(${normalizedRotation}deg)`;

                 resolve(spinWheelRewards[targetIndex]);
            }, 5000);
        });
    }

    let cooldownIntervalId = null;
    function updateSpinUI() {
         const user = auth.currentUser;
         const isLoggedIn = user !== null && currentUsername !== null;

         if (spinBtn) {
              const onUiScreen = mainMenu.style.display === 'flex' || settingsModal.style.display === 'flex' || profileModal.style.display === 'flex' || inviteModal.style.display === 'flex' || withdrawModal.style.display === 'flex' || infoModal.style.display === 'flex' || withdrawalHistoryModal.style.display === 'flex' || spinWheelModal.style.display === 'flex' || swapModal.style.display === 'flex' || gameTransactionsModal.style.display === 'flex' || characterSelectionModal.style.display === 'flex';
             if ((isLoggedIn || guestButtonAlt.style.display !== 'none') && onUiScreen) {
                  spinBtn.style.display = 'flex';
             } else {
                  spinBtn.style.display = 'none';
             }
             spinBtn.style.pointerEvents = isProcessingAuth ? 'none' : 'auto';
         }


         if (!isLoggedIn) {
             spinsLeftDisplay.textContent = 'Log in to spin';
             cooldownTimerDisplay.textContent = '';
             freeSpinBtn.disabled = true;
             buySpinBtn.disabled = true;
             spinStatusDisplay.textContent = '';
             if (cooldownIntervalId) clearInterval(cooldownIntervalId);
             cooldownIntervalId = null;
             return;
         }

         spinsLeftDisplay.textContent = `Spins left: ${spinsLeft}`;
         buySpinBtn.textContent = `Buy Spin (${spinBuyPrice} Coins)`;

         const now = Date.now();
         const timeSinceLastSpin = now - (lastSpinTime || 0);

         if (spinsLeft > 0) {
              freeSpinBtn.disabled = false;
              freeSpinBtn.textContent = `Spin Now!`;
              cooldownTimerDisplay.textContent = '';
              if (cooldownIntervalId) clearInterval(cooldownIntervalId);
              cooldownIntervalId = null;
              spinStatusDisplay.textContent = 'Ready to spin!';
         } else {
              const timeRemaining = spinCooldownMilliseconds - timeSinceLastSpin;
              freeSpinBtn.disabled = true;
              freeSpinBtn.textContent = 'Cooling Down';

             if (timeRemaining > 1000) {
                  spinStatusDisplay.textContent = 'Cooldown active';

                  if (!cooldownIntervalId) {
                       cooldownIntervalId = setInterval(() => {
                            updateSpinUI();
                       }, 1000);
                  }
                 const secondsRemaining = Math.ceil(timeRemaining / 1000);
                 const hours = Math.floor(secondsRemaining / 3600);
                 const minutes = Math.floor((secondsRemaining % 3600) / 60);
                 const seconds = secondsRemaining % 60;
                 cooldownTimerDisplay.textContent = `Next spin in: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

             } else {
                  spinStatusDisplay.textContent = 'Free spin available!';
                  cooldownTimerDisplay.textContent = '';
                  freeSpinBtn.disabled = false;
                  freeSpinBtn.textContent = 'Get Free Spin!';
                  if (cooldownIntervalId) clearInterval(cooldownIntervalId);
                  cooldownIntervalId = null;
             }
         }


         if (totalCoins >= spinBuyPrice) {
             buySpinBtn.disabled = false;
             buySpinBtn.title = '';
         } else {
             buySpinBtn.disabled = true;
             buySpinBtn.title = `Need ${spinBuyPrice - totalCoins} more coins`;
         }

          if(isProcessingAuth) {
             if (!freeSpinBtn.dataset.preAuthDisabled) freeSpinBtn.dataset.preAuthDisabled = freeSpinBtn.disabled;
             if (!buySpinBtn.dataset.preAuthDisabled) buySpinBtn.dataset.preAuthDisabled = buySpinBtn.disabled;
              freeSpinBtn.disabled = true;
              buySpinBtn.disabled = true;
          } else {
              if (freeSpinBtn.dataset.preAuthDisabled !== undefined) {
                   freeSpinBtn.disabled = (freeSpinBtn.dataset.preAuthDisabled === 'true');
                   delete freeSpinBtn.dataset.preAuthDisabled;
              }
              if (buySpinBtn.dataset.preAuthDisabled !== undefined) {
                   buySpinBtn.disabled = (buySpinBtn.dataset.preAuthDisabled === 'true');
                   delete buySpinBtn.dataset.preAuthDisabled;
              }
          }
    }

    spinBtn.addEventListener('click', () => {
        const user = auth.currentUser;
        const isGuest = !user || !currentUsername;

        if (isGuest) {
             showStatusMessage("Log in to use the Spin Wheel.", "info");
             return;
        }
        if (isProcessingAuth) return;


         const userRef = ref(db, `users/${auth.currentUser.uid}`);
         update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on spin button click:", e));


         showInterstitialAd(() => {
              console.log("Ad callback: Showing Spin Wheel modal.");
              hideAllViewsAndModalsExcept(spinWheelModal);

              createWheelSegments();
              updateSpinUI();
              spinWheelModal.style.display = 'flex';
         });
    });

    closeSpinWheelBtn.addEventListener('click', () => {
        spinWheelModal.style.display = 'none';
        wheelSvg.style.transition = 'none';
        wheelSvg.style.transform = 'rotate(0deg)';
        spinStatusDisplay.textContent = 'Ready to spin!';
        if (!gameStarted && !gameOver) showMainMenu();
        if (cooldownIntervalId) clearInterval(cooldownIntervalId);
        cooldownIntervalId = null;
    });

    freeSpinBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user || !currentUsername) {
            showStatusMessage("Log in to use the Spin Wheel.", "error");
            return;
        }
         if (isProcessingAuth) return;

        const now = Date.now();
        const timeSinceLastSpin = now - (lastSpinTime || 0);
        const timeRemaining = spinCooldownMilliseconds - timeSinceLastSpin;

        if (spinsLeft <= 0 && timeRemaining <= 1000) {
             if (freeSpinBtn.disabled) return;
             freeSpinBtn.disabled = true;
             freeSpinBtn.textContent = 'Getting Spin...';
             spinStatusDisplay.textContent = 'Claiming free spin...';
             console.log("Cooldown finished and 0 spins, attempting to grant a free spin...");

             const userRef = ref(db, `users/${user.uid}`);
             const updates = { spinsLeft: 1, lastSpinTime: serverTimestamp(), lastActiveTimestamp: serverTimestamp() };

             await update(userRef, updates)
                 .then(() => {
                     console.log("Free spin granted successfully in DB. Listener will update UI.");
                     showStatusMessage("Free spin claimed! Click 'Spin Now!'", "success", 3000);
                 })
                 .catch(e => {
                     console.error("Error granting free spin in DB:", e);
                     showStatusMessage("Error claiming free spin. Try again.", "error");
                     freeSpinBtn.disabled = false; freeSpinBtn.textContent = 'Get Free Spin!';
                 });
             return;
        }

        if (spinsLeft > 0) {
            if (freeSpinBtn.disabled) return;
            freeSpinBtn.disabled = true;
            buySpinBtn.disabled = true;
            spinStatusDisplay.textContent = 'Spinning...';
            playSound(spinStartSound);

            const winningIndex = calculateSpinResult(spinWheelRewards);
            const wonReward = spinWheelRewards[winningIndex];
            console.log("Calculated winning index:", winningIndex, wonReward);

            animateWheel(winningIndex).then(async () => {
                console.log("Spin animation finished. Won:", wonReward);
                playSound(spinWinSound);
                spinStatusDisplay.textContent = `You won: ${wonReward.name}!`;

                const userRef = ref(db, `users/${user.uid}`);
                 get(userRef).then(snap => {
                     if (!snap.exists()) { console.error("User data missing after spin!"); showStatusMessage("Error processing win.", "error", 5000); updateSpinUI(); return; }
                     const currentData = snap.val();
                     const currentSpins = currentData.spinsLeft ?? 0;
                     const currentTotalCoins = currentData.totalCoins ?? 0;
                     const currentTotalPKR = currentData.totalPKR ?? 0;
                     const currentSpinCoinsEarned = currentData.totalSpinCoinsEarned ?? 0;
                     const currentSpinPkrEarned = currentData.totalSpinPkrEarned ?? 0;

                    const updates = {};

                    updates[`/users/${user.uid}/spinsLeft`] = (currentSpins > 0 ? currentSpins - 1 : 0);
                    updates[`/users/${user.uid}/lastSpinTime`] = serverTimestamp();
                    updates[`/users/${user.uid}/lastActiveTimestamp`] = serverTimestamp();

                    if (wonReward.type === 'coins') {
                        updates[`/users/${user.uid}/totalCoins`] = currentTotalCoins + wonReward.amount;
                        updates[`/users/${user.uid}/totalSpinCoinsEarned`] = currentSpinCoinsEarned + wonReward.amount;
                    } else if (wonReward.type === 'pkr') {
                        updates[`/users/${user.uid}/totalPKR`] = currentTotalPKR + wonReward.amount;
                        updates[`/users/${user.uid}/totalSpinPkrEarned`] = currentSpinPkrEarned + wonReward.amount;
                    }

                     const newTransactionRef = push(ref(db, `users/${user.uid}/transactions`));
                     updates[`/users/${user.uid}/transactions/${newTransactionRef.key}`] = {
                          type: wonReward.type === 'coins' ? 'spin_coins' : 'spin_pkr',
                          amount: wonReward.amount,
                          timestamp: serverTimestamp(),
                          details: `Spin: Won ${wonReward.amount} ${wonReward.type === 'coins' ? 'Coins' : 'Rs'}`
                     };


                    console.log(`Updating Firebase after spin: Decrement spins, set lastSpinTime, add ${wonReward.amount} ${wonReward.type}, update spin earnings, add transaction.`);
                    update(ref(db), updates)
                        .then(() => {
                             console.log(`Spin winnings saved. Won ${wonReward.name}. Spins Left: ${currentSpins > 0 ? currentSpins - 1 : 0}. Transaction saved.`);
                             showStatusMessage(`Won ${wonReward.name}! Added ${wonReward.amount} ${wonReward.type}.`, "success", 5000);
                        })
                        .catch(e => {
                             console.error("Error saving spin winnings or transaction:", e);
                             showStatusMessage(`Error saving win: ${wonReward.name}. Reward not added.`, "error", 5000);
                        });
                 }).catch(e => {
                     console.error("Error fetching user data before spin win update:", e);
                     showStatusMessage("Error processing win.", "error", 5000);
                     updateSpinUI();
                 });
            });
        } else {
             showStatusMessage("No spins available.", "error", 2000);
             updateSpinUI();
        }
    });


    buySpinBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user || !currentUsername) return;
        if (isProcessingAuth || buySpinBtn.disabled) return;

        if (totalCoins < spinBuyPrice) {
            showStatusMessage(`Not enough coins. Need ${spinBuyPrice} coins.`, "error", 3000);
            updateSpinUI();
            return;
        }

        buySpinBtn.disabled = true;
        buySpinBtn.textContent = "Buying...";
        spinStatusDisplay.textContent = "Processing purchase...";
        showStatusMessage(`Buying spin for ${spinBuyPrice} coins...`, "info");

        const userRef = ref(db, `users/${user.uid}`);

         get(userRef).then(snap => {
             if (!snap.exists()) {
                 console.error("User data missing when buying spin!");
                 showStatusMessage("Error buying spin.", "error", 5000);
                 buySpinBtn.disabled = false; buySpinBtn.textContent = `Buy Spin (${spinBuyPrice} Coins)`;
                 updateSpinUI();
                 return;
             }
             const currentData = snap.val();
             const currentTotalCoins = currentData.totalCoins ?? 0;
             const currentSpinsLeft = currentData.spinsLeft ?? 0;

             if (currentTotalCoins < spinBuyPrice) {
                 console.warn("Insufficient coins on server during buy spin transaction check.");
                 showStatusMessage(`Not enough coins. Need ${spinBuyPrice} coins.`, "error", 3000);
                 buySpinBtn.disabled = false; buySpinBtn.textContent = `Buy Spin (${spinBuyPrice} Coins)`;
                 updateSpinUI();
                 return;
             }


            const updates = {};
            updates[`/users/${user.uid}/totalCoins`] = currentTotalCoins - spinBuyPrice;
            updates[`/users/${user.uid}/spinsLeft`] = currentSpinsLeft + 1;
            updates[`/users/${user.uid}/lastActiveTimestamp`] = serverTimestamp();

             const newTransactionRef = push(ref(db, `users/${user.uid}/transactions`));
              updates[`/users/${user.uid}/transactions/${newTransactionRef.key}`] = {
                  type: 'buy_spin',
                  amount: spinBuyPrice,
                  timestamp: serverTimestamp(),
                  details: `Bought spin for ${spinBuyPrice} Coins`
              };


            update(ref(db), updates)
                .then(() => {
                     console.log(`Spin purchased for ${spinBuyPrice} coins. Coins: -${spinBuyPrice}, Spins Left: ${currentSpinsLeft + 1}. Transaction saved.`);
                     showStatusMessage(`Spin purchased! ${spinBuyPrice} coins deducted.`, "success", 3000);
                })
                .catch(e => {
                     console.error("Error buying spin:", e);
                     showStatusMessage(`Error buying spin: ${e.message}`, "error", 5000);
                     buySpinBtn.disabled = false; buySpinBtn.textContent = `Buy Spin (${spinBuyPrice} Coins)`;
                });
         }).catch(e => {
             console.error("Error fetching user data before buy spin update:", e);
             showStatusMessage("Error buying spin.", "error", 5000);
             buySpinBtn.disabled = false; buySpinBtn.textContent = `Buy Spin (${spinBuyPrice} Coins)`;
         });
    });

    // --- Swap Modal Logic ---
    coinStatusBox.addEventListener('click', () => { // Changed from topRightStatus to coinStatusBox
         const user = auth.currentUser;
         if (!user || !currentUsername) {
             showStatusMessage("Log in & complete profile to swap.", "info");
             return;
         }
         if (isProcessingAuth) return;


         const userRef = ref(db, `users/${user.uid}`);
         update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on swap show:", e));


         showInterstitialAd(() => {
            console.log("Ad callback: Showing Swap modal.");
             hideAllViewsAndModalsExcept(swapModal);
             updateSwapModalState();
             swapModal.style.display = 'flex';
         });
    });

    closeSwapModalBtn.addEventListener('click', () => {
         swapModal.style.display = 'none';
         if (!gameStarted && !gameOver) showMainMenu();
    });

    function updateSwapModalState() {
         const user = auth.currentUser;
         const isLoggedInAndProfileComplete = user && currentUsername;
         const swapCoinBlock = gameConfig.swapBlock;
         const swapPkrBlock = swapCoinBlock / gameConfig.coinToPkrRate;

         if (!isLoggedInAndProfileComplete) {
             if(swapCurrentCoinsSpan) swapCurrentCoinsSpan.textContent = '...';
             if(swapCurrentPkrSpan) swapCurrentPkrSpan.textContent = '...';
             if(swapToPkrBtn) {
                  swapToPkrBtn.disabled = true;
                  swapToPkrBtn.textContent = 'Log in to Swap';
                  swapToPkrBtn.title = 'Log in & complete profile to swap.';
             }
             return;
         }

         if(swapCurrentCoinsSpan) swapCurrentCoinsSpan.textContent = totalCoins;
         if(swapCurrentPkrSpan) swapCurrentPkrSpan.textContent = totalPKR;

         const maxSwappableCoinsDisplay = Math.floor(totalCoins / swapCoinBlock) * swapCoinBlock;
         const maxSwappablePKRDisplay = (maxSwappableCoinsDisplay / swapCoinBlock) * swapPkrBlock;


         if (swapToPkrBtn) {
             if (maxSwappableCoinsDisplay >= swapCoinBlock) {
                 swapToPkrBtn.disabled = false;
                 swapToPkrBtn.textContent = `Swap ${maxSwappableCoinsDisplay} Coins`;
                 swapToPkrBtn.title = `Swap ${maxSwappableCoinsDisplay} Coins for ${maxSwappablePKRDisplay} Rs`;
             } else {
                 swapToPkrBtn.disabled = true;
                 swapToPkrBtn.textContent = `Need ${swapCoinBlock} Coins`;
                 swapToPkrBtn.title = `Need ${swapCoinBlock - totalCoins} more coins to swap.`;
             }
             if(isProcessingAuth) {
                  if (!swapToPkrBtn.dataset.preAuthDisabled) swapToPkrBtn.dataset.preAuthDisabled = swapToPkrBtn.disabled;
                  swapToPkrBtn.disabled = true;
             } else {
                  if (swapToPkrBtn.dataset.preAuthDisabled !== undefined) {
                       swapToPkrBtn.disabled = (swapToPkrBtn.dataset.preAuthDisabled === 'true');
                       delete swapToPkrBtn.dataset.preAuthDisabled;
                  }
             }
         }
    }

    swapToPkrBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user || !currentUsername || swapToPkrBtn.disabled) {
            showStatusMessage("Action not available. Log in?", "error");
            return;
        }
        if (isProcessingAuth) return;

         const swapCoinBlock = gameConfig.swapBlock;
         const coinsToSwapCheck = Math.floor(totalCoins / swapCoinBlock) * swapCoinBlock;
         if (coinsToSwapCheck < swapCoinBlock) {
            showStatusMessage(`Not enough coins to swap a block of ${swapCoinBlock}.`, "error", 3000);
            updateSwapModalState();
            return;
        }


        swapToPkrBtn.disabled = true;
         const processingText = `Processing Swap (${coinsToSwapCheck} Coins)...`;
        swapToPkrBtn.textContent = processingText;
        showStatusMessage("Processing swap...", "info");

        const userRef = ref(db, `users/${user.uid}`);

         get(userRef).then(snap => {
             if (!snap.exists()) {
                 console.error("User data missing when swapping coins!");
                 showStatusMessage("Error swapping coins.", "error", 5000);
                 swapToPkrBtn.disabled = false; swapToPkrBtn.textContent = `Swap ${coinsToSwapCheck} Coins`;
                 updateSwapModalState();
                 return;
             }
             const currentData = snap.val();
             const currentTotalCoins = currentData.totalCoins ?? 0;
             const currentTotalPKR = currentData.totalPKR ?? 0;
             const currentTotalCoinsSwapped = currentData.totalCoinsSwapped ?? 0;
             const swapPkrBlock = swapCoinBlock / gameConfig.coinToPkrRate;

             const coinsToSwap = Math.floor(currentTotalCoins / swapCoinBlock) * swapCoinBlock;
             const pkrToAdd = (coinsToSwap / swapCoinBlock) * swapPkrBlock;

             if (coinsToSwap < swapCoinBlock) {
                 console.warn("Insufficient coins on server during swap transaction check.");
                 showStatusMessage(`Not enough coins to swap a block of ${swapCoinBlock}.`, "error", 3000);
                 swapToPkrBtn.disabled = false; swapToPkrBtn.textContent = `Swap ${coinsToSwapCheck} Coins`;
                 updateSwapModalState();
                 return;
             }
             if (coinsToSwap === 0) {
                  console.warn("Calculated coinsToSwap is 0 during transaction.");
                  showStatusMessage("Swap amount error.", "error", 3000);
                  swapToPkrBtn.disabled = false; swapToPkrBtn.textContent = `Swap ${coinsToSwapCheck} Coins`;
                  updateSwapModalState();
                  return;
             }


            const updates = {};
            updates[`/users/${user.uid}/totalCoins`] = currentTotalCoins - coinsToSwap;
            updates[`/users/${user.uid}/totalPKR`] = currentTotalPKR + pkrToAdd;
            updates[`/users/${user.uid}/totalCoinsSwapped`] = currentTotalCoinsSwapped + coinsToSwap;
            updates[`/users/${user.uid}/lastActiveTimestamp`] = serverTimestamp();

             const newTransactionRef = push(ref(db, `users/${user.uid}/transactions`));
             updates[`/users/${user.uid}/transactions/${newTransactionRef.key}`] = {
                 type: 'swap_coins',
                 amount: coinsToSwap,
                 pkr_added: pkrToAdd,
                 timestamp: serverTimestamp(),
                 details: `Swapped ${coinsToSwap} Coins`
             };


            update(ref(db), updates)
                .then(() => {
                     console.log(`Coins swapped. Coins: -${coinsToSwap}, PKR: +${pkrToAdd}, Swapped: +${coinsToSwap}. Transaction saved.`);
                     showStatusMessage(`Successfully swapped ${coinsToSwap} Coins for ${pkrToAdd} Rs!`, "success", 5000);
                     swapModal.style.display = 'none';
                     showMainMenu();
                })
                .catch(e => {
                     console.error("Error swapping coins:", e);
                     showStatusMessage(`Swap failed: ${e.message}`, "error", 5000);
                     swapToPkrBtn.disabled = false;
                     swapToPkrBtn.textContent = `Swap ${coinsToSwapCheck} Coins`;
                     updateSwapModalState();
                });
         }).catch(err => {
             console.error("Error fetching user data before swap update:", err);
             showStatusMessage("Error checking user data.", "error", 5000);
             swapToPkrBtn.disabled = false; swapToPkrBtn.textContent = `Swap ${coinsToSwapCheck} Coins`;
         });
    });


    // --- Game Engine ---
    const ctx = gameCanvas.getContext("2d");
    function resizeCanvas() { gameCanvas.width=window.innerWidth; const bannerHeight=document.getElementById('bannerAdContainer')?.offsetHeight||50; gameCanvas.height=window.innerHeight-bannerHeight; if(gameStarted&&mario){const groundY=gameCanvas.height-50; if(mario.y+mario.height>=groundY-5){mario.y=groundY-mario.height;mario.dy=0;if(mario.isJumping){mario.isJumping=false;canDoubleJump=false;}}} } window.addEventListener("resize", resizeCanvas);
    const imagesToLoad = { background:"https://i.imgur.com/xZpZqGt.png", enemy:"https://i.imgur.com/TsR4WXH.png", coin:"https://i.imgur.com/cMQ9X0d.png", platform:"https://i.imgur.com/06ptzal.png", pkr_icon: "https://i.imgur.com/W96jC2k.png" };
    const gameImages = {}; let imagesLoadedCount = 0; let totalImagesToLoad = Object.keys(imagesToLoad).length;
    function checkAllImagesLoaded() { imagesLoadedCount++; console.log(`Image loaded (${imagesLoadedCount}/${totalImagesToLoad})`); if (imagesLoadedCount >= totalImagesToLoad) { allImagesLoaded = true; console.log("All essential images loaded."); if(startBtn) startBtn.disabled = false; if(restartBtn) restartBtn.disabled = false; showStatusMessage("Assets loaded!", "success", 1500); } }
    
    function loadInitialAssets() {
        console.log("Loading initial assets...");
        if (!db) {
            console.error("Firebase DB not initialized, cannot load assets.");
            showStatusMessage("Fatal error: Cannot load assets.", "error", 10000);
            if (startBtn) startBtn.disabled = true; if (restartBtn) restartBtn.disabled = true;
            return;
        }

        // Add character sprites to the loading list
        for (const charKey in gameConfig.characters) {
            const char = gameConfig.characters[charKey];
            if (!imagesToLoad[char.spriteUrl]) { // Avoid re-adding if URL is same
                imagesToLoad[char.spriteUrl] = char.spriteUrl;
                totalImagesToLoad++;
            }
        }

        for (const key in imagesToLoad) { 
            const url = imagesToLoad[key];
            gameImages[url] = new Image(); 
            gameImages[url].onload = checkAllImagesLoaded; 
            gameImages[url].onerror = () => { console.error(`Failed load: ${key}`); totalImagesToLoad--; showStatusMessage(`Error loading asset: ${key}.`, "error", 5000); };
            gameImages[url].src = url; 
        }
    }


    function initGame() {
        if (!allImagesLoaded) { showStatusMessage("Assets loading...", "info"); return; }
        if (gameStarted) return;
        console.log("Initializing game with character:", selectedCharacter.name);
        resizeCanvas();
        bgX = 0; platformX = 0;
        const groundY = gameCanvas.height - 50;
        mario = { 
            x: 60, 
            y: groundY - selectedCharacter.height, 
            width: selectedCharacter.width, 
            height: selectedCharacter.height, 
            dy: 0, 
            gravity: 1.6, 
            jumpPower: -22, 
            doubleJumpPower: -18, 
            isJumping: false, 
            onGround: true 
        };
        obstacles = []; coins = [];
        speed = 6; score = 0;
        gameOver = false;
        gameStarted = true;
        lastJumpInputTime = 0;
        canDoubleJump = false;
        if(animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null;

        if (auth.currentUser && currentUsername) {
             gameStartTime = Date.now();
             console.log(`Game timer started for ${currentUsername}: ${gameStartTime}`);
        } else {
             gameStartTime = 0;
             console.log("Game timer not started for guest/incomplete profile.");
        }

        playBackgroundMusic();
        if (whatsappBtn) whatsappBtn.style.display = 'none';
        if (spinBtn) spinBtn.style.display = 'none';
        topRightStatusContainer.style.display = 'none';
        if (settingsBtn) settingsBtn.style.display = 'none';

        console.log("Game initialized. Starting loop.");
        gameLoop();
    }
    function drawBackground() { if (!gameImages[imagesToLoad.background]?.complete || gameImages[imagesToLoad.background].naturalHeight === 0) { ctx.fillStyle = '#60a5fa'; ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height); return; }; bgX = (bgX - speed * 0.4) % gameImages[imagesToLoad.background].width; ctx.drawImage(gameImages[imagesToLoad.background], bgX, 0, gameImages[imagesToLoad.background].width, gameCanvas.height); ctx.drawImage(gameImages[imagesToLoad.background], bgX + gameImages[imagesToLoad.background].width, 0, gameImages[imagesToLoad.background].width, gameCanvas.height); }
    function drawPlatform() { if (!gameImages[imagesToLoad.platform]?.complete || gameImages[imagesToLoad.platform].naturalHeight === 0) { ctx.fillStyle = '#E0A070'; ctx.fillRect(0, gameCanvas.height - 50, gameCanvas.width, 50); return; }; const groundY = gameCanvas.height - 50; platformX = (platformX - speed) % gameImages[imagesToLoad.platform].width; ctx.drawImage(gameImages[imagesToLoad.platform], platformX, groundY, gameImages[imagesToLoad.platform].width, 50); ctx.drawImage(gameImages[imagesToLoad.platform], platformX + gameImages[imagesToLoad.platform].width, groundY, gameImages[imagesToLoad.platform].width, 50); }
    function drawMario() { if(!mario || !gameImages[selectedCharacter.spriteUrl]?.complete || gameImages[selectedCharacter.spriteUrl].naturalHeight === 0) return; ctx.drawImage(gameImages[selectedCharacter.spriteUrl], mario.x, mario.y, mario.width, mario.height); }
    function drawObstacles() { if (!gameImages[imagesToLoad.enemy]?.complete || gameImages[imagesToLoad.enemy].naturalHeight === 0) return; for (let i = obstacles.length - 1; i >= 0; i--){ let obs = obstacles[i]; obs.x -= speed; ctx.drawImage(gameImages[imagesToLoad.enemy], obs.x, obs.y, obs.width, obs.height); if(obs.x + obs.width < 0) obstacles.splice(i, 1); } }
    function spawnObstacles() { if(gameOver || !gameImages[imagesToLoad.enemy]?.complete || gameImages[imagesToLoad.enemy].naturalHeight === 0) return; const bMin=350, bMax=650; const dF=Math.max(0.3,1-(score/1000)); const cMin=bMin*dF, cMax=bMax*dF; const dR=Math.max(50,cMax-cMin); const rD=cMin+Math.random()*dR; let lastX=-rD; if(obstacles.length>0) lastX=obstacles[obstacles.length-1].x; if(gameCanvas.width-lastX>rD && obstacles.length<5){ const gY=gameCanvas.height-50; obstacles.push({x:gameCanvas.width+10,y:gY-50,width:50,height:50}); } }
    function spawnCoins() {
        if(!gameImages[imagesToLoad.coin]?.complete || gameImages[imagesToLoad.coin].naturalHeight === 0 || gameOver) return;
        const spawnChance = 0.014;
        const maxGroups = 3;
        if(coins.length < (maxGroups * 2) && Math.random() < spawnChance) {
            const groundY = gameCanvas.height - 50; let startY; const hChance=Math.random();
            if(hChance<0.5) startY=groundY-30; else if(hChance<0.85) startY=groundY-100-(Math.random()*40); else startY=groundY-160-(Math.random()*50);
            let coinCount = Math.floor(Math.random() * 2) + 1;
            let startX = gameCanvas.width + Math.random() * 150; const spacing = 45;
            for(let i=0; i<coinCount; i++) coins.push({x:startX+i*spacing,y:startY,width:25,height:25});
        }
    }
    function drawCoinsAndCollect() { if (!gameImages[imagesToLoad.coin]?.complete || gameImages[imagesToLoad.coin].naturalHeight === 0 || !mario || gameOver) return; for (let i = coins.length - 1; i >= 0; i--) { let c = coins[i]; c.x -= speed; ctx.drawImage(gameImages[imagesToLoad.coin], c.x - c.width / 2, c.y - c.height / 2, c.width, c.height); if (mario.x < c.x + c.width / 2 && mario.x + mario.width > c.x - c.width / 2 && mario.y < c.y + c.height / 2 && mario.y + mario.height > c.y - c.height / 2) { coins.splice(i, 1); score += 1; playSound(coinSound); } else if (c.x + c.width / 2 < 0) coins.splice(i, 1); } }
    function applyPhysics() { if(!mario || gameOver) return; mario.dy += mario.gravity; mario.y += mario.dy; const groundY = gameCanvas.height - 50; if (mario.y + mario.height >= groundY) { mario.y = groundY - mario.height; mario.dy = 0; mario.onGround = true; if(mario.isJumping) { mario.isJumping = false; canDoubleJump = false; } } else mario.onGround = false; if (mario.y < 0) { mario.y = 0; mario.dy = 0; } }
    function checkCollision() { if(!mario || gameOver) return; for(let i = obstacles.length - 1; i >= 0; i--){ let obs = obstacles[i]; const mX=mario.x+5, mY=mario.y+5, mW=mario.width-10, mH=mario.height-10; const oX=obs.x+5, oY=obs.y+5, oW=obs.width-10, oH=obs.height-10; if (mX < oX + oW && mX + mW > oX && mY < oY + oH && mY + mH > oY) { console.log("Collision!"); gameOver = true; stopBackgroundMusic(); break; } } }
    function jump() { if(!gameStarted || gameOver || !mario) return; const now = Date.now(); if (mario.isJumping && !mario.onGround && canDoubleJump && (now - lastJumpInputTime < doubleJumpWindow)) { mario.dy = mario.doubleJumpPower; canDoubleJump = false; lastJumpInputTime = 0; console.log("Double Jump!"); playSound(jumpSound); } else if (mario.onGround) { mario.dy = mario.jumpPower; mario.isJumping = true; mario.onGround = false; canDoubleJump = true; lastJumpInputTime = now; console.log("First Jump!"); playSound(jumpSound); } }
    function gameLoop() {
        if(gameOver || !gameStarted) { if (gameOver) handleGameOver(); return; }
        applyPhysics(); checkCollision(); if (gameOver) { handleGameOver(); return; }
        spawnObstacles(); spawnCoins();
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        drawBackground(); drawPlatform(); drawObstacles(); drawCoinsAndCollect(); drawMario();
        ctx.fillStyle="#FFF";
        ctx.font="18px 'Press Start 2P'";
        ctx.textAlign="left"; ctx.textBaseline="top"; ctx.shadowColor='rgba(0,0,0,0.8)'; ctx.shadowBlur=5; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2;
        ctx.fillText("Score: " + score, 25, 25);
        ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
        animationFrameId = requestAnimationFrame(gameLoop);
    }
    function handleGameOver() {
        if(animationFrameId) cancelAnimationFrame(animationFrameId);
        showGameOverMenu();
    }

    // --- Game Control Buttons ---
    startBtn.addEventListener("click", () => {
        if (!allImagesLoaded) { showStatusMessage("Assets loading...", "info"); return; }
        if (gameStarted) return;
        showCharacterSelectionScreen();
    });
    
    restartBtn.addEventListener("click", () => {
         if (!allImagesLoaded) { showStatusMessage("Assets error.", "error"); showMainMenu(); return; }
         if (gameStarted) return;
         gameOverMenu.style.display = "none";
         showCharacterSelectionScreen();
    });
    backMenuBtn.addEventListener("click", () => {
        console.log("Back to Menu clicked.");
        showInterstitialAd(() => { console.log("Ad callback: Showing main menu."); showMainMenu(); });
    });
    
    // --- Character Selection Logic ---
    function showCharacterSelectionScreen() {
        const user = auth.currentUser;
        if (!user && Object.keys(gameConfig.characters).length <= 1) {
            // Guest mode and only one character exists, start game directly
            selectedCharacter = gameConfig.characters[Object.keys(gameConfig.characters)[0]];
            startGame();
            return;
        }

        characterContainer.innerHTML = '';
        for (const charId in gameConfig.characters) {
            const char = gameConfig.characters[charId];
            const card = document.createElement('div');
            card.className = 'character-card';
            
            const isOwned = userPurchasedCharacters.includes(charId);
            let buttonHtml;

            if (isOwned) {
                buttonHtml = `<button class="game-btn char-btn select-char-btn" data-char-id="${charId}">Select</button>`;
            } else {
                buttonHtml = `<button class="game-btn char-btn buy-char-btn" data-char-id="${charId}">
                    Buy <span class="char-price">( ${char.price} <img src="${imagesToLoad.coin}">)</span>
                </button>`;
            }

            card.innerHTML = `
                <img src="${char.iconUrl}" alt="${char.name}">
                <h3>${char.name}</h3>
                ${buttonHtml}
            `;
            characterContainer.appendChild(card);
        }

        document.querySelectorAll('.select-char-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const charId = e.currentTarget.dataset.charId;
                selectedCharacter = gameConfig.characters[charId];
                startGame();
            });
        });

        document.querySelectorAll('.buy-char-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const charId = e.currentTarget.dataset.charId;
                handleCharacterPurchase(charId);
            });
        });

        hideAllViewsAndModalsExcept(characterSelectionModal);
        characterSelectionModal.style.display = 'flex';
    }
    
    async function handleCharacterPurchase(charId) {
        const user = auth.currentUser;
        if (!user) {
            showStatusMessage("Log in to buy characters.", "error");
            return;
        }
        const charToBuy = gameConfig.characters[charId];
        if (totalCoins < charToBuy.price) {
            showStatusMessage(`Not enough coins! Need ${charToBuy.price}.`, "error");
            return;
        }

        const userRef = ref(db, `users/${user.uid}`);
        const updates = {};
        updates.totalCoins = totalCoins - charToBuy.price;
        updates.purchasedCharacters = [...userPurchasedCharacters, charId];

        try {
            await update(userRef, updates);
            showStatusMessage(`${charToBuy.name} purchased!`, "success");
            // The listener will automatically update the UI
        } catch (error) {
            showStatusMessage("Purchase failed. Try again.", "error");
            console.error("Purchase error:", error);
        }
    }
    
    function startGame() {
        console.log("Start game sequence initiated.");
        const user = auth.currentUser;
        if (user && currentUsername) {
            const userRef = ref(db, `users/${user.uid}`);
            update(userRef, { lastActiveTimestamp: serverTimestamp() }).catch(e => console.error("Error updating last active timestamp on game start:", e));
        }
        
        showInterstitialAd(() => { 
            console.log("Ad callback: Starting game."); 
            hideAllViewsAndModalsExcept(gameCanvas);
            gameCanvas.style.display = 'block';
            initGame(); 
        });
    }

    closeCharacterSelectionBtn.addEventListener('click', () => {
        characterSelectionModal.style.display = 'none';
        showMainMenu();
    });


    // --- Jump Listeners ---
    document.addEventListener("keydown", (e) => { if ((e.code === "Space" || e.code === "ArrowUp") && gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    gameCanvas.addEventListener("click", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    gameCanvas.addEventListener("touchstart", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } }, { passive: false });

    // --- PWA Installation Logic ---
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredInstallPrompt = e;
      console.log('`beforeinstallprompt` event was fired.');
      if (installPwaBtn) installPwaBtn.style.display = 'inline-flex';
      if (pwaInstallBanner) pwaInstallBanner.style.display = 'flex';
    });

    pwaInstallBtn.addEventListener('click', handlePwaInstall);
    installPwaBtn.addEventListener('click', handlePwaInstall);
    
    async function handlePwaInstall() {
        pwaInstallBanner.style.display = 'none';
        if (!deferredInstallPrompt) {
            showStatusMessage("App already installed or not supported.", "info");
            return;
        }
        deferredInstallPrompt.prompt();
        const { outcome } = await deferredInstallPrompt.userChoice;
        if (outcome === 'accepted') {
            showStatusMessage("App installed successfully!", "success");
        } else {
            showStatusMessage("Installation cancelled.", "info");
        }
        deferredInstallPrompt = null;
        if (installPwaBtn) installPwaBtn.style.display = 'none';
    }

    pwaDismissBtn.addEventListener('click', () => {
        pwaInstallBanner.style.display = 'none';
    });


    window.addEventListener('appinstalled', () => {
      console.log('PWA was installed');
      deferredInstallPrompt = null;
      if (installPwaBtn) installPwaBtn.style.display = 'none';
      if (pwaInstallBanner) pwaInstallBanner.style.display = 'none';
    });

    // --- Initial Setup on Page Load ---
    async function initializeAppUI() {
        console.log("Initializing UI...");
        hideAllViewsAndModalsExcept();
        setAuthProcessing(true);
        showStatusMessage("Loading Game...", "info");

        await fetchGameConfig();
        applyGameConfig();
        loadInitialAssets(); // This now loads character sprites as well
        
        setAuthProcessing(false); updateSoundButton(); updateInviteLinkDisplay(); updateCoinPkrDisplay();
        if (startBtn) startBtn.disabled = true;
        if (restartBtn) restartBtn.disabled = true;

        console.log("Initial UI setup complete. Waiting for auth state...");
    }
    initializeAppUI();

  </script>

  <!-- Social Bar Script -->
  <script type='text/javascript' src='//pl26479822.profitableratecpm.com/11/f3/83/11f3830187c378aedebef88b0bcd83a0.js'></script>

</body>
</html>
